<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Product Details - Ramazone</title>
    <meta property="og:title" content="Ramazone">
    <meta property="og:image" content="https://i.ibb.co/My6h0gdd/20250706-230221.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .you-might-like-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-3 flex items-center justify-between">
                <a href="./products.html" class="text-gray-600 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </a>
                <a href="./index.html"><img src="https://i.ibb.co/My6h0gdd/20250706-230221.png" alt="Ramazone Logo" style="max-height: 35px; border-radius: 0;"></a>
                <a href="order.html" id="header-cart-link" class="header-cart-link">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-item-count"></span>
                </a>
            </div>
        </div>
    </header>

    <main id="product-content" class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-0 sm:mt-2 mb-12 pb-28" style="display: none;">
        <div class="bg-white sm:rounded-2xl sm:shadow-lg overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2">
                <div class="p-0 sm:p-4 lg:p-6">
                    <div id="main-media-wrapper" class="rounded-none sm:rounded-xl mb-4 cursor-pointer overflow-hidden relative"><div id="media-slider"></div></div>
                    <div class="relative px-4 sm:px-0"><div class="grid grid-cols-5 gap-2 sm:gap-4" id="thumbnail-gallery"></div></div>
                </div>
                <div class="flex flex-col p-4 sm:p-6 lg:p-8">
                    <div class="flex justify-between items-start mb-2">
                        <h1 id="product-title" class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight"></h1>
                        <button id="share-button" title="Share Product" class="flex-shrink-0 bg-gray-100 rounded-full w-11 h-11 flex items-center justify-center hover:bg-gray-200 transition"><img src="https://www.svgrepo.com/show/527876/share.svg" class="w-6 h-6" alt="Share Icon"></button>
                    </div>
                    <div id="rating-section" class="flex items-center gap-2 text-sm text-gray-500 mb-4" style="display: none;"><div id="product-rating-stars" class="rating-stars"></div><span id="product-review-count"></span></div>
                    <div id="variant-selection-section" class="mb-4" style="display: none;"><div id="variant-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div></div>
                    <div class="space-y-3 border-t border-b border-gray-200 py-3 my-3">
                        <div id="new-price-section">
                             <div id="lowest-price-tag-container" style="display: none;"><div class="lowest-price-tag">Lowest Price since Launch</div></div>
                            <div class="flex items-center gap-3 mb-2">
                                <span id="price-percentage-discount" class="text-2xl font-bold text-green-600 flex items-center"></span>
                                <span id="price-original" class="text-xl text-gray-400 line-through"></span>
                                <span id="price-final" class="text-3xl font-extrabold text-gray-900"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="advanced-highlights-section" class="border-t border-gray-200" style="display: none;"></div>
            <div id="description-section" class="p-4 sm:p-6 lg:p-8" style="display: none;">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Product Details</h2><div id="product-description" class="space-y-6"></div>
                <div id="handpicked-similar-section" class="mt-8 pt-6 border-t border-gray-200" style="display: none;">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">You Might Also Like</h2><div id="handpicked-similar-container" class="you-might-like-grid"></div>
                </div>
            </div>
        </div>
        <div id="recently-viewed-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">Recently Viewed</h2><div id="recently-viewed-container" class="carousel-container pb-4"></div></div>
        <div id="similar-products-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">More in this Category</h2><div id="similar-products-container" class="carousel-container pb-4"></div></div>
        <div id="other-products-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">Other Products</h2><div id="other-products-container" class="grid grid-cols-2 gap-3 sm:gap-4"></div></div>
    </main>

    <div id="loading-indicator" class="text-center py-20"><p class="text-lg font-semibold">Product load ho raha hai...</p></div>

    <div id="image-modal"><span class="close">×</span><a class="modal-nav prev">❮</a><img id="modal-image-content"><a class="modal-nav next">❯</a></div>
    <div id="toast-notification"></div>
    <div id="variant-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[1001] flex justify-center items-center p-4 hidden"><div id="variant-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[80vh] flex flex-col transform scale-95 opacity-0 transition-all duration-300"><div class="flex justify-between items-center p-4 border-b"><h3 id="variant-modal-title" class="text-lg font-bold">Select Option</h3><button id="variant-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">×</button></div><div id="variant-modal-body" class="p-4 overflow-y-auto space-y-3"></div></div></div>
    
    <div id="sticky-action-bar" class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] p-3 z-40 border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-2 gap-3">
                <div id="quantity-selector-wrapper" class="hidden flex items-center justify-center">
                    <div class="quantity-selector inline-flex items-center justify-center bg-white rounded-lg shadow-sm">
                        <button id="decrease-quantity" class="rounded-l-lg">-</button>
                        <span id="quantity-display" class="text-center px-4 py-2 border-t border-b border-gray-200">1</span>
                        <button id="increase-quantity" class="rounded-r-lg">+</button>
                    </div>
                </div>

                <div id="main-action-container" class="col-start-1 col-span-2 md:col-start-2">
                    <button id="add-to-cart-btn" class="w-full flex items-center justify-center text-white font-bold py-3 px-4 rounded-xl text-lg shadow-lg">
                        <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                    </button>

                    <a id="go-to-cart-btn" href="order.html" class="hidden w-full flex items-center justify-center text-white font-bold py-3 px-4 rounded-xl text-lg shadow-lg">
                        <i class="fas fa-arrow-right mr-2"></i> Go to Cart
                    </a>

                    <a id="order-now-link" href="#" class="hidden whatsapp-btn w-full flex items-center justify-center text-white font-bold py-3 px-4 rounded-xl text-lg shadow-lg">
                        <i class="fab fa-whatsapp text-2xl mr-2"></i> Order Now
                    </a>
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
    // --- GLOBAL STATE (product details page specific) ---
    let mediaItems = [], currentMediaIndex = 0, currentProductData = null, currentProductId = null;
    let allProductsCache = [], validCoupons = [];
    let selectedVariants = {};
    let ramazoneDeliveryCharge = 10;
    let appThemeColor = '#4F46E5';
    let database;

    const slider = document.getElementById('media-slider');
    const sliderWrapper = document.getElementById('main-media-wrapper');
    let isDragging = false, startPos = 0, currentTranslate = 0, prevTranslate = 0, animationID;

    // --- NEW CART FUNCTIONS ---
    /**
     * Retrieves the cart from localStorage.
     * @returns {Array} The cart array, or an empty array if not found.
     */
    function getCart() {
        try {
            const cart = localStorage.getItem('ramazoneCart');
            return cart ? JSON.parse(cart) : [];
        } catch (e) {
            console.error("Could not parse cart from localStorage", e);
            return [];
        }
    }

    /**
     * Saves the cart to localStorage.
     * @param {Array} cart The cart array to save.
     */
    function saveCart(cart) {
        localStorage.setItem('ramazoneCart', JSON.stringify(cart));
    }

    /**
     * Adds a product to the cart or updates its quantity if it already exists.
     * @param {string} productId The ID of the product to add.
     * @param {number} quantityToAdd The quantity to add. Defaults to 1.
     */
    function addToCart(productId, quantityToAdd = 1) {
        const cart = getCart();
        const existingItemIndex = cart.findIndex(item => item.id === productId);

        if (existingItemIndex > -1) {
            // Item exists, update quantity
            cart[existingItemIndex].quantity += quantityToAdd;
        } else {
            // New item, add to cart
            cart.push({ id: productId, quantity: quantityToAdd });
        }
        
        saveCart(cart);
        showToast(`${currentProductData.name} added to cart!`);
        // Update UI
        updateCartIcon();
        updateStickyActionBar();
    }
    
    /**
     * Updates the quantity of a specific item in the cart.
     * If quantity becomes 0 or less, the item is removed.
     * @param {string} productId The ID of the product to update.
     * @param {number} newQuantity The new quantity for the product.
     */
    function updateCartItemQuantity(productId, newQuantity) {
        let cart = getCart();
        const itemIndex = cart.findIndex(item => item.id === productId);

        if (itemIndex > -1) {
            if (newQuantity > 0) {
                cart[itemIndex].quantity = newQuantity;
            } else {
                // Remove item if quantity is 0 or less
                cart.splice(itemIndex, 1);
                 showToast(`${currentProductData.name} removed from cart.`);
            }
            saveCart(cart);
            // Update UI
            updateCartIcon();
            updateStickyActionBar();
        }
    }

    /**
     * Gets a specific item from the cart by its ID.
     * @param {string} productId The ID of the product to find.
     * @returns {Object|null} The cart item object or null if not found.
     */
    function getCartItem(productId) {
        const cart = getCart();
        return cart.find(item => item.id === productId) || null;
    }
    
    /**
     * Calculates the total number of items in the cart.
     * @returns {number} The total quantity of all items.
     */
    function getTotalCartQuantity() {
        const cart = getCart();
        return cart.reduce((total, item) => total + item.quantity, 0);
    }

    // --- NEW UI UPDATE FUNCTIONS ---
    /**
     * Updates the cart icon counter in the header.
     */
    function updateCartIcon() {
        const totalQuantity = getTotalCartQuantity();
        const cartCountElement = document.getElementById('cart-item-count');
        if (cartCountElement) {
            if (totalQuantity > 0) {
                cartCountElement.textContent = totalQuantity;
                cartCountElement.classList.remove('hidden');
            } else {
                cartCountElement.textContent = '';
                cartCountElement.classList.add('hidden');
            }
        }
    }

    /**
     * Updates the sticky action bar based on whether the current product is in the cart.
     */
    function updateStickyActionBar() {
        if (!currentProductId) return;

        const cartItem = getCartItem(currentProductId);
        const qtyWrapper = document.getElementById('quantity-selector-wrapper');
        const qtyDisplay = document.getElementById('quantity-display');
        const decreaseBtn = document.getElementById('decrease-quantity');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const goToCartBtn = document.getElementById('go-to-cart-btn');
        const orderNowBtn = document.getElementById('order-now-link'); // Fallback button
        const mainActionContainer = document.getElementById('main-action-container');

        if (cartItem) {
            // Item is IN the cart
            qtyDisplay.textContent = cartItem.quantity;
            decreaseBtn.disabled = cartItem.quantity <= 1; // Disable if qty is 1

            qtyWrapper.classList.remove('hidden');
            mainActionContainer.classList.remove('col-start-1', 'col-span-2');
            mainActionContainer.classList.add('col-start-2');

            addToCartBtn.classList.add('hidden');
            orderNowBtn.classList.add('hidden');
            goToCartBtn.classList.remove('hidden');

        } else {
            // Item is NOT in the cart
            qtyWrapper.classList.add('hidden');
            mainActionContainer.classList.add('col-start-1', 'col-span-2');
            mainActionContainer.classList.remove('col-start-2');
            
            addToCartBtn.classList.remove('hidden');
            goToCartBtn.classList.add('hidden');
            orderNowBtn.classList.add('hidden'); // We hide this by default in the new system
        }
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    async function initializeApp() {
        try {
            const response = await fetch('/api/firebase-config');
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const firebaseConfig = await response.json();
            if (firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                loadPageData();
            } else { throw new Error("Firebase config is missing or invalid."); }
        } catch (error) {
            console.error("Initialization or data fetch failed:", error);
            document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">Could not initialize application.</p>';
        }
    }

    async function loadPageData() {
        await fetchAllData(database);
        fetchProductData();
    }
    
    // Using the same fetchAllData as you provided
    async function fetchAllData(db) { /* ... Your existing fetchAllData function ... */
        const dbRef = db.ref('ramazone');
        const snapshot = await dbRef.get();
        if (snapshot.exists()) {
            const data = snapshot.val();
            const config = data.config || {};
            ramazoneDeliveryCharge = config.deliveryCharge || 10;
            appThemeColor = config.themeColor || '#4F46E5';
            applyTheme(appThemeColor);
            const homepageData = data.homepage || {};
            const productsObject = data.products || {};
            const mainProducts = Object.values(productsObject);
            const festiveProductIds = homepageData.festiveCollection?.productIds || [];
            const jfyMainProductId = homepageData.justForYou?.topDeals?.mainProductId;
            const jfySubProductIds = homepageData.justForYou?.topDeals?.subProductIds || [];
            const allReferencedIds = new Set([...festiveProductIds, jfyMainProductId, ...jfySubProductIds].filter(Boolean));
            const referencedProducts = mainProducts.filter(p => allReferencedIds.has(p.id));
            const combinedProducts = [...mainProducts, ...referencedProducts];
            allProductsCache = combinedProducts.filter((p, index, self) => p && p.id && index === self.findIndex((t) => t.id === p.id));
            validCoupons = (homepageData.coupons || []).filter(c => c.status === 'active');
        }
    }

    function fetchProductData() { /* ... Your existing fetchProductData function ... */
        const params = new URLSearchParams(window.location.search);
        let idFromUrl = params.get('id');
        if (idFromUrl) { currentProductId = idFromUrl.trim(); }
        if (!currentProductId) { document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Koi product ID nahi mila.</p>'; return; }
        if (allProductsCache.length === 0) { document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Product catalog load nahi hua. Refresh karke try karein.</p>'; return; }
        const product = allProductsCache.find(p => p.id == currentProductId);
        if (product) {
            currentProductData = product;
            loadProduct(currentProductData);
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('product-content').style.display = 'block';
        } else {
            console.error(`Product with ID "${currentProductId}" not found in cache.`);
            document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Maaf kijiye, yeh product nahi mil saka.</p>';
        }
    }

    function loadProduct(data) {
        // ... (Your existing loadProduct function code here, with one change at the end) ...
        document.title = `${data.name || "Product"} - Ramazone`;
        document.querySelector('meta[property="og:title"]').setAttribute("content", data.name);
        document.querySelector('meta[property="og:image"]').setAttribute("content", data.images?.[0] || "https://i.ibb.co/My6h0gdd/20250706-230221.png");
        document.getElementById("product-title").textContent = data.name;
        updateRecentlyViewed(data.id);
        mediaItems = [];
        if (data.images && Array.isArray(data.images)) mediaItems.push(...data.images.map(src => ({ type: "image", src })));
        if (data.videoUrl) mediaItems.push({ type: "video", src: data.videoUrl, thumbnail: data.images?.[0] });
        renderMediaGallery();
        if (data.rating && data.reviewCount) {
            document.getElementById("rating-section").style.display = "flex";
            renderStars(data.rating, document.getElementById("product-rating-stars"));
            document.getElementById("product-review-count").textContent = `(${data.reviewCount} ratings)`;
        }
        renderAdvancedHighlights(data.specHighlights);
        renderSimpleDescription(data.description);
        renderVariantSelectors(data.variants);
        setupSliderControls();
        
        // MODIFIED: Setup quantity and other controls
        setupActionControls(); // Replaces setupQuantityControls
        setupImageModal();
        setupShareButton();
        setupVariantModal();
        updatePriceDisplay();
        loadHandpickedSimilarProducts(data.similarProductIds);
        loadCategoryBasedProducts(data.category);
        loadOtherProducts(data.category);

        // --- NEW: Final UI updates for cart ---
        updateCartIcon();
        updateStickyActionBar();
    }
    
    // --- MODIFIED & NEW FUNCTIONS for controls ---
    /**
     * Sets up event listeners for all action bar buttons.
     */
    function setupActionControls() {
        document.getElementById('add-to-cart-btn').addEventListener('click', () => {
            addToCart(currentProductId);
        });

        document.getElementById('increase-quantity').addEventListener('click', () => {
            const item = getCartItem(currentProductId);
            if(item) {
                updateCartItemQuantity(currentProductId, item.quantity + 1);
            }
        });

        document.getElementById('decrease-quantity').addEventListener('click', () => {
            const item = getCartItem(currentProductId);
            if(item) {
                updateCartItemQuantity(currentProductId, item.quantity - 1);
            }
        });
    }

    function updatePriceDisplay() {
        // This function no longer needs to update the order link.
        // It only updates the price visuals on the page.
        const basePrice = Number(currentProductData.displayPrice);
        const originalPrice = Number(currentProductData.originalPrice);
        document.getElementById("price-final").textContent = `₹${basePrice.toLocaleString("en-IN")}`;
        const percentageDiscountEl=document.getElementById("price-percentage-discount");
        const originalPriceEl=document.getElementById("price-original");
        const lowestPriceTag=document.getElementById("lowest-price-tag-container");
        if(originalPrice>basePrice){
            percentageDiscountEl.innerHTML=`<i class="fas fa-arrow-down mr-1"></i>${Math.round(100*(originalPrice-basePrice)/originalPrice)}%`;
            originalPriceEl.textContent=`₹${originalPrice.toLocaleString("en-IN")}`;
            percentageDiscountEl.style.display="flex";
            originalPriceEl.style.display="inline";
            lowestPriceTag.style.display="block"
        } else {
            percentageDiscountEl.style.display="none";
            originalPriceEl.style.display="none";
            lowestPriceTag.style.display="none"
        }
    }
    
    // Keep all other existing helper functions (create cards, render media, modals, etc.)
    // ... (Your other functions like renderStars, getYoutubeEmbedUrl, showMedia, setupSliderControls, etc. would go here unchanged)
    function applyTheme(color) { document.documentElement.style.setProperty('--primary-color', color); }
    function renderMediaGallery() { const gallery=document.getElementById("thumbnail-gallery");gallery.innerHTML="",slider.innerHTML="",mediaItems.forEach((item,index)=>{const e=document.createElement("div");e.className="media-item","image"===item.type?e.innerHTML=`<img src="${item.src}" alt="Product image ${index+1}" draggable="false">`:getYoutubeEmbedUrl(item.src)&&(e.innerHTML=`<iframe src="${getYoutubeEmbedUrl(item.src)}" class="w-full h-auto object-cover aspect-square" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`),slider.appendChild(e);const t=document.createElement("div");t.className="aspect-square thumbnail";const l=document.createElement("img");l.src="image"===item.type?item.src:item.thumbnail,t.appendChild(l),"video"===item.type&&((n=document.createElement("div")).className="play-icon",n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="50%" height="50%"><path d="M8 5v14l11-7z"/></svg>',t.appendChild(n));var n;t.addEventListener("click",()=>showMedia(index)),gallery.appendChild(t)}),mediaItems.length>0&&showMedia(0)}
    function renderAdvancedHighlights(specData) { const container=document.getElementById("advanced-highlights-section");if(!specData||!specData.blocks||0===specData.blocks.length)return void(container.style.display="none");let html=`<div class="p-4 sm:p-6 lg:p-8"><h2 class="text-xl font-bold text-gray-900 mb-4">Highlights</h2>`;(specData.specScore||specData.specTag)&&(html+='<div class="flex items-center gap-3 mb-6">',specData.specScore&&(html+=`<div class="spec-score font-bold">${specData.specScore}</div>`),specData.specTag&&(html+=`<div class="spec-tag">${specData.specTag}</div>`),html+="</div>"),html+='<div class="space-y-6">',specData.blocks.forEach(block=>{const subtitleStyle="color: #B8860B; font-weight: 500;";html+=`<div class="flex items-start gap-4">\n                    <div class="flex-shrink-0 w-8 h-8 text-gray-600 pt-1">${block.icon||""}</div>\n                    <div class="flex-grow">\n                        <p class="text-sm text-gray-500">${block.category||""}</p>\n                        <h4 class="text-md font-semibold text-gray-800 mt-1">${block.title||""}</h4>\n                        <p class="text-sm mt-1" style="${subtitleStyle}">${block.subtitle||""}</p>\n                    </div>\n                </div>`}),html+="</div></div>",container.innerHTML=html,container.style.display="block"}
    function renderSimpleDescription(descriptionData) { const container=document.getElementById("product-description"),section=document.getElementById("description-section");if(container.innerHTML="",!descriptionData||0===descriptionData.length)return void(section.style.display="none");let hasContent=!1;descriptionData.forEach(block=>{if(block.title||block.details){let e="<div>";block.title&&(e+=`<h3 class="text-lg font-semibold text-gray-800 mb-2">${block.title}</h3>`),block.details&&(e+=`<p class="text-base text-gray-600 leading-relaxed">${block.details}</p>`),e+="</div>",container.innerHTML+=e,hasContent=!0}}),section.style.display=hasContent?"block":"none"}
    function renderStars(rating, container) { container.innerHTML = ""; const fullStars = Math.floor(rating), halfStar = rating % 1 >= .5, emptyStars = 5 - fullStars - (halfStar ? 1 : 0); for (let i = 0; i < fullStars; i++)container.innerHTML += '<i class="fas fa-star"></i>'; halfStar && (container.innerHTML += '<i class="fas fa-star-half-alt"></i>'); for (let i = 0; i < emptyStars; i++)container.innerHTML += '<i class="far fa-star"></i>' }
    function getYoutubeEmbedUrl(url) { if(!url)return null;let videoId=null;try{const urlObj=new URL(url);if("www.youtube.com"===urlObj.hostname||"youtube.com"===urlObj.hostname)videoId=urlObj.searchParams.get("v");else if("youtu.be"===urlObj.hostname)videoId=urlObj.pathname.slice(1);return videoId?`https://www.youtube.com/embed/${videoId}?controls=1&rel=0&modestbranding=1`:null}catch(e){return console.error("Invalid video URL:",url,e),null}}
    function showMedia(index) { if(!(index<0||index>=mediaItems.length))slider.style.transition="transform 0.3s ease-out",currentMediaIndex=index,currentTranslate=index*-sliderWrapper.offsetWidth,prevTranslate=currentTranslate,setSliderPosition(),document.querySelectorAll(".thumbnail").forEach((t,e)=>t.classList.toggle("active",e===index))}
    function setupSliderControls() { sliderWrapper.addEventListener("touchstart",touchStart,{passive:!0}),sliderWrapper.addEventListener("touchend",touchEnd),sliderWrapper.addEventListener("touchmove",touchMove,{passive:!0}),sliderWrapper.addEventListener("mousedown",touchStart),sliderWrapper.addEventListener("mouseup",touchEnd),sliderWrapper.addEventListener("mouseleave",touchEnd),sliderWrapper.addEventListener("mousemove",touchMove)}
    function touchStart(event) { startPos=getPositionX(event),isDragging=!0,animationID=requestAnimationFrame(animation),slider.style.transition="none"}
    function touchMove(event) { if(isDragging){const e=getPositionX(event);currentTranslate=prevTranslate+e-startPos}}
    function touchEnd(event) { if(isDragging){isDragging=!1,cancelAnimationFrame(animationID);const e=currentTranslate-prevTranslate;e<-50&&currentMediaIndex<mediaItems.length-1&&currentMediaIndex++,e>50&&currentMediaIndex>0&&currentMediaIndex--,showMedia(currentMediaIndex)}}
    function getPositionX(event) { return event.type.includes("mouse")?event.pageX:event.touches[0].clientX}
    function animation() { setSliderPosition(),isDragging&&requestAnimationFrame(animation)}
    function setSliderPosition() { slider.style.transform=`translateX(${currentTranslate}px)`}
    function setupImageModal() { const modal=document.getElementById("image-modal"),modalImg=document.getElementById("modal-image-content"),closeBtn=document.querySelector("#image-modal .close"),prevBtn=document.querySelector("#image-modal .prev"),nextBtn=document.querySelector("#image-modal .next");sliderWrapper.onclick=e=>{if(isDragging||currentTranslate-prevTranslate!=0)return;"image"===mediaItems[currentMediaIndex].type&&(modal.style.display="flex",modalImg.src=mediaItems[currentMediaIndex].src)},closeBtn.onclick=()=>modal.style.display="none";const showModalImage=direction=>{let e=mediaItems.map((e,t)=>({...e,originalIndex:t})).filter(e=>"image"===e.type);if(0!==e.length){const t=e.findIndex(e=>e.originalIndex===currentMediaIndex);let n=(t+direction+e.length)%e.length;const r=e[n];modalImg.src=r.src,showMedia(r.originalIndex)}};prevBtn.onclick=e=>{e.stopPropagation(),showModalImage(-1)},nextBtn.onclick=e=>{e.stopPropagation(),showModalImage(1)}}
    function setupShareButton() { document.getElementById("share-button").addEventListener("click",async()=>{const e=currentProductData.name.replace(/\*/g,"").trim(),t=`*${e}*\nPrice: *₹${Number(currentProductData.displayPrice).toLocaleString("en-IN")}*\n\n✨ Discover more at Ramazone! ✨\n${window.location.href}`;navigator.share?await navigator.share({text:t}):navigator.clipboard.writeText(window.location.href).then(()=>showToast("Link Copied!"))})}
    function showToast(message, type = "info") { const toast=document.getElementById("toast-notification");toast.textContent=message,toast.style.backgroundColor="error"===type?"#ef4444":"#333",toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),2500)}
    function renderVariantSelectors(variants) { const container=document.getElementById("variant-buttons-container"),section=document.getElementById("variant-selection-section");if(container.innerHTML="",selectedVariants={},!variants||!Array.isArray(variants)||0===variants.length)return void(section.style.display="none");section.style.display="block",variants.forEach(variant=>{if(variant&&variant.type&&variant.options){const e=document.createElement("button");e.className="variant-btn w-full p-3 rounded-lg flex justify-between items-center",e.innerHTML=`<span>${variant.type}</span> <i class="fas fa-chevron-down text-xs"></i>`,e.addEventListener("click",()=>openVariantModal(variant)),container.appendChild(e)}})}
    function openVariantModal(variant) { const overlay=document.getElementById("variant-modal-overlay"),titleEl=document.getElementById("variant-modal-title"),bodyEl=document.getElementById("variant-modal-body");titleEl.textContent=`Select ${variant.type}`,bodyEl.innerHTML="",variant.options.forEach(option=>{const e=selectedVariants[variant.type]===option.name,t=document.createElement("div");t.className=`variant-option ${e?"selected":""}`;let n="";n="color"===variant.type.toLowerCase()&&option.value?`<div class="color-swatch" style="background-color: ${option.value};"></div> <span class="flex-grow">${option.name}</span>`:`<span>${option.name}</span>`,t.innerHTML=n,t.addEventListener("click",()=>{selectedVariants[variant.type]=option.name,updateVariantButtonDisplay(variant.type,option.name),closeVariantModal()}),bodyEl.appendChild(t)}),overlay.classList.remove("hidden"),setTimeout(()=>overlay.classList.add("active"),10)}
    function closeVariantModal() { const overlay=document.getElementById("variant-modal-overlay");overlay.classList.remove("active"),setTimeout(()=>overlay.classList.add("hidden"),300)}
    function updateVariantButtonDisplay(type, value) { document.getElementById("variant-buttons-container").querySelectorAll("button").forEach(e=>{e.textContent.includes(type)&&(e.innerHTML=`<span>${type}: <span class="value">${value}</span></span> <i class="fas fa-chevron-down text-xs"></i>`)})}
    function setupVariantModal() { const overlay=document.getElementById("variant-modal-overlay");document.getElementById("variant-modal-close").addEventListener("click",closeVariantModal),overlay.addEventListener("click",e=>{e.target===overlay&&closeVariantModal()})}
    function updateRecentlyViewed(newId) { let viewedIds=JSON.parse(sessionStorage.getItem("ramazoneRecentlyViewed"))||[];viewedIds=viewedIds.filter(e=>e!==newId),viewedIds.unshift(newId),viewedIds=viewedIds.slice(0,10),sessionStorage.setItem("ramazoneRecentlyViewed",JSON.stringify(viewedIds)),loadRecentlyViewed(viewedIds)}
    function loadRecentlyViewed(viewedIds) { const container=document.getElementById("recently-viewed-container"),section=document.getElementById("recently-viewed-section");if(container&&section&&(container.innerHTML="",viewedIds&&viewedIds.length>1)){let t=0;viewedIds.filter(e=>e!=currentProductId).forEach(e=>{const n=allProductsCache.find(t=>t.id==e);n&&(container.innerHTML+=createCarouselCard(n),t++)}),t>0?section.style.display="block":section.style.display="none"}else section.style.display="none"}
    function createHandpickedCard(product) { const ratingTag = product.rating ? `<div class="absolute top-1 right-1 bg-green-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-1">${product.rating}<i class="fas fa-star text-[8px]"></i></div>` : ""; const originalPriceNum = Number(product.originalPrice); const displayPriceNum = Number(product.displayPrice); const discount = originalPriceNum && originalPriceNum > displayPriceNum ? Math.round(100 * ((originalPriceNum - displayPriceNum) / originalPriceNum)) : 0; const offerBadge = product.offerText ? `<div class="absolute bottom-2 left-2 text-[10px] font-bold px-2 py-1 rounded" style="background-color: ${product.offerBackgroundColor || '#FF3D3D'}; color: ${product.offerTextColor || '#FFFFFF'};">${product.offerText}</div>` : ""; return ` <a href="?id=${product.id}" class="block bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"> <div class="relative"> <img src="${product.images?.[0] || 'https://i.ibb.co/My6h0gdd/20250706-230221.png'}" class="w-full object-cover aspect-square" alt="${product.name}"> ${ratingTag} ${offerBadge} </div> <div class="p-2"> <h4 class="text-xs font-semibold truncate text-gray-800 mb-1">${product.name}</h4> <div class="flex items-baseline gap-1"> <p class="text-sm font-bold" style="color: var(--primary-color)">₹${displayPriceNum.toLocaleString("en-IN")}</p> ${originalPriceNum > displayPriceNum ? `<p class="text-[10px] text-gray-400 line-through">₹${originalPriceNum.toLocaleString("en-IN")}</p>` : ""} </div> ${discount > 0 ? `<p class="text-[10px] font-semibold text-green-600 mt-0.5">${discount}% OFF</p>` : ""} </div> </a>`; }
    function createCarouselCard(product) { const ratingTag = product.rating ? `<div class="card-rating-tag">${product.rating} <i class="fas fa-star"></i></div>` : ""; const originalPriceNum = Number(product.originalPrice); const displayPriceNum = Number(product.displayPrice); const discount = originalPriceNum && originalPriceNum > displayPriceNum ? Math.round(100 * ((originalPriceNum - displayPriceNum) / originalPriceNum)) : 0; const offerBadge = product.offerText ? `<div class="absolute bottom-2 left-2 text-[10px] font-bold px-2 py-1 rounded" style="background-color: ${product.offerBackgroundColor || '#FF3D3D'}; color: ${product.offerTextColor || '#FFFFFF'};">${product.offerText}</div>` : ""; return ` <a href="?id=${product.id}" class="carousel-item block bg-white rounded-lg shadow overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"> <div class="relative"> <img src="${product.images?.[0] || 'https://i.ibb.co/My6h0gdd/20250706-230221.png'}" class="w-full object-cover aspect-square" alt="${product.name}"> ${ratingTag} ${offerBadge} </div> <div class="p-2"> <h4 class="text-sm font-semibold truncate text-gray-800 mb-1">${product.name}</h4> <div class="flex items-baseline gap-2"> <p class="text-base font-bold" style="color: var(--primary-color)">₹${displayPriceNum.toLocaleString("en-IN")}</p> ${originalPriceNum > displayPriceNum ? `<p class="text-xs text-gray-400 line-through">₹${originalPriceNum.toLocaleString("en-IN")}</p>` : ""} </div> ${discount > 0 ? `<p class="text-xs font-semibold text-green-600 mt-1">${discount}% OFF</p>` : ""} </div> </a>`; }
    function createGridCard(product) { const ratingTag = product.rating ? `<div class="card-rating-tag">${product.rating} <i class="fas fa-star"></i></div>` : ""; const originalPriceNum = Number(product.originalPrice); const displayPriceNum = Number(product.displayPrice); const discount = originalPriceNum && originalPriceNum > displayPriceNum ? Math.round(100 * ((originalPriceNum - displayPriceNum) / originalPriceNum)) : 0; const offerBadge = product.offerText ? `<div class="absolute bottom-2 left-2 text-xs font-bold px-2 py-1 rounded" style="background-color: ${product.offerBackgroundColor || '#FF3D3D'}; color: ${product.offerTextColor || '#FFFFFF'};">${product.offerText}</div>` : ""; return ` <a href="?id=${product.id}" class="block bg-white rounded-lg shadow overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"> <div class="relative"> <img src="${product.images?.[0] || 'https://i.ibb.co/My6h0gdd/20250706-230221.png'}" class="w-full h-auto object-cover aspect-square" alt="${product.name}"> ${ratingTag} ${offerBadge} </div> <div class="p-2 sm:p-3"> <h4 class="text-sm font-semibold truncate text-gray-800 mb-1">${product.name}</h4> <div class="flex items-baseline gap-2"> <p class="text-base font-bold" style="color: var(--primary-color)">₹${displayPriceNum.toLocaleString("en-IN")}</p> ${originalPriceNum > displayPriceNum ? `<p class="text-xs text-gray-400 line-through">₹${originalPriceNum.toLocaleString("en-IN")}</p>` : ""} </div> ${discount > 0 ? `<p class="text-sm font-semibold text-green-600 mt-1">${discount}% OFF</p>` : ""} </div> </a>`; }
    function loadHandpickedSimilarProducts(similarIds) { const section = document.getElementById("handpicked-similar-section"); const container = document.getElementById("handpicked-similar-container"); if (!similarIds || similarIds.length === 0) { section.style.display = "none"; return; } container.innerHTML = ""; let cardCount = 0; similarIds.forEach(id => { const product = allProductsCache.find(p => p && p.id === id); if (product) { container.innerHTML += createHandpickedCard(product); cardCount++; } }); section.style.display = cardCount > 0 ? "block" : "none"; }
    function loadCategoryBasedProducts(category) { const section = document.getElementById("similar-products-section"); const container = document.getElementById("similar-products-container"); if (!category || !allProductsCache) { section.style.display = "none"; return; } container.innerHTML = ""; let cardCount = 0; allProductsCache.forEach(product => { if (product && product.category === category && product.id != currentProductId) { container.innerHTML += createCarouselCard(product); cardCount++; } }); section.style.display = cardCount > 0 ? "block" : "none"; }
    function loadOtherProducts(currentCategory) { const otherProducts = allProductsCache.filter(p => p.category !== currentCategory && p.id != currentProductId).map(p => ({ score: 5 * (p.rating || 0) + .5 * (Number(p.originalPrice) > Number(p.displayPrice) ? 100 * (Number(p.originalPrice) - Number(p.displayPrice)) / Number(p.originalPrice) : 0), ...p })).sort((a, b) => b.score - a.score).slice(0, 20), container = document.getElementById("other-products-container"); container.innerHTML = "", otherProducts.length > 0 && (otherProducts.forEach(e => { container.innerHTML += createGridCard(e) }), document.getElementById("other-products-section").style.display = "block") }

    </script>
</body>
</html>
