<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Product Details - Ramazone</title>
    <meta property="og:title" content="Ramazone">
    <meta property="og:image" content="https://i.ibb.co/My6h0gdd/20250706-230221.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #4F46E5; }
        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body { font-family: 'Inter', sans-serif; background-color: #fff; }

        /* Main Layout */
        #product-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }
        #main-media-container {
            flex-grow: 1;
            position: relative;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #main-media-container img, #main-media-container iframe {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed to contain to show full image */
        }
        #product-details-sheet {
            flex-shrink: 0;
            background-color: #ffffff;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }

        /* Thumbnails */
        #thumbnail-gallery {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 0.5rem;
        }
        #thumbnail-gallery::-webkit-scrollbar { display: none; }
        .thumbnail { 
            cursor: pointer; 
            border: 2px solid #e5e7eb; 
            transition: border-color 0.3s; 
            border-radius: 0.75rem; 
            position: relative;
            flex-shrink: 0; 
            width: 64px; 
            height: 64px;
            overflow: hidden;
        }
        .thumbnail.active { border-color: var(--primary-color); }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .thumbnail .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background-color: rgba(0,0,0,0.6); border-radius: 50%; display: flex; justify-content: center; align-items: center; pointer-events: none; }

        /* Full Screen Viewer */
        #fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 1000;
            display: none; /* Initially hidden */
            flex-direction: column;
            color: white;
            overscroll-behavior: contain;
        }
        #fullscreen-viewer.active { display: flex; }
        .fullscreen-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        .fullscreen-slider-wrapper {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .fullscreen-slider {
            display: flex;
            height: 100%;
            will-change: transform;
        }
        .fullscreen-slider.transitioning {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fullscreen-slide {
            width: 100vw;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fullscreen-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .fullscreen-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .fullscreen-dots .dot {
            width: 8px;
            height: 8px;
            background-color: rgba(255,255,255,0.5);
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        .fullscreen-dots .dot.active { background-color: white; }

        /* Buttons */
        .whatsapp-btn { background-color: #25D366; transition: background-color 0.3s, transform 0.3s; }
        .whatsapp-btn:hover { background-color: #1DAA50; transform: scale(1.05); }
        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 2000; transition: bottom 0.5s ease-in-out; }
        #toast-notification.show { bottom: 30px; }
    </style>
</head>
<body>
    <div id="product-container" style="display: none;">
        <div id="main-media-container">
            <img id="main-product-image" src="" alt="Main Product Image">
            <iframe id="main-product-video" class="hidden" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
            <div id="swipe-overlay" class="absolute inset-0 z-10 hidden"></div>
        </div>

        <div id="product-details-sheet">
            <div id="thumbnail-gallery" class="mb-4"></div>
            
            <div class="flex justify-between items-start mb-2">
                <h1 id="product-title" class="text-xl sm:text-2xl font-bold text-gray-900 leading-tight"></h1>
                <button id="share-button" title="Share Product" class="flex-shrink-0 bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200 transition">
                    <img src="https://www.svgrepo.com/show/527876/share.svg" class="w-5 h-5" alt="Share Icon">
                </button>
            </div>

            <div class="flex items-center flex-wrap gap-x-4 gap-y-2 my-3">
                <span id="product-price" class="text-2xl lg:text-3xl font-extrabold text-indigo-600"></span>
                <div id="product-discount-container" class="flex items-baseline gap-2">
                    <span id="product-original-price" class="text-lg line-through text-gray-400" style="display: none;"></span>
                    <span id="product-discount" class="text-sm font-semibold text-green-600 bg-green-100 px-2 py-0.5 rounded-md" style="display: none;"></span>
                </div>
            </div>

            <div id="description-section" class="mt-4 mb-5 border-t border-gray-200 pt-4" style="display: none;">
                <h2 class="text-md font-bold text-gray-900 mb-2">Product Details</h2>
                <div id="product-description" class="prose prose-sm max-w-none text-gray-600"></div>
            </div>

            <a id="whatsapp-order-link" href="#" target="_blank" class="whatsapp-btn w-full flex items-center justify-center text-white font-bold py-3.5 px-6 rounded-xl text-lg shadow-lg">
                <img src="https://www.svgrepo.com/show/452133/whatsapp.svg" class="w-7 h-7 mr-3" alt="WhatsApp">
                Order on WhatsApp
            </a>
        </div>
    </div>

    <div id="loading-indicator" class="flex items-center justify-center h-screen"><p class="text-lg font-semibold">Product load ho raha hai...</p></div>

    <div id="fullscreen-viewer">
        <div class="fullscreen-header">
             <button id="fullscreen-close-btn" class="text-white text-2xl font-bold">✕</button>
             <div id="fullscreen-counter" class="text-sm"></div>
        </div>
        <div class="fullscreen-slider-wrapper">
            <div class="fullscreen-slider"></div>
        </div>
        <div class="fullscreen-dots"></div>
    </div>

    <div id="toast-notification">Link Copied!</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Global state variables
        let mediaItems = [], imageItems = [];
        let currentMediaIndex = 0;
        let currentProductData = null, currentProductId = null;
        
        // Swipe functionality variables
        let touchstartX = 0, touchendX = 0;
        let isSwiping = false, currentTranslate = 0, startPos = 0, prevTranslate = 0;
        let animationID;
        let currentFullScreenIndex = 0;

        // DOM Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const productContainer = document.getElementById('product-container');

        // --- Initialization ---
        async function fetchFirebaseConfig() {
            try {
                const response = await fetch('/api/firebase-config');
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch Firebase config:', error);
                loadingIndicator.innerHTML = '<p class="text-red-500">Failed to load application configuration.</p>';
                return null;
            }
        }

        async function initializeAppAndLoadProduct() {
            const firebaseConfig = await fetchFirebaseConfig();
            if (!firebaseConfig) return;
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                fetchProductData(database);
            } catch (error) {
                console.error("Initialization or data fetch failed:", error);
                loadingIndicator.innerHTML = '<p class="text-red-500">Failed to load product data.</p>';
            }
        }

        function fetchProductData(database) {
            const productId = new URLSearchParams(window.location.search).get('id');
            currentProductId = productId;
            if (!productId) {
                loadingIndicator.innerHTML = '<p class="text-center text-red-500 font-bold">No product ID found.</p>';
                return;
            }
            
            const productRef = database.ref(`ramazone/homepage/festiveCollection/products/${productId}`);
            productRef.get().then((snapshot) => {
                if (snapshot.exists()) {
                    currentProductData = snapshot.val();
                    loadProduct(currentProductData);
                    loadingIndicator.style.display = 'none';
                    productContainer.style.display = 'flex';
                } else {
                    loadingIndicator.innerHTML = '<p class="text-center text-red-500 font-bold">Sorry, this product could not be found.</p>';
                }
            });
        }

        function loadProduct(data) {
            mediaItems = [];
            if (data.images) mediaItems.push(...data.images.map(src => ({ type: 'image', src })));
            if (data.videoUrl) mediaItems.push({ type: 'video', src: data.videoUrl, thumbnail: (data.images && data.images[0]) || 'https://i.ibb.co/My6h0gdd/20250706-230221.png' });
            
            imageItems = mediaItems.filter(item => item.type === 'image');

            const firstImage = imageItems.length > 0 ? imageItems[0].src : 'https://i.ibb.co/My6h0gdd/20250706-230221.png';
            document.title = `${data.name || 'Product'} - Ramazone`;
            document.querySelector('meta[property="og:title"]').setAttribute('content', data.name);
            document.querySelector('meta[property="og:image"]').setAttribute('content', firstImage);

            document.getElementById('product-title').textContent = data.name;
            document.getElementById('product-price').textContent = `₹${Number(data.displayPrice).toLocaleString('en-IN')}`;
            
            if (data.originalPrice && Number(data.originalPrice) > Number(data.displayPrice)) {
                const originalPriceEl = document.getElementById('product-original-price');
                const discountEl = document.getElementById('product-discount');
                originalPriceEl.textContent = `₹${Number(data.originalPrice).toLocaleString('en-IN')}`;
                originalPriceEl.style.display = 'inline';
                const discount = Math.round(((data.originalPrice - data.displayPrice) / data.originalPrice) * 100);
                discountEl.textContent = `${discount}% OFF`;
                discountEl.style.display = 'inline-block';
            }

            if (data.description) {
                document.getElementById('description-section').style.display = 'block';
                document.getElementById('product-description').innerHTML = data.description;
            }
            
            updateWhatsAppLink();
            renderThumbnails();
            showMedia(0);
            setupEventHandlers();
        }

        // --- Rendering ---
        function renderThumbnails() {
            const gallery = document.getElementById('thumbnail-gallery');
            gallery.innerHTML = '';
            mediaItems.forEach((item, index) => {
                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'thumbnail';
                const img = document.createElement('img');
                img.src = item.type === 'image' ? item.src : item.thumbnail;
                thumbWrapper.appendChild(img);
                if (item.type === 'video') {
                    const playIcon = document.createElement('div');
                    playIcon.className = 'play-icon';
                    playIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="100%" height="100%"><path d="M8 5v14l11-7z"/></svg>`;
                    thumbWrapper.appendChild(playIcon);
                }
                thumbWrapper.onclick = () => showMedia(index);
                gallery.appendChild(thumbWrapper);
            });
        }

        function showMedia(index) {
            if (index >= mediaItems.length) index = 0;
            if (index < 0) index = mediaItems.length - 1;
            currentMediaIndex = index;
            
            const item = mediaItems[index];
            const mainImage = document.getElementById('main-product-image');
            const mainVideo = document.getElementById('main-product-video');
            const swipeOverlay = document.getElementById('swipe-overlay');

            if (item.type === 'image') {
                mainVideo.classList.add('hidden');
                if (mainVideo.src) mainVideo.src = '';
                mainImage.classList.remove('hidden');
                mainImage.src = item.src;
                swipeOverlay.classList.add('hidden');
            } else if (item.type === 'video') {
                mainImage.classList.add('hidden');
                mainVideo.classList.remove('hidden');
                const embedUrl = getYoutubeEmbedUrl(item.src);
                if (embedUrl) {
                    mainVideo.src = embedUrl;
                    swipeOverlay.classList.remove('hidden');
                } else {
                    showMedia(0);
                }
            }
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => thumb.classList.toggle('active', i === index));
        }

        // --- Event Handlers & Logic ---
        function setupEventHandlers() {
            document.getElementById('share-button').onclick = shareProduct;
            document.getElementById('main-media-container').onclick = () => {
                if (mediaItems[currentMediaIndex].type === 'image') {
                    const imageIndex = imageItems.findIndex(item => item.src === mediaItems[currentMediaIndex].src);
                    openFullScreenViewer(imageIndex);
                }
            };
            setupMainSwipeControls();
            setupFullScreenViewer();
        }

        function updateWhatsAppLink() {
            const sellerPhoneNumber = '917903698180';
            const finalPrice = currentProductData.displayPrice;
            const whatsappMessage = `🛍️ *Ramazone Store Order* 🛍️\n\nHello! I'm interested in this product:\n\n*Product:* *${currentProductData.name}*\n*Price:* ₹${Number(finalPrice).toLocaleString('en-IN')}\n*Product Link:* ${window.location.href}\n\nPlease let me know if it's available.`;
            document.getElementById('whatsapp-order-link').href = `https://wa.me/${sellerPhoneNumber}?text=${encodeURIComponent(whatsappMessage)}`;
        }

        async function shareProduct() {
            const finalPrice = currentProductData.displayPrice;
            const shareText = `*${currentProductData.name}*\nPrice: *₹${Number(finalPrice).toLocaleString('en-IN')}*\n\n✨ Discover more at Ramazone! ✨\n${window.location.href}`;
            if (navigator.share) {
                await navigator.share({ text: shareText });
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => showToast("Link Copied!"));
            }
        }

        function setupMainSwipeControls() {
            const swipeArea = document.getElementById('main-media-container');
            swipeArea.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
            swipeArea.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                const swipeThreshold = 50;
                if (touchendX < touchstartX - swipeThreshold) showMedia(currentMediaIndex + 1);
                if (touchendX > touchstartX + swipeThreshold) showMedia(currentMediaIndex - 1);
            });
        }

        // --- Full Screen Viewer ---
        function setupFullScreenViewer() {
            const viewer = document.getElementById('fullscreen-viewer');
            const slider = viewer.querySelector('.fullscreen-slider');
            document.getElementById('fullscreen-close-btn').onclick = closeFullScreenViewer;
            
            slider.addEventListener('touchstart', touchStart);
            slider.addEventListener('touchend', touchEnd);
            slider.addEventListener('touchmove', touchMove);
        }

        function openFullScreenViewer(startIndex) {
            const viewer = document.getElementById('fullscreen-viewer');
            const slider = viewer.querySelector('.fullscreen-slider');
            const dotsContainer = viewer.querySelector('.fullscreen-dots');
            
            slider.innerHTML = imageItems.map(item => `<div class="fullscreen-slide"><img src="${item.src}" alt="Product image"></div>`).join('');
            dotsContainer.innerHTML = imageItems.map(() => `<div class="dot"></div>`).join('');

            currentFullScreenIndex = startIndex;
            updateFullScreenSlider();
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullScreenViewer() {
            const viewer = document.getElementById('fullscreen-viewer');
            viewer.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function updateFullScreenSlider() {
            const slider = document.getElementById('fullscreen-slider');
            const counter = document.getElementById('fullscreen-counter');
            const dots = document.querySelectorAll('#fullscreen-viewer .dot');

            slider.style.transform = `translateX(-${currentFullScreenIndex * 100}vw)`;
            counter.textContent = `${currentFullScreenIndex + 1} / ${imageItems.length}`;
            dots.forEach((dot, index) => dot.classList.toggle('active', index === currentFullScreenIndex));
        }

        function touchStart(event) {
            isSwiping = true;
            startPos = event.touches[0].clientX;
            const slider = event.currentTarget;
            slider.classList.remove('transitioning');
        }

        function touchMove(event) {
            if (!isSwiping) return;
            const currentPosition = event.touches[0].clientX;
            currentTranslate = prevTranslate + currentPosition - startPos;
        }

        function touchEnd(event) {
            if (!isSwiping) return;
            isSwiping = false;
            const slider = event.currentTarget;
            const movedBy = currentTranslate - prevTranslate;

            if (movedBy < -100 && currentFullScreenIndex < imageItems.length - 1) {
                currentFullScreenIndex += 1;
            }
            if (movedBy > 100 && currentFullScreenIndex > 0) {
                currentFullScreenIndex -= 1;
            }

            slider.classList.add('transitioning');
            slider.style.transform = `translateX(-${currentFullScreenIndex * 100}vw)`;
            prevTranslate = -currentFullScreenIndex * window.innerWidth;
            updateFullScreenSlider();
        }

        // --- Utilities ---
        function getYoutubeEmbedUrl(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}?autoplay=1&controls=1&rel=0&modestbranding=1` : null;
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initializeAppAndLoadProduct);
    </script>
</body>
</html>

