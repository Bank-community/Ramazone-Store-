<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Product Details - Ramazone</title>
    <meta property="og:title" content="Ramazone">
    <meta property="og:image" content="https://i.ibb.co/My6h0gdd/20250706-230221.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4F46E5; /* Default purple color, will be overridden by Firebase */
            --green-color: #16a34a;
            --whatsapp-color: #128C7E; /* Darker WhatsApp Green */
        }
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; }
        
        /* --- Enhanced Slider Styles --- */
        #main-media-wrapper { overflow: hidden; touch-action: pan-y; }
        #media-slider { display: flex; transition: transform 0.3s ease-out; } /* Faster, smoother transition */
        .media-item { flex: 0 0 100%; min-width: 100%; position: relative; }
        .media-item img, .media-item iframe { width: 100%; height: 100%; object-fit: cover; aspect-ratio: 1 / 1; }
        
        .whatsapp-btn { background-color: var(--whatsapp-color); transition: background-color 0.3s, transform 0.3s; }
        .whatsapp-btn:hover { background-color: #075E54; transform: scale(1.05); }
        
        #thumbnail-gallery { display: flex; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        #thumbnail-gallery::-webkit-scrollbar { display: none; }
        .thumbnail { cursor: pointer; border: 2px solid transparent; transition: border-color 0.3s; border-radius: 0.5rem; position: relative; flex-shrink: 0; width: 64px; }
        .thumbnail.active { border-color: var(--primary-color); }
        .thumbnail .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40%; height: 40%; background-color: rgba(0,0,0,0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; pointer-events: none; opacity: 0.8; }
        
        #image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); justify-content: center; align-items: center; }
        #image-modal img { max-width: 90%; max-height: 85%; object-fit: contain; }
        #image-modal .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        .modal-nav { cursor: pointer; position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -50px; color: white; font-weight: bold; font-size: 30px; transition: 0.6s ease; user-select: none; }
        .modal-nav.prev { left: 0; border-radius: 0 3px 3px 0; }
        .modal-nav.next { right: 0; border-radius: 3px 0 0 3px; }
        .modal-nav:hover { background-color: rgba(0, 0, 0, 0.8); }

        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 2000; transition: bottom 0.5s ease-in-out; }
        #toast-notification.show { bottom: 30px; }

        .quantity-selector button { background-color: #e5e7eb; border: 1px solid #d1d5db; color: #374151; font-weight: bold; width: 44px; height: 44px; transition: background-color 0.2s; }
        .quantity-selector button:hover { background-color: #d1d5db; }
        .quantity-selector button:disabled { opacity: 0.5; cursor: not-allowed; }
        .quantity-selector span { font-size: 1.1rem; font-weight: 600; min-width: 60px; }
        
        .rating-stars { color: #f59e0b; }
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none; }
        .carousel-container::-webkit-scrollbar { display: none; }
        .carousel-item { scroll-snap-align: start; flex: 0 0 160px; margin-right: 1rem; position: relative;}
        
        .desc-block { margin-bottom: 1.25rem; }
        .desc-block-title { font-weight: 700; font-size: 1rem; color: #111827; margin-bottom: 0.25rem; }
        .desc-block-details { color: #4b5563; margin-bottom: 0.5rem; }
        .desc-block-highlights { list-style-type: disc; padding-left: 1.25rem; color: #374151; }
        .desc-block-highlights li { margin-bottom: 0.25rem; font-weight: 600; }

        .delivery-option { display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease; }
        .delivery-option.selected { border-color: var(--primary-color); background-color: #eef2ff; }
        .delivery-option input[type="radio"] { display: none; }
        .delivery-option .icon { font-size: 1.5rem; margin-right: 0.75rem; color: #6b7280; }
        .delivery-option.selected .icon { color: var(--primary-color); }

        .card-rating-tag { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(34, 197, 94, 0.9); color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.2rem; }
        .card-rating-tag .fa-star { font-size: 0.65rem; }
        
        .lowest-price-tag { background-color: var(--green-color); color: white; padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 600; border-radius: 0.375rem; display: inline-block; margin-bottom: 0.75rem; }
        
        #coupon-btn { border-color: var(--primary-color); color: var(--primary-color); }
        #coupon-btn:hover { background-color: var(--primary-color); color: white; }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-3 flex items-center justify-between">
                <a href="./products.html" class="text-gray-600 hover:text-gray-900"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></a>
                <a href="./index.html"><img src="https://i.ibb.co/My6h0gdd/20250706-230221.png" alt="Ramazone Logo" style="max-height: 35px; border-radius: 0;"></a>
                <div class="w-6"></div>
            </div>
        </div>
    </header>

    <main id="product-content" class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-0 sm:mt-6 mb-12 pb-28" style="display: none;">
        <div class="bg-white sm:rounded-2xl sm:shadow-lg overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2">
                <div class="p-0 sm:p-4 lg:p-6">
                    <div id="main-media-wrapper" class="rounded-none sm:rounded-xl mb-4 cursor-pointer overflow-hidden relative">
                        <div id="media-slider"></div>
                    </div>
                    <div class="relative px-4 sm:px-0">
                        <div class="grid grid-cols-5 gap-2 sm:gap-4" id="thumbnail-gallery"></div>
                    </div>
                </div>

                <div class="flex flex-col p-4 sm:p-6 lg:p-8">
                    <div class="flex justify-between items-start mb-2">
                        <h1 id="product-title" class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight"></h1>
                        <button id="share-button" title="Share Product" class="flex-shrink-0 bg-gray-100 rounded-full w-11 h-11 flex items-center justify-center hover:bg-gray-200 transition"><img src="https://www.svgrepo.com/show/527876/share.svg" class="w-6 h-6" alt="Share Icon"></button>
                    </div>

                    <div id="rating-section" class="flex items-center gap-2 text-sm text-gray-500 mb-2" style="display: none;">
                        <div id="product-rating-stars" class="rating-stars"></div>
                        <span id="product-review-count"></span>
                    </div>
                    
                    <div class="space-y-3 border-t border-b border-gray-200 py-3 my-3">
                        <div id="new-price-section">
                             <div id="lowest-price-tag-container" style="display: none;">
                                <div class="lowest-price-tag">Lowest Price since Launch</div>
                            </div>
                            <div class="flex items-center gap-3 mb-2">
                                <span id="price-percentage-discount" class="text-2xl font-bold text-green-600 flex items-center"></span>
                                <span id="price-original" class="text-xl text-gray-400 line-through"></span>
                                <span id="price-final" class="text-3xl font-extrabold text-gray-900"></span>
                            </div>
                             <div class="space-y-1 text-sm">
                                <div id="price-coupon-row" class="flex justify-between items-baseline" style="display: none;">
                                    <span class="text-gray-600">Coupon Discount</span>
                                    <span id="price-coupon-discount" class="font-medium text-gray-800"></span>
                                </div>
                                <div class="flex justify-between items-baseline">
                                    <span class="text-gray-600">Delivery Charges</span>
                                    <span id="price-delivery-charge" class="font-medium text-gray-800"></span>
                                </div>
                            </div>
                        </div>

                        <div id="delivery-options" class="space-y-3 pt-2">
                            <h3 class="text-md font-semibold text-gray-800">Choose Delivery Option</h3>
                            <label class="delivery-option"><input type="radio" name="delivery" value="Self" checked><i class="fas fa-walking icon"></i><div><p class="font-semibold text-gray-800">Self Delivery</p><p class="text-xs text-gray-500">No extra charges.</p></div></label>
                            <label class="delivery-option"><input type="radio" name="delivery" value="Ramazone"><i class="fas fa-truck-fast icon"></i><div><p id="ramazone-delivery-label" class="font-semibold text-gray-800">Ramazone Delivery</p><p class="text-xs text-gray-500">Fast and secure delivery.</p></div></label>
                        </div>
                    </div>
                    
                    <div id="description-section" class="mb-6" style="display: none;"><h2 class="text-lg font-bold text-gray-900 mb-2">Product Details</h2><div id="product-description" class="space-y-4"></div></div>

                    <div class="mt-auto pt-6">
                         <div class="flex items-center justify-between"><label class="block text-sm font-medium text-gray-700">Quantity</label><div class="quantity-selector inline-flex items-center justify-center bg-white rounded-lg"><button id="decrease-quantity" class="rounded-l-lg">-</button><span id="quantity-display" class="text-center px-4 py-2 border-t border-b border-gray-300">1</span><button id="increase-quantity" class="rounded-r-lg">+</button></div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="recently-viewed-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">Recently Viewed</h2><div id="recently-viewed-container" class="carousel-container pb-4"></div></div>
        <div id="similar-products-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">Similar Products</h2><div id="similar-products-container" class="carousel-container pb-4"></div></div>
        <div id="other-products-section" class="max-w-7xl mx-auto px-4 sm:px-0 mt-12" style="display: none;"><h2 class="text-2xl font-bold text-gray-800 mb-4">Other Products</h2><div id="other-products-container" class="grid grid-cols-2 gap-3 sm:gap-4"></div></div>
    </main>
    <div id="loading-indicator" class="text-center py-20"><p class="text-lg font-semibold">Product load ho raha hai...</p></div>

    <div id="image-modal"><span class="close">&times;</span><a class="modal-nav prev">&#10094;</a><img id="modal-image-content"><a class="modal-nav next">&#10095;</a></div>
    <div id="toast-notification"></div>

    <div id="sticky-action-bar" class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] p-3 z-40 border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-2 gap-3">
                <button id="coupon-btn" class="w-full flex items-center justify-center font-bold py-3 px-4 rounded-xl text-lg shadow-sm bg-white border-2 hover:text-white transition-all duration-300">
                    <i class="fas fa-ticket-alt mr-2"></i> Coupon
                </button>
                <a id="whatsapp-order-link" href="#" target="_blank" class="whatsapp-btn w-full flex items-center justify-center text-white font-bold py-3 px-4 rounded-xl text-lg shadow-lg">
                    <!-- Adjusted WhatsApp Icon -->
                    <i class="fab fa-whatsapp text-2xl mr-2"></i> Order Now
                </a>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCXrwTUdy5B5mxEMsmAOX_3ZVKxiWht7Vw",
            authDomain: "re-store-8e5b3.firebaseapp.com",
            databaseURL: "https://re-store-8e5b3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "re-store-8e5b3",
            storageBucket: "re-store-8e5b3.appspot.com",
            messagingSenderId: "747691299697",
            appId: "1:747691299697:web:20dda42f47c7b39d495cd0"
        };
        
        let mediaItems = [], currentMediaIndex = 0, productQuantity = 1, currentProductData = null, currentProductId = null;
        let allProductsCache = [], validCoupons = [], appliedCoupon = null;
        let selectedDeliveryType = 'Self';
        let ramazoneDeliveryCharge = 10;
        let appThemeColor = '#4F46E5';

        const slider = document.getElementById('media-slider');
        const sliderWrapper = document.getElementById('main-media-wrapper');
        let isDragging = false, startPos = 0, currentTranslate = 0, prevTranslate = 0, animationID;

        async function initializeAppAndLoadProduct() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                await fetchAllData(database);
                fetchProductData();
            } catch (error) { 
                console.error("Initialization ya data fetch fail ho gaya:", error); 
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">Product data load nahi ho saka.</p>'; 
            }
        }
        
        async function fetchAllData(database) {
            const dbRef = database.ref('ramazone');
            const snapshot = await dbRef.get();
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                const config = data.config || {};
                ramazoneDeliveryCharge = config.deliveryCharge || 10;
                appThemeColor = config.themeColor || '#4F46E5';
                applyTheme(appThemeColor);

                const homepageData = data.homepage || {};
                const mainProducts = data.products || [];
                const festiveProductIds = homepageData.festiveCollection?.productIds || [];
                const jfyMainProductId = homepageData.justForYou?.topDeals?.mainProductId;
                const jfySubProductIds = homepageData.justForYou?.topDeals?.subProductIds || [];
                const allReferencedIds = new Set([...festiveProductIds, jfyMainProductId, ...jfySubProductIds].filter(Boolean));
                const referencedProducts = mainProducts.filter(p => allReferencedIds.has(p.id));
                const combinedProducts = [...mainProducts, ...referencedProducts];
                allProductsCache = combinedProducts.filter((p, index, self) => p && p.id && index === self.findIndex((t) => t.id === p.id));
                validCoupons = (homepageData.coupons || []).filter(c => c.status === 'active');
            }
        }

        function applyTheme(color) {
            document.documentElement.style.setProperty('--primary-color', color);
        }

        function fetchProductData() {
            const params = new URLSearchParams(window.location.search);
            currentProductId = params.get('id');
            if (!currentProductId) { document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Koi product ID nahi mila.</p>'; return; }
            if (allProductsCache.length === 0) { document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Product catalog load nahi hua. Refresh karke try karein.</p>'; return; }
            const product = allProductsCache.find(p => p.id == currentProductId);
            if (product) {
                currentProductData = product;
                loadProduct(currentProductData);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('product-content').style.display = 'block';
                updateRecentlyViewed(currentProductId);
            } else { 
                console.error(`Product with ID "${currentProductId}" not found in cache.`);
                document.getElementById('loading-indicator').innerHTML = '<p class="text-center text-red-500 font-bold">Maaf kijiye, yeh product nahi mil saka.</p>'; 
            }
        }

        function loadProduct(data) {
            mediaItems = [];
            if (data.images) mediaItems.push(...data.images.map(src => ({ type: 'image', src })));
            if (data.videoUrl) mediaItems.push({ type: 'video', src: data.videoUrl, thumbnail: (data.images && data.images[0]) || 'https://i.ibb.co/My6h0gdd/20250706-230221.png' });

            document.title = `${data.name || 'Product'} - Ramazone`;
            document.querySelector('meta[property="og:title"]').setAttribute('content', data.name);
            document.querySelector('meta[property="og:image"]').setAttribute('content', (data.images && data.images[0]) || 'https://i.ibb.co/My6h0gdd/20250706-230221.png');
            document.getElementById('product-title').textContent = data.name;
            
            if (data.rating && data.reviewCount) {
                document.getElementById('rating-section').style.display = 'flex';
                renderStars(data.rating, document.getElementById('product-rating-stars'));
                document.getElementById('product-review-count').textContent = `(${data.reviewCount} ratings)`;
            }

            const descriptionContainer = document.getElementById('product-description');
            descriptionContainer.innerHTML = '';
            if (data.description && Array.isArray(data.description)) {
                document.getElementById('description-section').style.display = 'block';
                data.description.forEach(block => {
                    const blockDiv = document.createElement('div');
                    blockDiv.className = 'desc-block';
                    let blockHTML = '';
                    if (block.title) blockHTML += `<h3 class="desc-block-title">${block.title}</h3>`;
                    if (block.details) blockHTML += `<p class="desc-block-details">${block.details}</p>`;
                    if (block.highlights && Array.isArray(block.highlights) && block.highlights.length > 0) {
                        blockHTML += `<ul class="desc-block-highlights">${block.highlights.map(h => `<li>${h}</li>`).join('')}</ul>`;
                    }
                    blockDiv.innerHTML = blockHTML;
                    descriptionContainer.appendChild(blockDiv);
                });
            }
            
            const gallery = document.getElementById('thumbnail-gallery');
            gallery.innerHTML = '';
            slider.innerHTML = '';

            mediaItems.forEach((item, index) => {
                const slide = document.createElement('div');
                slide.className = 'media-item';
                if (item.type === 'image') {
                    slide.innerHTML = `<img src="${item.src}" alt="Product image ${index + 1}" draggable="false">`;
                } else {
                    const embedUrl = getYoutubeEmbedUrl(item.src);
                    slide.innerHTML = `<iframe src="${embedUrl}" class="w-full h-auto object-cover aspect-square" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
                }
                slider.appendChild(slide);

                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'aspect-square thumbnail';
                const img = document.createElement('img');
                img.src = item.type === 'image' ? item.src : item.thumbnail;
                thumbWrapper.appendChild(img);
                if (item.type === 'video') {
                    const playIcon = document.createElement('div');
                    playIcon.className = 'play-icon';
                    playIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="50%" height="50%"><path d="M8 5v14l11-7z"/></svg>`;
                    thumbWrapper.appendChild(playIcon);
                }
                thumbWrapper.addEventListener('click', () => showMedia(index));
                gallery.appendChild(thumbWrapper);
            });
            
            showMedia(0);
            setupSliderControls();
            setupQuantityControls();
            setupImageModal();
            setupShareButton();
            setupCouponButton();
            setupDeliveryOptions();
            updatePriceDisplay();
            loadSimilarProducts(data.category);
            loadOtherProducts(data.category);
        }

        function renderStars(rating, container) {
            container.innerHTML = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            for (let i = 0; i < fullStars; i++) container.innerHTML += '<i class="fas fa-star"></i>';
            if (halfStar) container.innerHTML += '<i class="fas fa-star-half-alt"></i>';
            for (let i = 0; i < emptyStars; i++) container.innerHTML += '<i class="far fa-star"></i>';
        }

        function updatePriceDisplay() {
            const basePrice = Number(currentProductData.displayPrice);
            const originalPrice = Number(currentProductData.originalPrice);
            const couponDiscount = appliedCoupon ? Number(appliedCoupon.discount) : 0;
            const deliveryCharge = selectedDeliveryType === 'Ramazone' ? ramazoneDeliveryCharge : 0;
            
            const finalPrice = basePrice - couponDiscount;
            document.getElementById('price-final').textContent = `â‚¹${finalPrice.toLocaleString('en-IN')}`;

            const percentageDiscountEl = document.getElementById('price-percentage-discount');
            const originalPriceEl = document.getElementById('price-original');
            const lowestPriceTag = document.getElementById('lowest-price-tag-container');

            if (originalPrice > basePrice) {
                const discount = Math.round(((originalPrice - basePrice) / originalPrice) * 100);
                percentageDiscountEl.innerHTML = `<i class="fas fa-arrow-down mr-1"></i>${discount}%`;
                originalPriceEl.textContent = `â‚¹${originalPrice.toLocaleString('en-IN')}`;
                percentageDiscountEl.style.display = 'flex';
                originalPriceEl.style.display = 'inline';
                lowestPriceTag.style.display = 'block';
            } else {
                percentageDiscountEl.style.display = 'none';
                originalPriceEl.style.display = 'none';
                lowestPriceTag.style.display = 'none';
            }

            const couponRow = document.getElementById('price-coupon-row');
            if (appliedCoupon) {
                document.getElementById('price-coupon-discount').textContent = `- â‚¹${couponDiscount.toLocaleString('en-IN')}`;
                couponRow.style.display = 'flex';
            } else {
                couponRow.style.display = 'none';
            }
            
            document.getElementById('price-delivery-charge').textContent = deliveryCharge > 0 ? `+ â‚¹${deliveryCharge.toLocaleString('en-IN')}` : 'Free';
            updateQuantityAndWhatsAppLink();
        }

        function getYoutubeEmbedUrl(url) {
            if(!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}?controls=1&rel=0&modestbranding=1` : null;
        }

        function showMedia(index) {
            slider.style.transition = 'transform 0.3s ease-out';
            currentMediaIndex = index;
            currentTranslate = index * -sliderWrapper.offsetWidth;
            prevTranslate = currentTranslate;
            setSliderPosition();
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => thumb.classList.toggle('active', i === index));
        }
        
        function setupSliderControls() {
            sliderWrapper.addEventListener('touchstart', touchStart, { passive: true });
            sliderWrapper.addEventListener('touchend', touchEnd);
            sliderWrapper.addEventListener('touchmove', touchMove, { passive: true });
            sliderWrapper.addEventListener('mousedown', touchStart);
            sliderWrapper.addEventListener('mouseup', touchEnd);
            sliderWrapper.addEventListener('mouseleave', touchEnd);
            sliderWrapper.addEventListener('mousemove', touchMove);
        }

        function touchStart(event) {
            startPos = getPositionX(event);
            isDragging = true;
            animationID = requestAnimationFrame(animation);
            slider.style.transition = 'none';
        }

        function touchMove(event) {
            if (isDragging) {
                const currentPosition = getPositionX(event);
                currentTranslate = prevTranslate + currentPosition - startPos;
            }
        }

        function touchEnd(event) {
            if (!isDragging) return;
            isDragging = false;
            cancelAnimationFrame(animationID);
            const movedBy = currentTranslate - prevTranslate;

            // More sensitive swipe threshold
            if (movedBy < -50 && currentMediaIndex < mediaItems.length - 1) {
                currentMediaIndex += 1;
            }
            if (movedBy > 50 && currentMediaIndex > 0) {
                currentMediaIndex -= 1;
            }
            showMedia(currentMediaIndex);
        }

        function getPositionX(event) {
            return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
        }

        function animation() {
            setSliderPosition();
            if (isDragging) requestAnimationFrame(animation);
        }

        function setSliderPosition() {
            slider.style.transform = `translateX(${currentTranslate}px)`;
        }

        function setupQuantityControls() {
            document.getElementById('increase-quantity').addEventListener('click', () => { productQuantity++; updateQuantityAndWhatsAppLink(); });
            document.getElementById('decrease-quantity').addEventListener('click', () => { if (productQuantity > 1) { productQuantity--; updateQuantityAndWhatsAppLink(); } });
            updateQuantityAndWhatsAppLink();
        }

        function updateQuantityAndWhatsAppLink() {
            const sellerPhoneNumber = '917903698180';
            document.getElementById('quantity-display').textContent = productQuantity;
            document.getElementById('decrease-quantity').disabled = productQuantity <= 1;
            
            const basePrice = Number(currentProductData.displayPrice), couponDiscount = appliedCoupon ? Number(appliedCoupon.discount) : 0;
            const deliveryCharge = selectedDeliveryType === 'Ramazone' ? ramazoneDeliveryCharge : 0;
            const singleItemFinalPrice = basePrice - couponDiscount, totalOrderPrice = (singleItemFinalPrice * productQuantity) + deliveryCharge;
            const productName = currentProductData.name.replace(/\*/g, '').trim();

            let message = `ðŸ›ï¸ *Ramazone Store Order* ðŸ›ï¸\n\nHello! I'm interested in this product:\n\n*Product:* *${productName}*\n*Quantity:* ${productQuantity}\n-------------------------------------\n*Price per item:* â‚¹${basePrice.toLocaleString('en-IN')}\n`;
            if (appliedCoupon) message += `*Coupon Discount:* - â‚¹${couponDiscount.toLocaleString('en-IN')}\n`;
            message += `*Delivery (${selectedDeliveryType}):* + â‚¹${deliveryCharge.toLocaleString('en-IN')}\n-------------------------------------\n*Total Price:* *â‚¹${totalOrderPrice.toLocaleString('en-IN')}*\n\n*Product ID:* ${currentProductId}\n*Product Link:* ${window.location.href}\n\nPlease let me know if it's available.`;
            document.getElementById('whatsapp-order-link').href = `https://wa.me/${sellerPhoneNumber}?text=${encodeURIComponent(message)}`;
        }
        
        function setupCouponButton() {
            document.getElementById('coupon-btn').addEventListener('click', () => {
                const code = prompt("Enter coupon code:");
                if (code) {
                    const coupon = validCoupons.find(c => c.code.toLowerCase() === code.toLowerCase());
                    if (coupon) { appliedCoupon = coupon; showToast(`Coupon "${coupon.code}" applied!`); } 
                    else { appliedCoupon = null; showToast("Invalid coupon code.", "error"); }
                    updatePriceDisplay();
                }
            });
        }
        
        function setupDeliveryOptions() {
            document.getElementById('ramazone-delivery-label').textContent = `Ramazone Delivery (+â‚¹${ramazoneDeliveryCharge})`;
            const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
            deliveryRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedDeliveryType = e.target.value;
                    document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.closest('.delivery-option').classList.add('selected');
                    updatePriceDisplay();
                });
            });
            document.querySelector('.delivery-option').classList.add('selected');
        }

        function setupImageModal() {
            const modal = document.getElementById('image-modal'), modalImg = document.getElementById("modal-image-content"), closeBtn = document.querySelector("#image-modal .close"), prevBtn = document.querySelector("#image-modal .prev"), nextBtn = document.querySelector("#image-modal .next");
            
            sliderWrapper.onclick = (e) => { 
                if(isDragging || (currentTranslate - prevTranslate) !== 0) return;
                if (mediaItems[currentMediaIndex].type === 'image') { modal.style.display = "flex"; modalImg.src = mediaItems[currentMediaIndex].src; } 
            };
            closeBtn.onclick = () => modal.style.display = "none";
            const showModalImage = (direction) => {
                let imageItems = mediaItems.map((item, i) => ({...item, originalIndex: i})).filter(item => item.type === 'image');
                if (imageItems.length === 0) return;
                const currentImageInFilteredArray = imageItems.findIndex(item => item.originalIndex === currentMediaIndex);
                let nextImageInFilteredArray = (currentImageInFilteredArray + direction + imageItems.length) % imageItems.length;
                const nextImageItem = imageItems[nextImageInFilteredArray];
                modalImg.src = nextImageItem.src; showMedia(nextImageItem.originalIndex);
            };
            prevBtn.onclick = (e) => { e.stopPropagation(); showModalImage(-1); };
            nextBtn.onclick = (e) => { e.stopPropagation(); showModalImage(1); };
        }

        function setupShareButton() {
            document.getElementById('share-button').addEventListener('click', async () => {
                const productName = currentProductData.name.replace(/\*/g, '').trim();
                const shareText = `*${productName}*\nPrice: *â‚¹${Number(currentProductData.displayPrice).toLocaleString('en-IN')}*\n\nâœ¨ Discover more at Ramazone! âœ¨\n${window.location.href}`;
                if (navigator.share) { await navigator.share({ text: shareText }); } 
                else { navigator.clipboard.writeText(window.location.href).then(() => showToast("Link Copied!")); }
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message; toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#333';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        function createCarouselCard(product) {
            const ratingTag = product.rating ? `<div class="card-rating-tag">${product.rating} <i class="fas fa-star"></i></div>` : '';
            return `
                <a href="?id=${product.id}" class="carousel-item block bg-white rounded-lg shadow overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                    <div class="relative"><img src="${product.images?.[0] || 'https://i.ibb.co/My6h0gdd/20250706-230221.png'}" class="w-full h-32 object-cover" alt="${product.name}">${ratingTag}</div>
                    <div class="p-2"><h4 class="text-sm font-semibold truncate text-gray-800">${product.name}</h4><p class="text-base font-bold" style="color: var(--primary-color)">â‚¹${Number(product.displayPrice).toLocaleString('en-IN')}</p></div>
                </a>`;
        }

        function createGridCard(product) {
            const ratingTag = product.rating ? `<div class="card-rating-tag">${product.rating} <i class="fas fa-star"></i></div>` : '';
            const discount = (product.originalPrice && product.originalPrice > product.displayPrice) ? Math.round(((product.originalPrice - product.displayPrice) / product.originalPrice) * 100) : 0;
            const discountTag = discount > 0 ? `<p class="text-sm font-semibold text-green-600 mt-1">${discount}% OFF</p>` : '';

            return `
                <a href="?id=${product.id}" class="block bg-white rounded-lg shadow overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                    <div class="relative">
                        <img src="${product.images?.[0] || 'https://i.ibb.co/My6h0gdd/20250706-230221.png'}" class="w-full h-auto object-cover aspect-square" alt="${product.name}">
                        ${ratingTag}
                    </div>
                    <div class="p-2 sm:p-3">
                        <h4 class="text-sm font-semibold truncate text-gray-800 mb-1">${product.name}</h4>
                        <div class="flex items-baseline gap-2">
                            <p class="text-base font-bold" style="color: var(--primary-color)">â‚¹${Number(product.displayPrice).toLocaleString('en-IN')}</p>
                            ${product.originalPrice > product.displayPrice ? `<p class="text-xs text-gray-400 line-through">â‚¹${Number(product.originalPrice).toLocaleString('en-IN')}</p>` : ''}
                        </div>
                        ${discountTag}
                    </div>
                </a>`;
        }
        
        function updateRecentlyViewed(newId) {
            let viewedIds = JSON.parse(sessionStorage.getItem('recentlyViewed')) || [];
            viewedIds = viewedIds.filter(id => id !== newId);
            viewedIds.unshift(newId);
            viewedIds = viewedIds.slice(0, 10);
            sessionStorage.setItem('recentlyViewed', JSON.stringify(viewedIds));
            loadRecentlyViewed(viewedIds);
        }

        function loadRecentlyViewed(viewedIds) {
            if (!viewedIds || viewedIds.length <= 1) return;
            const container = document.getElementById('recently-viewed-container');
            container.innerHTML = '';
            let cardCount = 0;
            viewedIds.filter(id => id != currentProductId).forEach(id => {
                const product = allProductsCache.find(p => p.id == id);
                if (product) { container.innerHTML += createCarouselCard(product); cardCount++; }
            });
            if (cardCount > 0) document.getElementById('recently-viewed-section').style.display = 'block';
        }
        
        function loadSimilarProducts(category) {
            if (!category || !allProductsCache) return;
            const container = document.getElementById('similar-products-container');
            container.innerHTML = '';
            let cardCount = 0;
            allProductsCache.forEach(product => {
                if (product && product.category === category && product.id != currentProductId) {
                    container.innerHTML += createCarouselCard(product);
                    cardCount++;
                }
            });
            if (cardCount > 0) document.getElementById('similar-products-section').style.display = 'block';
        }

        function loadOtherProducts(currentCategory) {
            const otherProducts = allProductsCache.filter(p => p.category !== currentCategory && p.id != currentProductId).map(p => { const discount = p.originalPrice > p.displayPrice ? ((p.originalPrice - p.displayPrice) / p.originalPrice) * 100 : 0; const rating = p.rating || 0; const score = (rating * 5) + (discount * 0.5); return {...p, score}; }).sort((a, b) => b.score - a.score).slice(0, 20);
            const container = document.getElementById('other-products-container');
            container.innerHTML = '';
            if (otherProducts.length > 0) {
                otherProducts.forEach(product => { container.innerHTML += createGridCard(product); });
                document.getElementById('other-products-section').style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeAppAndLoadProduct);
    </script>
</body>
</html>

