<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - Ramazone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #e50914;
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 80px;
        }

        /* --- Login View --- */
        #login-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        #login-view.active { display: flex; }

        .login-card { width: 100%; max-width: 380px; text-align: center; }
        .login-input {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 15px; font-size: 16px;
            background: var(--bg-body); outline: none;
        }
        .btn-primary {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.2s;
        }

        /* --- Admin Dashboard --- */
        #admin-view { display: none; }
        #admin-view.active { display: block; animation: fadeIn 0.3s; }

        .header {
            background: var(--bg-card); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 90;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .header h1 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .logout-icon { font-size: 24px; color: var(--text-muted); cursor: pointer; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card {
            background: var(--bg-card); padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow-sm); text-align: center;
            border: 1px solid var(--border);
        }
        .stat-card h3 { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .stat-number { font-size: 20px; font-weight: 800; color: var(--text-main); }

        /* Tabs */
        .tabs-wrapper {
            overflow-x: auto; white-space: nowrap; margin: 0 -15px 20px -15px;
            padding: 0 15px; scrollbar-width: none;
        }
        .tab-btn {
            display: inline-block; padding: 8px 16px; margin-right: 8px;
            background: white; border: 1px solid var(--border);
            border-radius: 20px; font-size: 13px; font-weight: 600;
            color: var(--text-muted); transition: 0.2s;
        }
        .tab-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease-out; }

        /* List Items */
        .list-item {
            background: var(--bg-card); padding: 15px; border-radius: 16px;
            margin-bottom: 12px; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        .list-header { display: flex; justify-content: space-between; align-items: center; }
        .badge-gray { background: #f3f4f6; color: #4b5563; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }

        /* Full Screen Receipt Overlay */
        #payment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 9999; display: none; justify-content: center; align-items: center;
            padding: 20px;
        }
        #payment-overlay.active { display: flex; animation: fadeIn 0.2s; }
        
        .receipt-card {
            background: white; width: 100%; max-width: 340px;
            border-radius: 24px; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: scaleUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .receipt-header {
            background: var(--success); padding: 30px 20px; text-align: center; color: white;
        }
        .success-icon-circle {
            width: 60px; height: 60px; background: white; border-radius: 50%;
            margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;
            color: var(--success); font-size: 32px;
        }
        .receipt-body { padding: 25px; text-align: center; }
        .receipt-amount { font-size: 40px; font-weight: 800; color: var(--text-main); margin: 10px 0; }
        .receipt-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; }
        .receipt-value { font-size: 16px; font-weight: 600; color: var(--text-main); margin-top: 4px; }
        
        .close-receipt-btn {
            background: var(--text-main); color: white; border: none;
            padding: 15px; width: 100%; font-weight: 600; font-size: 16px;
            cursor: pointer;
        }

        /* Mobile Bottom Sheet Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 1000; display: none; align-items: flex-end;
        }
        .modal-overlay.active { display: flex; }
        .modal-sheet {
            background: white; width: 100%; border-radius: 20px 20px 0 0;
            padding: 25px; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <!-- Full Screen Receipt Overlay -->
    <div id="payment-overlay">
        <div class="receipt-card">
            <div class="receipt-header">
                <div class="success-icon-circle"><i class="ph-fill ph-check-circle"></i></div>
                <h2 style="font-size: 20px; margin:0;">Payment Received!</h2>
                <p style="font-size: 13px; opacity: 0.9; margin:5px 0 0 0;">RMZ Wallet Top-up</p>
            </div>
            <div class="receipt-body">
                <p style="color: var(--text-muted); font-size: 13px; margin:0;">Total Amount</p>
                <div class="receipt-amount" id="popup-amount">₹0.00</div>
                <div class="receipt-label">Received From</div>
                <div class="receipt-value" id="popup-sender">Unknown</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div><div class="receipt-label">Date</div><div class="receipt-value" style="font-size: 14px;" id="popup-date">--/--</div></div>
                    <div><div class="receipt-label">Time</div><div class="receipt-value" style="font-size: 14px;" id="popup-time">--:--</div></div>
                </div>
                <div class="receipt-label">Transaction ID</div>
                <div class="receipt-value" style="font-size: 12px; color: var(--text-muted); font-family: monospace;" id="popup-txnid">#------</div>
            </div>
            <button class="close-receipt-btn" onclick="document.getElementById('payment-overlay').classList.remove('active')">Close Receipt</button>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="active">
        <div class="login-card">
            <img src="https://i.ibb.co/S4S28p24/20251106-092435.png" alt="Logo" style="height: 50px; margin-bottom: 20px;">
            <h2>Admin Access</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Secure Panel for Dukaan Pay</p>
            <form id="admin-login-form">
                <input type="tel" id="admin-email" class="login-input" value="7903698180" placeholder="Mobile Number" required>
                <input type="number" id="admin-password" class="login-input" placeholder="Password" required>
                <button type="submit" class="btn-primary">Unlock Dashboard</button>
                <p id="admin-login-error" style="color: var(--danger); margin-top: 15px; font-size: 13px;"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-view">
        <div class="header">
            <h1><img src="https://i.ibb.co/S4S28p24/20251106-092435.png" alt="Logo" style="height: 24px;"> Admin</h1>
            <i class="ph ph-sign-out logout-icon" id="logout-btn"></i>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card" data-tab="members">
                    <h3>Members</h3><div class="stat-number" id="total-members-stat">0</div>
                </div>
                <div class="stat-card" data-tab="due-list">
                    <h3>Total Due</h3><div class="stat-number" id="total-due-stat" style="color: var(--danger);">₹0</div>
                </div>
                <div class="stat-card" data-tab="rmz-history">
                    <h3>Wallet</h3><div class="stat-number" id="rmz-wallet-stat" style="color: var(--success);">₹0</div>
                </div>
                <div class="stat-card" data-tab="notifications">
                    <h3>Alerts</h3><div class="stat-number" id="notifications-stat">0</div>
                </div>
            </div>

            <div class="tabs-wrapper">
                <button class="tab-btn active" data-tab="members">Members</button>
                <button class="tab-btn" data-tab="due-list">Due Payments</button>
                <button class="tab-btn" data-tab="rmz-history">History</button>
                <button class="tab-btn" data-tab="notifications">Broadcast</button>
            </div>

            <div id="members-content" class="tab-content active">
                <h2 style="font-size: 16px; margin-bottom: 15px;">All Members</h2>
                <div id="members-list"></div>
            </div>

            <div id="due-list-content" class="tab-content">
                <h2 style="font-size: 16px; margin-bottom: 15px;">Pending Dues</h2>
                <div id="due-list-table"></div>
            </div>

            <div id="rmz-history-content" class="tab-content">
                <h2 style="font-size: 16px; margin-bottom: 15px;">Wallet History</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="rmz-start-date" class="login-input" style="margin:0; padding: 10px;">
                    <button id="rmz-filter-btn" class="btn-primary" style="width: auto; padding: 0 20px;">Go</button>
                </div>
                <div id="rmz-history-list"></div>
            </div>

            <div id="notifications-content" class="tab-content">
                <h2 style="font-size: 16px; margin-bottom: 15px;">Send Broadcast</h2>
                <form id="notification-form" style="background: white; padding: 15px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px;">
                    <input type="text" id="notification-title" class="login-input" placeholder="Title" required>
                    <textarea id="notification-text" class="login-input" placeholder="Message..." rows="3" required></textarea>
                    <input type="url" id="notification-link" class="login-input" placeholder="Link (Optional)">
                    <button type="submit" class="btn-primary">Send</button>
                </form>
                <h3 style="font-size: 14px; margin-bottom: 10px;">History</h3>
                <div id="notifications-list"></div>
            </div>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div id="member-details-modal" class="modal-overlay">
        <div class="modal-sheet">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px;">Member Action</h3>
                <i class="ph ph-x" data-close-modal style="font-size: 24px; padding: 5px;"></i>
            </div>
            <div id="member-details-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;"></div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <form id="give-credit-form" style="display: flex; gap: 10px;">
                    <input type="number" id="give-credit-amount" class="login-input" style="margin:0;" placeholder="Credit Amount" required>
                    <button type="submit" class="btn-primary" style="background: var(--info); width: 80px;">Add</button>
                </form>
                <form id="clear-due-form" style="display: flex; gap: 10px;">
                    <input type="number" id="clear-due-amount" class="login-input" style="margin:0;" placeholder="Clear Due" required>
                    <button type="submit" class="btn-primary" style="background: var(--success); width: 80px;">Pay</button>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW: Edit Notification Modal -->
    <div id="edit-notification-modal" class="modal-overlay">
        <div class="modal-sheet">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px;">Edit Broadcast</h3>
                <i class="ph ph-x" data-close-modal style="font-size: 24px; padding: 5px;"></i>
            </div>
            <form id="edit-notification-form">
                <input type="hidden" id="edit-notification-id">
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">Title</label>
                    <input type="text" id="edit-notification-title" class="login-input" style="margin:0;" required>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">Message</label>
                    <textarea id="edit-notification-text" class="login-input" style="margin:0;" rows="3" required></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="font-size:12px; color:#666;">Link</label>
                    <input type="url" id="edit-notification-link" class="login-input" style="margin:0;">
                </div>
                <button type="submit" class="btn-primary">Update Broadcast</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, runTransaction, increment, serverTimestamp, orderBy, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCmgMr4cj7ec1B09eu3xpRhCwsVCeQR9v0",
            authDomain: "tipsplit-e3wes.firebaseapp.com",
            projectId: "tipsplit-e3wes",
            storageBucket: "tipsplit-e3wes.appspot.com",
            appId: "1:984733883633:web:adc1e1d22b629a6b631d50"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_UID = "O12QPLCWaCQ9E8NQxW0K6I778IS2"; 
        let activeListeners = [];
        let currentMemberUid = null;
        let allRmzTransactions = []; 

        async function init() {
            await setPersistence(auth, browserSessionPersistence);
            onAuthStateChanged(auth, user => {
                if (user && user.uid === ADMIN_UID) {
                    document.getElementById('admin-view').classList.add('active');
                    document.getElementById('login-view').classList.remove('active');
                    loadAllData();
                } else {
                    if (user) signOut(auth);
                    document.getElementById('login-view').classList.add('active');
                    document.getElementById('admin-view').classList.remove('active');
                    activeListeners.forEach(unsub => unsub());
                }
            });
            addEventListeners();
        }

        function loadAllData() {
            activeListeners.forEach(unsub => unsub());
            activeListeners.push(
                onSnapshot(query(collection(db, 'users'), orderBy('createdAt', 'desc')), (snapshot) => {
                    renderMembers(snapshot); renderDueList(snapshot);
                }),
                onSnapshot(doc(db, 'app_settings', 'config'), renderStats), 
                onSnapshot(query(collection(db, 'rmz_wallet_transactions'), orderBy('timestamp', 'desc')), handleRmzTransactionsUpdate),
                onSnapshot(query(collection(db, 'notifications'), orderBy('createdAt', 'desc')), renderNotifications)
            );
        }
        
        function handleRmzTransactionsUpdate(snapshot) {
            const previousTransactions = allRmzTransactions.map(t => t.id);
            allRmzTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            snapshot.docChanges().forEach(change => {
                const t = { id: change.doc.id, ...change.doc.data() };
                if (change.type === "added" && !previousTransactions.includes(t.id) && t.amount > 0) {
                    showFullScreenReceipt(t);
                }
            });
            renderRmzHistoryList();
        }

        function showFullScreenReceipt(data) {
            document.getElementById('popup-amount').textContent = `₹${data.amount.toFixed(2)}`;
            document.getElementById('popup-sender').textContent = data.senderName || data.senderMobile || 'Unknown';
            document.getElementById('popup-txnid').textContent = `ID: ${data.id}`;
            let dateObj = data.timestamp ? data.timestamp.toDate() : new Date();
            document.getElementById('popup-date').textContent = dateObj.toLocaleDateString();
            document.getElementById('popup-time').textContent = dateObj.toLocaleTimeString();
            document.getElementById('payment-overlay').classList.add('active');
        }

        function renderMembers(snapshot) {
            document.getElementById('total-members-stat').textContent = snapshot.size;
            let totalDue = 0, html = '';
            snapshot.forEach(doc => {
                const u = doc.data();
                totalDue += u.dueAmount || 0;
                html += `
                <div class="list-item member-row" data-id="${u.uid}">
                    <div class="list-header"><div style="font-weight:700;">${u.name}</div><span class="badge-gray">Lvl ${u.creditLevel||0}</span></div>
                    <div style="font-size:13px; color:var(--text-muted); margin-bottom:5px;">${u.mobile}</div>
                    <div style="display:flex; justify-content:space-between;">
                        <div><div style="font-size:11px;">Wallet</div><div style="font-weight:700; color:var(--success);">₹${(u.wallet||0).toFixed(2)}</div></div>
                        <div style="text-align:right;"><div style="font-size:11px;">Due</div><div style="font-weight:700; color:${u.dueAmount>0?'var(--danger)':'var(--text-muted)'};">₹${(u.dueAmount||0).toFixed(2)}</div></div>
                    </div>
                </div>`;
            });
            document.getElementById('members-list').innerHTML = html || '<div style="text-align:center; padding:20px; color:#999;">No members</div>';
            document.getElementById('total-due-stat').textContent = `₹${totalDue.toFixed(2)}`;
        }
        
        function renderDueList(snapshot) {
            let html = '', hasData = false;
            snapshot.forEach(doc => {
                const u = doc.data();
                if (u.dueAmount > 0) {
                    hasData = true;
                    html += `<div class="list-item member-row" data-id="${u.uid}"><div class="list-header"><div>${u.name}</div><div style="color:var(--danger); font-weight:700;">₹${u.dueAmount.toFixed(2)}</div></div><div style="font-size:13px; color:var(--text-muted);">${u.mobile}</div></div>`;
                }
            });
            document.getElementById('due-list-table').innerHTML = hasData ? html : '<div style="text-align:center; padding:20px; color:#999;">No dues</div>';
        }

        function renderRmzHistoryList() {
            const listEl = document.getElementById('rmz-history-list');
            let html = '';
            allRmzTransactions.forEach(t => {
                const dateObj = t.timestamp ? t.timestamp.toDate() : new Date();
                html += `<div class="list-item"><div class="list-header"><div style="color:var(--success); font-weight:700;">+ ₹${t.amount.toFixed(2)}</div><div style="font-size:12px;">${dateObj.toLocaleDateString()}</div></div><div style="font-size:13px;">From: ${t.senderName||t.senderMobile}</div><div style="font-size:11px; color:var(--text-muted); margin-top:4px;">${dateObj.toLocaleTimeString()}</div></div>`;
            });
            listEl.innerHTML = html || '<div style="text-align:center; padding:20px; color:#999;">No transactions</div>';
        }

        function renderNotifications(snapshot) {
            document.getElementById('notifications-stat').textContent = snapshot.size;
            let html = '';
            snapshot.forEach(doc => {
                const n = { id: doc.id, ...doc.data() };
                const date = n.createdAt ? n.createdAt.toDate().toLocaleDateString() : '';
                html += `
                <div class="list-item">
                    <div class="list-header">
                        <div style="font-size:14px; font-weight:600;">${n.title}</div>
                        <div style="display:flex; gap:10px;">
                            <i class="ph-fill ph-pencil-simple" data-action="edit-notification" data-id="${n.id}" style="color:var(--info); font-size:18px;"></i>
                            <i class="ph-fill ph-trash" data-action="delete-notification" data-id="${n.id}" style="color:var(--danger); font-size:18px;"></i>
                        </div>
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">${date}</div>
                </div>`;
            });
            document.getElementById('notifications-list').innerHTML = html;
        }

        function renderStats(doc) { if (doc.exists()) document.getElementById('rmz-wallet-stat').textContent = `₹${(doc.data().rmz_wallet_balance || 0).toFixed(2)}`; }

        function addEventListeners() {
            document.getElementById('admin-login-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const btn = e.target.querySelector('button'); btn.textContent = "Checking...";
                signInWithEmailAndPassword(auth, `${document.getElementById('admin-email').value}@ramazone.com`, document.getElementById('admin-password').value)
                .catch(() => { document.getElementById('admin-login-error').textContent = "Invalid Credentials"; btn.textContent = "Unlock Dashboard"; }); 
            });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            document.querySelector('.tabs-wrapper').addEventListener('click', (e) => {
                if (!e.target.classList.contains('tab-btn')) return;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${e.target.dataset.tab}-content`).classList.add('active');
            });

            document.querySelector('.stats-grid').addEventListener('click', (e) => {
                const card = e.target.closest('.stat-card');
                if (card) document.querySelector(`.tab-btn[data-tab="${card.dataset.tab}"]`).click();
            });

            document.getElementById('members-list').addEventListener('click', (e) => {
                const row = e.target.closest('.member-row'); if (row) showMemberDetails(row.dataset.id);
            });
            document.getElementById('due-list-table').addEventListener('click', (e) => {
                const row = e.target.closest('.member-row'); if (row) showMemberDetails(row.dataset.id);
            });

            document.getElementById('give-credit-form').addEventListener('submit', handleGiveCredit);
            document.getElementById('clear-due-form').addEventListener('submit', handleClearDue);
            document.getElementById('notification-form').addEventListener('submit', handleSendNotification);
            document.getElementById('edit-notification-form').addEventListener('submit', handleUpdateNotification);

            document.querySelectorAll('[data-close-modal]').forEach(el => el.addEventListener('click', () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'))));
            
            document.getElementById('notifications-list').addEventListener('click', (e) => {
                const target = e.target.closest('i');
                if (!target) return;
                const id = target.dataset.id;
                
                if(target.dataset.action === "delete-notification") {
                    if(confirm("Delete?")) deleteDoc(doc(db, "notifications", id));
                }
                if(target.dataset.action === "edit-notification") {
                    showEditNotification(id);
                }
            });
        }

        async function showMemberDetails(uid) {
            currentMemberUid = uid;
            const d = await getDoc(doc(db, 'users', uid));
            if(!d.exists()) return;
            const u = d.data();
            // ADDED: Password and User ID fields
            document.getElementById('member-details-content').innerHTML = `
                <div><div style="font-size:11px; color:#999;">Name</div><div style="font-weight:600;">${u.name}</div></div>
                <div><div style="font-size:11px; color:#999;">Mobile</div><div style="font-weight:600;">${u.mobile}</div></div>
                <div><div style="font-size:11px; color:#999;">Wallet</div><div style="font-weight:600; color:var(--success);">₹${(u.wallet||0).toFixed(2)}</div></div>
                <div><div style="font-size:11px; color:#999;">Due</div><div style="font-weight:600; color:var(--danger);">₹${(u.dueAmount||0).toFixed(2)}</div></div>
                <div><div style="font-size:11px; color:#999;">Password</div><div style="font-weight:600;">${u.password || 'N/A'}</div></div>
                <div><div style="font-size:11px; color:#999;">User ID</div><div style="font-weight:600; font-size:12px; word-break:break-all;">${u.uid}</div></div>
            `;
            document.getElementById('member-details-modal').classList.add('active');
        }

        // --- NEW: Edit Notification Functions ---
        async function showEditNotification(id) {
            const d = await getDoc(doc(db, 'notifications', id));
            if(!d.exists()) return;
            const n = d.data();
            document.getElementById('edit-notification-id').value = id;
            document.getElementById('edit-notification-title').value = n.title;
            document.getElementById('edit-notification-text').value = n.text;
            document.getElementById('edit-notification-link').value = n.link || '';
            document.getElementById('edit-notification-modal').classList.add('active');
        }

        async function handleUpdateNotification(e) {
            e.preventDefault();
            const id = document.getElementById('edit-notification-id').value;
            const title = document.getElementById('edit-notification-title').value;
            const text = document.getElementById('edit-notification-text').value;
            const link = document.getElementById('edit-notification-link').value;
            
            await updateDoc(doc(db, 'notifications', id), { title, text, link });
            alert("Updated");
            document.getElementById('edit-notification-modal').classList.remove('active');
        }
        // -----------------------------------------

        async function handleGiveCredit(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('give-credit-amount').value);
            if(!amt || !currentMemberUid) return;
            const btn = e.target.querySelector('button'); btn.disabled = true;
            try {
                await runTransaction(db, async (t) => {
                    const ref = doc(db, 'users', currentMemberUid);
                    t.update(ref, { wallet: increment(amt), totalCreditGiven: increment(amt), dueAmount: increment(amt) });
                    const tr = doc(collection(db, 'transactions'));
                    t.set(tr, { involvedUsers: [currentMemberUid], type: 'credit_given', amount: amt, description: `Admin Credit`, status: 'completed', timestamp: serverTimestamp() });
                });
                alert("Credit Added"); document.getElementById('give-credit-amount').value = ""; document.getElementById('member-details-modal').classList.remove('active');
            } catch(err) { alert(err.message); }
            btn.disabled = false;
        }

        async function handleClearDue(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('clear-due-amount').value);
            if(!amt || !currentMemberUid) return;
            try {
                await runTransaction(db, async (t) => {
                    const ref = doc(db, 'users', currentMemberUid);
                    const userData = (await t.get(ref)).data();
                    if (amt > (userData.dueAmount || 0) + 1) throw new Error("Amount exceeds due");
                    let updateData = { dueAmount: increment(-amt), totalCreditGiven: increment(-amt) };
                    if ((userData.dueAmount - amt) < 1 && (userData.creditLevel || 0) < 7) updateData.creditLevel = increment(1);
                    t.update(ref, updateData);
                    const tr = doc(collection(db, 'transactions'));
                    t.set(tr, { involvedUsers: [currentMemberUid], type: 'due_payment', amount: -amt, description: `Due Cleared`, status: 'completed', timestamp: serverTimestamp() });
                });
                alert("Due Cleared"); document.getElementById('clear-due-amount').value = ""; document.getElementById('member-details-modal').classList.remove('active');
            } catch(err) { alert(err.message); }
        }

        async function handleSendNotification(e) {
            e.preventDefault();
            const title = document.getElementById('notification-title').value;
            const text = document.getElementById('notification-text').value;
            const link = document.getElementById('notification-link').value;
            if(!title || !text) return;
            await addDoc(collection(db, 'notifications'), { title, text, link, createdAt: serverTimestamp() });
            alert("Sent"); e.target.reset();
        }

        init();
    </script>
</body>
</html>