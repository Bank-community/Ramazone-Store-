<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazone Cashback</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f7f9; --bg-card: #ffffff; --text-primary: #1c2028;
            --text-secondary: #5a647e; --border-color: #e8eef3; --brand-red: #e50914;
            --accent-green: #27ae60; --accent-yellow: #f1c40f; --due-red: #ff6b6b;
            --accent-red-light: #c0392b; --brand-blue: #0052D4; --link-blue: #0056b3;
            --network-line-color: #d1d5db; /* NEW: Line color variable */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-page);
            color: var(--text-primary);
            min-height: 100%; 
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .container { 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; /* Center the container and ensure stability */
        }
        .view { display: none; background-color: var(--bg-card); min-height: 100vh; }
        #login-view, #registration-view { padding: 20px; }
        #dashboard-view { padding: 15px; background-color: var(--bg-page); }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        
        #network-view.active {
            display: flex;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* --- Login/Register --- */
        .auth-container { padding: 20px; border-radius: 16px; margin-top: 40px; background-color: var(--bg-card); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .main-logo { max-width: 200px; margin: 0 auto 30px auto; display: block; }
        h1 { text-align: center; font-size: 22px; font-weight: 600; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: 500; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; display: block; }
        input[type="text"], input[type="tel"], input[type="password"], input[type="number"] {
            width: 100%; padding: 12px; background-color: var(--bg-page); border: 1px solid #ced4da;
            border-radius: 8px; font-size: 16px;
        }
        button { width: 100%; padding: 14px; background: var(--brand-red); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .form-link { text-align: center; margin-top: 25px; color: var(--text-secondary); font-size: 14px; }
        .form-link a { color: var(--brand-red); text-decoration: none; font-weight: 600; }
        .error-message { color: var(--due-red); font-size: 14px; text-align: center; margin-top: 15px; display: none; }
        
        /* --- Dashboard UI --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-card); 
            border-radius: 8px;
            margin-bottom: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            gap: 10px;
        }
        .header-logo { height: 35px; flex-shrink: 0; }
        #static-notification-card { flex-grow: 1; margin-right: 2px; }

        #static-notification-card {
            display: flex; align-items: center; gap: 1px;
            padding: 5px 10px; 
            border-radius: 8px;
            background-color: var(--brand-red); color: white;
            transition: all 0.3s ease; display: none;
            border: var(--notification-border-width, 0px) solid var(--notification-border-color, transparent);
        }
        #static-notification-card.visible { display: flex; }
        
        .notification-content-wrapper { opacity: 0; display: flex; align-items: center; gap: 8px; }
        
        .notification-content-wrapper.animate { animation: fade-in-out 4.2s infinite; }
        .notification-text-container { display: flex; flex-direction: column; line-height: 1.1; }
        .notification-text-line { overflow: hidden; white-space: nowrap; width: 0; }
        .notification-percentage { transform: scale(1); opacity: 0; }

        @keyframes fade-in-out {
            0%, 100% { opacity: 0; }
            5%, 95% { opacity: 1; }
        }
        
        .animate .notification-text-line1 { animation: typing-hold 4.2s steps(30, end) infinite; }
        .animate .notification-text-line2 { animation: typing-hold 4.2s steps(30, end) 0.2s infinite; }
        
        @keyframes typing-hold {
            0% { width: 0; }
            28.5% { width: 100%; }
            100% { width: 100%; }
        }
        
        .animate .notification-percentage { animation: simple-fade-in-hold 4.2s infinite; }
        
        @keyframes simple-fade-in-hold {
            0%, 33% { opacity: 0; }
            38%, 100% { opacity: 1; }
        }

        #static-notification-card .notification-text-container { font-size: 10px; font-weight: 500; }
        #static-notification-card .notification-percentage { font-size: 20px; font-weight: 800; }

        .wallet-card {
            background: linear-gradient(45deg, #0052D4, #4364F7, #6FB1FC);
            color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(67, 100, 247, 0.3);
            text-align: center; position: relative;
        }
        #wallet-user-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        
        #wallet-profile-icon-container {
            position: absolute; top: 15px; right: 15px; cursor: pointer;
        }
        #wallet-profile-img {
            width: 45px; height: 45px; border-radius: 50%;
            object-fit: cover; border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .wallet-balance-label { font-size: 14px; color: rgba(255,255,255,0.8); }
        #wallet-balance { font-size: 40px; font-weight: 700; line-height: 1; margin-bottom: 15px; }
        .wallet-footer { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 15px; }
        .wallet-footer-item { text-align: center; }
        .wallet-footer-item p { font-size: 12px; color: rgba(255,255,255,0.8); margin: 0; }
        .wallet-footer-item .amount { font-size: 16px; font-weight: 600; }
        #wallet-share-btn { cursor: pointer; }
        #wallet-share-btn svg { width: 24px; height: 24px; stroke: white; }
        #wallet-referral-container { margin-top: 15px; display: inline-flex; justify-content: center; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.15); padding: 5px 12px; border-radius: 20px; }
        #wallet-referral-id { font-size: 13px; font-weight: 500; letter-spacing: 0.5px; }
        #copy-referral-btn { background: none; border: none; padding: 0; cursor: pointer; display: flex; align-items: center; }
        #copy-referral-btn svg { width: 16px; height: 16px; stroke: white; }
        .wallet-sub-items { grid-column: 1 / -1; display: flex; justify-content: space-around; margin-top: 15px; }

        .dashboard-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .action-card { 
            background-color: var(--bg-card); padding: 15px 10px; border-radius: 12px; text-align: center; cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: center; align-items: center; aspect-ratio: 1/1;
            position: relative; overflow: hidden;
        }
        .action-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.07); }
        .action-card .icon { margin-bottom: 8px; width: 30px; height: 30px; }
        .action-card .card-text { font-size: 12px; font-weight: 500; color: var(--text-primary); }

        #open-notification-center-btn { 
            padding: 10px;
            border: var(--thumbnail-border-width, 1px) solid var(--thumbnail-border-color, var(--border-color));
        }
        #open-notification-center-btn .notification-content-wrapper {
             flex-direction: column; justify-content: center; align-items: center; gap: 4px;
        }
        #open-notification-center-btn .notification-text-container { 
            font-size: 12px; font-weight: 600; text-align: center;
        }
        #open-notification-center-btn .notification-percentage { 
            font-size: 22px; font-weight: 800; margin-top: 4px;
        }

        .section { background: var(--bg-card); padding: 20px; border-radius: 16px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        
        #transaction-summary {
            background-color: var(--bg-page); border-radius: 10px; padding: 12px 15px;
            margin-bottom: 15px; display: none;
            justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color);
        }
        #transaction-summary .summary-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
        #transaction-summary .summary-amount { font-size: 18px; font-weight: 700; color: var(--text-primary); }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .filter-btn { padding: 6px 14px; border: 1px solid #ccc; background: transparent; color: var(--text-secondary); border-radius: 20px; cursor: pointer; font-size: 14px; white-space: nowrap; }
        .filter-btn.active { background-color: var(--brand-red); color: white; border-color: var(--brand-red); }
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background-color 0.2s;
        }
        .history-item:hover { background-color: #fafafa; }
        .history-item:last-child { border-bottom: none; }
        .history-info .title { font-weight: 500; font-size: 15px; }
        .history-info .date { font-size: 13px; color: var(--text-secondary); }
        .history-amount .amount.credit { color: var(--accent-green); }
        .history-amount .amount.debit { color: var(--due-red); }
        .history-amount .amount.rejected { color: var(--due-red); }
        .history-amount .status { font-size: 12px; text-transform: capitalize; }
        
        /* --- Modals --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); display: none; 
            justify-content: center; align-items: center; z-index: 1000; padding: 15px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background-color: var(--bg-card); padding: 25px; border-radius: 16px; 
            width: 100%; max-width: 400px; position: relative;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .modal-content h3 { text-align: center; font-size: 20px; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: #e8eef3; color: var(--text-primary); }
        #password-verification-modal { z-index: 1001; }
        
        #profile-modal .modal-content { padding-top: 15px; }
        #modal-profile-img-container { text-align: center; margin-bottom: 15px; position: relative; }
        #modal-profile-img {
            width: 80px; height: 80px; border-radius: 50%;
            object-fit: cover; border: 3px solid var(--brand-red);
            cursor: pointer; transition: transform 0.2s;
        }
        #modal-profile-img:hover { transform: scale(1.05); }
        #edit-profile-pic-icon {
            position: absolute; bottom: 0; right: calc(50% - 40px);
            background-color: var(--text-primary); color: white;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--bg-card); cursor: pointer;
        }
        #edit-profile-pic-icon svg { width: 14px; height: 14px; }
        #profile-modal #logout-btn { background-color: var(--text-secondary); margin-top: 20px; }
        #scanner-container { width: 100%; max-width: 250px; aspect-ratio: 1/1; margin: 0 auto 15px; border-radius: 10px; overflow: hidden; background: #000; }
        #scanner-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- Professional Success & Details Modals --- */
        .professional-modal .modal-content { padding: 30px; max-width: 380px; text-align: center; }
        .professional-modal .success-icon {
            width: 80px; height: 80px; background-color: var(--accent-green);
            border-radius: 50%; margin: 0 auto 20px auto; display: flex;
            align-items: center; justify-content: center;
        }
        .professional-modal .success-icon svg { width: 40px; height: 40px; stroke: white; stroke-width: 4; }
        .professional-modal h2 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .professional-modal .amount { font-size: 36px; font-weight: 700; color: var(--brand-red); margin-bottom: 25px; }
        .professional-modal .details-box {
            background-color: var(--bg-page); border-radius: 12px; padding: 15px;
            text-align: left; margin-bottom: 30px;
        }
        .professional-modal .detail-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px; }
        .professional-modal .detail-item:last-child { margin-bottom: 0; }
        .professional-modal .detail-item .label { color: var(--text-secondary); }
        .professional-modal .detail-item .value { font-weight: 600; }
        .professional-modal .action-btn { width: 100%; }
        
        #transaction-details-modal hr { border: none; height: 1px; background-color: var(--border-color); margin-bottom: 20px; }
        #transaction-details-modal .details-list { display: flex; flex-direction: column; gap: 15px; text-align: left; margin-bottom: 30px; }
        #transaction-details-modal .status-badge {
            background-color: #e9f7ef; color: var(--accent-green); padding: 4px 12px;
            border-radius: 15px; font-size: 13px; font-weight: 600;
        }
        #transaction-details-modal .status-badge.pending { background-color: #fff4e5; color: #f39c12; }
        #transaction-details-modal .status-badge.rejected { background-color: #ffebee; color: #c0392b; }
        #transaction-details-modal .action-btn { background-color: var(--text-secondary); }

        .modal-close-btn { 
            position: absolute; top: 10px; right: 15px; 
            background: transparent; border: none; 
            font-size: 28px; font-weight: bold;
            cursor: pointer; color: #aaa; line-height: 1; padding: 0;
        }
        .modal-close-btn:hover { color: #000; }
        
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--text-primary); color: white; padding: 12px 25px; border-radius: 25px; font-size: 15px; z-index: 2000; transition: bottom 0.5s ease; }
        .toast-notification.show { bottom: 30px; }

        /* --- Network View Styles (SVG UPGRADE) --- */
        #network-view { 
            display: none;
            flex-direction: column; 
            height: 100vh; 
            padding: 0; 
            background-color: var(--bg-page);
        }
        .network-header {
            display: grid; grid-template-columns: auto 1fr auto; align-items: center;
            gap: 15px; padding: 10px 15px;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            background-color: var(--bg-card);
        }
        .network-header h1 { font-size: 18px; font-weight: 600; margin: 0; text-align: center; }
        .network-header .header-action { display: flex; cursor: pointer; align-items: center; justify-content: center; }
        .network-header .header-action svg { width: 24px; height: 24px; stroke: var(--text-secondary); }
        
        .network-tabs { display: flex; gap: 10px; padding: 15px; flex-shrink: 0; background-color: var(--bg-card); border-bottom: 1px solid var(--border-color);}
        .network-tab-btn { flex: 1; padding: 10px; font-size: 14px; font-weight: 600; border: 1px solid var(--border-color); background-color: var(--bg-card); color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .network-tab-btn.active { background-color: var(--brand-red); color: white; border-color: var(--brand-red); }
        
        .network-content-container { flex-grow: 1; overflow: hidden; position: relative; }
        .network-tab-content { display: none; width: 100%; height: 100%; }
        .network-tab-content.active { display: block; }

        #downline-content { cursor: grab; }
        #downline-content:active { cursor: grabbing; }
        #network-tree-container { width: 100%; height: 100%; transform-origin: 0 0; transition: transform 0.2s ease-out; }
        .network-tree { display: inline-flex; flex-direction: column; align-items: center; padding: 40px; min-width: 100%; min-height: 100%; }
        
        .network-node { 
            display: flex; flex-direction: column; align-items: center; 
            position: relative; padding: 20px 5px 0 5px; 
            z-index: 1;
        }
        .network-node > .node-content { 
            display: flex; flex-direction: column; align-items: center; text-align: center;
            padding: 5px; border-radius: 8px;
            transition: background-color 0.2s;
        }
        .network-node > .node-content:hover {
            background-color: rgba(0,0,0,0.04);
        }

        .node-avatar {
            width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--brand-red); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 600;
            border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            margin-bottom: 8px; overflow: hidden;
        }
        .node-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .node-name { font-weight: 600; font-size: 14px; }
        .node-earning { font-size: 12px; color: var(--accent-green); font-weight: 500;}
        
        .node-children { 
            display: flex; justify-content: center; 
            position: relative; padding-top: 50px; 
        }
        /* NEW: SVG container for lines */
        .node-children .connector-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: visible;
            z-index: -1;
        }

        .commission-badge { position: absolute; top: 25px; left: calc(50% + 5px); background-color: var(--text-secondary); color: white; padding: 2px 6px; font-size: 10px; border-radius: 5px; font-weight: 600; z-index: 1; }

        #upline-list { display: flex; flex-direction: column-reverse; align-items: center; padding: 20px; gap: 15px; }
        .upline-member { display: flex; flex-direction: column; align-items: center; position: relative; }
        .upline-member .node-content { text-align: center; }
        .upline-member .node-avatar { width: 70px; height: 70px; font-size: 28px; }
        .upline-member.current-user .node-avatar { background-color: var(--brand-blue); }
        .upline-member .node-name { font-size: 15px; }
        .upline-member .node-earning { font-size: 13px; color: var(--text-secondary); }
        .upline-member:not(:first-child)::after { content: ''; width: 2px; height: 15px; background-color: #ccc; position: absolute; bottom: -15px; }
        .upline-commission { position: absolute; bottom: -28px; left: 10px; font-size: 12px; color: var(--text-secondary); font-weight: 600; }

        #network-loader, .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }

        /* --- Notification Center (Popup) Styles --- */
        #notification-center-modal .modal-content {
            width: 100%; height: 100%; max-width: 100%; max-height: 100%;
            border-radius: 0; padding: 0; display: flex; flex-direction: column;
            background-color: var(--bg-page);
        }
        .notification-center-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; background-color: var(--bg-card);
        }
        .notification-center-header h1 { font-size: 18px; font-weight: 600; margin: 0; }
        #notification-center-close-btn { font-size: 28px; line-height: 1; color: #aaa; background: none; border: none; padding: 0; cursor: pointer; }
        #notification-center-list {
            flex-grow: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .notification-center-item {
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
        }
        .notification-center-item .title {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.4;
            word-break: break-all;
        }
        .notification-center-item .title a {
            color: var(--link-blue) !important;
            text-decoration: underline;
        }
        .notification-center-item .percentage { font-size: 40px; font-weight: 800; margin-top: 10px; }
        .notification-center-item .paragraph {
            font-size: 14px;
            color: inherit; /* Inherits color from parent */
            opacity: 0.9;
            margin-top: 15px;
            line-height: 1.6;
            white-space: pre-wrap; /* Respects new lines */
        }

        #popup-notification {
            position: fixed; top: -200px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 450px;
            padding: 15px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            display: flex; align-items: center; justify-content: space-between;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #popup-notification.show { top: 20px; }
        .popup-notification-content { display: flex; align-items: center; gap: 15px; }
        .popup-notification-icon { font-size: 28px; font-weight: 800; }
        .popup-notification-text .title { font-size: 14px; font-weight: 600; }
        .popup-notification-text .percentage { font-size: 24px; font-weight: 800; }
        #popup-notification-close { background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.7; padding: 0; line-height: 1; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login and Registration Views -->
        <div id="login-view" class="view active">
            <div class="auth-container">
                <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone Logo" class="main-logo">
                <h1>Customer Login</h1>
                <form id="login-form">
                    <div class="form-group"><label for="login-mobile">Mobile Number</label><input type="tel" id="login-mobile" required></div>
                    <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                    <button type="submit">Login</button><p id="login-error-msg" class="error-message"></p>
                </form>
                <p class="form-link">Naye user? <a href="#" id="show-register-link">Yahan register karein</a></p>
            </div>
        </div>

        <div id="registration-view" class="view">
            <div class="auth-container">
                 <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone Logo" class="main-logo">
                 <h1>Register New Account</h1>
                <form id="register-form">
                    <div class="form-group"><label for="reg-name">Poora Naam</label><input type="text" id="reg-name" required></div>
                    <div class="form-group"><label for="reg-mobile">Mobile Number</label><input type="tel" id="reg-mobile" required></div>
                    <div class="form-group"><label for="reg-password">Password</label><input type="password" id="reg-password" required></div>
                    <div class="form-group"><label for="reg-referral">Referral Code (Optional)</label><input type="text" id="reg-referral"></div>
                    <button type="submit">Register Karein</button><p id="register-error-msg" class="error-message"></p>
                </form>
                <p class="form-link">Pehle se account hai? <a href="#" id="show-login-link">Yahan login karein</a></p>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <div class="header">
                <div id="static-notification-card">
                    <div class="notification-content-wrapper">
                        <div class="notification-text-container">
                            <span class="notification-text-line notification-text-line1"></span>
                            <span class="notification-text-line notification-text-line2"></span>
                        </div>
                        <div class="notification-percentage"></div>
                    </div>
                </div>
                <a href="https://ramazone.in" target="_blank">
                    <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone" class="header-logo">
                </a>
            </div>
            
            <div class="wallet-card">
                <div id="wallet-profile-icon-container">
                    <img id="wallet-profile-img" src="https://placehold.co/45x45/ffffff/e50914?text=R" alt="Profile">
                </div>
                <h3 id="wallet-user-name">User Name</h3>
                <p class="wallet-balance-label">Available Balance</p>
                <p id="wallet-balance">₹ 0.00</p>
                <div class="wallet-footer">
                    <div class="wallet-footer-item"><p>Lifetime Earning</p><span id="lifetime-earning" class="amount">₹0.00</span></div>
                    <div id="wallet-share-btn" title="Share App"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></div>
                    <div class="wallet-footer-item"><p>Total Credit</p><span id="credit-limit" class="amount">₹0.00</span></div>
                    <div class="wallet-sub-items">
                        <div class="wallet-footer-item"><p>Due Amount</p><span id="due-amount" class="amount" style="color: var(--due-red);">₹0.00</span></div>
                    </div>
                </div>
                <div id="wallet-referral-container">
                    <span id="wallet-referral-id">REF-CODE</span>
                    <button id="copy-referral-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                </div>
            </div>

            <div class="dashboard-actions">
                <div id="open-cashback-modal" class="action-card"><img class="icon" src="https://www.svgrepo.com/show/499839/money.svg"><span class="card-text">Cashback</span></div>
                <div id="scan-and-pay-btn" class="action-card"><img class="icon" src="https://www.svgrepo.com/show/503562/scan-qrcode.svg"><span class="card-text">RMZ Pay</span></div>
                <div id="open-network-view" class="action-card">
                    <img class="icon" src="https://www.svgrepo.com/show/228705/collaboration-team.svg">
                    <span class="card-text">Network</span>
                </div>
                <div id="whatsapp-support-btn" class="action-card"><img class="icon" src="https://www.svgrepo.com/show/452133/whatsapp.svg"><span class="card-text">Support</span></div>
                <div id="open-credit-request-modal" class="action-card">
                    <img class="icon" src="https://www.svgrepo.com/show/513295/credit-card.svg">
                    <span class="card-text">Credit Request</span>
                </div>
                <div id="open-notification-center-btn" class="action-card">
                    <div class="notification-content-wrapper">
                        <div class="notification-text-container">
                            <span class="notification-text-line notification-text-line1"></span>
                            <span class="notification-text-line notification-text-line2"></span>
                        </div>
                        <div class="notification-percentage"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">All Transactions</h2>
                <div id="transaction-summary">
                    <span class="summary-label">Total Amount</span>
                    <span class="summary-amount">₹0.00</span>
                </div>
                <div class="filter-bar" id="filter-bar">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="cashback">Cashback</button>
                    <button class="filter-btn" data-filter="commission">Commission</button>
                    <button class="filter-btn" data-filter="payment">Payments</button>
                    <button class="filter-btn" data-filter="credit">Credit</button>
                    <button class="filter-btn" data-filter="due_payment">Due Paid</button>
                </div>
                <div id="unified-history-list" class="history-list"></div>
            </div>
        </div>
        
        <!-- Network View -->
        <div id="network-view" class="view">
            <div class="network-header">
                <div id="network-nav-btn" class="header-action" title="Back to Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </div>
                <h1 id="network-title">My Network</h1>
                <div id="network-refresh-btn" class="header-action" title="Refresh Network">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </div>
            </div>
            <div class="network-tabs">
                <button class="network-tab-btn active" data-tab="downline">My Team</button>
                <button class="network-tab-btn" data-tab="upline">My Sponsor</button>
            </div>
            <div class="network-content-container">
                <div id="downline-content" class="network-tab-content active">
                    <div id="network-tree-container"></div>
                    <div id="network-loader">Loading your network...</div>
                </div>
                <div id="upline-content" class="network-tab-content">
                    <div id="upline-list"></div>
                    <div id="upline-loader">Loading your upline...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- All Modals -->
    <div id="password-verification-modal" class="modal-overlay"> <div class="modal-content"> <h3>Verify Your Identity</h3><p style="text-align:center; font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">Please enter your password to continue.</p><div class="form-group"><label for="verification-password">Password</label><input type="password" id="verification-password" required></div><p id="verification-error-msg" class="error-message"></p><div class="modal-actions"><button type="button" class="btn-secondary" data-close-modal>Cancel</button><button id="verification-confirm-btn" class="btn-primary">Confirm</button></div></div> </div>
    <div id="cashback-modal" class="modal-overlay"> <div class="modal-content"> <h3>Cashback Request</h3><form id="cashback-request-form"><div class="form-group"><label for="product-name">Product ka Naam</label><input type="text" id="product-name" required></div><div class="form-group"><label for="product-price">Product ka Price (₹)</label><input type="number" id="product-price" min="10" required></div><p id="cashback-error-msg" class="error-message"></p><div class="modal-actions"><button type="button" class="btn-secondary" data-close-modal>Cancel</button><button type="submit" id="cashback-submit-btn">Request</button></div></form></div> </div>
    
    <div id="credit-request-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Credit Request</h3>
            <form id="credit-request-form">
                <div class="form-group">
                    <label for="credit-amount">Amount (₹)</label>
                    <input type="number" id="credit-amount" min="1" max="100" required>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Pehli baar maximum ₹100 ka anurodh kar sakte hain.</p>
                </div>
                <p id="credit-error-msg" class="error-message"></p>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                    <button type="submit" id="credit-submit-btn">Request Credit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="scan-pay-modal" class="modal-overlay"> <div class="modal-content"> <h3>Scan QR and Pay</h3> <div id="scanner-container"><video id="scanner-video" playsinline></video></div><input type="file" id="qr-file-input" accept="image/*" style="display: none;"><button id="upload-qr-btn" class="btn-secondary" style="width:100%; margin-top: 15px;">Upload QR Image</button><p id="scanner-status" style="text-align:center; margin-top:10px;">Scanning...</p> <div id="payment-form" style="display: none;"> <p style="text-align:center;">Paying to: <span id="receiver-id-display"></span></p> <div class="form-group"><label for="payment-amount">Amount (₹)</label><input type="number" id="payment-amount" min="5" required></div> <p id="payment-error-msg" class="error-message"></p> <div class="modal-actions"><button type="button" id="rescan-btn" class="btn-secondary">Scan Again</button><button id="pay-submit-btn" class="btn-primary">Pay Now</button></div> </div> <div id="scan-pay-initial-actions" class="modal-actions"><button type="button" class="btn-secondary" data-close-modal>Cancel</button></div> </div> </div>
    
    <div id="profile-modal" class="modal-overlay"> 
        <div class="modal-content"> 
            <div id="modal-profile-img-container">
                <img id="modal-profile-img" src="https://placehold.co/80x80/e50914/FFFFFF?text=R" alt="Profile Picture">
                <div id="edit-profile-pic-icon" title="Change Profile Picture">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </div>
            </div>
            <h3>My Profile</h3> 
            <div id="profile-payment-id-container"><p style="font-size: 12px; text-align: center; color: var(--text-secondary);">Your Payment ID</p><div id="profile-payment-id" style="text-align:center; font-weight:600;"></div></div> 
            <div id="profile-referral-id-container" style="margin-top: 15px;"><p style="font-size: 12px; text-align: center; color: var(--text-secondary);">Your Referral Code</p><div id="profile-referral-id" style="text-align:center; font-weight:600;"></div></div> 
            <form id="password-change-form" style="margin-top: 20px;"> 
                <div class="form-group"><label for="current-password">Purana Password</label><input type="password" id="current-password" required></div> 
                <div class="form-group"><label for="new-password">Naya Password</label><input type="password" id="new-password" required></div> 
                <button type="submit" id="password-change-btn">Password Badlein</button><p id="password-change-error-msg" class="error-message"></p> 
            </form> 
            <button id="logout-btn" style="width:100%; margin-top: 15px;" class="btn-secondary">Logout</button> 
            <div class="modal-actions" style="margin-top:10px;"><button type="button" class="btn-secondary" data-close-modal>Close</button></div> 
        </div> 
    </div>

    <!-- Notification Center Modal -->
    <div id="notification-center-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="notification-center-header">
                <h1>Latest Offers</h1>
                <button id="notification-center-close-btn" data-close-modal>&times;</button>
            </div>
            <div id="notification-center-list">
                <!-- Notifications will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <div id="profile-picture-modal" class="modal-overlay">
        <div class="modal-content" style="padding: 10px; background-color: transparent; text-align: center; box-shadow: none; width: auto;">
            <button class="modal-close-btn" data-close-modal style="color: white; font-size: 36px; top: 0px; right: 5px; text-shadow: 0 1px 3px black;">&times;</button>
            <img id="full-profile-img" src="" alt="Profile Picture" style="max-width: 90vw; max-height: 80vh; border-radius: 16px;">
        </div>
    </div>

    <!-- Professional Success Modal -->
    <div id="payment-success-modal" class="modal-overlay professional-modal">
        <div class="modal-content">
            <div class="success-icon">
                <svg viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 27.2L21.84 35L38 19" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <h2>Payment Successful!</h2>
            <p class="amount" id="success-modal-amount"></p>
            <div class="details-box">
                <div class="detail-item">
                    <span class="label">Paid to</span>
                    <span class="value" id="success-modal-receiver"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Transaction ID</span>
                    <span class="value" id="success-modal-txn-id"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Date & Time</span>
                    <span class="value" id="success-modal-datetime"></span>
                </div>
            </div>
            <button class="action-btn" data-close-modal style="background-color: var(--brand-red); color: white;">Done</button>
        </div>
    </div>

    <!-- Professional Transaction Details Modal -->
    <div id="transaction-details-modal" class="modal-overlay professional-modal">
        <div class="modal-content">
            <p class="amount" id="details-modal-amount"></p>
            <hr>
            <div class="details-list">
                <div class="detail-item">
                    <span class="label">Status</span>
                    <span class="value status-badge" id="details-modal-status"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Description</span>
                    <span class="value" id="details-modal-desc"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Date</span>
                    <span class="value" id="details-modal-date"></span>
                </div>
                 <div class="detail-item">
                    <span class="label">Time</span>
                    <span class="value" id="details-modal-time"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Transaction ID</span>
                    <span class="value" id="details-modal-txn-id"></span>
                </div>
            </div>
            <button class="action-btn" data-close-modal>Close</button>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification"></div>

    <div id="popup-notification">
        <div class="popup-notification-content">
            <div class="popup-notification-icon">🔥</div>
            <div class="popup-notification-text">
                <div class="title" id="popup-notification-title"></div>
                <div class="percentage" id="popup-notification-percentage"></div>
            </div>
        </div>
        <button id="popup-notification-close">&times;</button>
    </div>

    <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy, runTransaction, increment, limit, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCmgMr4cj7ec1B09eu3xpRhCwsVCeQR9v0",
            authDomain: "tipsplit-e3wes.firebaseapp.com",
            projectId: "tipsplit-e3wes",
            storageBucket: "tipsplit-e3wes.appspot.com",
            appId: "1:984733883633:web:adc1e1d22b629a6b631d50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserData = null;
        let activeListeners = [];
        let scannerAnimation = null;
        let allTransactions = [];
        let cashbackRequests = [];
        let creditRequests = [];
        let activeFilter = 'all';
        let pendingAction = null;
        let isUplineLoaded = false;
        let lastShownNotificationId = null;
        let popupTimeout = null;
        const commissionRates = [30, 25, 20, 15, 10];
        
        let networkHistory = []; 
        const networkTitleEl = document.getElementById('network-title');

        const showToast = (message) => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const toggleView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const view = document.getElementById(viewId);
            if (view) {
                view.classList.add('active');
                document.body.style.overflowY = (viewId === 'network-view') ? 'hidden' : 'auto';
            }
        };
        const openModal = (modalId) => document.getElementById(modalId)?.classList.add('active');
        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
            if (modalId === 'scan-pay-modal') stopScanner();
        };
        const showErrorMessage = (element, message) => { if (element) { element.textContent = message; element.style.display = 'block'; } };
        const hideErrorMessage = (element) => { if (element) { element.style.display = 'none'; } };
        
        const showSuccessPopup = (details) => {
            document.getElementById('success-modal-amount').textContent = `- ₹${details.amount.toFixed(2)}`;
            document.getElementById('success-modal-receiver').textContent = details.receiver;
            document.getElementById('success-modal-txn-id').textContent = details.txnId;
            document.getElementById('success-modal-datetime').textContent = details.datetime;
            openModal('payment-success-modal');
        };

        const showTransactionDetails = (item) => {
            const amount = item.amount || item.cashbackAmount || 0;
            const sign = amount >= 0 ? '+' : '-';
            const typeClass = amount >= 0 ? 'credit' : 'debit';
            
            document.getElementById('details-modal-amount').textContent = `${sign} ₹${Math.abs(amount).toFixed(2)}`;
            document.getElementById('details-modal-amount').style.color = typeClass === 'credit' ? 'var(--accent-green)' : 'var(--brand-red)';
            
            const statusEl = document.getElementById('details-modal-status');
            statusEl.textContent = item.status || 'Completed';
            statusEl.className = 'value status-badge';
            if (item.status) statusEl.classList.add(item.status);

            document.getElementById('details-modal-desc').textContent = item.description;
            document.getElementById('details-modal-date').textContent = item.date ? item.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';
            document.getElementById('details-modal-time').textContent = item.date ? item.date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';
            document.getElementById('details-modal-txn-id').textContent = item.id;
            
            openModal('transaction-details-modal');
        };

        onAuthStateChanged(auth, user => {
            if (user && user.displayName) {
                currentUser = user;
                toggleView('dashboard-view');
                attachRealtimeListeners(user);
            } else if (!user) {
                detachAllListeners();
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    toggleView('registration-view');
                    const referralInput = document.getElementById('reg-referral');
                    if (referralInput) {
                        referralInput.value = refCode.toUpperCase();
                    }
                } else {
                    toggleView('login-view');
                }
            }
        });

        function attachRealtimeListeners(user) {
            detachAllListeners();
            const uid = user.uid;
            const userUnsubscribe = onSnapshot(doc(db, 'users', uid), (doc) => {
                if (doc.exists()) {
                    currentUserData = { id: doc.id, ...doc.data() };
                    updateDashboardUI(currentUserData, user);
                }
            });
            const transUnsubscribe = onSnapshot(query(collection(db, "transactions"), where("involvedUsers", "array-contains", uid), orderBy("timestamp", "desc")), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                combineAndRenderHistory();
            });
            const cashbackRequestsUnsubscribe = onSnapshot(query(collection(db, "cashback_requests"), where("userId", "==", uid), orderBy("requestDate", "desc")), (snapshot) => {
                cashbackRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                combineAndRenderHistory();
            });
            const creditRequestsUnsubscribe = onSnapshot(query(collection(db, "credit_requests"), where("userId", "==", uid), orderBy("requestDate", "desc")), (snapshot) => {
                creditRequests = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                combineAndRenderHistory();
            });
            const latestNotificationUnsubscribe = onSnapshot(query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(1)), (snapshot) => {
                if (!snapshot.empty) {
                    const latestNotif = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    updateNotificationUI(latestNotif);
                } else {
                    updateNotificationUI(null);
                }
            });
            const allNotificationsUnsubscribe = onSnapshot(query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(5)), (snapshot) => {
                renderNotificationCenter(snapshot);
            });
            activeListeners.push(userUnsubscribe, transUnsubscribe, cashbackRequestsUnsubscribe, creditRequestsUnsubscribe, latestNotificationUnsubscribe, allNotificationsUnsubscribe);
        }

        function detachAllListeners() {
            activeListeners.forEach(unsub => unsub());
            activeListeners = [];
        }

        function updateDashboardUI(dbData, authUser) {
            const profilePicUrl = dbData.profilePictureUrl || `https://placehold.co/80x80/e50914/FFFFFF?text=${authUser.displayName.charAt(0)}`;
            document.getElementById('wallet-user-name').textContent = authUser.displayName;
            document.getElementById('wallet-profile-img').src = profilePicUrl;
            document.getElementById('modal-profile-img').src = profilePicUrl;
            document.getElementById('wallet-balance').textContent = `₹ ${(dbData.wallet || 0).toFixed(2)}`;
            document.getElementById('lifetime-earning').textContent = `₹ ${(dbData.lifetimeEarning || 0).toFixed(2)}`;
            document.getElementById('credit-limit').textContent = `₹ ${(dbData.totalCreditGiven || 0).toFixed(2)}`;
            document.getElementById('due-amount').textContent = `₹ ${(dbData.dueAmount || 0).toFixed(2)}`;
            document.getElementById('profile-payment-id').textContent = `${dbData.mobile}@RMZ`;
            document.getElementById('profile-referral-id').textContent = dbData.referralId || 'N/A';
            document.getElementById('wallet-referral-id').textContent = dbData.referralId || 'N/A';
        }

        function updateNotificationUI(notifData) {
            const topNotifCard = document.getElementById('static-notification-card');
            const thumbNotifCard = document.getElementById('open-notification-center-btn');

            if (!notifData) {
                topNotifCard.classList.remove('visible');
                thumbNotifCard.querySelector('.notification-content-wrapper').style.opacity = 0;
                return;
            }

            const updateElement = (card, title, percentage, animate) => {
                const [text1, text2 = ''] = (title || '').split('|').map(t => t.trim());
                const wrapper = card.querySelector('.notification-content-wrapper');
                const line1 = wrapper.querySelector('.notification-text-line1');
                const line2 = wrapper.querySelector('.notification-text-line2');
                const percentEl = wrapper.querySelector('.notification-percentage');

                line1.textContent = text1;
                line2.textContent = text2;
                percentEl.textContent = `${percentage}%`;
                
                wrapper.classList.remove('animate');
                void wrapper.offsetWidth; // Trigger reflow

                if (animate) {
                    wrapper.classList.add('animate');
                } else {
                    wrapper.style.opacity = 1;
                    line1.style.width = 'auto';
                    line2.style.width = 'auto';
                    percentEl.style.transform = 'scale(1)';
                }
            };
            
            topNotifCard.style.backgroundColor = notifData.mainBgColor || 'var(--brand-red)';
            topNotifCard.style.color = notifData.mainTextColor || 'white';
            topNotifCard.style.setProperty('--notification-border-color', notifData.mainBorderColor || 'transparent');
            topNotifCard.style.setProperty('--notification-border-width', notifData.mainBorderWidth ? `${notifData.mainBorderWidth}px` : '0px');
            updateElement(topNotifCard, notifData.mainTitle, notifData.mainPercentage, notifData.mainAnimation !== false);
            topNotifCard.classList.add('visible');

            thumbNotifCard.style.backgroundColor = notifData.thumbnailBgColor || 'var(--bg-card)';
            thumbNotifCard.style.color = notifData.thumbnailTextColor || 'var(--text-primary)';
            thumbNotifCard.style.setProperty('--thumbnail-border-color', notifData.thumbnailBorderColor || 'var(--border-color)');
            thumbNotifCard.style.setProperty('--thumbnail-border-width', notifData.thumbnailBorderWidth ? `${notifData.thumbnailBorderWidth}px` : '1px');
            updateElement(thumbNotifCard, notifData.thumbnailTitle, notifData.thumbnailPercentage, notifData.thumbnailAnimation !== false);

            if (notifData.id !== lastShownNotificationId) {
                lastShownNotificationId = notifData.id;
                showPopupNotification(notifData);
            }
        }

        function renderNotificationCenter(snapshot) {
            const listEl = document.getElementById('notification-center-list');
            listEl.innerHTML = ''; 
            if (snapshot.empty) {
                listEl.innerHTML = '<p class="empty-state">No new offers right now.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const notif = doc.data();
                const item = document.createElement('div');
                item.className = 'notification-center-item';
                item.style.backgroundColor = notif.mainBgColor;
                item.style.color = notif.mainTextColor;

                const linkify = (text) => {
                    if (!text) return '';
                    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                    return text.replace(urlRegex, (url) => {
                        let href = url;
                        if (!href.match(/^[a-zA-Z]+:\/\//)) {
                            href = 'http://' + href;
                        }
                        return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color: inherit;">${url}</a>`;
                    });
                };

                const paragraphHTML = notif.mainParagraph ? `<p class="paragraph">${linkify(notif.mainParagraph)}</p>` : '';

                item.innerHTML = `
                    <div class="title">${linkify((notif.mainTitle || '').replace('|', '<br>'))}</div>
                    <div class="percentage">${notif.mainPercentage}%</div>
                    ${paragraphHTML}
                `;
                listEl.appendChild(item);
            });
        }
        
        function showPopupNotification(notifData) {
            if (popupTimeout) clearTimeout(popupTimeout);
            const popup = document.getElementById('popup-notification');
            popup.style.backgroundColor = notifData.mainBgColor;
            popup.style.color = notifData.mainTextColor;
            document.getElementById('popup-notification-title').textContent = (notifData.mainTitle || '').replace('|', ' ');
            document.getElementById('popup-notification-percentage').textContent = `${notifData.mainPercentage}%`;
            document.getElementById('popup-notification-close').style.color = notifData.mainTextColor;
            popup.classList.add('show');
            popupTimeout = setTimeout(() => popup.classList.remove('show'), 5000);
        }
        
        document.getElementById('popup-notification-close').addEventListener('click', () => {
            if (popupTimeout) clearTimeout(popupTimeout);
            document.getElementById('popup-notification').classList.remove('show');
        });

        function combineAndRenderHistory() {
            const formattedTransactions = allTransactions.map(t => ({ ...t, date: t.timestamp?.toDate(), isTransaction: true }));
            
            const formattedCashbackRequests = cashbackRequests
                .filter(r => r.status === 'pending' || r.status === 'rejected')
                .map(r => ({ ...r, description: `Cashback Request: ${r.productName}`, date: r.requestDate?.toDate(), type: 'cashback', isTransaction: false }));
            
            const formattedCreditRequests = creditRequests
                .filter(r => r.status === 'pending' || r.status === 'rejected')
                .map(r => ({ ...r, description: `Credit Request`, date: r.requestDate?.toDate(), type: 'credit_request', isTransaction: false, amount: r.amount }));

            const combined = [...formattedTransactions, ...formattedCashbackRequests, ...formattedCreditRequests].sort((a, b) => (b.date || 0) - (a.date || 0));
            renderUnifiedHistory(combined);
        }

        function renderUnifiedHistory(items) {
            const listEl = document.getElementById('unified-history-list');
            const summaryEl = document.getElementById('transaction-summary');
            const summaryAmountEl = summaryEl.querySelector('.summary-amount');
            const summaryLabelEl = summaryEl.querySelector('.summary-label');
            listEl.innerHTML = '';

            const itemsToRender = items.filter(item => {
                if (activeFilter === 'all') return true;
                if (activeFilter === 'cashback') {
                    return item.type === 'cashback';
                }
                if (activeFilter === 'credit') {
                    return item.type === 'credit' || item.type === 'due_payment';
                }
                return item.type === activeFilter;
            });

            if (itemsToRender.length > 0 && activeFilter !== 'all') {
                const total = itemsToRender.reduce((sum, item) => {
                    const amount = item.amount || item.cashbackAmount || 0;
                    return sum + Math.abs(amount);
                }, 0);
                
                const filterText = document.querySelector(`.filter-btn[data-filter="${activeFilter}"]`).textContent;
                summaryLabelEl.textContent = `Total ${filterText}`;
                summaryAmountEl.textContent = `₹ ${total.toFixed(2)}`;
                summaryEl.style.display = 'flex';
            } else {
                summaryEl.style.display = 'none';
            }

            if (itemsToRender.length === 0) {
                listEl.innerHTML = `<div class="empty-state" style="border:none; padding: 20px 0; text-align:center; color: var(--text-secondary);"><h4>No Transactions</h4></div>`;
                return;
            }

            itemsToRender.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.addEventListener('click', () => showTransactionDetails(item));

                const amount = item.amount || item.cashbackAmount || 0;
                let sign = '+';
                let typeClass = 'credit';
                
                if(item.type === 'due_payment' || item.type === 'payment' || item.amount < 0) { 
                    typeClass = 'debit'; 
                    sign = '-'; 
                }
                if (item.status === 'rejected' || item.status === 'refunded') { 
                    typeClass = 'rejected'; 
                }

                itemDiv.innerHTML = `
                    <div class="history-details">
                        <div class="history-info">
                            <div class="title">${item.description}</div>
                            <div class="date">${item.date ? item.date.toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="history-amount">
                        <div class="amount ${typeClass}">${sign} ₹${Math.abs(amount).toFixed(2)}</div>
                        <span class="status">${item.status || ''}</span>
                    </div>`;
                listEl.appendChild(itemDiv);
            });
        }

        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            const imgbbApiKey = "432d6a433181e46445ce5c5f643ba4d0"; 
            if (imgbbApiKey === "YOUR_IMGBB_API_KEY") { showToast("Image hosting is not configured."); return; }
            showToast("Uploading picture...");
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: "POST", body: formData });
                const result = await response.json();
                if (result.success) {
                    const imageUrl = result.data.url;
                    await updateDoc(doc(db, "users", currentUser.uid), { profilePictureUrl: imageUrl });
                    showToast("Profile picture updated!");
                } else { throw new Error(result.error.message || "Failed to upload image."); }
            } catch (error) {
                console.error("Image upload failed:", error);
                showToast("Upload failed. Please try again.");
            } finally { event.target.value = ''; }
        }

        function verifyPasswordAndExecute(action, sourceModalId) {
            if (sourceModalId) closeModal(sourceModalId);
            pendingAction = action;
            openModal('password-verification-modal');
        }

        async function handleVerificationConfirm() {
            const password = document.getElementById('verification-password').value;
            const errorMsg = document.getElementById('verification-error-msg');
            const confirmBtn = document.getElementById('verification-confirm-btn');
            hideErrorMessage(errorMsg);
            if (!password) return showErrorMessage(errorMsg, "Password is required.");

            confirmBtn.disabled = true; confirmBtn.textContent = "Verifying...";
            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, password);

            try {
                await reauthenticateWithCredential(user, credential);
                closeModal('password-verification-modal');
                if (pendingAction) await pendingAction();
            } catch (error) {
                showErrorMessage(errorMsg, "Incorrect password.");
            } finally {
                confirmBtn.disabled = false; confirmBtn.textContent = "Confirm";
                document.getElementById('verification-password').value = '';
                pendingAction = null;
            }
        }

        function handlePayment() {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const errorMsg = document.getElementById('payment-error-msg');
            hideErrorMessage(errorMsg);
            if (isNaN(amount) || amount < 5) return showErrorMessage(errorMsg, "Minimum payment is ₹5.");
            if (currentUserData.wallet < amount) return showErrorMessage(errorMsg, "Insufficient balance.");
            
            verifyPasswordAndExecute(async () => {
                try {
                    const newTxnRef = doc(collection(db, "transactions"));
                    await runTransaction(db, async (t) => {
                        const userRef = doc(db, "users", currentUserData.id);
                        const configRef = doc(db, "app_settings", "config");
                        t.update(userRef, { wallet: increment(-amount) });
                        t.update(configRef, { rmz_wallet_balance: increment(amount) });
                        t.set(newTxnRef, { type: 'payment', amount: -amount, description: 'Paid to Ramazone Store', status: 'completed', timestamp: serverTimestamp(), involvedUsers: [currentUserData.id] });
                        t.set(doc(collection(db, "rmz_wallet_transactions")), { amount, senderId: currentUserData.id, senderName: currentUserData.name, senderMobile: currentUserData.mobile, timestamp: serverTimestamp() });
                    });
                    const now = new Date();
                    showSuccessPopup({
                        amount: amount,
                        receiver: 'Ramazone Store',
                        txnId: newTxnRef.id,
                        datetime: `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`
                    });
                } catch (error) { showToast("Payment failed. Please try again."); }
            }, 'scan-pay-modal');
        }

        async function handleCashbackRequest(e) {
            e.preventDefault();
            const btn = document.getElementById('cashback-submit-btn');
            const errorMsg = document.getElementById('cashback-error-msg');
            hideErrorMessage(errorMsg);
            btn.disabled = true; btn.textContent = "Submitting...";
            const productName = document.getElementById("product-name").value.trim();
            const productPrice = parseFloat(document.getElementById("product-price").value);
            if (!productName || isNaN(productPrice) || productPrice < 10) {
                showErrorMessage(errorMsg, "Sahi details daalein.");
                btn.disabled = false; btn.textContent = "Request"; return;
            }
            try {
                const configDoc = await getDoc(doc(db, "app_settings", "config"));
                const cashbackPercentage = configDoc.exists() && configDoc.data().cashback_percentage ? configDoc.data().cashback_percentage : 2;
                const cashbackAmount = productPrice * (cashbackPercentage / 100);
                await addDoc(collection(db, "cashback_requests"), {
                    userId: currentUserData.id, userName: currentUserData.name, userMobile: currentUserData.mobile,
                    productName, productPrice, cashbackAmount, status: "pending", requestDate: serverTimestamp(), claimed: false
                });
                showToast(`Your cashback request for ₹${cashbackAmount.toFixed(2)} has been submitted.`);
                document.getElementById('cashback-request-form').reset();
                closeModal('cashback-modal');
            } catch (error) { 
                showErrorMessage(errorMsg, `Error: ${error.message}`);
            } finally {
                btn.disabled = false; btn.textContent = "Request";
            }
        }

        async function handleCreditRequest(e) {
            e.preventDefault();
            const btn = document.getElementById('credit-submit-btn');
            const errorMsg = document.getElementById('credit-error-msg');
            const amountInput = document.getElementById('credit-amount');
            hideErrorMessage(errorMsg);
            
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > 100) {
                showErrorMessage(errorMsg, "Amount 1 se 100 ke beech hona chahiye.");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Submitting...";

            verifyPasswordAndExecute(async () => {
                try {
                    await addDoc(collection(db, "credit_requests"), {
                        userId: currentUserData.id,
                        userName: currentUserData.name,
                        userMobile: currentUserData.mobile,
                        amount: amount,
                        status: "pending",
                        requestDate: serverTimestamp()
                    });
                    showToast(`₹${amount.toFixed(2)} ka credit request bhej diya gaya hai.`);
                    document.getElementById('credit-request-form').reset();
                } catch (error) {
                    showToast("Request fail ho gaya. Dobara try karein.");
                    console.error("Credit request error:", error);
                } finally {
                    closeModal('credit-request-modal');
                }
            }, 'credit-request-modal');
            
            btn.disabled = false;
            btn.textContent = "Request Credit";
        }


        async function handlePasswordChange(e) {
            e.preventDefault();
            const form = document.getElementById('password-change-form');
            const btn = document.getElementById('password-change-btn');
            const errorMsgEl = document.getElementById('password-change-error-msg');
            hideErrorMessage(errorMsgEl);

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            if (newPassword.length < 6) {
                showErrorMessage(errorMsgEl, "Naya password kam se kam 6 character ka hona chahiye.");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Updating...";

            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                const userRef = doc(db, "users", user.uid);
                await updateDoc(userRef, { password: newPassword });
                showToast("Password safaltapoorvak badal gaya!");
                form.reset();
                closeModal('profile-modal');
            } catch (error) {
                console.error("Password change failed:", error);
                if (error.code === 'auth/wrong-password') {
                    showErrorMessage(errorMsgEl, "Aapka purana password galat hai.");
                } else {
                    showErrorMessage(errorMsgEl, "Ek error aayi. Dobara try karein.");
                }
            } finally {
                btn.disabled = false;
                btn.textContent = "Password Badlein";
            }
        }

        function startScanner() {
            stopScanner();
            const video = document.getElementById('scanner-video');
            const statusEl = document.getElementById('scanner-status');
            document.getElementById('payment-form').style.display = 'none';
            document.getElementById('scan-pay-initial-actions').style.display = 'flex';
            statusEl.textContent = 'Starting camera...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                video.srcObject = stream;
                video.play();
                statusEl.textContent = 'Scanning for QR code...';
                scannerAnimation = requestAnimationFrame(tick);
            }).catch(() => statusEl.textContent = 'Could not access camera.');
            const tick = () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code && code.data === '@RamazoneStoreCashback') { handleSuccessfulScan(code.data); return; }
                }
                if (scannerAnimation) scannerAnimation = requestAnimationFrame(tick);
            };
        }
        function stopScanner() {
            if (scannerAnimation) cancelAnimationFrame(scannerAnimation);
            scannerAnimation = null;
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        function handleSuccessfulScan(data) {
            stopScanner();
            document.getElementById('receiver-id-display').textContent = data;
            document.getElementById('payment-form').style.display = 'block';
            document.getElementById('scan-pay-initial-actions').style.display = 'none';
            document.getElementById('scanner-status').textContent = 'QR Code Scanned!';
        }
        function handleQrUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const image = new Image();
                image.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width; canvas.height = image.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code && code.data === '@RamazoneStoreCashback') handleSuccessfulScan(code.data);
                    else showToast("No valid QR code found.");
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        function handleShare() {
            if (!currentUserData) return;
            const { referralId, name, lifetimeEarning } = currentUserData;
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${referralId}`;
            const shareText = `🎉 *Wow! Ek Zabardast Offer!* 🎉\n\nMai, *${name}*, Ramazone Cashback app se ab tak *₹${(lifetimeEarning || 0).toFixed(2)}* ki bachat ki hai! 🤑\n\nAap bhi is app ko use karein aur har khareed par dher saare paise bachayein. Miss mat karna! Mera code use karein: *${referralId}*\n\nAbhi join karein: ${referralLink}`;
            if (navigator.share) navigator.share({ text: shareText });
            else navigator.clipboard.writeText(shareText).then(() => showToast("Referral ID Copied!"));
        }
        function handleWhatsAppSupport() {
            if (!currentUserData) return showToast("Please wait for your data to load.");
            const { name, referralId, lifetimeEarning, mobile } = currentUserData;
            const message = `Name: ${name}\nMobile: ${mobile}\nReferral ID: ${referralId}\nLifetime Earning: ₹${(lifetimeEarning || 0).toFixed(2)}\n\nHelp Me`;
            const whatsappUrl = `https://wa.me/message/RUJS4JVH3AUAD1?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // --- NETWORK VIEW LOGIC (SVG UPGRADE) ---
        const networkLoader = document.getElementById('network-loader');
        const uplineLoader = document.getElementById('upline-loader');
        const downlineContainer = document.getElementById('downline-content');
        const treeContainer = document.getElementById('network-tree-container');

        async function loadUpline() {
            uplineLoader.style.display = 'block';
            const uplineListContainer = document.getElementById('upline-list');
            uplineListContainer.innerHTML = '';
            isUplineLoaded = false;
            try {
                const currentUserNode = createUplineNode({
                    name: currentUserData.name,
                    lifetimeEarning: currentUserData.lifetimeEarning,
                    profilePictureUrl: currentUserData.profilePictureUrl,
                    isCurrentUser: true
                });
                uplineListContainer.appendChild(currentUserNode);

                const uplineUIDs = currentUserData.upline || [];
                if (uplineUIDs.length === 0) {
                    uplineListContainer.insertAdjacentHTML('beforeend', '<div class="empty-state">Aapke paas koi upline nahi hai.</div>');
                    return;
                }
                
                const uplinePromises = uplineUIDs.map(async (uplineId, i) => {
                    const uplineDoc = await getDoc(doc(db, 'users', uplineId));
                    if (uplineDoc.exists()) {
                        const uplineData = uplineDoc.data();
                        const commissionPaid = await calculateCommissionPaidToUpline(uplineId);
                        return createUplineNode({
                            name: uplineData.name,
                            lifetimeEarning: commissionPaid,
                            profilePictureUrl: uplineData.profilePictureUrl,
                            level: i + 1
                        });
                    }
                    return null;
                });
                const uplineNodes = await Promise.all(uplinePromises);
                uplineNodes.forEach(node => { if (node) uplineListContainer.appendChild(node); });
                isUplineLoaded = true;
            } catch (error) {
                console.error("Error loading upline:", error);
                uplineListContainer.innerHTML = '<div class="empty-state">Upline load karne mein error hua.</div>';
            } finally {
                uplineLoader.style.display = 'none';
            }
        }

        function createUplineNode({ name, lifetimeEarning, profilePictureUrl, level, isCurrentUser = false }) {
            const node = document.createElement('div');
            node.className = 'upline-member';
            if (isCurrentUser) node.classList.add('current-user');

            const avatarHTML = profilePictureUrl ? `<img src="${profilePictureUrl}" alt="${name}">` : name.charAt(0).toUpperCase();
            let earningHTML = isCurrentUser ? `<div class="node-earning">Aap (Your Earning: ₹${(lifetimeEarning || 0).toFixed(2)})</div>` : `<div class="node-earning">Commission Paid: ₹${(lifetimeEarning || 0).toFixed(2)}</div>`;

            node.innerHTML = `
                <div class="node-content">
                    <div class="node-avatar">${avatarHTML}</div>
                    <div class="node-name">${name}</div>
                    ${earningHTML}
                </div>
                ${!isCurrentUser ? `<div class="upline-commission"><sup>${commissionRates[level-1]}%</sup></div>` : ''}
            `;
            return node;
        }

        async function updateNetworkTreeView(userId) {
            networkLoader.style.display = 'block';
            treeContainer.innerHTML = '';
            try {
                const rootUserDoc = await getDoc(doc(db, 'users', userId));
                if (!rootUserDoc.exists()) throw new Error("User not found");
                const rootUserData = rootUserDoc.data();
                
                networkTitleEl.textContent = rootUserData.name === currentUser.displayName ? "My Network" : `${rootUserData.name}'s Network`;

                const rootNode = await buildNetworkTree(userId, 0);
                const treeRoot = document.createElement('div');
                treeRoot.className = 'network-tree';
                
                if (rootNode) {
                    treeRoot.appendChild(rootNode);
                }
                
                treeContainer.appendChild(treeRoot);
                
                // Use a short timeout to allow the DOM to render before drawing SVG lines
                setTimeout(() => {
                    drawAllConnectors(treeRoot);
                    if (!rootNode || !rootNode.querySelector('.node-children')) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'empty-state';
                        emptyMessage.style.padding = '20px 0';
                        emptyMessage.textContent = `${rootUserData.name} ke network mein koi member nahi hai.`;
                        if (rootNode) rootNode.appendChild(emptyMessage);
                        else treeRoot.appendChild(emptyMessage);
                    }
                }, 50);

                updateNetworkNavButton();
            } catch (error) {
                console.error("Error loading downline:", error);
                treeContainer.innerHTML = '<div class="empty-state">Network load karne mein error hua.</div>';
            } finally {
                networkLoader.style.display = 'none';
            }
        }

        async function buildNetworkTree(userId, level) {
            if (level > 4) return null;
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) return null;
            const userData = userDoc.data();
            const node = createDownlineNode(userData, level);
            const referrals = await getDirectReferrals(userId);
            if (referrals.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'node-children';
                
                const referralPromises = referrals.map(member => buildNetworkTree(member.uid, level + 1));
                const childNodes = await Promise.all(referralPromises);
                childNodes.forEach(childNode => { if (childNode) childrenContainer.appendChild(childNode); });
                
                if (childrenContainer.hasChildNodes()) { 
                    // Add SVG element for drawing lines
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.classList.add('connector-svg');
                    childrenContainer.appendChild(svg);
                    node.appendChild(childrenContainer); 
                }
            }
            return node;
        }

        function createDownlineNode(userData, level) {
            const node = document.createElement('div');
            node.className = 'network-node';
            node.dataset.uid = userData.uid; // Store UID for easy access
            const avatarHTML = userData.profilePictureUrl ? `<img src="${userData.profilePictureUrl}" alt="${userData.name}">` : userData.name.charAt(0).toUpperCase();
            const earning = userData.lifetimeEarning || 0;
            
            const nodeContent = document.createElement('div');
            nodeContent.className = 'node-content';
            nodeContent.innerHTML = `
                <div class="node-avatar">${avatarHTML}</div>
                <div class="node-name">${userData.name}</div>
                <div class="node-earning">Earning: ₹${earning.toFixed(2)}</div>
            `;
            node.appendChild(nodeContent);

            if (level > 0) {
                const commissionBadge = document.createElement('div');
                commissionBadge.className = 'commission-badge';
                commissionBadge.innerHTML = `<sup>${commissionRates[level-1]}%</sup>`;
                node.appendChild(commissionBadge);
            }
            
            nodeContent.style.cursor = 'pointer';
            nodeContent.addEventListener('click', (e) => {
                e.stopPropagation();
                if (networkHistory[networkHistory.length - 1] === userData.uid) return;
                
                networkHistory.push(userData.uid);
                updateNetworkTreeView(userData.uid);
            });

            return node;
        }
        
        function drawAllConnectors(treeRoot) {
            const childrenGroups = treeRoot.querySelectorAll('.node-children');
            childrenGroups.forEach(group => {
                const parentNode = group.closest('.network-node');
                const svg = group.querySelector('.connector-svg');
                if (!parentNode || !svg) return;
                
                const children = Array.from(group.children).filter(el => el.classList.contains('network-node'));
                if (children.length === 0) return;

                const parentRect = parentNode.getBoundingClientRect();
                const groupRect = group.getBoundingClientRect();

                const startX = parentRect.left + parentRect.width / 2 - groupRect.left;
                const startY = parentNode.querySelector('.node-content').offsetHeight - 5;

                children.forEach(child => {
                    const childRect = child.getBoundingClientRect();
                    const endX = childRect.left + childRect.width / 2 - groupRect.left;
                    const endY = child.offsetTop;

                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    const controlY1 = startY + 30;
                    const controlY2 = endY - 30;
                    const d = `M ${startX} ${startY} C ${startX} ${controlY1}, ${endX} ${controlY2}, ${endX} ${endY}`;
                    
                    path.setAttribute("d", d);
                    path.setAttribute("stroke", "var(--network-line-color)");
                    path.setAttribute("stroke-width", "2");
                    path.setAttribute("fill", "none");
                    svg.appendChild(path);
                });
            });
        }

        function updateNetworkNavButton() {
            const navBtn = document.getElementById('network-nav-btn');
            if (networkHistory.length > 1) {
                navBtn.title = "Go Up One Level";
                navBtn.onclick = () => {
                    networkHistory.pop();
                    const prevUserId = networkHistory[networkHistory.length - 1];
                    updateNetworkTreeView(prevUserId);
                };
            } else {
                navBtn.title = "Back to Dashboard";
                navBtn.onclick = () => {
                    toggleView('dashboard-view');
                };
            }
        }
        
        let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
        function setTransform() { treeContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        downlineContainer.onmousedown = (e) => { e.preventDefault(); start = { x: e.clientX - pointX, y: e.clientY - pointY }; panning = true; };
        downlineContainer.onmouseup = () => panning = false;
        downlineContainer.onmouseleave = () => panning = false;
        downlineContainer.onmousemove = (e) => { e.preventDefault(); if (!panning) return; pointX = (e.clientX - start.x); pointY = (e.clientY - start.y); setTransform(); };
        downlineContainer.onwheel = (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale, ys = (e.clientY - pointY) / scale;
            const delta = (e.wheelDelta ? e.wheelDelta : -e.deltaY);
            (delta > 0) ? (scale *= 1.2) : (scale /= 1.2);
            scale = Math.min(Math.max(0.2, scale), 3);
            pointX = e.clientX - xs * scale; pointY = e.clientY - ys * scale;
            setTransform();
        };

        async function getDirectReferrals(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) return [];
                const referralId = userDoc.data().referralId;
                if (!referralId) return [];
                const q = query(collection(db, 'users'), where('referredBy', '==', referralId));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            } catch (error) { console.error("Error getting direct referrals:", error); return []; }
        }

        async function calculateCommissionPaidToUpline(uplineMemberId) {
            let totalCommission = 0;
            try {
                const q = query(collection(db, 'transactions'), where('involvedUsers', 'array-contains', uplineMemberId), where('type', '==', 'commission'), where('commissionFromUid', '==', currentUser.uid));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => { totalCommission += doc.data().amount; });
            } catch (error) { console.error("Error calculating commission paid:", error); }
            return totalCommission;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', e => {
                e.preventDefault();
                const mobile = document.getElementById('login-mobile').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, `${mobile}@ramazone.com`, password)
                    .catch(() => showErrorMessage(document.getElementById('login-error-msg'), "Galat mobile/password."));
            });
            
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const registerButton = e.target.querySelector('button');
                const errorMsgEl = document.getElementById('register-error-msg');
                hideErrorMessage(errorMsgEl);
                registerButton.disabled = true; registerButton.textContent = 'Registering...';
                const name = document.getElementById('reg-name').value.trim();
                const mobile = document.getElementById('reg-mobile').value.trim();
                const password = document.getElementById('reg-password').value;
                const referralCode = document.getElementById('reg-referral').value.trim().toUpperCase();
                if (!name || !mobile || password.length < 6) {
                    showErrorMessage(errorMsgEl, "Sahi naam, mobile number, aur kam se kam 6 character ka password daalein.");
                    registerButton.disabled = false; registerButton.textContent = 'Register Karein'; return;
                }
                let tempUser = null;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, `${mobile}@ramazone.com`, password);
                    tempUser = userCredential.user;
                    let upline = []; let referredBy = 'none';
                    if (referralCode) {
                        registerButton.textContent = 'Verifying Code...';
                        const q = query(collection(db, 'users'), where("referralId", "==", referralCode));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) {
                            await tempUser.delete();
                            showErrorMessage(errorMsgEl, "Aapka referral code galat hai.");
                            registerButton.disabled = false; registerButton.textContent = 'Register Karein'; return;
                        }
                        const referrerDoc = querySnapshot.docs[0];
                        const referrerData = referrerDoc.data();
                        referredBy = referralCode;
                        upline = [referrerDoc.id, ...(referrerData.upline || [])].slice(0, 5);
                    }
                    registerButton.textContent = 'Saving Data...';
                    await updateProfile(tempUser, { displayName: name });
                    const newUserDoc = {
                        uid: tempUser.uid, name, mobile, password, wallet: 0, lifetimeEarning: 0, totalCreditGiven: 0, dueAmount: 0,
                        referralId: `RMZC${Math.floor(100+Math.random()*900)}B${Math.floor(100+Math.random()*900)}`,
                        referredBy, upline, createdAt: serverTimestamp()
                    };
                    await setDoc(doc(db, 'users', tempUser.uid), newUserDoc);
                    await signOut(auth);
                    toggleView('login-view');
                    document.getElementById('login-form').reset();
                    document.getElementById('register-form').reset();
                    alert("Registration safal hua! Ab login karein.");
                } catch (error) {
                    console.error("Registration failed:", error);
                    if (tempUser) await tempUser.delete().catch(e => console.error("Failed to delete temp user", e));
                    let message = "Registration fail ho gaya. Dobara try karein.";
                    if (error.code === 'auth/email-already-in-use') message = "Yah mobile number pehle se register hai.";
                    showErrorMessage(errorMsgEl, message);
                } finally {
                    registerButton.disabled = false; registerButton.textContent = 'Register Karein';
                }
            });

            document.getElementById('show-register-link').addEventListener('click', e => { e.preventDefault(); toggleView('registration-view'); });
            document.getElementById('show-login-link').addEventListener('click', e => { e.preventDefault(); toggleView('login-view'); });
            document.getElementById('logout-btn').addEventListener('click', () => { closeModal('profile-modal'); signOut(auth); });
            document.getElementById('wallet-profile-icon-container').addEventListener('click', () => openModal('profile-modal'));
            document.getElementById('modal-profile-img').addEventListener('click', () => {
                document.getElementById('full-profile-img').src = document.getElementById('modal-profile-img').src;
                openModal('profile-picture-modal');
            });
            document.getElementById('edit-profile-pic-icon').addEventListener('click', () => document.getElementById('profile-picture-input').click());
            document.getElementById('profile-picture-input').addEventListener('change', handleProfilePictureUpload);
            document.getElementById('open-cashback-modal').addEventListener('click', () => openModal('cashback-modal'));
            
            document.getElementById('open-credit-request-modal').addEventListener('click', () => openModal('credit-request-modal'));
            document.getElementById('credit-request-form').addEventListener('submit', handleCreditRequest);

            document.getElementById('open-notification-center-btn').addEventListener('click', () => openModal('notification-center-modal'));

            document.getElementById('scan-and-pay-btn').addEventListener('click', () => { openModal('scan-pay-modal'); startScanner(); });
            document.getElementById('rescan-btn').addEventListener('click', startScanner);
            document.getElementById('pay-submit-btn').addEventListener('click', handlePayment);
            document.getElementById('wallet-share-btn').addEventListener('click', handleShare);
            document.getElementById('copy-referral-btn').addEventListener('click', () => { navigator.clipboard.writeText(currentUserData.referralId).then(() => showToast("Referral ID Copied!")); });
            document.getElementById('whatsapp-support-btn').addEventListener('click', handleWhatsAppSupport);
            document.getElementById('cashback-request-form').addEventListener('submit', handleCashbackRequest);
            document.getElementById('upload-qr-btn').addEventListener('click', () => document.getElementById('qr-file-input').click());
            document.getElementById('qr-file-input').addEventListener('change', handleQrUpload);
            document.getElementById('verification-confirm-btn').addEventListener('click', handleVerificationConfirm);
            
            document.getElementById('password-change-form').addEventListener('submit', handlePasswordChange);

            document.getElementById('filter-bar').addEventListener('click', e => {
                const target = e.target.closest('.filter-btn');
                if (!target) return;
                document.querySelector('#filter-bar .active')?.classList.remove('active');
                target.classList.add('active');
                activeFilter = target.dataset.filter;
                combineAndRenderHistory();
            });
            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay').id)));

            document.getElementById('open-network-view').addEventListener('click', () => {
                toggleView('network-view');
                const activeTab = document.querySelector('.network-tab-btn.active').dataset.tab;
                if (activeTab === 'downline') {
                    networkHistory = [currentUser.uid];
                    updateNetworkTreeView(currentUser.uid);
                } else if (activeTab === 'upline' && !isUplineLoaded) {
                    loadUpline();
                }
            });
            
            document.getElementById('network-refresh-btn').addEventListener('click', () => {
                const activeTab = document.querySelector('#network-view .network-tab-btn.active').dataset.tab;
                if (activeTab === 'downline') { 
                    const currentUserId = networkHistory[networkHistory.length - 1] || currentUser.uid;
                    updateNetworkTreeView(currentUserId);
                } else { 
                    isUplineLoaded = false; 
                    loadUpline(); 
                }
            });

            document.querySelector('#network-view .network-tabs').addEventListener('click', e => {
                const target = e.target.closest('.network-tab-btn');
                if (!target || target.classList.contains('active')) return;
                
                document.querySelector('#network-view .network-tab-btn.active').classList.remove('active');
                target.classList.add('active');
                
                document.querySelectorAll('#network-view .network-tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${target.dataset.tab}-content`).classList.add('active');
                
                if (target.dataset.tab === 'upline' && !isUplineLoaded) { loadUpline(); }
                if (target.dataset.tab === 'downline') { 
                    networkHistory = [currentUser.uid];
                    updateNetworkTreeView(currentUser.uid);
                }
            });
        });
    </script>
</body>
</html>

