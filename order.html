<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Cart & Orders - Ramazone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        
        /* Stepper */
        .stepper { display: flex; justify-content: space-between; align-items: center; position: relative; margin-bottom: 20px; }
        .step { display: flex; flex-direction: column; align-items: center; text-align: center; z-index: 1; transition: all 0.3s ease; }
        .step-icon { width: 32px; height: 32px; border-radius: 50%; background-color: #e5e7eb; color: #6b7280; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; border: 2px solid #e5e7eb; transition: all 0.3s ease; }
        .step-label { margin-top: 6px; font-size: 0.7rem; font-weight: 600; color: #6b7280; }
        .step.active .step-icon { background-color: #4f46e5; border-color: #4f46e5; color: white; }
        .step.active .step-label { color: #4f46e5; }
        .step.completed .step-icon { background-color: #16a34a; border-color: #16a34a; color: white; }
        .stepper-line { position: absolute; top: 15px; left: 10%; right: 10%; height: 3px; background-color: #e5e7eb; z-index: 0; }
        .stepper-progress { height: 100%; background-color: #16a34a; width: 0%; transition: width 0.5s ease; }
        .step-content { display: none; animation: fadeIn 0.4s ease-out; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .action-btn { background: white; border-radius: 12px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; transition: transform 0.1s; cursor: pointer; height: 85px; }
        .action-btn:active { transform: scale(0.96); background-color: #f9fafb; }
        .action-icon { width: 32px; height: 32px; margin-bottom: 8px; }
        .action-label { font-size: 0.7rem; font-weight: 600; color: #374151; text-align: center; line-height: 1.1; }

        /* Product Card */
        .order-item-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 12px; padding: 10px; display: flex; gap: 12px; position: relative; border: 1px solid #f3f4f6; }
        .product-img-container { width: 110px; flex-shrink: 0; aspect-ratio: 3/4; background: #fff; position: relative; border: 1px solid #eee; }
        .product-img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
        .delete-item-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background: #fee2e2; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ef4444; border: none; z-index: 5; }
        .quantity-selector-order { display: flex; align-items: center; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; height: 32px; overflow: hidden; }
        .quantity-selector-order button { width: 30px; height: 100%; display: flex; align-items: center; justify-content: center; border: none; background: #f9fafb; font-weight: bold; color: #374151; cursor: pointer; transition: background 0.2s; }
        .quantity-selector-order span { font-size: 0.9rem; font-weight: 600; width: 32px; text-align: center; border-left: 1px solid #f3f4f6; border-right: 1px solid #f3f4f6; }

        /* Coupons Card */
        .coupon-card { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition: all 0.2s; }
        .coupon-card:hover { border-color: #4f46e5; background: #eef2ff; }
        .coupon-code { font-family: monospace; font-weight: 700; color: #334155; font-size: 1.1rem; letter-spacing: 1px; }
        .coupon-desc { font-size: 0.75rem; color: #64748b; }

        .add-more-products-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; margin: 15px 0; background-color: #eef2ff; border: 1px dashed #4f46e5; border-radius: 10px; color: #4f46e5; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .add-more-products-btn:active { background-color: #e0e7ff; transform: scale(0.98); }
        .copy-btn-icon { width: 20px; height: 20px; cursor: pointer; margin-left: 8px; vertical-align: middle; padding: 2px; border-radius: 4px; transition: all 0.2s; }
        .copy-btn-icon:hover { background-color: #e0e7ff; }

        /* UI Elements */
        .form-input { width: 100%; border-radius: 8px; border: 1px solid #D1D5DB; padding: 10px 12px; font-size: 0.95rem; outline: none; transition: border-color 0.2s; }
        .form-input:focus { border-color: #4F46E5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        .btn { display: flex; align-items: center; justify-content: center; padding: 12px; border-radius: 10px; font-weight: 600; width: 100%; transition: all 0.2s; }
        .btn-primary { background-color: #4F46E5; color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; }
        
        /* Popups */
        .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: all 0.3s; }
        .popup-overlay.active { opacity: 1; pointer-events: auto; }
        .popup-content { background: white; width: 100%; max-width: 500px; margin: 0 auto; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .popup-overlay.active .popup-content { transform: translateY(0); }

        #toast-notification { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; }
        #invoice-capture-area { position: fixed; top: 0; left: -9999px; width: 794px; background: white; z-index: -1; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center gap-3">
            <a href="index.html" class="text-gray-600"><i class="fas fa-arrow-left text-lg"></i></a>
            <h1 class="text-lg font-bold text-gray-800 flex-grow">My Cart</h1>
            <a href="index.html"><img src="https://i.ibb.co/2RySQ5K/20240813-084352.png" alt="Logo" class="h-6"></a>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">
        
        <!-- Stepper -->
        <div id="stepper" class="stepper">
            <div class="stepper-line"><div id="stepper-progress" class="stepper-progress"></div></div>
            <div id="step-icon-1" class="step active" data-step="1"><div class="step-icon">1</div><div class="step-label">Cart</div></div>
            <div id="step-icon-2" class="step" data-step="2"><div class="step-icon">2</div><div class="step-label">Details</div></div>
            <div id="step-icon-3" class="step" data-step="3"><div class="step-icon">3</div><div class="step-label">Payment</div></div>
        </div>

        <!-- Step 1: Cart -->
        <div id="step-cart" class="step-content active">
            <div class="dashboard-grid">
                <div class="action-btn" onclick="openOrderPopup()">
                    <img src="https://www.svgrepo.com/show/354161/parcel-icon.svg" class="action-icon" alt="Orders">
                    <span class="action-label">Track<br>Order</span>
                </div>
                
                <!-- UPDATED WISHLIST BUTTON -->
                <div class="action-btn" onclick="openWishlistPopup()">
                    <svg viewBox="0 0 48 48" class="action-icon" xmlns="http://www.w3.org/2000/svg" fill="#ef4444"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g><path class="c" d="m43,17.0766c0-5.6539-4.5835-10.2373-10.2374-10.2373-3.7223,0-6.9708,1.9932-8.7626,4.964-1.7919-2.9708-5.0403-4.964-8.7626-4.964-5.6539,0-10.2373,4.5834-10.2373,10.2373,0,1.2925.2496,2.524.6866,3.6627,3.3851,9.7368,18.3134,20.4215,18.3134,20.4215,0,0,14.9282-10.6847,18.3134-20.4215.437-1.1386.6867-2.3702.6867-3.6627Z"></path></g></svg>
                    <span class="action-label">My<br>Wishlist</span>
                </div>
                
                <div class="action-btn" onclick="openCouponsPopup()">
                    <img src="https://www.svgrepo.com/show/533049/gift.svg" class="action-icon" alt="Coupons">
                    <span class="action-label">Best<br>Coupons</span>
                </div>
                
                <div class="action-btn" onclick="openHelpPopup()">
                    <img src="https://www.svgrepo.com/show/535434/headphones.svg" class="action-icon" alt="Help">
                    <span class="action-label">Help<br>Center</span>
                </div>
            </div>

            <div id="loading-indicator" class="text-center py-10"><p class="text-sm text-gray-500">Loading cart...</p></div>
            <div id="order-items-container" class="space-y-4"></div>

            <div id="empty-cart-message" class="hidden text-center py-10">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shopping-basket text-3xl text-gray-400"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-800">Your Cart is Empty</h2>
                <p class="text-sm text-gray-500 mb-6">Looks like you haven't added anything yet.</p>
                <a href="index.html" class="btn btn-primary text-white no-underline inline-flex w-auto px-8">Start Shopping</a>
            </div>

            <!-- ADD MORE PRODUCTS BUTTON -->
            <button id="add-more-products-btn" class="add-more-products-btn hidden" onclick="window.location.href='products.html'">
                <i class="fas fa-plus-circle"></i> Add More Products
            </button>

            <div id="price-summary-box" class="bg-white rounded-xl p-4 shadow-sm mt-2 border border-gray-100 hidden">
                <h3 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">Bill Details</h3>
                <div id="price-summary-container-step1" class="space-y-2 text-sm"></div>
            </div>
            <button id="btn-to-address" class="btn btn-primary mt-6 hidden">Proceed to Details <i class="fas fa-arrow-right ml-2"></i></button>
        </div>

        <!-- Step 2: Address -->
        <div id="step-address" class="step-content">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Shipping Details</h2>
            <div id="saved-address-container" class="space-y-3 mb-6"></div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4" id="address-form-title">Add New Address</h3>
                <form id="customer-details-form" class="space-y-3">
                    <div><input type="text" id="customer-name" class="form-input" placeholder="Full Name" required></div>
                    <div><input type="tel" id="customer-mobile" class="form-input" placeholder="10-digit Mobile Number" pattern="[0-9]{10}" required></div>
                    <div><textarea id="customer-address" rows="3" class="form-input" placeholder="House No, Area, Landmark, City, Pincode" required></textarea></div>
                    <button type="button" id="save-address-btn" class="btn btn-secondary text-sm !py-2">Save Address</button>
                </form>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="navigateToStep(1)" class="btn btn-secondary w-1/3"><i class="fas fa-arrow-left"></i></button>
                <button id="btn-to-payment" class="btn btn-primary w-2/3">Continue</button>
            </div>
        </div>

        <!-- Step 3: Payment -->
        <div id="step-payment" class="step-content">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 space-y-4">
                <div>
                    <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">Delivery Method</h3>
                    <div class="flex gap-2">
                        <label class="flex-1 border p-3 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-colors">
                            <input type="radio" name="delivery" value="Pickup" class="hidden" checked>
                            <div class="font-bold text-sm">Pickup</div>
                            <div class="text-xs text-gray-500">Self Collect</div>
                        </label>
                        <label class="flex-1 border p-3 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-colors">
                            <input type="radio" name="delivery" value="Ramazone" class="hidden">
                            <div class="font-bold text-sm">Delivery</div>
                            <div class="text-xs text-gray-500" id="ramazone-delivery-info">Standard</div>
                        </label>
                    </div>
                    <div id="delivery-minimum-notice" class="hidden mt-2 text-xs text-red-600 bg-red-50 p-2 rounded"></div>
                </div>
                <div>
                    <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">Payment Mode</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 border p-3 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="radio" name="payment" value="Cash on Delivery" class="accent-indigo-600" checked>
                            <span class="font-medium text-sm">Cash on Delivery</span>
                        </label>
                        <label class="flex items-center gap-3 border p-3 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="radio" name="payment" value="Online Payment" class="accent-indigo-600">
                            <span class="font-medium text-sm">Online Payment (UPI/Card)</span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="coupon-section-wrapper" class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mt-4">
                <div id="coupon-section" class="flex gap-2">
                    <input type="text" id="coupon-input" placeholder="Enter Coupon Code" class="form-input text-sm uppercase">
                    <button id="apply-coupon-btn" class="btn btn-primary !w-auto px-6">Apply</button>
                </div>
                <div id="applied-coupon-div" class="hidden items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm font-bold text-green-700">âœ… <span id="applied-coupon-code"></span> Applied</p>
                    <button id="remove-coupon-btn" class="text-red-500 font-bold">&times;</button>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mt-4">
                <div id="price-summary-container-step3" class="space-y-2 text-sm"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="navigateToStep(2)" class="btn btn-secondary w-1/3"><i class="fas fa-arrow-left"></i></button>
                <button id="place-order-btn" class="btn btn-primary w-2/3">Place Order</button>
            </div>
        </div>
    </main>

    <!-- NEW: WISHLIST POPUP -->
    <div id="wishlist-popup-overlay" class="popup-overlay" onclick="closeWishlistPopup(event)">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <div>
                    <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-heart text-red-500 mr-2"></i>My Wishlist</h3>
                    <p class="text-xs text-gray-500">Items you saved for later</p>
                </div>
                <button onclick="closeWishlistPopup(true)" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="wishlist-list-container" class="space-y-3 pb-4 overflow-y-auto" style="max-height: 60vh;">
                <!-- Wishlist items will be injected here -->
            </div>
        </div>
    </div>

    <!-- TRACK ORDER POPUP -->
    <div id="order-popup-overlay" class="popup-overlay" onclick="closeOrderPopup(event)">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Track Order</h3>
                <button onclick="closeOrderPopup(true)" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Details</label>
                    <input type="text" id="popup-search-input" placeholder="Enter Mobile Number or Order ID" class="form-input">
                </div>
                <button id="popup-search-btn" class="btn btn-primary">Search Orders</button>
            </div>
            <div id="popup-search-results" class="mt-6 hidden space-y-3"></div>
        </div>
    </div>

    <!-- COUPONS POPUP -->
    <div id="coupons-popup-overlay" class="popup-overlay" onclick="closeCouponsPopup(event)">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <div>
                    <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-gift text-primary mr-2"></i>Available Coupons</h3>
                    <p class="text-xs text-gray-500">Tap on a coupon to apply it</p>
                </div>
                <button onclick="closeCouponsPopup(true)" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="coupons-list-container" class="space-y-3 pb-4"></div>
        </div>
    </div>

    <!-- FULL DETAILS POPUP -->
    <div id="order-details-overlay" class="popup-overlay" onclick="closeOrderDetails(event)">
        <div class="popup-content" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Order Details</h3>
                    <p class="text-xs text-gray-500" id="details-order-id">#ID</p>
                </div>
                <button onclick="closeOrderDetails(true)" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto" id="details-content-body">
                <div id="details-tracker-container" class="mb-6 pt-2 pb-4"></div>
                <h4 class="font-bold text-sm text-gray-700 mb-2">Items Ordered</h4>
                <div id="details-products-list" class="space-y-3 mb-6"></div>
                <div id="details-pricing" class="bg-gray-50 p-3 rounded-lg text-sm space-y-2"></div>
            </div>
            <div class="mt-4 pt-4 border-t">
                <button id="details-invoice-btn" class="btn btn-secondary w-full text-red-600 border-red-100 bg-red-50 hover:bg-red-100">
                    <i class="fas fa-file-image mr-2"></i> Download Invoice as Image
                </button>
            </div>
        </div>
    </div>

    <!-- HELP POPUP -->
    <div id="help-popup-overlay" class="popup-overlay" onclick="closeHelpPopup(event)">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Help Center</h3>
                <button onclick="closeHelpPopup(true)" class="text-gray-500 text-2xl">&times;</button>
            </div>
            
            <div id="help-active-request-container" class="hidden mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                <div class="flex items-start gap-3">
                    <div id="help-status-icon" class="text-2xl"></div>
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm">Request Status: <span id="help-status-text"></span></h4>
                        <p class="text-xs text-gray-600 mt-1" id="help-request-preview"></p>
                    </div>
                </div>
            </div>

            <form id="help-form" class="space-y-4" onsubmit="handleHelpSubmit(event)">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label><input type="text" id="help-name" class="form-input" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label><input type="tel" id="help-mobile" class="form-input" pattern="[0-9]{10}" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">What's the issue?</label><textarea id="help-reason" rows="5" class="form-input resize-none" placeholder="Please describe your issue in detail..." required></textarea></div>
                <button type="submit" class="btn btn-primary">Submit Request</button>
            </form>
        </div>
    </div>

    <!-- SUCCESS POPUP -->
    <div id="order-success-popup" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 hidden backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-[90%] text-center transform scale-90 transition-transform duration-300" id="order-success-content">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-4xl text-green-600"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Order Confirmed!</h2>
            <p class="text-gray-600 mb-6 text-sm">Thank you for shopping with Ramazone.</p>
            <button id="success-popup-btn" class="btn btn-primary">View Order</button>
        </div>
    </div>

    <div id="invoice-capture-area"></div>
    <div id="toast-notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="order-main.js"></script>
</body>
</html>
