<!-- sections/dashboard.html -->
<style>
    /* New styles for the compact dashboard buttons */
    .action-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 0.75rem; /* 12px */
        border-radius: 0.75rem;
        border-width: 1px;
        transition: all 0.2s ease-in-out;
        text-decoration: none;
        height: 100%;
        min-height: 90px;
    }
    .action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.07);
    }
    .action-card .stat-number {
        font-size: 1.5rem; /* 24px */
        font-weight: 700;
        color: #1f2937;
    }
    .action-card .stat-label {
        font-size: 0.75rem; /* 12px */
        color: #4b5563;
        margin-top: 2px;
    }
    /* Styles for modal lists */
    .modal-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .modal-list-item:last-child {
        border-bottom: none;
    }
</style>

<div id="dashboard-container" class="space-y-6">

    <!-- 1. NEW Action Grid -->
    <div class="grid grid-cols-4 gap-3">
        <!-- Row 1: Main Stats -->
        <a href="#" data-page="sections/orders.html" class="action-card bg-blue-50 border-blue-200 hover:bg-blue-100">
            <div id="stats-total-orders" class="stat-number">0</div>
            <div class="stat-label">Total Orders</div>
        </a>
        <a href="#" data-page="sections/products.html" class="action-card bg-green-50 border-green-200 hover:bg-green-100">
            <div id="stats-total-products" class="stat-number">0</div>
            <div class="stat-label">Products</div>
        </a>
        <a href="#" data-page="sections/normal-categories.html" class="action-card bg-yellow-50 border-yellow-200 hover:bg-yellow-100">
            <div id="stats-total-categories" class="stat-number">0</div>
            <div class="stat-label">Categories</div>
        </a>
        <a href="#" data-action="show-low-stock" class="action-card bg-red-50 border-red-200 hover:bg-red-100">
            <div id="stats-low-stock" class="stat-number">0</div>
            <div class="stat-label">Low Stock</div>
        </a>
        
        <!-- Row 2: New Action Buttons -->
        <a href="#" data-action="add-product" class="action-card bg-indigo-50 border-indigo-200 hover:bg-indigo-100">
            <div class="stat-number text-indigo-600"><i class="fas fa-plus"></i></div>
            <div class="stat-label">Add Product</div>
        </a>
        <a href="#" data-action="top-selling" class="action-card bg-purple-50 border-purple-200 hover:bg-purple-100">
            <div class="stat-number text-purple-600"><i class="fas fa-chart-bar"></i></div>
            <div class="stat-label">Top Selling</div>
        </a>
        <a href="#" data-action="recent-customers" class="action-card bg-pink-50 border-pink-200 hover:bg-pink-100">
            <div class="stat-number text-pink-600"><i class="fas fa-users"></i></div>
            <div class="stat-label">Customers</div>
        </a>
        <a href="#" data-action="today-sale" class="action-card bg-teal-50 border-teal-200 hover:bg-teal-100">
            <div id="stats-today-sale" class="stat-number">₹0</div>
            <div class="stat-label">Today's Sale</div>
        </a>
    </div>

    <!-- 2. Today's Activity & Recent Orders -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-2 admin-card">
            <div class="card-header"><h3>Today's Activity</h3></div>
            <div id="today-activity-list" class="card-body space-y-3">
                 <p class="text-center text-sm text-gray-500 py-4">Loading activity...</p>
            </div>
        </div>
        <div class="lg:col-span-3 admin-card">
            <div class="card-header flex justify-between items-center">
                <h3>Recent Orders</h3>
                <a href="#" data-page="sections/orders.html" class="text-sm font-medium text-primary hover:underline">View All</a>
            </div>
            <div class="p-0">
                <div id="recent-orders-list" class="divide-y divide-gray-100">
                    <p class="p-4 text-center text-sm text-gray-500">Loading recent orders...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const dashboardContainer = document.getElementById('dashboard-container');
    if (!dashboardContainer) return;

    let dashboardRef = null;

    /**
     * === YAHAN PAR SABSE ZAROORI FIX KIYA GAYA HAI ===
     * Yeh function ab Real-time mein Firebase se data sunega.
     */
    function initializeDashboardListener() {
        if (dashboardRef) {
            dashboardRef.off();
        }

        dashboardRef = db.ref(DB_BASE_PATH);
        dashboardRef.on('value', (snapshot) => {
            const allData = snapshot.val() || {};
            
            // Data ko process karke UI update karein
            processAndRenderDashboard(allData);

        }, (error) => {
            console.error("Dashboard listener error:", error);
            window.showToast('Error', 'Could not load dashboard data in real-time.', 'error');
        });
        
        setupEventListeners();
    }
    
    function processAndRenderDashboard(allData) {
        // --- DATA PROCESSING ---
        const ordersData = allData.orders || {};
        const pendingOrders = Object.values(ordersData.pending || {});
        const confirmedOrders = Object.values(ordersData.confirmed || {});
        const rejectedOrders = Object.values(ordersData.rejected || {});
        const allOrders = [...pendingOrders, ...confirmedOrders, ...rejectedOrders];
        const allProducts = Array.isArray(allData.products) ? allData.products.filter(p => p) : [];
        const allCategories = (allData.homepage?.normalCategories || []).map(c => c.name);
        const today = new Date().setHours(0, 0, 0, 0);

        // --- RENDER FUNCTIONS ---
        renderMainStats(allOrders, allProducts, allCategories, today);
        renderActivityAndRecent(allOrders, today);
    }

    function renderMainStats(allOrders, allProducts, allCategories, today) {
        document.getElementById('stats-total-orders').textContent = allOrders.length;
        document.getElementById('stats-total-products').textContent = allProducts.length;
        document.getElementById('stats-total-categories').textContent = allCategories.length;
        const lowStockCount = allProducts.filter(p => p && p.quantity !== undefined && parseInt(p.quantity, 10) < 5).length;
        document.getElementById('stats-low-stock').textContent = lowStockCount;
        
        const todaysSales = allOrders.filter(o => o.createdAt && new Date(o.createdAt).setHours(0,0,0,0) === today && (o.status !== 'Rejected' && o.status !== 'Pending'));
        const totalSaleAmount = todaysSales.reduce((sum, order) => sum + (order.priceSummary?.grandTotal || 0), 0);
        document.getElementById('stats-today-sale').textContent = `₹${totalSaleAmount.toLocaleString('en-IN')}`;
    }

    function renderActivityAndRecent(allOrders, today) {
        const activityContainer = document.getElementById('today-activity-list');
        const recentOrdersContainer = document.getElementById('recent-orders-list');
        activityContainer.innerHTML = '';
        recentOrdersContainer.innerHTML = '';

        const todaysOrders = allOrders.filter(o => o.createdAt && new Date(o.createdAt).setHours(0,0,0,0) === today);
        if (todaysOrders.length > 0) {
            todaysOrders.sort((a,b) => b.createdAt - a.createdAt).slice(0, 5).forEach(o => {
                activityContainer.innerHTML += `<div class="flex items-center gap-3 text-sm"><div class="bg-green-100 text-green-600 rounded-full h-8 w-8 flex items-center justify-center"><i class="fas fa-shopping-cart"></i></div><div><p>New order from <span class="font-semibold">${o.customerDetails?.name || 'Guest'}</span></p><p class="text-xs text-gray-500">${new Date(o.createdAt).toLocaleTimeString()}</p></div></div>`;
            });
        } else {
            activityContainer.innerHTML = `<p class="text-center text-sm text-gray-500 py-4">No activity today.</p>`;
        }

        const recentOrders = allOrders.sort((a, b) => (b.createdAt || b.timestamp) - (a.createdAt || a.timestamp)).slice(0, 5);
        if (recentOrders.length > 0) {
            recentOrders.forEach(o => {
                recentOrdersContainer.innerHTML += `<div class="p-3 flex justify-between items-center hover:bg-gray-50 text-sm"><div><p class="font-semibold">${o.customerDetails?.name||'Unknown'}</p><p class="text-xs text-gray-500">${o.orderId||'N/A'}</p></div><div class="text-right"><p class="font-semibold">₹${(o.priceSummary?.grandTotal || 0).toLocaleString('en-IN')}</p><p class="text-xs text-gray-500">${new Date(o.createdAt || o.timestamp).toLocaleDateString()}</p></div></div>`;
            });
        } else {
            recentOrdersContainer.innerHTML = `<p class="p-4 text-center text-sm text-gray-500">No recent orders found.</p>`;
        }
    }
    
    // --- EVENT LISTENERS & MODALS (Inmein koi badlaav nahi) ---
    function openModal(title, content) { /* ... Same as before ... */ }
    function showTopSelling() { /* ... Same as before ... */ }
    function showRecentCustomers() { /* ... Same as before ... */ }
    function showTodaysSalesDetails() { /* ... Same as before ... */ }

    function setupEventListeners() {
        dashboardContainer.addEventListener('click', (e) => {
            const target = e.target.closest('a');
            if (!target) return;
            e.preventDefault();

            const pageUrl = target.dataset.page;
            const action = target.dataset.action;

            if (pageUrl) {
                const sidebarLink = document.querySelector(`.sidebar-link[data-page="${pageUrl}"]`);
                if (sidebarLink) sidebarLink.click();
            } else if (action) {
                // Modal functions need access to the latest data
                const allData = window.ramazoneData || {};
                const allOrders = Object.values(allData.orders?.pending || {}).concat(Object.values(allData.orders?.confirmed || {})).concat(Object.values(allData.orders?.rejected || {}));
                const allProducts = Array.isArray(allData.products) ? allData.products.filter(p => p) : [];

                document.getElementById('modalFooter').classList.remove('hidden'); 
                switch(action) {
                    case 'add-product': loadPage('sections/product-form.html'); break;
                    case 'top-selling': showModalTopSelling(allOrders, allProducts); break;
                    case 'recent-customers': showModalRecentCustomers(allOrders); break;
                    case 'today-sale': showModalTodaysSalesDetails(allOrders, new Date().setHours(0,0,0,0)); break;
                    case 'show-low-stock':
                        window.showLowStockOnly = true;
                        const productsLink = document.querySelector('.sidebar-link[data-page="sections/products.html"]');
                        if (productsLink) productsLink.click();
                        break;
                }
            }
        });
    }

    // Modal functions ko data parameter ke saath update kiya gaya hai
    function showModalTopSelling(allOrders, allProducts) {
        const salesCount = {};
        allOrders.forEach(order => {
            if (order.status !== 'Rejected' && order.status !== 'Pending') {
                (order.items || []).forEach(item => { salesCount[item.id] = (salesCount[item.id] || 0) + (item.quantity || 1); });
            }
        });
        const topProducts = Object.entries(salesCount).sort(([,a],[,b]) => b-a).slice(0, 5).map(([id, count]) => ({ name: (allProducts.find(p => p.id === id) || {}).name || 'Unknown', count }));
        let content = topProducts.map(p => `<div class="modal-list-item"><span>${p.name}</span><span class="font-bold">${p.count} sold</span></div>`).join('');
        openModal('Top 5 Selling Products', content || '<p class="text-center text-gray-500">No sales data.</p>');
    }
    function showModalRecentCustomers(allOrders) {
        const customers = [...new Set(allOrders.sort((a,b)=>b.createdAt-a.createdAt).map(o=>o.customerDetails?.name).filter(Boolean))].slice(0,5);
        let content = customers.map(name => `<div class="modal-list-item"><span>${name}</span></div>`).join('');
        openModal('Recent Customers', content || '<p class="text-center text-gray-500">No customers found.</p>');
    }
    function showModalTodaysSalesDetails(allOrders, today) {
        const items = allOrders.filter(o => o.createdAt && new Date(o.createdAt).setHours(0,0,0,0) === today && o.status !== 'Rejected' && o.status !== 'Pending').flatMap(o => o.items || []);
        let content = items.map(item => `<div class="modal-list-item"><span>${item.name} (x${item.quantity})</span><span class="font-bold">₹${((item.displayPrice || 0) * (item.quantity || 1)).toLocaleString('en-IN')}</span></div>`).join('');
        openModal("Today's Sold Items", content || '<p class="text-center text-gray-500">No sales today.</p>');
    }
     function openModal(title, content) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('modalFooter').classList.add('hidden');
        document.getElementById('universalModal').classList.add('active');
    }
    
    // --- INITIAL CALL ---
    initializeDashboardListener();
})();
</script>

