<!-- sections/orders.html -->

<div class="mb-6">
    <div class="border-b border-gray-200 bg-white rounded-t-lg">
        <nav class="-mb-px" aria-label="Tabs">
            <div class="flex">
                <button id="pending-tab-btn" class="tab-button active" data-tab="pending">Pending</button>
                <button id="confirmed-tab-btn" class="tab-button" data-tab="confirmed">Confirmed</button>
                <button id="rejected-tab-btn" class="tab-button" data-tab="rejected">Rejected</button>
            </div>
        </nav>
    </div>
</div>

<div id="orders-content">
    <div id="pending-orders-content" class="tab-content"></div>
    <div id="confirmed-orders-content" class="tab-content hidden"></div>
    <div id="rejected-orders-content" class="tab-content hidden"></div>
</div>

<div id="orders-loading-indicator" class="text-center py-16"><div class="loader"></div><p class="text-primary font-medium mt-6">Loading Orders...</p></div>
<div id="no-orders-message" class="text-center py-16 hidden"><i class="fas fa-inbox text-5xl text-gray-300"></i><h3 class="mt-4 text-xl font-semibold text-gray-700">No Orders Found</h3><p class="text-gray-500 mt-1">Is section mein abhi koi order nahi hai.</p></div>

<script>
(function() {
    // --- ELEMENTS ---
    const contentArea = document.getElementById('orders-content');
    const loadingIndicator = document.getElementById('orders-loading-indicator');
    const noOrdersMessage = document.getElementById('no-orders-message');
    const tabs = { pending: document.getElementById('pending-tab-btn'), confirmed: document.getElementById('confirmed-tab-btn'), rejected: document.getElementById('rejected-tab-btn') };
    const contents = { pending: document.getElementById('pending-orders-content'), confirmed: document.getElementById('confirmed-orders-content'), rejected: document.getElementById('rejected-orders-content') };

    let currentTab = 'pending';
    let ordersRef = null;

    // --- REAL-TIME LISTENER ---
    function initializeOrdersSection() {
        loadingIndicator.classList.remove('hidden');
        contentArea.classList.add('hidden');
        
        if (ordersRef) ordersRef.off(); 

        ordersRef = db.ref(`${DB_BASE_PATH}/orders`);
        ordersRef.on('value', (snapshot) => {
            const ordersData = snapshot.val() || {};
            const allOrders = {
                pending: ordersData.pending || {},
                confirmed: ordersData.confirmed || {},
                rejected: ordersData.rejected || {}
            };
            renderAllOrders(allOrders);
            updateNoOrdersMessage(allOrders);
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');
        }, (error) => {
            console.error("Firebase read failed:", error);
            window.showToast('Error', 'Could not fetch orders.', 'error');
            loadingIndicator.classList.add('hidden');
        });

        setupEventListeners();
        switchTab('pending');
    }

    // --- RENDER FUNCTIONS ---
    function renderAllOrders(allOrders) {
        renderOrderList(allOrders.pending, contents.pending, 'pending');
        renderOrderList(allOrders.confirmed, contents.confirmed, 'confirmed');
        renderOrderList(allOrders.rejected, contents.rejected, 'rejected');
    }

    function renderOrderList(orderObject, container, type) {
        container.innerHTML = '';
        const orderIds = Object.keys(orderObject);
        if (orderIds.length === 0) return;
        orderIds.sort((a, b) => orderObject[b].createdAt - orderObject[a].createdAt);
        orderIds.forEach(orderId => container.appendChild(createOrderCard(orderObject[orderId], type)));
    }

    function createOrderCard(order, type) {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'order-card-wrapper';
        cardWrapper.dataset.orderId = order.orderId;
        cardWrapper.dataset.orderType = type;

        const allProductsInDB = window.ramazoneData.products || [];
        const sellerSet = new Set();
        order.items.forEach(item => {
            const productDetails = allProductsInDB.find(p => p && p.id === item.id);
            const sellerName = productDetails ? (productDetails.sellerName || 'Ramazone') : 'Ramazone';
            sellerSet.add(sellerName);
        });
        
        const sellers = Array.from(sellerSet);
        let sourceTag = '';
        if (sellers.length === 1 && sellers[0] === 'Ramazone') {
            sourceTag = `<div class="ramazone-tag">üè¨ Ramazone</div>`;
        } else if (sellers.length === 1) {
            sourceTag = `<div class="vendor-tag">üõçÔ∏è Vendor: ${sellers[0]}</div>`;
        } else {
             sourceTag = `<div class="vendor-tag">üõçÔ∏è Multiple Vendors</div>`;
        }

        const statusClass = `status-${order.status.replace(/\s+/g, '-')}`;
        let actionButtons = '';
        let compactActionButtons = '';

        if (type === 'pending') {
            compactActionButtons = `<button class="btn btn-sm btn-primary approve-btn"><i class="fas fa-check mr-1"></i>Approve</button>`;
            actionButtons = `<button class="btn btn-sm btn-danger reject-btn"><i class="fas fa-times mr-1"></i>Reject</button>`;
        } else if (type === 'confirmed') {
            switch(order.status) {
                case 'Confirmed': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Shipped"><i class="fas fa-truck mr-1"></i>Mark Shipped</button>`; break;
                case 'Shipped': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Out for Delivery"><i class="fas fa-box-taped mr-1"></i>Mark OFD</button>`; break;
                case 'Out for Delivery': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Delivered"><i class="fas fa-star mr-1"></i>Mark Delivered</button>`; break;
                case 'Delivered': actionButtons = `<span class="font-semibold text-green-600 flex items-center gap-2"><i class="fas fa-check-circle"></i>Completed</span>`; break;
            }
        } else if (type === 'rejected') {
            actionButtons = `<button class="btn btn-sm btn-danger delete-btn"><i class="fas fa-trash-alt mr-1"></i>Delete</button>`;
        }

        const customerPhone = order.customerDetails.mobile || order.customerDetails.phone || 'N/A';
        
        let whatsappMessage = `*Ramazone Store*\n\n`;
        whatsappMessage += `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${order.customerDetails.name},\n\n`;
        whatsappMessage += `‡§Ü‡§™‡§ï‡•á ‡§ë‡§∞‡•ç‡§°‡§∞ (${order.orderId}) ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§π‡•à:\n`;
        order.items.forEach(item => {
            whatsappMessage += `- ${item.name} (Qty: ${item.quantity})\n`;
        });
        whatsappMessage += `\nTotal Amount: ‚Çπ${order.priceSummary.grandTotal.toLocaleString('en-IN')}\n\n`;
        whatsappMessage += `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§ï‡•É‡§™‡§Ø‡§æ 'Yes' ‡§Ø‡§æ 'No' ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§`;
        const encodedWhatsappMessage = encodeURIComponent(whatsappMessage);
        const whatsappLink = `https://api.whatsapp.com/send?phone=91${customerPhone.replace(/\s/g, '')}&text=${encodedWhatsappMessage}`;


        cardWrapper.innerHTML = `
            <div class="order-card-compact">
                <div>
                    <h3 class="font-bold text-lg">${order.customerDetails.name}</h3>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="font-mono">${order.orderId}</span>
                        <button class="copy-btn" title="Copy Order ID"><i class="far fa-copy"></i></button>
                    </div>
                     <div class="mt-2">${sourceTag}</div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-xl text-primary">‚Çπ${order.priceSummary.grandTotal.toLocaleString('en-IN')}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(order.createdAt).toLocaleString()}</p>
                    <div class="flex items-center gap-2 mt-2 justify-end">
                       <button class="btn btn-sm view-details-btn"><i class="fas fa-chevron-down mr-1"></i>Details</button>
                       ${compactActionButtons}
                    </div>
                </div>
            </div>
            <div class="order-card-details">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="font-semibold mb-2 text-gray-700">Items:</p>
                        <div class="space-y-3">${order.items.map(item => {
                            const productDetails = allProductsInDB.find(p => p && p.id === item.id);
                            const sellerName = productDetails ? (productDetails.sellerName || 'Ramazone') : 'Ramazone';
                            return `
                            <div class="flex items-start text-sm">
                                <img src="${item.image}" class="w-12 h-12 rounded-md mr-3 object-cover border">
                                <div class="flex-grow">
                                    <p class="font-medium">${item.name}</p>
                                    <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
                                    <p class="text-xs text-purple-700 font-semibold mt-1">‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ: ${sellerName}</p>
                                </div>
                                <span class="font-medium">‚Çπ${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</span>
                            </div>`
                        }).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2 text-gray-700">Customer Details:</p>
                        <div class="text-sm space-y-2">
                            <p><strong>Address:</strong> ${order.customerDetails.address || 'N/A'}, ${order.customerDetails.city || ''}, ${order.customerDetails.state || ''} - ${order.customerDetails.pincode || ''}</p>
                            <div class="flex items-center gap-2 pt-1">
                                <a href="${whatsappLink}" target="_blank" class="text-green-600 text-xl" title="Send WhatsApp Confirmation">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                                <a href="${whatsappLink}" target="_blank" class="text-blue-600 hover:underline">
                                    ${customerPhone}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <div class="flex items-center gap-3"><span class="status-badge ${statusClass}">${order.status}</span></div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm invoice-btn"><i class="fas fa-receipt mr-1"></i>Download Invoice</button>
                        ${actionButtons}
                    </div>
                </div>
            </div>
        `;
        return cardWrapper;
    }

    // --- UI & EVENT FUNCTIONS ---
    function setupEventListeners() {
        Object.keys(tabs).forEach(tabName => tabs[tabName].addEventListener('click', () => switchTab(tabName)));
        contentArea.addEventListener('click', handleCardButtonClick);
    }
    
    async function handleCardButtonClick(e) {
        const button = e.target.closest('button');
        const link = e.target.closest('a');
        if (!button && !link) return;

        const card = e.target.closest('.order-card-wrapper');
        if (!card) return; 
        const orderId = card.dataset.orderId;
        const orderType = card.dataset.orderType;

        if (button && button.classList.contains('view-details-btn')) {
            const details = card.querySelector('.order-card-details');
            const icon = button.querySelector('i');
            details.classList.toggle('expanded');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        } else if (button && button.classList.contains('copy-btn')) {
            const textToCopy = orderId;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); window.showToast('Copied!', `Order ID ${textToCopy} copied.`, 'success', 2000); } 
            catch (err) { console.error('Copy failed', err); window.showToast('Error', 'Could not copy ID.', 'error', 2000); }
            document.body.removeChild(textArea);
        } else if (button && button.classList.contains('invoice-btn')) {
            await generateInvoice(orderId);
        } 
        else if (button && button.classList.contains('approve-btn')) {
            await moveOrder(orderId, orderType, 'confirmed', 'Confirmed');
        } else if (button && button.classList.contains('reject-btn')) {
            await moveOrder(orderId, orderType, 'rejected', 'Rejected');
        } 
        else if (button && button.classList.contains('delete-btn')) {
            await deleteOrder(orderId);
        } else if (button && button.classList.contains('status-update-btn')) {
            await updateOrderStatus(orderId, button.dataset.status);
        }
    }
    
    // --- FIREBASE ACTIONS ---
    async function moveOrder(orderId, from, to, newStatus) { /* ... (Code unchanged) ... */ }
    async function deleteOrder(orderId) { /* ... (Code unchanged) ... */ }
    async function updateOrderStatus(orderId, newStatus) { /* ... (Code unchanged) ... */ }

    // === FINAL FIX: INVOICE GENERATION FUNCTION ===
    // This function is now adapted from your working code.
    async function generateInvoice(orderId) {
        const btn = event.target.closest('.invoice-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>Generating...`;
        
        const orderType = event.target.closest('.order-card-wrapper').dataset.orderType;
        
        try {
            const snapshot = await db.ref(`ramazone/orders/${orderType}/${orderId}`).get();
            if (!snapshot.exists()) {
                throw new Error('Could not find order data for invoice.');
            }
            const orderData = snapshot.val();
            const summary = orderData.priceSummary;
            const storeDetails = { name: 'Ramazone Online Store', owner: 'Prince Rama', address: 'Lalunagar, Begusarai, Bihar - 851129', phone: 'WhatsApp: 7903698180', email: 'ramazone007@gmail.com', website: 'www.ramazon.in' };

            const mobileNumberHTML = orderData.customerDetails.mobile ? `<p style="margin: 4px 0 0; color: #666;"><strong>Mobile:</strong> ${orderData.customerDetails.mobile}</p>` : '';
            
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #DC2626; color: #FFFFFF;">
                                <th style="padding: 0.8rem; text-align: left; white-space: nowrap;">SL.</th>
                                <th style="padding: 0.8rem; text-align: left; white-space: nowrap;">DESCRIPTION</th>
                                <th style="padding: 0.8rem; text-align: center; white-space: nowrap;">QTY</th>
                                <th style="padding: 0.8rem; text-align: right; white-space: nowrap;">RATE</th>
                                <th style="padding: 0.8rem; text-align: right; white-space: nowrap;">AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orderData.items.map((item, index) => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 0.8rem;">${index + 1}</td>
                                    <td style="padding: 0.8rem;">
                                        <div style="display: flex; align-items: center; min-width: 200px;">
                                            <img src="${item.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 12px;" crossOrigin="anonymous">
                                            <span style="font-weight: 500;">${item.name}</span>
                                        </div>
                                    </td>
                                    <td style="padding: 0.8rem; text-align: center;">${item.quantity}</td>
                                    <td style="padding: 0.8rem; text-align: right;">‚Çπ${item.displayPrice.toLocaleString('en-IN')}</td>
                                    <td style="padding: 0.8rem; text-align: right; font-weight: 500;">‚Çπ${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            
            const invoiceHTML = `
                <div style="width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; color: #333; font-size: 11pt; display: flex; flex-direction: column; background: white;">
                    <header style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1.5rem; border-bottom: 4px solid #DC2626;">
                        <div>
                            <h1 style="font-size: 2.5rem; font-weight: bold; color: #DC2626; margin: 0;">INVOICE</h1>
                            <p style="margin: 8px 0 0; font-size: 1rem; color: #555;"><strong>Invoice No:</strong> ${orderData.orderId}</p>
                            <p style="margin: 4px 0 0; font-size: 1rem; color: #555;"><strong>Invoice Date:</strong> ${new Date(orderData.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <img src="https://i.ibb.co/2RySQ5K/20240813-084352.png" alt="Ramazone Logo" style="height: 65px; margin-bottom: 8px; margin-left: auto;" crossOrigin="anonymous">
                            <p style="margin: 0; font-weight: bold; font-size: 1.1rem;">${storeDetails.name}</p>
                            <p style="margin: 4px 0 0; font-size: 0.9rem; color: #555;">Proprietor: ${storeDetails.owner}</p>
                        </div>
                    </header>
                    <section style="margin-top: 2rem; display: flex; justify-content: space-between; font-size: 0.9rem; line-height: 1.5;">
                        <div>
                            <p style="font-weight: bold; color: #555;">STORE DETAILS:</p>
                            <p style="margin: 4px 0 0;">${storeDetails.address}</p>
                            <p style="margin: 4px 0 0;">${storeDetails.phone}</p>
                            <p style="margin: 4px 0 0;">${storeDetails.email}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-weight: bold; color: #555;">BILL TO:</p>
                            <p style="margin: 4px 0 0;">${orderData.customerDetails.name}</p>
                            <p style="margin: 4px 0 0; color: #666; max-width: 250px;">${orderData.customerDetails.address}</p>
                            ${mobileNumberHTML}
                        </div>
                    </section>
                    <section style="margin-top: 2.5rem; flex-grow: 1;">${tableHTML}</section>
                    <section style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                        <div style="width: 300px; font-size: 0.9rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Subtotal:</span><span>‚Çπ${summary.subtotal.toLocaleString('en-IN')}</span></div>
                            ${summary.coupon ? `<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #16a34a;"><span>Coupon (${summary.coupon.code}):</span><span>- ‚Çπ${summary.coupon.discount.toLocaleString('en-IN')}</span></div>` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Delivery Fee:</span><span>${summary.deliveryCharge > 0 ? `‚Çπ${summary.deliveryCharge.toLocaleString('en-IN')}` : 'Free'}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; border-top: 2px solid #333; font-weight: bold; font-size: 1.3rem;"><span>Grand Total:</span><span>‚Çπ${summary.grandTotal.toLocaleString('en-IN')}</span></div>
                        </div>
                    </section>
                    <footer style="margin-top: 4rem; display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #eee; padding-top: 1rem;">
                        <div style="font-size: 0.8rem; color: #888;"><p style="margin: 0;">Thank you for your order!</p><p style="margin: 4px 0 0; font-weight: bold;">${storeDetails.website}</p></div>
                        <div style="text-align: center;"><p style="font-weight: bold; font-size: 1.2rem; letter-spacing: 1px; font-family: 'Segoe UI', sans-serif; margin: 0; color: #333;">Ramazone</p><p style="margin: 0; border-top: 1px solid #555; padding-top: 4px; font-size: 0.8rem; font-weight: bold;">Authorized Signatory</p></div>
                    </footer>
                </div>`;
            
            const renderContainer = document.createElement('div');
            renderContainer.style.position = 'absolute';
            renderContainer.style.left = '-9999px';
            document.body.appendChild(renderContainer);
            renderContainer.innerHTML = invoiceHTML;
            const invoiceElement = renderContainer.querySelector('div');
            
            const canvas = await html2canvas(invoiceElement, { scale: 3, useCORS: true, allowTaint: true });
            
            const link = document.createElement('a');
            link.download = `Ramazone-Invoice-${orderId}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            document.body.removeChild(renderContainer);
            window.showToast('Success', `Invoice for ${orderId} downloaded.`, 'success');

        } catch (error) {
            console.error("Invoice download failed:", error);
            window.showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-receipt mr-1"></i>Download Invoice`;
        }
    }

    // Unchanged helper functions for completeness
    function switchTab(tabName) { currentTab = tabName; Object.values(tabs).forEach(t => t.classList.remove('active')); Object.values(contents).forEach(c => c.classList.add('hidden')); tabs[tabName].classList.add('active'); contents[tabName].classList.remove('hidden'); updateNoOrdersMessage(); }
    function updateNoOrdersMessage(allOrdersData) { const ordersToShow = allOrdersData || { pending: contents.pending.children.length, confirmed: contents.confirmed.children.length, rejected: contents.rejected.children.length }; const count = (typeof ordersToShow[currentTab] === 'number') ? ordersToShow[currentTab] : Object.keys(ordersToShow[currentTab]).length; noOrdersMessage.classList.toggle('hidden', count > 0); }
    async function moveOrder(orderId, from, to, newStatus) { const orderRef = db.ref(`${DB_BASE_PATH}/orders/${from}/${orderId}`); const snapshot = await orderRef.get(); if (!snapshot.exists()) return window.showToast('Error', 'Order not found.', 'error'); const orderData = snapshot.val(); orderData.status = newStatus; orderData.statusHistory = orderData.statusHistory || {}; orderData.statusHistory[Date.now()] = { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP }; const updates = {}; updates[`orders/${from}/${orderId}`] = null; updates[`orders/${to}/${orderId}`] = orderData; try { await db.ref(DB_BASE_PATH).update(updates); window.showToast('Success', `Order has been ${newStatus.toLowerCase()}.`, 'success'); } catch (error) { window.showToast('Error', `Failed to update order: ${error.message}`, 'error'); } }
    async function deleteOrder(orderId) { if (confirm(`DELETE order ID: ${orderId} permanently?`)) { try { await db.ref(`${DB_BASE_PATH}/orders/rejected/${orderId}`).remove(); window.showToast('Success', `Order ${orderId} has been deleted.`, 'success'); } catch (error) { window.showToast('Error', `Failed to delete order: ${error.message}`, 'error'); } } }
    async function updateOrderStatus(orderId, newStatus) { const button = event.target.closest('button'); button.disabled = true; button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const updates = { status: newStatus, [`statusHistory/${Date.now()}`]: { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP } }; try { await db.ref(`${DB_BASE_PATH}/orders/confirmed/${orderId}`).update(updates); window.showToast('Success', `Status updated to ${newStatus}.`, 'success'); } catch (error) { window.showToast('Error', `Failed to update status: ${error.message}`, 'error'); button.disabled = false; /* Restore button text */ } }

    initializeOrdersSection();
})();
</script>

