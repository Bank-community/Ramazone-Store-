<!-- sections/orders.html -->
<!-- FINAL & COMPLETE WORKING CODE -->

<style>
    /* CSS specifically for the orders page to avoid conflicts */
    main#main-content-area {
        padding: 0.75rem;
        background-color: #ffffff;
    }
    .master-filter-container {
        padding: 0;
        margin-bottom: 1rem;
        border: none;
        background-color: transparent;
        box-shadow: none;
    }
    .search-bar-wrapper {
        position: relative;
        margin-bottom: 0.75rem;
    }
    .search-bar-wrapper i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }
    #search-input {
        width: 100%;
        border-radius: 0.5rem;
        padding: 0.625rem 0.75rem 0.625rem 2.25rem;
        font-size: 1rem;
        border: 1px solid #e5e7eb;
        background-color: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    #search-input:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        outline: none;
    }
    .horizontal-filters {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 8px;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .horizontal-filters::-webkit-scrollbar {
        display: none;
    }
    .filter-item {
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    .filter-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.25rem;
    }
    .filter-input-small {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.375rem 0.75rem;
        background-color: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        font-size: 0.875rem;
    }
    .filter-input-small[type="date"] {
        width: 135px;
    }
    .filter-input-small:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        outline: none;
    }
    nav[aria-label="Tabs"] {
        display: flex;
        justify-content: space-around;
        background-color: #ffffff;
    }
    .tab-button {
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: #4b5563;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
        cursor: pointer;
        flex-shrink: 0;
    }
    .tab-button.active {
        color: #4f46e5;
        border-bottom-color: #4f46e5;
    }
    .order-card-wrapper {
        background-color: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        margin-bottom: 0.75rem;
        overflow: hidden;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .order-card-wrapper:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }
    .order-card-compact {
        padding: 0.75rem 1rem;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.25rem 1rem;
        align-items: start;
    }
    .compact-left {
        grid-column: 1 / 2;
    }
    .compact-right {
        grid-column: 2 / 3;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }
    .order-card-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        padding: 0 1rem;
    }
    .order-card-details.expanded {
        max-height: 800px;
        padding: 1rem;
        border-top: 1px solid #f3f4f6;
    }
    .copy-btn {
        background: none;
        border: none;
        color: #4b5563;
        cursor: pointer;
        margin-left: 0.25rem;
        transition: color 0.2s;
    }
    .copy-btn:hover {
        color: #4f46e5;
    }
    .vendor-tag,
    .ramazone-tag {
        font-size: 0.8rem;
        font-weight: 500;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .vendor-tag {
        color: #581c87;
        background-color: #f3e8ff;
    }
    .ramazone-tag {
        color: #1e40af;
        background-color: #dbeafe;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    .status-Confirmed { background-color: #e0f2fe; color: #0ea5e9; }
    .status-Shipped { background-color: #dbeafe; color: #3b82f6; }
    .status-Out-for-Delivery { background-color: #fef3c7; color: #f59e0b; }
    .status-Delivered { background-color: #dcfce7; color: #22c55e; }
    .status-Pending { background-color: #fee2e2; color: #ef4444; }
    .status-Rejected { background-color: #e5e7eb; color: #4b5563; }

    .next-step-btn {
        border: 1px solid #4f46e5;
        color: #4f46e5;
        background-color: #eff6ff;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        text-align: center;
    }
    .next-step-btn:hover {
        background-color: #4f46e5;
        color: #fff;
    }
    .next-step-tag {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    .next-step-tag.completed {
        color: #15803d;
        background-color: #dcfce7;
    }
    .next-step-tag.rejected {
        color: #4b5563;
        background-color: #e5e7eb;
    }
</style>

<!-- COMPACT HORIZONTAL MASTER SEARCH & FILTER BAR -->
<div class="master-filter-container">
    <div class="search-bar-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="Search by ID, Name, or Phone...">
    </div>
    <div class="horizontal-filters">
        <div class="filter-item">
            <label for="start-date" class="filter-label">Start Date</label>
            <input type="date" id="start-date" class="filter-input-small">
        </div>
        <div class="filter-item">
            <label for="end-date" class="filter-label">End Date</label>
            <input type="date" id="end-date" class="filter-input-small">
        </div>
        <div class="filter-item">
            <label for="vendor-filter" class="filter-label">Vendor</label>
            <select id="vendor-filter" class="filter-input-small">
                <option value="">All</option>
            </select>
        </div>
        <div class="filter-item" style="justify-content: flex-end;">
            <button id="reset-filters-btn" class="btn btn-sm" style="background-color: #e5e7eb; padding: 0.375rem 1rem;">Reset</button>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="mb-6">
    <div class="border-b border-gray-200 bg-white rounded-t-lg">
        <nav class="-mb-px" aria-label="Tabs">
            <div class="flex">
                <button id="pending-tab-btn" class="tab-button active" data-tab="pending">Pending</button>
                <button id="confirmed-tab-btn" class="tab-button" data-tab="confirmed">Confirmed</button>
                <button id="rejected-tab-btn" class="tab-button" data-tab="rejected">Rejected</button>
            </div>
        </nav>
    </div>
</div>

<!-- CONTENT AREA -->
<div id="orders-content">
    <div id="pending-orders-content" class="tab-content"></div>
    <div id="confirmed-orders-content" class="tab-content hidden"></div>
    <div id="rejected-orders-content" class="tab-content hidden"></div>
</div>

<!-- LOADING & EMPTY MESSAGE -->
<div id="orders-loading-indicator" class="text-center py-16"><div class="loader"></div><p class="text-primary font-medium mt-6">Loading Orders...</p></div>
<div id="no-orders-message" class="text-center py-16 hidden"><i class="fas fa-inbox text-5xl text-gray-300"></i><h3 class="mt-4 text-xl font-semibold text-gray-700">No Orders Found</h3><p class="text-gray-500 mt-1">Is section mein abhi koi order nahi hai.</p></div>

<script>
(function() {
    // --- ELEMENTS ---
    const contentArea = document.getElementById('orders-content');
    const loadingIndicator = document.getElementById('orders-loading-indicator');
    const noOrdersMessage = document.getElementById('no-orders-message');
    const tabs = { pending: document.getElementById('pending-tab-btn'), confirmed: document.getElementById('confirmed-tab-btn'), rejected: document.getElementById('rejected-tab-btn') };
    const contents = { pending: document.getElementById('pending-orders-content'), confirmed: document.getElementById('confirmed-orders-content'), rejected: document.getElementById('rejected-orders-content') };
    
    const searchInput = document.getElementById('search-input');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const vendorFilter = document.getElementById('vendor-filter');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    let currentTab = 'pending';
    let ordersRef = null;
    let allOrdersData = {}; 

    // --- INITIALIZATION ---
    function initializeOrdersSection() {
        loadingIndicator.classList.remove('hidden');
        contentArea.classList.add('hidden');
        if (ordersRef) ordersRef.off(); 
        ordersRef = db.ref(`${DB_BASE_PATH}/orders`);
        ordersRef.on('value', (snapshot) => {
            const ordersData = snapshot.val() || {};
            allOrdersData = {
                pending: ordersData.pending || {},
                confirmed: ordersData.confirmed || {},
                rejected: ordersData.rejected || {}
            };
            populateVendorFilter();
            applyFiltersAndRender();
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');
        }, (error) => { console.error("Firebase read failed:", error); window.showToast('Error', 'Could not fetch orders.', 'error'); loadingIndicator.classList.add('hidden'); });

        setupEventListeners();
        switchTab('pending');
    }
    
    // --- ROBUST FILTER LOGIC ---
    function populateVendorFilter() {
        const vendors = new Set();
        if (window.ramazoneData && window.ramazoneData.products) {
            window.ramazoneData.products.forEach(p => {
                if(p && p.sellerName) vendors.add(p.sellerName);
            });
        }
        vendors.add('Ramazone'); 
        const currentVal = vendorFilter.value;
        vendorFilter.innerHTML = '<option value="">All</option>';
        Array.from(vendors).sort().forEach(vendor => { vendorFilter.innerHTML += `<option value="${vendor}">${vendor}</option>`; });
        vendorFilter.value = currentVal;
    }

    function applyFiltersAndRender() {
        const searchTerm = searchInput.value.toLowerCase();
        const startDate = startDateInput.value ? new Date(startDateInput.value).setHours(0, 0, 0, 0) : null;
        const endDate = endDateInput.value ? new Date(endDateInput.value).setHours(23, 59, 59, 999) : null;
        const selectedVendor = vendorFilter.value;
        const allProductsInDB = window.ramazoneData.products || [];
        const ordersForCurrentTab = allOrdersData[currentTab] || {};

        const filteredOrders = Object.values(ordersForCurrentTab).filter(order => {
            const customer = order.customerDetails;
            const searchMatch = !searchTerm || order.orderId.toLowerCase().includes(searchTerm) || (customer.name && customer.name.toLowerCase().includes(searchTerm)) || (customer.mobile && customer.mobile.includes(searchTerm));
            if (!searchMatch) return false;

            const orderDate = new Date(order.createdAt).getTime();
            if (startDate && orderDate < startDate) return false;
            if (endDate && orderDate > endDate) return false;
            
            if (selectedVendor) {
                const orderSellers = new Set(order.items.map(item => { const product = allProductsInDB.find(p => p && p.id === item.id); return product ? (product.sellerName || 'Ramazone') : 'Ramazone'; }));
                if (!orderSellers.has(selectedVendor)) return false;
            }
            return true;
        });

        const filteredOrderObject = filteredOrders.reduce((obj, order) => { obj[order.orderId] = order; return obj; }, {});
        renderOrderList(filteredOrderObject, contents[currentTab]);
        updateNoOrdersMessage(filteredOrderObject);
    }

    // --- RENDER FUNCTIONS ---
    function renderOrderList(orderObject, container) {
        container.innerHTML = '';
        const orderIds = Object.keys(orderObject);
        if (orderIds.length === 0) return;
        orderIds.sort((a, b) => orderObject[b].createdAt - orderObject[a].createdAt);
        orderIds.forEach(orderId => container.appendChild(createOrderCard(orderObject[orderId])));
    }
    
    function createOrderCard(order) {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'order-card-wrapper';
        cardWrapper.dataset.orderId = order.orderId;
        cardWrapper.dataset.orderType = order.status === 'Pending' ? 'pending' : (order.status === 'Rejected' ? 'rejected' : 'confirmed');

        const allProductsInDB = window.ramazoneData.products || [];
        const sellerSet = new Set(order.items.map(item => { const p = allProductsInDB.find(prod => prod && prod.id === item.id); return p ? (p.sellerName || 'Ramazone') : 'Ramazone'; }));
        const sellers = Array.from(sellerSet);
        let sourceTag = '';
        if (sellers.length === 1 && sellers[0] === 'Ramazone') { sourceTag = `<div class="ramazone-tag">🏬 Ramazone</div>`; } 
        else if (sellers.length === 1) { sourceTag = `<div class="vendor-tag">🛍️ Vendor: ${sellers[0]}</div>`; } 
        else { sourceTag = `<div class="vendor-tag">🛍️ Multiple Vendors</div>`; }

        let nextStepHtml = '';
        const orderType = cardWrapper.dataset.orderType;
        if (orderType === 'pending') { nextStepHtml = `<button class="next-step-btn approve-btn"><i class="fas fa-check"></i> Approve</button>`; } 
        else if (orderType === 'confirmed') {
            switch (order.status) {
                case 'Confirmed': nextStepHtml = `<button class="next-step-btn status-update-btn" data-status="Shipped">🚚 Mark Shipped</button>`; break;
                case 'Shipped': nextStepHtml = `<button class="next-step-btn status-update-btn" data-status="Out for Delivery">📦 Mark OFD</button>`; break;
                case 'Out for Delivery': nextStepHtml = `<button class="next-step-btn status-update-btn" data-status="Delivered">⭐ Mark Delivered</button>`; break;
                case 'Delivered': nextStepHtml = `<div class="next-step-tag completed"><i class="fas fa-check-circle"></i> Completed</div>`; break;
            }
        } else if (orderType === 'rejected') { nextStepHtml = `<div class="next-step-tag rejected"><i class="fas fa-times-circle"></i> Rejected</div>`; }

        cardWrapper.innerHTML = `
            <div class="order-card-compact">
                <div class="compact-left">
                    <h3 class="font-bold text-lg">${order.customerDetails.name}</h3>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="font-mono">${order.orderId}</span>
                        <button class="copy-btn" title="Copy Order ID"><i class="far fa-copy"></i></button>
                    </div>
                    <div class="mt-2">${sourceTag}</div>
                </div>
                <div class="compact-right">
                    <p class="font-bold text-xl text-primary">₹${order.priceSummary.grandTotal.toLocaleString('en-IN')}</p>
                    <p class="text-xs text-gray-500">${new Date(order.createdAt).toLocaleString()}</p>
                    <div class="next-step-indicator">${nextStepHtml}</div>
                    <button class="btn btn-sm view-details-btn mt-2" style="background: transparent; border: none; color: var(--primary); padding: 0.25rem;">
                        <i class="fas fa-chevron-down mr-1"></i>Details
                    </button>
                </div>
            </div>
            <div class="order-card-details"></div>`;
        return cardWrapper;
    }
    
    // **FIXED**: This function now correctly generates the details HTML.
    function expandOrderDetails(cardWrapper, order) {
        const detailsContainer = cardWrapper.querySelector('.order-card-details');
        if (detailsContainer.innerHTML !== '') return;

        const allProductsInDB = window.ramazoneData.products || [];
        const statusClass = `status-${order.status.replace(/\s+/g, '-')}`;
        let actionButtons = '';
        const orderType = cardWrapper.dataset.orderType;

        if (orderType === 'pending') { actionButtons = `<button class="btn btn-sm btn-danger reject-btn"><i class="fas fa-times mr-1"></i>Reject</button>`; } 
        else if (orderType === 'confirmed' && order.status !== 'Delivered') { actionButtons = `<button class="btn btn-sm btn-danger reject-btn"><i class="fas fa-times mr-1"></i>Reject</button>`; } 
        else if (orderType === 'rejected') { actionButtons = `<button class="btn btn-sm btn-danger delete-btn"><i class="fas fa-trash-alt mr-1"></i>Delete</button>`; }

        const customerPhone = order.customerDetails.mobile || order.customerDetails.phone || 'N/A';
        const whatsappMessage = encodeURIComponent(`*Ramazone Store*\n\nनमस्ते ${order.customerDetails.name},\n\nआपके ऑर्डर (${order.orderId}) में यह सामान है:\n${order.items.map(item => `- ${item.name} (Qty: ${item.quantity})`).join('\n')}\n\nTotal Amount: ₹${order.priceSummary.grandTotal.toLocaleString('en-IN')}\n\nक्या आप इस ऑर्डर को कन्फर्म करना चाहते हैं? कृपया 'Yes' या 'No' में जवाब दें।`);
        const whatsappLink = `https://api.whatsapp.com/send?phone=91${customerPhone.replace(/\s/g, '')}&text=${whatsappMessage}`;

        detailsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><p class="font-semibold mb-2 text-gray-700">Items:</p><div class="space-y-3">${order.items.map(item => { const productDetails = allProductsInDB.find(p => p && p.id === item.id); const sellerName = productDetails ? (productDetails.sellerName || 'Ramazone') : 'Ramazone'; return `<div class="flex items-start text-sm"><img src="${item.image}" class="w-12 h-12 rounded-md mr-3 object-cover border"><div class="flex-grow"><p class="font-medium">${item.name}</p><p class="text-xs text-gray-500">Qty: ${item.quantity}</p><p class="text-xs text-purple-700 font-semibold mt-1">विक्रेता: ${sellerName}</p></div><span class="font-medium">₹${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</span></div>` }).join('')}</div></div>
                <div><p class="font-semibold mb-2 text-gray-700">Customer Details:</p><div class="text-sm space-y-2"><p><strong>Address:</strong> ${order.customerDetails.address || 'N/A'}</p><div class="flex items-center gap-2 pt-1"><a href="${whatsappLink}" target="_blank" class="text-green-600 text-xl" title="Send WhatsApp Confirmation"><i class="fab fa-whatsapp"></i></a><a href="${whatsappLink}" target="_blank" class="text-blue-600 hover:underline">${customerPhone}</a></div></div></div>
            </div>
            <div class="mt-4 pt-4 border-t flex justify-between items-center">
                <div class="flex items-center gap-3"><span class="status-badge ${statusClass}">${order.status}</span></div>
                <div class="flex items-center gap-2"><button class="btn btn-sm invoice-btn"><i class="fas fa-receipt mr-1"></i>Invoice</button>${actionButtons}</div>
            </div>`;
    }

    // --- EVENT FUNCTIONS ---
    function setupEventListeners() {
        Object.keys(tabs).forEach(tabName => tabs[tabName].addEventListener('click', () => switchTab(tabName)));
        contentArea.addEventListener('click', handleCardButtonClick);
        searchInput.addEventListener('input', applyFiltersAndRender);
        startDateInput.addEventListener('change', applyFiltersAndRender);
        endDateInput.addEventListener('change', applyFiltersAndRender);
        vendorFilter.addEventListener('change', applyFiltersAndRender);
        resetFiltersBtn.addEventListener('click', () => { searchInput.value = ''; startDateInput.value = ''; endDateInput.value = ''; vendorFilter.value = ''; applyFiltersAndRender(); });
    }

    async function handleCardButtonClick(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const card = e.target.closest('.order-card-wrapper');
        if (!card) return;
        const orderId = card.dataset.orderId;
        const orderType = card.dataset.orderType;

        if (button.classList.contains('view-details-btn')) {
            const details = card.querySelector('.order-card-details');
            const icon = button.querySelector('i');
            const orderData = allOrdersData[orderType][orderId];
            if (orderData && details.innerHTML === '') { // **FIX**: Only expand if content is not loaded
                expandOrderDetails(card, orderData);
            }
            setTimeout(() => {
                details.classList.toggle('expanded');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }, 10);
        } else if (button.classList.contains('copy-btn')) { 
            const textToCopy = orderId;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy; document.body.appendChild(textArea); textArea.select();
            try { document.execCommand('copy'); window.showToast('Copied!', `ID Copied.`, 'success', 2000); } 
            catch (err) { window.showToast('Error', 'Could not copy.', 'error', 2000); }
            document.body.removeChild(textArea);
        } else if (button.classList.contains('invoice-btn')) { await generateInvoice(orderId, orderType); } 
        else if (button.classList.contains('approve-btn')) { await moveOrder(orderId, 'pending', 'confirmed', 'Confirmed'); } 
        else if (button.classList.contains('reject-btn')) { await moveOrder(orderId, orderType, 'rejected', 'Rejected'); } 
        else if (button.classList.contains('delete-btn')) { await deleteOrder(orderId); } 
        else if (button.classList.contains('status-update-btn')) { await updateOrderStatus(orderId, button.dataset.status); }
    }
    
    // --- UNCHANGED HELPER & FIREBASE FUNCTIONS ---
    function switchTab(tabName) { currentTab = tabName; Object.values(tabs).forEach(t => t.classList.remove('active')); Object.values(contents).forEach(c => c.classList.add('hidden')); tabs[tabName].classList.add('active'); contents[tabName].classList.remove('hidden'); applyFiltersAndRender(); }
    function updateNoOrdersMessage(ordersData) { const count = Object.keys(ordersData).length; if (count === 0) { noOrdersMessage.classList.remove('hidden'); noOrdersMessage.querySelector('p').textContent = (searchInput.value || startDateInput.value || endDateInput.value || vendorFilter.value) ? 'Koi order is filter se match nahi hua.' : 'Is section mein abhi koi order nahi hai.'; } else { noOrdersMessage.classList.add('hidden'); } }
    async function moveOrder(orderId, from, to, newStatus) { const orderRef = db.ref(`${DB_BASE_PATH}/orders/${from}/${orderId}`); const snapshot = await orderRef.get(); if (!snapshot.exists()) return window.showToast('Error', 'Order not found.', 'error'); const orderData = snapshot.val(); orderData.status = newStatus; orderData.statusHistory = orderData.statusHistory || {}; orderData.statusHistory[Date.now()] = { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP }; const updates = {}; updates[`orders/${from}/${orderId}`] = null; updates[`orders/${to}/${orderId}`] = orderData; try { await db.ref(DB_BASE_PATH).update(updates); window.showToast('Success', `Order has been ${newStatus.toLowerCase()}.`, 'success'); } catch (error) { window.showToast('Error', `Failed to update order: ${error.message}`, 'error'); } }
    async function deleteOrder(orderId) { if (confirm(`DELETE order ID: ${orderId} permanently?`)) { try { await db.ref(`${DB_BASE_PATH}/orders/rejected/${orderId}`).remove(); window.showToast('Success', `Order ${orderId} has been deleted.`, 'success'); } catch (error) { window.showToast('Error', `Failed to delete order: ${error.message}`, 'error'); } } }
    async function updateOrderStatus(orderId, newStatus) { const button = event.target.closest('button'); button.disabled = true; button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const updates = { status: newStatus, [`statusHistory/${Date.now()}`]: { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP } }; try { await db.ref(`${DB_BASE_PATH}/orders/confirmed/${orderId}`).update(updates); window.showToast('Success', `Status updated to ${newStatus}.`, 'success'); } catch (error) { window.showToast('Error', `Failed to update status: ${error.message}`, 'error'); } }
    async function generateInvoice(orderId, orderType) { const btn = event.target.closest('.invoice-btn'); btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>Generating...`; try { const snapshot = await db.ref(`ramazone/orders/${orderType}/${orderId}`).get(); if (!snapshot.exists()) { throw new Error('Could not find order data for invoice.'); } const orderData = snapshot.val(); const summary = orderData.priceSummary; const storeDetails = { name: 'Ramazone Online Store', owner: 'Prince Rama', address: 'Lalunagar, Begusarai, Bihar - 851129', phone: 'WhatsApp: 7903698180', email: 'ramazone007@gmail.com', website: 'www.ramazon.in' }; const mobileNumberHTML = orderData.customerDetails.mobile ? `<p style="margin: 4px 0 0; color: #666;"><strong>Mobile:</strong> ${orderData.customerDetails.mobile}</p>` : ''; const tableHTML = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"><thead><tr style="background-color: #DC2626; color: #FFFFFF;"><th style="padding: 0.8rem; text-align: left; white-space: nowrap;">SL.</th><th style="padding: 0.8rem; text-align: left; white-space: nowrap;">DESCRIPTION</th><th style="padding: 0.8rem; text-align: center; white-space: nowrap;">QTY</th><th style="padding: 0.8rem; text-align: right; white-space: nowrap;">RATE</th><th style="padding: 0.8rem; text-align: right; white-space: nowrap;">AMOUNT</th></tr></thead><tbody>${orderData.items.map((item, index) => `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 0.8rem;">${index + 1}</td><td style="padding: 0.8rem;"><div style="display: flex; align-items: center; min-width: 200px;"><img src="${item.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 12px;" crossOrigin="anonymous"><span style="font-weight: 500;">${item.name}</span></div></td><td style="padding: 0.8rem; text-align: center;">${item.quantity}</td><td style="padding: 0.8rem; text-align: right;">₹${item.displayPrice.toLocaleString('en-IN')}</td><td style="padding: 0.8rem; text-align: right; font-weight: 500;">₹${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</td></tr>`).join('')}</tbody></table></div>`; const invoiceHTML = `<div style="width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; color: #333; font-size: 11pt; display: flex; flex-direction: column; background: white;"><header style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1.5rem; border-bottom: 4px solid #DC2626;"><div><h1 style="font-size: 2.5rem; font-weight: bold; color: #DC2626; margin: 0;">INVOICE</h1><p style="margin: 8px 0 0; font-size: 1rem; color: #555;"><strong>Invoice No:</strong> ${orderData.orderId}</p><p style="margin: 4px 0 0; font-size: 1rem; color: #555;"><strong>Invoice Date:</strong> ${new Date(orderData.createdAt).toLocaleDateString()}</p></div><div style="text-align: right;"><img src="https://i.ibb.co/2RySQ5K/20240813-084352.png" alt="Ramazone Logo" style="height: 65px; margin-bottom: 8px; margin-left: auto;" crossOrigin="anonymous"><p style="margin: 0; font-weight: bold; font-size: 1.1rem;">${storeDetails.name}</p><p style="margin: 4px 0 0; font-size: 0.9rem; color: #555;">Proprietor: ${storeDetails.owner}</p></div></header><section style="margin-top: 2rem; display: flex; justify-content: space-between; font-size: 0.9rem; line-height: 1.5;"><div><p style="font-weight: bold; color: #555;">STORE DETAILS:</p><p style="margin: 4px 0 0;">${storeDetails.address}</p><p style="margin: 4px 0 0;">${storeDetails.phone}</p><p style="margin: 4px 0 0;">${storeDetails.email}</p></div><div style="text-align: right;"><p style="font-weight: bold; color: #555;">BILL TO:</p><p style="margin: 4px 0 0;">${orderData.customerDetails.name}</p><p style="margin: 4px 0 0; color: #666; max-width: 250px;">${orderData.customerDetails.address}</p>${mobileNumberHTML}</div></section><section style="margin-top: 2.5rem; flex-grow: 1;">${tableHTML}</section><section style="margin-top: 2rem; display: flex; justify-content: flex-end;"><div style="width: 300px; font-size: 0.9rem;"><div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Subtotal:</span><span>₹${summary.subtotal.toLocaleString('en-IN')}</span></div>${summary.coupon ? `<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #16a34a;"><span>Coupon (${summary.coupon.code}):</span><span>- ₹${summary.coupon.discount.toLocaleString('en-IN')}</span></div>` : ''}<div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Delivery Fee:</span><span>${(summary.deliveryCharge || summary.deliveryFee) > 0 ? `₹${(summary.deliveryCharge || summary.deliveryFee).toLocaleString('en-IN')}` : 'Free'}</span></div><div style="display: flex; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; border-top: 2px solid #333; font-weight: bold; font-size: 1.3rem;"><span>Grand Total:</span><span>₹${summary.grandTotal.toLocaleString('en-IN')}</span></div></div></section><footer style="margin-top: 4rem; display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #eee; padding-top: 1rem;"><div style="font-size: 0.8rem; color: #888;"><p style="margin: 0;">Thank you for your order!</p><p style="margin: 4px 0 0; font-weight: bold;">${storeDetails.website}</p></div><div style="text-align: center;"><p style="font-weight: bold; font-size: 1.2rem; letter-spacing: 1px; font-family: 'Segoe UI', sans-serif; margin: 0; color: #333;">Ramazone</p><p style="margin: 0; border-top: 1px solid #555; padding-top: 4px; font-size: 0.8rem; font-weight: bold;">Authorized Signatory</p></div></footer></div>`;
            const renderContainer = document.createElement('div'); renderContainer.style.position = 'absolute'; renderContainer.style.left = '-9999px'; document.body.appendChild(renderContainer); renderContainer.innerHTML = invoiceHTML; const invoiceElement = renderContainer.querySelector('div'); const canvas = await html2canvas(invoiceElement, { scale: 3, useCORS: true, allowTaint: true }); const link = document.createElement('a'); link.download = `Ramazone-Invoice-${orderId}.png`; link.href = canvas.toDataURL('image/png'); link.click(); document.body.removeChild(renderContainer); window.showToast('Success', `Invoice for ${orderId} downloaded.`, 'success'); } 
        catch (error) { console.error("Invoice download failed:", error); window.showToast(error.message, 'error'); } 
        finally { btn.disabled = false; btn.innerHTML = `<i class="fas fa-receipt mr-1"></i>Invoice`; }
    }
    
    initializeOrdersSection();
})();
</script>

