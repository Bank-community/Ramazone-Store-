<!-- sections/orders.html -->

<div class="mb-6">
    <div class="border-b border-gray-200 bg-white rounded-t-lg">
        <nav class="-mb-px" aria-label="Tabs">
            <div class="flex">
                <button id="pending-tab-btn" class="tab-button active" data-tab="pending">Pending</button>
                <button id="confirmed-tab-btn" class="tab-button" data-tab="confirmed">Confirmed</button>
                <button id="rejected-tab-btn" class="tab-button" data-tab="rejected">Rejected</button>
            </div>
        </nav>
    </div>
</div>

<div id="orders-content">
    <div id="pending-orders-content" class="tab-content"></div>
    <div id="confirmed-orders-content" class="tab-content hidden"></div>
    <div id="rejected-orders-content" class="tab-content hidden"></div>
</div>

<div id="orders-loading-indicator" class="text-center py-16"><div class="loader"></div><p class="text-primary font-medium mt-6">Loading Orders...</p></div>
<div id="no-orders-message" class="text-center py-16 hidden"><i class="fas fa-inbox text-5xl text-gray-300"></i><h3 class="mt-4 text-xl font-semibold text-gray-700">No Orders Found</h3><p class="text-gray-500 mt-1">Is section mein abhi koi order nahi hai.</p></div>

<!-- Hidden Invoice Template for Image Generation -->
<div id="invoice-template-container" style="font-family: 'Poppins', sans-serif;">
    <!-- Invoice content will be dynamically generated here before capturing -->
</div>


<script>
(function() {
    // --- ELEMENTS ---
    const contentArea = document.getElementById('orders-content');
    const loadingIndicator = document.getElementById('orders-loading-indicator');
    const noOrdersMessage = document.getElementById('no-orders-message');
    const tabs = { pending: document.getElementById('pending-tab-btn'), confirmed: document.getElementById('confirmed-tab-btn'), rejected: document.getElementById('rejected-tab-btn') };
    const contents = { pending: document.getElementById('pending-orders-content'), confirmed: document.getElementById('confirmed-orders-content'), rejected: document.getElementById('rejected-orders-content') };

    let currentTab = 'pending';
    let ordersRef = null;

    // --- REAL-TIME LISTENER ---
    function initializeOrdersSection() {
        loadingIndicator.classList.remove('hidden');
        contentArea.classList.add('hidden');
        
        if (ordersRef) ordersRef.off(); 

        ordersRef = db.ref(`${DB_BASE_PATH}/orders`);
        ordersRef.on('value', (snapshot) => {
            const ordersData = snapshot.val() || {};
            const allOrders = {
                pending: ordersData.pending || {},
                confirmed: ordersData.confirmed || {},
                rejected: ordersData.rejected || {}
            };
            renderAllOrders(allOrders);
            updateNoOrdersMessage(allOrders);
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');
        }, (error) => {
            console.error("Firebase read failed:", error);
            window.showToast('Error', 'Could not fetch orders.', 'error');
            loadingIndicator.classList.add('hidden');
        });

        setupEventListeners();
        switchTab('pending');
    }

    // --- RENDER FUNCTIONS ---
    function renderAllOrders(allOrders) {
        renderOrderList(allOrders.pending, contents.pending, 'pending');
        renderOrderList(allOrders.confirmed, contents.confirmed, 'confirmed');
        renderOrderList(allOrders.rejected, contents.rejected, 'rejected');
    }

    function renderOrderList(orderObject, container, type) {
        container.innerHTML = '';
        const orderIds = Object.keys(orderObject);
        if (orderIds.length === 0) return;
        orderIds.sort((a, b) => orderObject[b].createdAt - orderObject[a].createdAt);
        orderIds.forEach(orderId => container.appendChild(createOrderCard(orderObject[orderId], type)));
    }

    function createOrderCard(order, type) {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'order-card-wrapper';
        cardWrapper.dataset.orderId = order.orderId;
        cardWrapper.dataset.orderType = type;

        const allProductsInDB = window.ramazoneData.products || [];
        const sellerSet = new Set();
        order.items.forEach(item => {
            const productDetails = allProductsInDB.find(p => p && p.id === item.id);
            const sellerName = productDetails ? (productDetails.sellerName || 'Ramazone') : 'Ramazone';
            sellerSet.add(sellerName);
        });
        
        const sellers = Array.from(sellerSet);
        let sourceTag = '';
        if (sellers.length === 1 && sellers[0] === 'Ramazone') {
            sourceTag = `<div class="ramazone-tag">üè¨ Ramazone</div>`;
        } else if (sellers.length === 1) {
            sourceTag = `<div class="vendor-tag">üõçÔ∏è Vendor: ${sellers[0]}</div>`;
        } else {
             sourceTag = `<div class="vendor-tag">üõçÔ∏è Multiple Vendors</div>`;
        }

        const statusClass = `status-${order.status.replace(/\s+/g, '-')}`;
        let actionButtons = '';
        let compactActionButtons = '';

        if (type === 'pending') {
            compactActionButtons = `<button class="btn btn-sm btn-primary approve-btn"><i class="fas fa-check mr-1"></i>Approve</button>`;
            actionButtons = `<button class="btn btn-sm btn-danger reject-btn"><i class="fas fa-times mr-1"></i>Reject</button>`;
        } else if (type === 'confirmed') {
            switch(order.status) {
                case 'Confirmed': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Shipped"><i class="fas fa-truck mr-1"></i>Mark Shipped</button>`; break;
                case 'Shipped': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Out for Delivery"><i class="fas fa-box-taped mr-1"></i>Mark OFD</button>`; break;
                case 'Out for Delivery': actionButtons = `<button class="btn btn-sm btn-primary status-update-btn" data-status="Delivered"><i class="fas fa-star mr-1"></i>Mark Delivered</button>`; break;
                case 'Delivered': actionButtons = `<span class="font-semibold text-green-600 flex items-center gap-2"><i class="fas fa-check-circle"></i>Completed</span>`; break;
            }
        } else if (type === 'rejected') {
            actionButtons = `<button class="btn btn-sm btn-danger delete-btn"><i class="fas fa-trash-alt mr-1"></i>Delete</button>`;
        }

        const customerPhone = order.customerDetails.mobile || order.customerDetails.phone || 'N/A';
        
        // === FEATURE 2: WHATSAPP PRE-FILLED MESSAGE GENERATION ===
        let whatsappMessage = `*Ramazone Store*\n\n`;
        whatsappMessage += `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${order.customerDetails.name},\n\n`;
        whatsappMessage += `‡§Ü‡§™‡§ï‡•á ‡§ë‡§∞‡•ç‡§°‡§∞ (${order.orderId}) ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§π‡•à:\n`;
        order.items.forEach(item => {
            whatsappMessage += `- ${item.name} (Qty: ${item.quantity})\n`;
        });
        whatsappMessage += `\nTotal Amount: ‚Çπ${order.priceSummary.grandTotal.toLocaleString('en-IN')}\n\n`;
        whatsappMessage += `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§ï‡•É‡§™‡§Ø‡§æ 'Yes' ‡§Ø‡§æ 'No' ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§`;
        const encodedWhatsappMessage = encodeURIComponent(whatsappMessage);
        const whatsappLink = `https://api.whatsapp.com/send?phone=91${customerPhone.replace(/\s/g, '')}&text=${encodedWhatsappMessage}`;


        cardWrapper.innerHTML = `
            <div class="order-card-compact">
                <!-- Left Side -->
                <div>
                    <h3 class="font-bold text-lg">${order.customerDetails.name}</h3>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="font-mono">${order.orderId}</span>
                        <button class="copy-btn" title="Copy Order ID"><i class="far fa-copy"></i></button>
                    </div>
                     <div class="mt-2">${sourceTag}</div>
                </div>
                <!-- Right Side -->
                <div class="text-right">
                    <p class="font-bold text-xl text-primary">‚Çπ${order.priceSummary.grandTotal.toLocaleString('en-IN')}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(order.createdAt).toLocaleString()}</p>
                    <div class="flex items-center gap-2 mt-2 justify-end">
                       <button class="btn btn-sm view-details-btn"><i class="fas fa-chevron-down mr-1"></i>Details</button>
                       ${compactActionButtons}
                    </div>
                </div>
            </div>
            <div class="order-card-details">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="font-semibold mb-2 text-gray-700">Items:</p>
                        <div class="space-y-3">${order.items.map(item => {
                             // === FEATURE 1: SELLER NAME PER PRODUCT ===
                            const productDetails = allProductsInDB.find(p => p && p.id === item.id);
                            const sellerName = productDetails ? (productDetails.sellerName || 'Ramazone') : 'Ramazone';
                            return `
                            <div class="flex items-start text-sm">
                                <img src="${item.image}" class="w-12 h-12 rounded-md mr-3 object-cover border">
                                <div class="flex-grow">
                                    <p class="font-medium">${item.name}</p>
                                    <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
                                    <p class="text-xs text-purple-700 font-semibold mt-1">‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ: ${sellerName}</p>
                                </div>
                                <span class="font-medium">‚Çπ${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</span>
                            </div>`
                        }).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2 text-gray-700">Customer Details:</p>
                        <div class="text-sm space-y-2">
                            <p><strong>Address:</strong> ${order.customerDetails.address || 'N/A'}, ${order.customerDetails.city || ''}, ${order.customerDetails.state || ''} - ${order.customerDetails.pincode || ''}</p>
                            <!-- FEATURE 2: WHATSAPP ICON AND LINK -->
                            <div class="flex items-center gap-2 pt-1">
                                <a href="${whatsappLink}" target="_blank" class="text-green-600 text-xl" title="Send WhatsApp Confirmation">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                                <a href="${whatsappLink}" target="_blank" class="text-blue-600 hover:underline">
                                    ${customerPhone}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <div class="flex items-center gap-3"><span class="status-badge ${statusClass}">${order.status}</span></div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm invoice-btn"><i class="fas fa-receipt mr-1"></i>Download Invoice</button>
                        ${actionButtons}
                    </div>
                </div>
            </div>
        `;
        return cardWrapper;
    }

    // --- UI & EVENT FUNCTIONS ---
    function switchTab(tabName) { /* ... (Code unchanged) ... */ }
    function updateNoOrdersMessage(allOrdersData) { /* ... (Code unchanged) ... */ }
    function setupEventListeners() { /* ... (Code unchanged) ... */ }
    async function handleCardButtonClick(e) { /* ... (Code unchanged but will work with new buttons) ... */ }
    async function generateInvoice(orderId) { /* ... (Code unchanged) ... */ }
    async function moveOrder(orderId, from, to, newStatus) { /* ... (Code unchanged) ... */ }
    async function deleteOrder(orderId) { /* ... (Code unchanged) ... */ }
    async function updateOrderStatus(orderId, newStatus) { /* ... (Code unchanged) ... */ }

    // Re-pasting the unchanged functions for completeness
    function switchTab(tabName) {
        currentTab = tabName;
        Object.values(tabs).forEach(t => t.classList.remove('active'));
        Object.values(contents).forEach(c => c.classList.add('hidden'));
        tabs[tabName].classList.add('active');
        contents[tabName].classList.remove('hidden');
        updateNoOrdersMessage();
    }
    
    function updateNoOrdersMessage(allOrdersData) {
        const ordersToShow = allOrdersData || { pending: contents.pending.children.length, confirmed: contents.confirmed.children.length, rejected: contents.rejected.children.length };
        const count = (typeof ordersToShow[currentTab] === 'number') ? ordersToShow[currentTab] : Object.keys(ordersToShow[currentTab]).length;
        noOrdersMessage.classList.toggle('hidden', count > 0);
    }
    
    function setupEventListeners() {
        Object.keys(tabs).forEach(tabName => tabs[tabName].addEventListener('click', () => switchTab(tabName)));
        contentArea.addEventListener('click', handleCardButtonClick);
    }

    async function handleCardButtonClick(e) {
        const button = e.target.closest('button');
        const link = e.target.closest('a');
        if (!button && !link) return;

        const card = e.target.closest('.order-card-wrapper');
        if (!card) return; 
        const orderId = card.dataset.orderId;
        const orderType = card.dataset.orderType;

        if (button && button.classList.contains('view-details-btn')) {
            const details = card.querySelector('.order-card-details');
            const icon = button.querySelector('i');
            details.classList.toggle('expanded');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        } else if (button && button.classList.contains('copy-btn')) {
            const textToCopy = orderId;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); window.showToast('Copied!', `Order ID ${textToCopy} copied.`, 'success', 2000); } 
            catch (err) { console.error('Copy failed', err); window.showToast('Error', 'Could not copy ID.', 'error', 2000); }
            document.body.removeChild(textArea);
        } else if (button && button.classList.contains('invoice-btn')) {
            await generateInvoice(orderId);
        } 
        else if (button && button.classList.contains('approve-btn')) {
            await moveOrder(orderId, orderType, 'confirmed', 'Confirmed');
        } else if (button && button.classList.contains('reject-btn')) {
            await moveOrder(orderId, orderType, 'rejected', 'Rejected');
        } 
        else if (button && button.classList.contains('delete-btn')) {
            await deleteOrder(orderId);
        } else if (button && button.classList.contains('status-update-btn')) {
            await updateOrderStatus(orderId, button.dataset.status);
        }
    }
    
    async function moveOrder(orderId, from, to, newStatus) {
        const orderRef = db.ref(`${DB_BASE_PATH}/orders/${from}/${orderId}`);
        const snapshot = await orderRef.get();
        if (!snapshot.exists()) return window.showToast('Error', 'Order not found.', 'error');
        const orderData = snapshot.val();
        orderData.status = newStatus;
        orderData.statusHistory = orderData.statusHistory || {};
        orderData.statusHistory[Date.now()] = { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP };
        const updates = {};
        updates[`orders/${from}/${orderId}`] = null;
        updates[`orders/${to}/${orderId}`] = orderData;
        try { await db.ref(DB_BASE_PATH).update(updates); window.showToast('Success', `Order has been ${newStatus.toLowerCase()}.`, 'success'); } 
        catch (error) { window.showToast('Error', `Failed to update order: ${error.message}`, 'error'); }
    }

    async function deleteOrder(orderId) {
        if (confirm(`DELETE order ID: ${orderId} permanently?`)) {
            try { await db.ref(`${DB_BASE_PATH}/orders/rejected/${orderId}`).remove(); window.showToast('Success', `Order ${orderId} has been deleted.`, 'success'); } 
            catch (error) { window.showToast('Error', `Failed to delete order: ${error.message}`, 'error'); }
        }
    }
    
    async function updateOrderStatus(orderId, newStatus) {
        const button = event.target.closest('button');
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        const updates = { status: newStatus, [`statusHistory/${Date.now()}`]: { status: newStatus, timestamp: firebase.database.ServerValue.TIMESTAMP } };
        try { await db.ref(`${DB_BASE_PATH}/orders/confirmed/${orderId}`).update(updates); window.showToast('Success', `Status updated to ${newStatus}.`, 'success'); } 
        catch (error) { window.showToast('Error', `Failed to update status: ${error.message}`, 'error'); button.disabled = false; /* Restore button text */ }
    }
    
    async function generateInvoice(orderId) {
        const btn = event.target.closest('.invoice-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>Generating...`;
        const orderType = event.target.closest('.order-card-wrapper').dataset.orderType;
        const orderRef = db.ref(`${DB_BASE_PATH}/orders/${orderType}/${orderId}`);
        const snapshot = await orderRef.get();
        if (!snapshot.exists()) { /* ... error handling ... */ return; }
        const order = snapshot.val();
        const invoiceContainer = document.getElementById('invoice-template-container');
        const today = new Date();
        const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
        const customerPhone = order.customerDetails.mobile || order.customerDetails.phone || 'N/A';
        invoiceContainer.innerHTML = `
            <div style="padding: 2rem; border: 1px solid #eee; background: white; width: 800px;">
                 <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1rem;"><div><h2 style="font-size: 1.5rem; font-weight: 600; margin: 0;">INVOICE</h2><p style="margin: 5px 0 0 0;"><strong>Invoice No:</strong> ${order.orderId}</p><p style="margin: 5px 0 0 0;"><strong>Invoice Date:</strong> ${formattedDate}</p></div><div style="text-align: right;"><img src="https://i.ibb.co/2RySQ5K/20240813-084352.png" alt="Ramazone Logo" style="width: 80px; height: auto; margin-bottom: 5px;"><h3 style="font-size: 1.2rem; font-weight: 600; margin: 0;">Ramazone Online Store</h3><p style="margin: 5px 0 0 0;">Proprietor: Prince Rama</p></div></div>
                 <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #eee; font-size: 0.9rem;"><div><h4 style="margin: 0 0 10px 0; color: #555;">STORE DETAILS:</h4><p style="margin: 5px 0;">Lalunagar, Begusarai, Bihar - 851129</p><p style="margin: 5px 0;"><strong>WhatsApp:</strong> 7903698180</p><p style="margin: 5px 0;">ramazone007@gmail.com</p></div><div style="text-align: right;"><h4 style="margin: 0 0 10px 0; color: #555;">BILL TO:</h4><p style="margin: 5px 0;"><strong>${order.customerDetails.name}</strong></p><p style="margin: 5px 0;">${order.customerDetails.address}, ${order.customerDetails.city}, ${order.customerDetails.state} - ${order.customerDetails.pincode}</p><p style="margin: 5px 0;"><strong>Mobile:</strong> ${customerPhone}</p></div></div>
                 <table style="width: 100%; border-collapse: collapse; margin-top: 2rem; font-size: 0.9rem;"><thead style="background-color: #dc2626; color: white;"><tr><th style="padding: 0.75rem; text-align: left;">SL.</th><th style="padding: 0.75rem; text-align: left;">DESCRIPTION</th><th style="padding: 0.75rem; text-align: center;">QTY</th><th style="padding: 0.75rem; text-align: right;">RATE</th><th style="padding: 0.75rem; text-align: right;">AMOUNT</th></tr></thead><tbody>${order.items.map((item, index) => `
                        <tr style="border-bottom: 1px solid #eee;"><td style="padding: 0.75rem;">${index + 1}</td><td style="padding: 0.75rem; display: flex; align-items: center;"><img src="${item.image}" style="width: 40px; height: 40px; border-radius: 4px; margin-right: 10px; object-fit: cover;">${item.name}</td><td style="padding: 0.75rem; text-align: center;">${item.quantity}</td><td style="padding: 0.75rem; text-align: right;">‚Çπ${item.displayPrice.toLocaleString('en-IN')}</td><td style="padding: 0.75rem; text-align: right;">‚Çπ${(item.displayPrice * item.quantity).toLocaleString('en-IN')}</td></tr>`).join('')}</tbody></table>
                 <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;"><div style="width: 280px; font-size: 0.9rem;"><div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Subtotal:</span><strong>‚Çπ${order.priceSummary.subtotal.toLocaleString('en-IN')}</strong></div><div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"><span>Delivery Fee:</span><strong>‚Çπ${order.priceSummary.deliveryCharge.toLocaleString('en-IN')}</strong></div>${order.priceSummary.personalDiscount ? `<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: green;"><span>Special Offer:</span><strong>- ‚Çπ${order.priceSummary.personalDiscount.toLocaleString('en-IN')}</strong></div>` : ''}<div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-top: 2px solid #333; margin-top: 0.5rem; font-size: 1.2rem; font-weight: bold;"><span>Grand Total:</span><strong>‚Çπ${order.priceSummary.grandTotal.toLocaleString('en-IN')}</strong></div></div></div>
                 <div style="margin-top: 3rem; border-top: 1px solid #eee; padding-top: 1rem; font-size: 0.8rem; color: #777; text-align: center;"><p>Thank you for your order!</p><p>www.ramazon.in</p></div>
            </div>`;
        try { const canvas = await html2canvas(invoiceContainer, { scale: 2 }); const imageURL = canvas.toDataURL('image/jpeg', 0.9); const link = document.createElement('a'); link.href = imageURL; link.download = `Invoice-${order.orderId}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); invoiceContainer.innerHTML = ''; window.showToast('Success', `Invoice for ${order.orderId} downloaded.`, 'success'); } 
        catch(err) { console.error('Invoice generation error:', err); window.showToast('Error', 'Could not generate invoice image.', 'error'); } 
        finally { btn.disabled = false; btn.innerHTML = `<i class="fas fa-receipt mr-1"></i>Download Invoice`; }
    }


    initializeOrdersSection();
})();
</script>

