<!-- sections/product-form.html -->
<style>
/* Styles for dynamic blocks */
.variant-type-block, .description-block, .spec-highlight-block {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    background-color: #ffffff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    overflow: hidden;
}
.variant-type-header, .description-block-header, .spec-highlight-header {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    cursor: pointer;
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}
.variant-type-body, .description-block-body, .spec-highlight-body {
    padding: 1.25rem;
    background-color: #ffffff;
}
.multi-image-preview-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
}
.multi-image-preview-item {
    position: relative;
    aspect-ratio: 1/1;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    cursor: grab;
    background-color: #f3f4f6;
}
.multi-image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
.remove-img-btn {
    position: absolute; top: 0.25rem; right: 0.25rem; width: 1.5rem; height: 1.5rem;
    background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%;
    cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;
}
.remove-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1.25rem; color: #ef4444;
}
.fa-chevron-down { transition: transform 0.3s ease; }
.rotate-180 { transform: rotate(180deg); }
.combo-item { display: flex; gap: 0.5rem; align-items: center; }
</style>

<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div>
        <h2 id="product-form-title" class="text-2xl font-bold text-gray-800">Add New Product</h2>
        <p class="text-sm text-gray-500">Fill in the details below and click save.</p>
    </div>
    <button id="back-to-products-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back to Products</button>
</div>

<div class="admin-card">
    <div class="card-body">
        <form id="product-form" class="space-y-6">
            <!-- Yeh hidden field edit kiye ja rahe product ka original index store karega -->
            <input type="hidden" id="product-edit-index">
            <input type="hidden" id="combo-data-storage">

            <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                <!-- Basic Details -->
                <div><label class="form-label">Product Name</label><input type="text" class="form-control" data-key="name" required></div>
                <div><label class="form-label">Category</label><select class="form-control" data-key="category" id="product-category-selector" required><option value="">Select Category</option></select></div>
                <div><label class="form-label">Display Price</label><input type="number" class="form-control" data-key="displayPrice" required></div>
                <div><label class="form-label">Original Price</label><input type="number" class="form-control" data-key="originalPrice" required></div>
                <div><label class="form-label">Seller Name</label><input type="text" class="form-control" data-key="sellerName" value="Ramazone"></div>
                <div><label class="form-label">Product Quantity</label><input type="number" class="form-control" data-key="quantity"></div>
                
                <div class="md:col-span-2">
                    <label class="form-label">Return Policy</label>
                    <div class="flex items-center gap-4">
                        <select id="return-policy-type" class="form-control w-1/3">
                            <option value="days">Returnable</option>
                            <option value="no_return">No Return</option>
                            <option value="custom">Custom Policy</option>
                        </select>
                        <div id="return-policy-value-container" class="flex-grow">
                            <input type="number" id="return-policy-days" class="form-control" placeholder="e.g., 7 (in days)">
                            <input type="text" id="return-policy-custom" class="form-control hidden" placeholder="e.g., 7 Days Replacement">
                        </div>
                    </div>
                </div>

                <div><label class="form-label">SKU (Auto-Generated)</label><input type="text" class="form-control bg-gray-200" data-key="sku" readonly></div>

                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Offer Badge (Optional)</h4></div>
                <div><label class="form-label">Offer Text</label><input type="text" class="form-control" data-key="offerText"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="form-label">Background Color</label><input type="color" class="form-control h-10 p-1" data-key="offerBackgroundColor" value="#0000ff"></div><div><label class="form-label">Text Color</label><input type="color" class="form-control h-10 p-1" data-key="offerTextColor" value="#ffffff"></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Review & Rating</h4></div>
                <div><label class="form-label">Star Rating</label><input type="number" step="0.1" min="1" max="5" class="form-control" data-key="rating"></div>
                <div><label class="form-label">Review Count</label><input type="number" class="form-control" data-key="reviewCount"></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Media</h4></div>
                <div class="md:col-span-2"><label class="form-label">Product YouTube Video (Optional)</label><input type="url" class="form-control" data-key="videoUrl"></div>
                <div class="md:col-span-2">
                    <label class="form-label">Product Images</label>
                    <p class="text-xs text-gray-500 mb-2">Pehli image thumbnail banegi. Images ko drag karke order badal sakte hain.</p>
                    <input type="file" id="multi-image-upload-input" class="form-control" accept="image/*" multiple>
                    <div id="multi-image-preview-container" class="multi-image-preview-container mt-2"></div>
                </div>
                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Select Similar Products</h4><select id="similar-products-filter" class="form-control text-sm w-auto"><option value="all">All Products</option><option value="same_category">Same Category</option></select></div>
                    <p class="text-xs text-gray-500 mb-2">Customer ko suggest karne ke liye products chunein.</p>
                    <select id="similar-products-selector" class="form-control" data-key="similarProductIds" multiple style="height: 150px;"></select>
                </div>
                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-lg text-gray-700">Combo Offers</h4>
                        <button type="button" id="open-combo-modal-btn" class="btn btn-secondary"><i class="fas fa-cogs mr-2"></i> Manage Combos</button>
                    </div>
                </div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Product Variants</h4><button type="button" id="add-variant-type-btn" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i> Add Variant Type</button></div><div id="variants-container"></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Advanced Highlights</h4><div id="spec-highlights-container" class="space-y-4 border rounded-lg p-4 bg-gray-50"><div class="grid md:grid-cols-2 gap-4"><div><label class="form-label">Spec Score</label><input type="text" class="form-control" id="spec-score-input"></div><div><label class="form-label">Spec Tag</label><input type="text" class="form-control" id="spec-tag-input"></div></div><div class="border-t pt-4 mt-4"><div class="flex justify-between items-center"><h5 class="font-semibold text-gray-700">Highlight Blocks</h5><button type="button" id="add-spec-block-btn" class="btn btn-sm btn-secondary"><i class="fas fa-plus mr-1"></i> Add Block</button></div><div id="spec-blocks-list" class="mt-2"></div></div></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Simple Product Description</h4><button type="button" id="add-desc-block-btn" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i> Add Block</button></div><div id="description-blocks-container"></div></div>
            </div>
        </form>
    </div>
    <div class="card-footer text-right">
        <button id="save-product-btn" class="btn btn-primary"><i class="fas fa-save mr-2"></i> Save Changes</button>
    </div>
</div>

<script>
(function() {
    // --- ELEMENTS ---
    const form = document.getElementById('product-form');
    const saveBtn = document.getElementById('save-product-btn');
    const backBtn = document.getElementById('back-to-products-btn');
    const formTitle = document.getElementById('product-form-title');
    const imagePreviewContainer = document.getElementById('multi-image-preview-container');
    const openComboModalBtn = document.getElementById('open-combo-modal-btn');
    const comboDataStorage = document.getElementById('combo-data-storage');
    const returnPolicyType = document.getElementById('return-policy-type');
    const returnPolicyDays = document.getElementById('return-policy-days');
    const returnPolicyCustom = document.getElementById('return-policy-custom');
    let currentProductId = null;

    // --- ALL HELPER FUNCTIONS FOR DYNAMIC HTML ---
    const getVariantOptionHtml = (d={},t='')=>`<div class="variant-option-item flex items-center gap-2 relative pl-6"><i class="fas fa-grip-vertical handle-option cursor-move text-gray-300 absolute top-1/2 -translate-y-1/2 left-0"></i><input type="text" class="form-control variant-option-name" placeholder="Option Name" value="${d.name||''}"><input type="color" class="variant-option-value h-10 w-10 p-1" style="display:${t.toLowerCase()==='color'?'block':'none'}" value="${d.value||'#000000'}"><button type="button" class="remove-btn remove-variant-option-btn">×</button></div>`;
    const getVariantTypeHtml = (d={})=>`<div class="variant-type-block"><div class="variant-type-header"><i class="fas fa-grip-vertical handle cursor-move text-gray-400 mr-3"></i><span class="font-semibold flex-grow truncate">${d.type||'New Variant Type'}</span><i class="fas fa-chevron-down text-gray-500"></i><button type="button" class="remove-btn remove-variant-type-btn ml-3">×</button></div><div class="variant-type-body" style="display:none;"><div class="grid md:grid-cols-2 gap-4"><div><label class="form-label">Type</label><input type="text" class="form-control variant-type-name" value="${d.type||''}"></div><div><label class="form-label">Options</label><div class="variant-options-container space-y-2">${(d.options||[]).map(o=>getVariantOptionHtml(o,d.type)).join('')}</div><button type="button" class="btn btn-sm btn-secondary mt-2 add-variant-option-btn"><i class="fas fa-plus mr-1"></i>Add Option</button></div></div></div></div>`;
    const getDescriptionBlockHtml = (d={})=>`<div class="description-block"><div class="description-block-header"><i class="fas fa-grip-vertical handle cursor-move text-gray-400 mr-3"></i><span class="font-semibold flex-grow truncate">${d.title||'New Block'}</span><i class="fas fa-chevron-down text-gray-500"></i><button type="button" class="remove-btn remove-desc-block-btn ml-3">×</button></div><div class="description-block-body" style="display:none;"><label class="form-label">Title</label><input type="text" class="form-control desc-title mb-2" value="${d.title||''}"><label class="form-label">Details</label><textarea class="form-control desc-details" rows="3">${d.details||''}</textarea></div></div>`;
    const getSpecHighlightBlockHtml = (d={})=>`<div class="spec-highlight-block"><div class="spec-highlight-header"><i class="fas fa-grip-vertical handle cursor-move text-gray-400 mr-3"></i><span class="font-semibold flex-grow truncate">${d.title||'New Highlight'}</span><i class="fas fa-chevron-down text-gray-500"></i><button type="button" class="remove-btn remove-spec-block-btn ml-3">×</button></div><div class="spec-highlight-body" style="display:none;"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="form-label">Icon (SVG)</label><textarea class="form-control spec-block-icon" rows="2">${d.icon||''}</textarea></div><div><label class="form-label">Category</label><input type="text" class="form-control spec-block-category" value="${d.category||''}"></div><div class="md:col-span-2"><label class="form-label">Title</label><input type="text" class="form-control spec-block-title" value="${d.title||''}"></div><div class="md:col-span-2"><label class="form-label">Subtitle</label><input type="text" class="form-control spec-block-subtitle" value="${d.subtitle||''}"></div></div></div></div>`;
    
    // --- MAIN FUNCTIONS ---
    function initializeForm() {
        const productToEdit = window.editingProductData;
        const catSelector = form.querySelector('#product-category-selector');
        catSelector.innerHTML = '<option value="">Select Category</option>';
        (window.allCategoriesCache || []).forEach(c => { catSelector.innerHTML += `<option value="${c}">${c}</option>`; });

        if (productToEdit) {
            formTitle.textContent = 'Edit Product';
            currentProductId = productToEdit.id;
            form.querySelector('#product-edit-index').value = productToEdit.originalIndex;
            
            Object.keys(productToEdit).forEach(key => {
                const input = form.querySelector(`[data-key="${key}"]`);
                if (input && typeof productToEdit[key] !== 'object') {
                     input.value = productToEdit[key];
                }
            });
            
            const policy = productToEdit.returnPolicy;
            if (policy && policy.type) {
                returnPolicyType.value = policy.type;
                if (policy.type === 'days') returnPolicyDays.value = policy.value;
                if (policy.type === 'custom') returnPolicyCustom.value = policy.value;
            }
            handleReturnPolicyChange();

            (productToEdit.images || []).forEach(url => renderImagePreview(url));
            (productToEdit.variants || []).forEach(d => document.getElementById('variants-container').insertAdjacentHTML('beforeend', getVariantTypeHtml(d)));
            (productToEdit.description || []).forEach(d => document.getElementById('description-blocks-container').insertAdjacentHTML('beforeend', getDescriptionBlockHtml(d)));
            if (productToEdit.specHighlights) {
                form.querySelector('#spec-score-input').value = productToEdit.specHighlights.specScore || '';
                form.querySelector('#spec-tag-input').value = productToEdit.specHighlights.specTag || '';
                (productToEdit.specHighlights.blocks || []).forEach(d => document.getElementById('spec-blocks-list').insertAdjacentHTML('beforeend', getSpecHighlightBlockHtml(d)));
            }
            if (productToEdit.combos) comboDataStorage.value = JSON.stringify(productToEdit.combos);
            if (productToEdit.similarProductIds) form.dataset.tempSimilarIds = JSON.stringify(productToEdit.similarProductIds);
        
        } else {
            formTitle.textContent = 'Add New Product';
            const newSku = `RAMA-${Date.now().toString().slice(-6)}`;
            form.querySelector('[data-key="sku"]').value = newSku;
        }
        
        updateSimilarProductsSelector('all');
        window.editingProductData = null;
    }

    async function saveProduct() {
        if (!form.reportValidity()) return window.showToast('Validation Error', 'Please fill all required fields.', 'error');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        try {
            const itemData = {};
            form.querySelectorAll('[data-key]').forEach(el => {
                if (el.type === 'number') itemData[el.dataset.key] = Number(el.value) || null;
                else itemData[el.dataset.key] = el.value || null;
            });
            
            const index = form.querySelector('#product-edit-index').value;

            if (index && window.allProductsCache[index] && window.allProductsCache[index].vendorId) {
                itemData.vendorId = window.allProductsCache[index].vendorId;
            } else {
                itemData.vendorId = 'admin';
            }

            const policyType = returnPolicyType.value;
            let policyValue = null;
            if (policyType === 'days') policyValue = returnPolicyDays.value;
            else if (policyType === 'custom') policyValue = returnPolicyCustom.value;
            itemData.returnPolicy = { type: policyType, value: policyValue };

            const uploadedImages = await Promise.all(
                Array.from(imagePreviewContainer.querySelectorAll('img'))
                .map(img => img._file ? window.uploadToImgBB(img._file) : Promise.resolve(img.src))
            );
            itemData.images = uploadedImages.filter(Boolean);
            
            itemData.similarProductIds = Array.from(form.querySelector('#similar-products-selector').selectedOptions).map(o=>o.value);
            itemData.variants = Array.from(form.querySelectorAll('.variant-type-block')).map(b=>({type:b.querySelector('.variant-type-name').value,options:Array.from(b.querySelectorAll('.variant-option-item')).map(o=>({name:o.querySelector('.variant-option-name').value,value:o.querySelector('.variant-option-value').value}))}));
            itemData.description = Array.from(form.querySelectorAll('.description-block')).map(b=>({title:b.querySelector('.desc-title').value,details:b.querySelector('.desc-details').value}));
            itemData.specHighlights = {specScore:form.querySelector('#spec-score-input').value,specTag:form.querySelector('#spec-tag-input').value,blocks:Array.from(form.querySelectorAll('.spec-highlight-block')).map(b=>({icon:b.querySelector('.spec-block-icon').value,category:b.querySelector('.spec-block-category').value,title:b.querySelector('.spec-block-title').value,subtitle:b.querySelector('.spec-block-subtitle').value}))};
            if(comboDataStorage.value) itemData.combos = JSON.parse(comboDataStorage.value);

            const listRef = db.ref(`${DB_BASE_PATH}/products`);
            let list = (await listRef.get()).val() || [];
            
            if (index) {
                itemData.id = list[index].id;
                list[index] = itemData;
            } else {
                itemData.id = `prod-${Date.now()}`;
                list.push(itemData);
            }
            
            await listRef.set(list);
            window.showToast('Success', 'Product saved successfully!', 'success');
            document.querySelector('.sidebar-link[data-page="sections/products.html"]').click();
        
        } catch (err) {
            window.showToast('Error', `Save failed: ${err.message}`, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
        }
    }

    function handleReturnPolicyChange() {
        const selectedType = returnPolicyType.value;
        returnPolicyDays.classList.toggle('hidden', selectedType !== 'days');
        returnPolicyCustom.classList.toggle('hidden', selectedType !== 'custom');
    }

    function renderImagePreview(src, file=null) {
        const item = document.createElement('div');
        item.className = 'multi-image-preview-item';
        const img = document.createElement('img');
        img.src = src;
        if (file) img._file = file;
        item.innerHTML = `<span class="remove-img-btn">×</span>`;
        item.prepend(img);
        imagePreviewContainer.appendChild(item);
    }

    function updateSimilarProductsSelector(filterType) {
        const selector = form.querySelector('#similar-products-selector');
        const currentCategory = form.querySelector('#product-category-selector').value;
        const tempIds = JSON.parse(form.dataset.tempSimilarIds || '[]');
        selector.innerHTML = '';
        let list = (filterType === 'same_category' && currentCategory)
            ? (window.allProductsCache || []).filter(p => p.category === currentCategory)
            : (window.allProductsCache || []);
        
        list.filter(p => p && p.id !== currentProductId).forEach(p => {
            const opt = new Option(`${p.name} (${p.vendorId || 'N/A'})`, p.id);
            if (tempIds.includes(p.id)) opt.selected = true;
            selector.add(opt);
        });
    }
    
    // --- ALL EVENT LISTENERS ---
    backBtn.addEventListener('click', () => document.querySelector('.sidebar-link[data-page="sections/products.html"]').click());
    saveBtn.addEventListener('click', saveProduct);
    returnPolicyType.addEventListener('change', handleReturnPolicyChange);
    new Sortable(imagePreviewContainer, { animation: 150, ghostClass: 'sortable-ghost' });
    
    document.getElementById('multi-image-upload-input').addEventListener('change', e => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = ev => renderImagePreview(ev.target.result, file);
            reader.readAsDataURL(file);
        }
    });

    form.addEventListener('click', e => {
        if(e.target.closest('.remove-img-btn')) e.target.closest('.multi-image-preview-item').remove();
        if(e.target.closest('#add-variant-type-btn')) document.getElementById('variants-container').insertAdjacentHTML('beforeend',getVariantTypeHtml());
        if(e.target.closest('.add-variant-option-btn')) e.target.closest('.variant-type-body').querySelector('.variant-options-container').insertAdjacentHTML('beforeend', getVariantOptionHtml());
        if(e.target.closest('.remove-variant-type-btn')) e.target.closest('.variant-type-block').remove();
        if(e.target.closest('.remove-variant-option-btn')) e.target.closest('.variant-option-item').remove();
        if(e.target.closest('#add-desc-block-btn')) document.getElementById('description-blocks-container').insertAdjacentHTML('beforeend', getDescriptionBlockHtml());
        if(e.target.closest('.remove-desc-block-btn')) e.target.closest('.description-block').remove();
        if(e.target.closest('#add-spec-block-btn')) document.getElementById('spec-blocks-list').insertAdjacentHTML('beforeend', getSpecHighlightBlockHtml());
        if(e.target.closest('.remove-spec-block-btn')) e.target.closest('.spec-highlight-block').remove();
        const header = e.target.closest('.variant-type-header, .description-block-header, .spec-highlight-header');
        if(header && !e.target.closest('.remove-btn')) {
            const body = header.nextElementSibling;
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
            header.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
        }
    });

    // --- === LOGIC FIX STARTS HERE === ---
    openComboModalBtn.addEventListener('click', () => {
        const modal = document.getElementById('universalModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const existingData = comboDataStorage.value ? JSON.parse(comboDataStorage.value) : {};

        const getComboHtml = (data={}) => {
            let packsHtml = (data.quantityPacks||[]).map(p=>`<div class="combo-item"><input type="text" class="form-control" value="${p.name || ''}" placeholder="e.g., 2 Piece Pack"><input type="number" class="form-control" value="${p.price || ''}" placeholder="Price"><button type="button" class="remove-btn remove-quantity-pack-btn">×</button></div>`).join('');
            const opts = (window.allProductsCache || []).filter(p=> p && p.id !== currentProductId).map(p=>`<option value="${p.id}" ${data.productBundle&&data.productBundle.linkedProductId===p.id?'selected':''}>${p.name}</option>`).join('');
            return `<div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-semibold">Quantity Packs</h5>
                        <button type="button" id="add-quantity-pack-btn" class="btn btn-sm btn-secondary"><i class="fas fa-plus mr-1"></i>Add Pack</button>
                    </div>
                    <p class="text-xs text-gray-500 mb-2">Max 5 packs.</p>
                    <div id="quantity-packs-container" class="space-y-2">${packsHtml}</div>
                </div>
                <div class="border-t pt-4 mt-4">
                    <h5 class="font-semibold mb-2">Product Bundle</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="form-label">Select Product</label><select id="bundle-product-selector" class="form-control"><option value="">None</option>${opts}</select></div>
                        <div><label class="form-label">Bundle Price</label><input type="number" id="bundle-price-input" class="form-control" value="${data.productBundle ? data.productBundle.bundlePrice : ''}"></div>
                    </div>
                </div>
            </div>`;
        };

        modalTitle.textContent = 'Manage Combo Offers';
        modalBody.innerHTML = getComboHtml(existingData);
        modalSaveBtn.style.display = 'inline-flex';
        modalSaveBtn.textContent = 'Save Combos';
        document.getElementById('modalFooter').style.display = 'flex';


        const modalClickHandler = (e) => {
            if (e.target.id === 'add-quantity-pack-btn') {
                const container = modalBody.querySelector('#quantity-packs-container');
                if (container.children.length < 5) {
                    container.insertAdjacentHTML('beforeend', `<div class="combo-item"><input type="text" class="form-control" placeholder="e.g., 2 Piece Pack"><input type="number" class="form-control" placeholder="Price"><button type="button" class="remove-btn remove-quantity-pack-btn">×</button></div>`);
                } else {
                    window.showToast('Limit Reached', 'You can only add up to 5 quantity packs.', 'error');
                }
            }
            if (e.target.closest('.remove-quantity-pack-btn')) {
                e.target.closest('.combo-item').remove();
            }
        };

        modalBody.addEventListener('click', modalClickHandler);

        modalSaveBtn.onclick = () => {
            const quantityPacks = Array.from(modalBody.querySelectorAll('#quantity-packs-container .combo-item'))
                .map(item => ({name: item.querySelector('input[type="text"]').value, price: Number(item.querySelector('input[type="number"]').value)}))
                .filter(p => p.name && p.price > 0);
            
            const linkedProductId = modalBody.querySelector('#bundle-product-selector').value;
            const bundlePrice = modalBody.querySelector('#bundle-price-input').value;
            let productBundle = (linkedProductId && bundlePrice) ? {linkedProductId, bundlePrice: Number(bundlePrice)} : null;
            
            comboDataStorage.value = JSON.stringify({ quantityPacks, productBundle });
            window.showToast('Combos Ready', 'Combo data will be saved with the product.', 'info');
            
            document.getElementById('modalCloseBtn').click();
            modalBody.removeEventListener('click', modalClickHandler);
            modalSaveBtn.onclick = null; // Purana onclick handler saaf karein
        };

        modal.classList.add('active');
    });
    // --- === LOGIC FIX ENDS HERE === ---

    // --- RUN ON LOAD ---
    initializeForm();
})();
</script>

