<!-- 
  SECTION: sections/product-form.html
  VERSION: 3.6 (New Tag UI + Hidden Field Fix)
  DESCRIPTION: Yeh aapka UI idea hai! Ek alag "Tags Display Area" aur 
               "Input + Plus Button" wala naya system. Yeh 100% save hoga.
-->

<style>
    /* --- CARD & LAYOUT --- */
    .card-section {
        background: #ffffff; border: 1px solid #e5e7eb;
        border-radius: 0.75rem; padding: 1.5rem;
        margin-bottom: 1.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .section-title {
        font-size: 1.1rem; font-weight: 600; color: #1f2937;
        margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
    }

    /* --- IMAGE MANAGER STYLES --- */
    .image-manager-container {
        border: 2px dashed #d1d5db; border-radius: 0.75rem;
        padding: 1rem; background: #f9fafb; transition: border-color 0.2s;
    }
    .image-manager-container.dragover { border-color: #4f46e5; }
    #image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem; margin-top: 1rem;
    }
    .image-card {
        position: relative; aspect-ratio: 1; border-radius: 0.5rem;
        overflow: hidden; background: #fff; border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); cursor: grab;
        transition: transform 0.2s, border-color 0.2s;
    }
    .image-card:active { cursor: grabbing; }
    .image-card.is-cover {
        border: 2px solid #f59e0b; /* Golden border */
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .image-card img { width: 100%; height: 100%; object-fit: cover; }
    .img-action-btn {
        position: absolute; width: 28px; height: 28px; border-radius: 50%;
        border: none; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s, background-color 0.2s; z-index: 10;
    }
    .img-action-btn:hover { transform: scale(1.1); }
    .delete-img-btn {
        top: 5px; right: 5px; background: rgba(255, 255, 255, 0.9); color: #ef4444;
    }
    .star-img-btn {
        top: 5px; left: 5px; background: rgba(255, 255, 255, 0.9); color: #d1d5db;
    }
    .image-card.is-cover .star-img-btn { color: #f59e0b; background: #fff; }
    .cover-badge {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(245, 158, 11, 0.9); color: white; font-size: 0.7rem;
        text-align: center; padding: 2px 0; font-weight: 600; display: none;
    }
    .image-card.is-cover .cover-badge { display: block; }
    .sortable-ghost { opacity: 0.4; border: 2px dashed #4f46e5; background: #f0f0f0; }
    .upload-placeholder {
        text-align: center; cursor: pointer; padding: 1.5rem;
    }
    
    /* --- *** NAYA TAGS UI (Aapka Idea) *** --- */
    #tags-display-area {
        display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem;
        border: 1px solid #d1d5db; border-radius: 0.5rem; background: #f9fafb;
        min-height: 100px; /* Thodi height badha di hai */
        margin-bottom: 0.75rem;
    }
    .tag-pill-placeholder {
        color: #9ca3af; font-size: 0.9rem; margin: auto;
    }
    .tag-pill {
        background-color: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem;
        border-radius: 9999px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;
        animation: tag-pop-in 0.2s ease-out;
    }
    .tag-pill .remove-tag { 
        cursor: pointer; font-weight: bold; font-size: 1rem;
        padding-left: 0.25rem;
    }
    .tag-pill .remove-tag:hover { color: #ef4444; }
    @keyframes tag-pop-in {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    #add-tag-group {
        display: flex; gap: 0.5rem;
    }
    #add-tag-btn {
        padding-left: 1rem; padding-right: 1rem;
        flex-shrink: 0;
    }
    /* --- *** Naya Tags UI End *** --- */

    .location-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem;
        max-height: 150px; overflow-y: auto; padding: 0.5rem; 
        border: 1px solid #e5e7eb; border-radius: 0.5rem; background: #f9fafb;
    }
    .location-checkbox-item {
        display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; cursor: pointer;
        padding: 0.25rem; border-radius: 0.25rem; transition: background 0.2s;
    }
    .location-checkbox-item:hover { background-color: #e5e7eb; }

    /* --- TOGGLES & BLOCKS --- */
    .toggle-switch-label { display: flex; align-items: center; cursor: pointer; gap: 0.75rem; }
    .toggle-switch-checkbox { display: none; }
    .toggle-switch-slider {
        position: relative; width: 50px; height: 26px; background-color: #ccc;
        border-radius: 34px; transition: .4s;
    }
    .toggle-switch-slider:before {
        position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
        background-color: white; transition: .4s; border-radius: 50%;
    }
    .toggle-switch-checkbox:checked + .toggle-switch-slider { background-color: #10b981; }
    .toggle-switch-checkbox:checked + .toggle-switch-slider:before { transform: translateX(24px); }
    .veg-icon { color: #16a34a; font-weight: bold; display: none; }
    .non-veg-icon { color: #ef4444; font-weight: bold; display: block; }
    .toggle-switch-checkbox:checked ~ .veg-icon { display: block; }
    .toggle-switch-checkbox:checked ~ .non-veg-icon { display: none; }

    /* --- VARIANT GROUPING --- */
    #variant-group-info {
        background: #f3e8ff; border: 1px solid #e9d5ff; border-left-width: 4px; border-left-color: #a855f7;
        padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem;
        display: none; /* JS se show hoga */
        align-items: center; justify-content: space-between;
    }
    #variant-group-info .text-purple-700 { color: #6b21a8; }
</style>

<!-- PAGE HEADER -->
<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div>
        <h2 id="product-form-title" class="text-2xl font-bold text-gray-800">Add New Product</h2>
        <p class="text-sm text-gray-500">Manage inventory, variants, and media.</p>
    </div>
    <button id="back-to-products-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back to List</button>
</div>

<!-- MAIN FORM -->
<div class="max-w-5xl mx-auto pb-20">
    <form id="product-form">
        <!-- Hidden inputs for state management -->
        <input type="hidden" id="product-edit-index">
        <input type="hidden" id="combo-data-storage">
        
        <!-- *** YEH HAI "RAMBAAN ILAAJ" WALA HIDDEN FIELD (YEH RAHEGA) *** -->
        <input type="hidden" id="tags-data-storage"> 

        <input type="hidden" id="product-group-id" data-key="groupId">

        <!-- VARIANT GROUP INFO (Visible only if linked) -->
        <div id="variant-group-info">
            <span class="font-semibold text-purple-700"><i class="fas fa-link mr-2"></i>Linked Variant</span>
            <p class="text-xs text-purple-700">This product is part of a variant group. Shared data will be cloned.</p>
        </div>

        <!-- SECTION 1: AVAILABILITY (Hyperlocal) -->
        <div class="card-section border-l-4 border-l-blue-500">
            <div class="section-title text-blue-700"><i class="fas fa-map-marker-alt"></i> Location Availability</div>
            <div class="flex justify-between items-center mb-2">
                <label class="flex items-center text-sm cursor-pointer select-none">
                    <input type="checkbox" id="select-all-locations" class="mr-2 h-4 w-4 text-blue-600 rounded border-gray-300"> Select All
                </label>
                <button type="button" id="add-new-location-btn" class="text-xs text-blue-600 font-bold hover:underline">+ Add New Location</button>
            </div>
            <div id="locations-container" class="location-grid">
                <p class="text-xs text-gray-400 p-2">Loading locations...</p>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- LEFT COLUMN (Media, Basic, Variant Attrs) -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- SECTION 2: MEDIA MANAGER -->
                <div class="card-section">
                    <div class="section-title">
                        <i class="fas fa-images text-gray-500"></i> Product Media
                        <span class="text-xs font-normal text-gray-400 ml-auto">Star (⭐) the cover image</span>
                    </div>
                    
                    <div class="image-manager-container" id="drop-zone">
                        <input type="file" id="hidden-file-input" class="hidden" accept="image/*" multiple>
                        
                        <div id="image-preview-grid">
                            <!-- JS will render images here -->
                        </div>
                        
                        <div class="upload-placeholder" id="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-300"></i>
                            <p class="text-sm text-gray-500 mt-2">Click to upload or drag & drop images</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Drag images to reorder. The starred image will be the main thumbnail.</p>
                </div>

                <!-- SECTION 3: BASIC DETAILS -->
                <div class="card-section">
                    <div class="section-title"><i class="fas fa-info-circle text-gray-500"></i> Basic Details</div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Product Name <span class="text-red-500">*</span></label>
                                <input type="text" class="form-control text-lg font-medium" data-key="name" placeholder="e.g., Plain T-Shirt (Red)" required>
                            </div>
                            <div>
                                <label class="form-label">Brand</label>
                                <input type="text" class="form-control" data-key="brand" placeholder="e.g. Clinic Plus, Samsung">
                            </div>
                        </div>

                        <!-- *** YEH HAI AAPKA NAYA UI *** -->
                        <div>
                            <label class="form-label">Search Keywords (Tags)</label>
                            <!-- 1. Display Area -->
                            <div id="tags-display-area">
                                <!-- JS yahaan pills banayega -->
                                <span class="tag-pill-placeholder">Tags yahaan dikhenge...</span>
                            </div>
                            <!-- 2. Input + Button Area -->
                            <div id="add-tag-group">
                                <input type="text" class="form-control" id="new-tag-input" placeholder="Naya tag likhein...">
                                <button type="button" id="add-tag-btn" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <!-- *** Naya UI Khatam *** -->


                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between"><label class="form-label">Category *</label><button type="button" id="create-category-btn" class="text-xs text-primary hover:underline">+ New</button></div>
                                <select class="form-control" data-key="category" id="product-category-selector" required><option value="">Select</option></select>
                            </div>
                            <div>
                                <div class="flex justify-between"><label class="form-label">Sub-Category</label><button type="button" id="create-subcategory-btn" class="text-xs text-primary hover:underline">+ New</button></div>
                                <select class="form-control" data-key="subcategory" id="product-subcategory-selector" disabled><option value="">Select Category First</option></select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label">Short Description</label>
                            <textarea class="form-control" data-key="simpleDescription" rows="3" placeholder="Short description for the app..."></textarea>
                        </div>

                        <div>
                            <label class="form-label">Full Description</label>
                            <textarea class="form-control" data-key="longDescription" rows="6" placeholder="Detailed product description, features, how to use..."></textarea>
                        </div>
                        
                        <div>
                            <label class="form-label">Video URL (Optional)</label>
                            <input type="url" class="form-control" data-key="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
                        </div>

                    </div>
                </div>

                <!-- SECTION 4: VARIANT ATTRIBUTES -->
                <div class="card-section" id="variant-attributes-section">
                    <div class="section-title"><i class="fas fa-tags text-gray-500"></i> Variant Attributes</div>
                    <p class="text-xs text-gray-500 mb-3">Define this specific variant (e.g., Type: Color, Value: Red).</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Variant Type</label>
                            <select class="form-control" data-key="variantType" id="variant-type-select">
                                <option value="">None</option>
                                <option value="Size">Size (S, M, L)</option>
                                <option value="Color">Color (Red, Blue)</option>
                                <option value="Weight">Weight (1kg, 500g)</option>
                                <option value="Volume">Volume (1L, 500ml)</option>
                                <option value="Flavor">Flavor (Masala, Orange)</option>
                                <option value="Storage">Storage (128GB, 256GB)</option>
                                <option value="Pack Size">Pack Size (Pack of 3)</option>
                                <option value="Style">Style (Basmati, Cotton)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Variant Value</label>
                            <input type="text" class="form-control" data-key="variantValue" placeholder="e.g., M, Red, 1kg, 256GB">
                        </div>
                    </div>
                </div>

                <!-- SECTION 5: DYNAMIC FIELDS (Category-based) -->
                <div class="card-section bg-gray-50 border-dashed" id="dynamic-fields-container">
                    <!-- Veg/Non-Veg & Shelf Life is here (Yeh 'hidden' rahega jab tak Grocery select na ho) -->
                    <div id="grocery-fields" class="hidden">
                        <div class="section-title text-green-700"><i class="fas fa-leaf"></i> Grocery Attributes</div>
                        <div class="flex items-center gap-8 mb-4">
                            <div>
                                <label class="form-label mb-1">Food Type</label>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" class="toggle-switch-checkbox" id="is-veg-toggle">
                                    <span class="toggle-switch-slider"></span>
                                    <span class="veg-icon"><i class="fas fa-circle"></i> Veg</span>
                                    <span class="non-veg-icon"><i class="fas fa-circle"></i> Non-Veg</span>
                                </label>
                            </div>
                            <div class="flex-grow">
                                <label class="form-label">Shelf Life / Expiry</label>
                                <input type="text" class="form-control" data-key="shelfLife" placeholder="e.g., Best before 6 months">
                            </div>
                        </div>
                    </div>
                    <!-- TECH MODE -->
                    <div id="tech-fields" class="hidden">
                        <div class="section-title text-blue-700"><i class="fas fa-microchip"></i> Tech Specs</div>
                        <!-- ... Tech fields ... -->
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN (Pricing, Stock, Meta) -->
            <div class="space-y-6">
                <!-- SECTION 6: PRICING & STOCK -->
                <div class="card-section">
                    <div class="section-title"><i class="fas fa-tag text-gray-500"></i> Pricing & Stock</div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Display Price (₹) *</label><input type="number" class="form-control font-bold" data-key="displayPrice" required></div>
                            <div><label class="form-label">Original Price (₹)</label><input type="number" class="form-control text-gray-500" data-key="originalPrice"></div>
                        </div>
                        <div>
                            <label class="form-label">Stock Qty *</label>
                            <input type="number" class="form-control" data-key="quantity" placeholder="e.g. 100" required>
                        </div>
                        <div>
                            <label class="form-label">Low Stock Alert</label>
                            <input type="number" class="form-control" data-key="lowStockLimit" value="5" placeholder="Notify if below this">
                        </div>
                    </div>
                </div>

                <!-- SECTION 7: UNITS (UOM) -->
                <div class="card-section">
                    <div class="section-title"><i class="fas fa-balance-scale text-gray-500"></i> Unit / Weight</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="form-label">Net Qty</label><input type="number" step="0.01" class="form-control" data-key="netQuantity" placeholder="1, 500"></div>
                        <div>
                            <label class="form-label">Unit</label>
                            <select class="form-control" data-key="unitType">
                                <option value="Pcs">Pieces</option> <option value="Kg">Kg</option> <option value="g">Gram</option>
                                <option value="L">Litre</option> <option value="ml">ml</option> <option value="Pack">Pack</option>
                                <option value="m">Meter</option> <option value="Pair">Pair</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SECTION 8: META & ADVANCED -->
                <div class="card-section">
                    <div class="section-title"><i class="fas fa-cogs text-gray-500"></i> Advanced</div>
                    
                    <button type="button" id="open-combo-modal-btn" class="w-full btn btn-secondary mb-4">
                        <i class="fas fa-box-open mr-2"></i> Combos / Quantity Packs
                    </button>

                    <div class="space-y-2">
                        <label class="form-label">SKU (Auto)</label>
                        <input type="text" class="form-control bg-gray-100 text-xs" data-key="sku" readonly>
                        
                        <label class="form-label mt-2">Offer Badge</label>
                        <input type="text" class="form-control" data-key="offerText" placeholder="e.g. 50% OFF">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- STICKY FOOTER (SAVE ACTIONS) -->
<div class="fixed bottom-0 left-0 md:left-64 right-0 bg-white border-t shadow-lg p-4 z-40 flex items-center justify-between">
    <div class="text-sm text-gray-500 hidden md:block">
        <span id="unsaved-changes-indicator" class="hidden text-orange-500"><i class="fas fa-circle text-[8px] mr-1"></i> Unsaved Changes</span>
    </div>
    <div class="flex gap-3 ml-auto">
        <button id="save-create-variant-btn" class="btn bg-purple-100 text-purple-700 hover:bg-purple-200 border border-purple-300">
            <i class="fas fa-copy mr-2"></i> Save & Create Variant
        </button>
        <button id="save-product-btn" class="btn btn-primary px-6 shadow-md">
            <i class="fas fa-save mr-2"></i> Save Product
        </button>
    </div>
</div>

<script>
// Yeh ek IIFE (Immediately Invoked Function Expression) hai taaki variables global na hon.
(function() {
    // --- DOM ELEMENTS ---
    const form = document.getElementById('product-form');
    const saveBtn = document.getElementById('save-product-btn');
    const saveVariantBtn = document.getElementById('save-create-variant-btn');
    const backBtn = document.getElementById('back-to-products-btn');
    const formTitle = document.getElementById('product-form-title');
    const unsavedIndicator = document.getElementById('unsaved-changes-indicator');
    
    // Image Manager
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('hidden-file-input');
    const uploadTrigger = document.getElementById('upload-placeholder'); // Placeholder div
    const imageGrid = document.getElementById('image-preview-grid');
    
    // --- *** NAYA TAGS UI *** ---
    const tagsDisplayArea = document.getElementById('tags-display-area'); // 1. Display Area
    const newTagInput = document.getElementById('new-tag-input');       // 2. Input Box
    const addTagBtn = document.getElementById('add-tag-btn');         // 3. Plus Button
    const tagsDataStorage = document.getElementById('tags-data-storage'); // 4. Hidden Storage
    
    // Baaki ke Inputs
    const categorySelect = document.getElementById('product-category-selector');
    const subcategorySelect = document.getElementById('product-subcategory-selector');
    const locationsContainer = document.getElementById('locations-container');
    const selectAllLocBtn = document.getElementById('select-all-locations');
    const isVegToggle = document.getElementById('is-veg-toggle');
    const comboDataStorage = document.getElementById('combo-data-storage');
    const groupIdInput = document.getElementById('product-group-id');
    const variantGroupInfo = document.getElementById('variant-group-info');
    const openComboModalBtn = document.getElementById('open-combo-modal-btn');

    // --- LOCAL STATE ---
    let searchTags = []; // Yeh local array UI aur hidden field ko sync karega
    let imageFiles = []; 
    let currentProductId = null;

    // --- 1. IMAGE MANAGER LOGIC (Star & Drag) ---
    // (Is code mein koi badlaav nahi hai)
    
    function renderImages() {
        imageGrid.innerHTML = '';
        if (imageFiles.length > 0) {
            uploadTrigger.classList.add('hidden');
        } else {
            uploadTrigger.classList.remove('hidden');
        }

        imageFiles.forEach((imgObj, index) => {
            const card = document.createElement('div');
            card.className = `image-card ${imgObj.isCover ? 'is-cover' : ''}`;
            card.draggable = true;
            card.dataset.index = index;
            card.innerHTML = `
                <img src="${imgObj.url}" loading="lazy" alt="Product Image ${index + 1}">
                <div class="cover-badge">COVER</div>
                <button type="button" class="img-action-btn star-img-btn" title="Set as Cover">
                    <i class="${imgObj.isCover ? 'fas' : 'far'} fa-star"></i>
                </button>
                <button type="button" class="img-action-btn delete-img-btn" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            imageGrid.appendChild(card);
        });

        // Click handlers
        imageGrid.querySelectorAll('.delete-img-btn').forEach((btn, index) => {
            btn.onclick = (e) => {
                e.stopPropagation();
                imageFiles.splice(index, 1);
                if (imageFiles.length > 0 && !imageFiles.some(img => img.isCover)) {
                    imageFiles[0].isCover = true;
                }
                renderImages();
                markUnsaved();
            };
        });

        imageGrid.querySelectorAll('.star-img-btn').forEach((btn, index) => {
            btn.onclick = (e) => {
                e.stopPropagation();
                imageFiles.forEach(i => i.isCover = false);
                imageFiles[index].isCover = true;
                renderImages();
                markUnsaved();
            };
        });
    }

    if (typeof Sortable !== 'undefined') {
        new Sortable(imageGrid, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
                const item = imageFiles.splice(evt.oldIndex, 1)[0];
                imageFiles.splice(evt.newIndex, 0, item);
                renderImages();
                markUnsaved();
            }
        });
    } else {
        console.warn("Sortable.js library is missing. Drag & Drop for images will not work.");
    }

    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const isFirst = imageFiles.length === 0;
                imageFiles.push({
                    file: file,
                    url: e.target.result,
                    isCover: isFirst && !imageFiles.some(img => img.isCover)
                });
                renderImages();
                markUnsaved();
            };
            reader.readAsDataURL(file);
        });
    }

    // Image Upload Triggers
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    };


    // --- 2. TAGS SYSTEM (*** NAYA RELIABLE LOGIC ***) ---

    // Function 1: Hidden field ko update karo
    function updateHiddenTags() {
        tagsDataStorage.value = JSON.stringify(searchTags);
        markUnsaved(); // Har tag change ek unsaved change hai
    }

    // Function 2: UI (Display Area) ko update karo
    function renderTags() {
        tagsDisplayArea.innerHTML = ''; // Display area ko khali karo
        if (searchTags.length === 0) {
            tagsDisplayArea.innerHTML = '<span class="tag-pill-placeholder">Tags yahaan dikhenge...</span>';
            return;
        }
        
        searchTags.forEach((tag, index) => {
            const pill = document.createElement('span');
            pill.className = 'tag-pill';
            // Har pill ko ek data-tag attribute diya, delete karne mein aasani hogi
            pill.innerHTML = `${tag} <span class="remove-tag" data-tag="${tag}">×</span>`; 
            tagsDisplayArea.appendChild(pill);
        });
    }

    // Function 3: Naya tag add karne ka function
    function addNewTag() {
        const val = newTagInput.value.trim().toLowerCase();
        if (val && !searchTags.includes(val)) {
            searchTags.push(val);
            renderTags(); // UI update karo
            updateHiddenTags(); // Hidden input ko update karo
        }
        newTagInput.value = ''; // Input box ko khali karo
        newTagInput.focus(); // Wapis focus karo
    }

    // Event Listener 1: "+" Button par click
    addTagBtn.addEventListener('click', addNewTag);

    // Event Listener 2: Input box mein "Enter" dabane par
    newTagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Form ko submit hone se roko
            addNewTag();
        }
    });

    // Event Listener 3: Tag (Pill) ko delete karne ke liye
    tagsDisplayArea.addEventListener('click', e => {
        if(e.target.classList.contains('remove-tag')) {
            const tagToDelete = e.target.dataset.tag; // 'sampoo'
            searchTags = searchTags.filter(tag => tag !== tagToDelete); // Array se filter karke hataya
            renderTags(); // UI update karo
            updateHiddenTags(); // Hidden input ko update karo
        }
    });

    // --- 3. DYNAMIC LOCATIONS & CATEGORIES ---
    // (Is code mein koi badlaav nahi hai)
    function renderLocationCheckboxes(availableLocs = []) {
        locationsContainer.innerHTML = '';
        const allLocs = window.allLocationsCache || [];
        const locList = Array.isArray(allLocs) ? allLocs : Object.values(allLocs);
        
        if(locList.length === 0) {
            locationsContainer.innerHTML = '<p class="text-sm text-gray-400 p-2">No locations. Add new.</p>';
            return;
        }
        locList.forEach(loc => {
            const name = typeof loc === 'string' ? loc : loc.name;
            const checked = availableLocs.includes(name) ? 'checked' : '';
            locationsContainer.insertAdjacentHTML('beforeend', `
                <label class="location-checkbox-item"><input type="checkbox" class="location-cb" value="${name}" ${checked}> ${name}</label>
            `);
        });
    }
    selectAllLocBtn.onchange = e => {
        locationsContainer.querySelectorAll('.location-cb').forEach(cb => cb.checked = e.target.checked);
        markUnsaved();
    };

    // Yeh function Veg/Non-Veg ko control karta hai
    function handleCategoryChange() {
        const cat = categorySelect.value;
        const catLower = cat.toLowerCase();
        
        document.getElementById('grocery-fields').classList.add('hidden');
        document.getElementById('tech-fields').classList.add('hidden');
        
        if (catLower.match(/grocery|food|fruit|veg/)) {
            document.getElementById('grocery-fields').classList.remove('hidden');
        }
        if (catLower.match(/elect|mobile|tech|gadget/)) {
            document.getElementById('tech-fields').classList.remove('hidden');
        }

        subcategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
        subcategorySelect.disabled = true;
        const catKey = cat.replace(/[.#$/\[\]]/g, "_");
        if (cat && window.allSubCategoriesCache && window.allSubCategoriesCache[catKey]) {
            const subs = window.allSubCategoriesCache[catKey];
            (Array.isArray(subs) ? subs : Object.values(subs)).forEach(s => subcategorySelect.add(new Option(s, s)));
            subcategorySelect.disabled = false;
        }
    }
    categorySelect.onchange = () => { handleCategoryChange(); markUnsaved(); };

    // --- 4. FORM STATE & UNSAVED CHANGES ---
    function markUnsaved() {
        unsavedIndicator.classList.remove('hidden');
    }
    form.oninput = markUnsaved; 

    // --- 5. INIT & SAVE LOGIC ---
    function initializeForm() {
        const productToEdit = window.editingProductData; 
        
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        (window.allCategoriesCache || []).forEach(c => categorySelect.add(new Option(c, c)));

        renderLocationCheckboxes(productToEdit?.availableLocations || []);

        if (productToEdit) {
            // --- EDIT MODE ---
            formTitle.innerHTML = `Edit Product <span class="text-base font-normal text-gray-500 ml-2">SKU: ${productToEdit.sku || 'N/A'}</span>`;
            currentProductId = productToEdit.id;
            document.getElementById('product-edit-index').value = productToEdit.originalIndex;

            form.querySelectorAll('[data-key]').forEach(input => {
                const key = input.dataset.key;
                if (productToEdit[key] !== undefined) {
                    input.value = productToEdit[key];
                }
            });

            if (productToEdit.groupId) {
                variantGroupInfo.style.display = 'flex';
            }

            // Media (Images)
            imageFiles = [];
            if (productToEdit.images && productToEdit.images.length > 0) {
                imageFiles = productToEdit.images.map((url, idx) => ({
                    file: null, url: url, isCover: idx === 0 
                }));
            }
            renderImages();

            // --- *** YEH AAPKA REQUESTED FEATURE HAI (LOADING) *** ---
            // 1. Purane tags ko 'product_of_keyword' se load karo
            searchTags = productToEdit.product_of_keyword || [];
            // 2. UI (Display Area) mein pills banao
            renderTags();
            // 3. Hidden field ko bhi update karo (Taaki agar aap kuch na bhi badle, toh bhi save ho)
            updateHiddenTags(); 
            // ----------------------------------------------------

            // Toggles
            if(productToEdit.isVeg !== undefined) isVegToggle.checked = productToEdit.isVeg;
            
            // Combos
            if(productToEdit.combos) comboDataStorage.value = JSON.stringify(productToEdit.combos);

            // Category Logic (TAAKI VEG/NON-VEG DIKHE)
            handleCategoryChange(); 
            if(productToEdit.subcategory) {
                setTimeout(() => subcategorySelect.value = productToEdit.subcategory, 50);
            }

        } else {
            // --- ADD NEW MODE ---
            formTitle.textContent = 'Add New Product';
            form.querySelector('[data-key="sku"]').value = `RAMA-${Date.now().toString().slice(-6)}`;
            renderLocationCheckboxes([]);
            imageFiles = [];
            renderImages();
            searchTags = []; // Naye product ke liye tags clear
            renderTags(); // UI clear
            updateHiddenTags(); // Hidden input ko bhi clear karo
        }
        
        window.editingProductData = null;
        unsavedIndicator.classList.add('hidden');
    }

    /**
     * SAVE PRODUCT LOGIC (Main Function)
     */
    async function saveProduct(createVariantMode = false) {
        if (!form.reportValidity()) {
            window.showToast('Validation Error', 'Please fill all required fields.', 'error');
            return;
        }
        
        const btn = createVariantMode ? saveVariantBtn : saveBtn;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

        try {
            // 1. Gather all data from [data-key]
            const data = {};
            form.querySelectorAll('[data-key]').forEach(el => {
                data[el.dataset.key] = el.type === 'number' ? (Number(el.value) || 0) : el.value;
            });

            // 2. Gather complex data
            
            // --- *** YEH 100% SAVE HOGA *** ---
            // Data ko 'tagsDataStorage' (hidden field) se padho
            const tagsData = tagsDataStorage.value;
            if (tagsData) {
                data.product_of_keyword = JSON.parse(tagsData);
            } else {
                data.product_of_keyword = []; // Khali array save karo agar kuch na ho
            }
            // -----------------------------------------------------------
            
            data.availableLocations = Array.from(locationsContainer.querySelectorAll('.location-cb:checked')).map(cb => cb.value);
            data.isVeg = isVegToggle.checked;
            
            if(comboDataStorage.value) data.combos = JSON.parse(comboDataStorage.value);

            // 3. Variant Grouping Logic
            const existingGroupId = groupIdInput.value;
            if (createVariantMode) {
                data.groupId = existingGroupId || `grp_${Date.now()}`;
            }

            // 4. Image Upload Logic
            const sortedImages = [...imageFiles].sort((a, b) => (b.isCover ? 1 : 0) - (a.isCover ? 1 : 0));
            const uploadedUrls = await Promise.all(sortedImages.map(async (imgObj) => {
                if (imgObj.file) {
                    return await window.uploadToImgBB(imgObj.file);
                }
                return imgObj.url;
            }));
            data.images = uploadedUrls.filter(Boolean); 

            // 5. Save to Firebase
            const index = document.getElementById('product-edit-index').value;
            const listRef = db.ref('ramazone/products');
            let list = (await listRef.get()).val() || [];
            if (!Array.isArray(list)) list = Object.values(list); 

            if (index && !createVariantMode) {
                // --- UPDATE EXISTING PRODUCT ---
                data.id = list[index].id; 
                list[index] = { ...list[index], ...data }; 
            } else {
                // --- ADD NEW PRODUCT (ya NEW VARIANT) ---
                data.id = `prod-${Date.now()}`;
                data.createdAt = new Date().toISOString();
                if (createVariantMode) {
                    data.sku = `RAMA-${Date.now().toString().slice(-6)}`;
                }
                list.push(data);
            }

            await listRef.set(list);
            
            // 6. Post-Save Actions
            if (createVariantMode) {
                // --- VARIANT CLONE MODE ---
                window.showToast('Success', 'Product Saved! Cloning data for new variant...', 'success');
                
                const clonedData = { ...data }; 
                clonedData.name += " (Variant)";
                clonedData.id = null; 
                clonedData.sku = null; 
                clonedData.variantValue = ""; 
                clonedData.quantity = 0; 
                clonedData.images = []; 
                clonedData.originalIndex = null;
                // Tags (product_of_keyword) bhi clone ho jayenge
                
                window.editingProductData = clonedData;
                initializeForm(); // Form ko clone kiye hue data se bharo
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                window.showToast('Ready', 'Edit details for the new variant.', 'info');
            } else {
                // --- NORMAL SAVE MODE ---
                window.showToast('Success', 'Product Saved Successfully!', 'success');
                document.querySelector('.sidebar-link[data-page="sections/products.html"]').click();
            }

        } catch (err) {
            console.error(err);
            window.showToast('Error', `Save failed: ${err.message}`, 'error');
        } finally {
            saveBtn.disabled = false;
            saveVariantBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Product';
            saveVariantBtn.innerHTML = '<i class="fas fa-copy mr-2"></i> Save & Create Variant';
        }
    }

    // --- 6. EVENT LISTENERS ---
    saveBtn.onclick = () => saveProduct(false);
    saveVariantBtn.onclick = () => saveProduct(true);
    backBtn.onclick = () => document.querySelector('.sidebar-link[data-page="sections/products.html"]').click();

    // Modal/Helper Buttons
    document.getElementById('create-category-btn').onclick = () => window.openCategoryModal();
    document.getElementById('create-subcategory-btn').onclick = () => window.openSubCategoryModal(categorySelect.value);
    document.getElementById('add-new-location-btn').onclick = () => window.openLocationModal();
    
    openComboModalBtn.onclick = () => {
        const modal = document.getElementById('universalModal');
        const modalBody = document.getElementById('modalBody');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        document.getElementById('modalTitle').textContent = 'Manage Quantity Packs';
        
        const existing = comboDataStorage.value ? JSON.parse(comboDataStorage.value) : { quantityPacks: [] };
        let packsHtml = (existing.quantityPacks || []).map(p => 
            `<div class="flex gap-2 mb-2 item"><input class="form-control w-1/2" value="${p.name || ''}" placeholder="Pack Name"><input type="number" class="form-control w-1/3" value="${p.price || ''}" placeholder="Price"><button type="button" class="text-red-500 px-2 remove-pack">×</button></div>`
        ).join('');

        modalBody.innerHTML = `
            <p class="text-xs text-gray-500 mb-2">Example: '1 Kg Pack', 'Box of 6'.</p>
            <div id="pack-list">${packsHtml}</div>
            <button type="button" id="add-pack-ui" class="text-blue-600 text-sm font-bold mt-2">+ Add Pack</button>
        `;
        modalBody.onclick = (e) => {
            if(e.target.id === 'add-pack-ui') document.getElementById('pack-list').insertAdjacentHTML('beforeend', `<div class="flex gap-2 mb-2 item"><input class="form-control w-1/2" placeholder="e.g. 500g"><input type="number" class="form-control w-1/3" placeholder="Price"><button type="button" class="text-red-500 px-2 remove-pack">×</button></div>`);
            if(e.target.classList.contains('remove-pack')) e.target.closest('.item').remove();
        };
        modalSaveBtn.onclick = () => {
            const packs = Array.from(modalBody.querySelectorAll('.item')).map(row => ({
                name: row.children[0].value, price: Number(row.children[1].value)
            })).filter(p => p.name && p.price);
            comboDataStorage.value = JSON.stringify({ quantityPacks: packs });
            window.showToast('Saved', 'Combos updated.', 'success');
            document.getElementById('modalCloseBtn').click();
        };
        modal.classList.add('active');
    };

    // --- 7. RUN ON LOAD ---
    initializeForm();

})();
</script>

