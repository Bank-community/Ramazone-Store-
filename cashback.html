<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazone Cashback</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121828;
            --bg-light: #1B2133;
            --text-primary-dark: #ffffff;
            --text-secondary-dark: #a9b1c8;
            --border-color-dark: #2c344a;

            --bg-light-theme: #f4f7f9;
            --bg-light-theme-card: #ffffff;
            --text-primary-light: #1c2028;
            --text-secondary-light: #5a647e;
            --border-color-light: #e8eef3;
            --border-color-light-strong: #ced4da;
            
            --brand-red: #e50914;
            --brand-red-hover: #c40812;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --whatsapp-green: #25D366;
            --accent-purple: #9b59b6; 
            --shiny-green: #2eff71;
        }

        /* --- Base Styles & Resets --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { height: 100%; }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100%;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Light Theme --- */
        body[data-theme="light"] {
            background-color: var(--bg-light-theme);
            color: var(--text-primary-light);
        }
        body[data-theme="light"] .view, body[data-theme="light"] .action-card, body[data-theme="light"] .modal-content, body[data-theme="light"] .history-item {
            background-color: var(--bg-light-theme-card);
            border-color: var(--border-color-light);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        body[data-theme="light"] .action-card {
            border: 1px solid var(--border-color-light-strong);
        }
        body[data-theme="light"] input, body[data-theme="light"] select, body[data-theme="light"] input[type="date"] {
            background-color: var(--bg-light-theme);
            border-color: var(--border-color-light-strong);
            color: var(--text-primary-light);
        }
        body[data-theme="light"] label, body[data-theme="light"] .form-link, body[data-theme="light"] .section-title, body[data-theme="light"] .modal-description, body[data-theme="light"] .history-info .date, body[data-theme="light"] #profile-payment-id {
            color: var(--text-secondary-light);
        }
        body[data-theme="light"] .btn-secondary {
            background-color: #e8eef3;
            color: var(--text-primary-light);
        }
        body[data-theme="light"] .header-icon:hover { background-color: #e8eef3; }
        body[data-theme="light"] .notification-dot { border-color: var(--bg-light-theme-card); }
        
        .container { width: 100%; max-width: 500px; padding: 0; }

        /* --- Logo Styles --- */
        .logo-link { display: block; text-align: center; margin: 40px 0 30px 0; }
        .main-logo { max-width: 220px; width: 100%; height: auto; transition: transform 0.3s ease; }
        .main-logo:hover { transform: scale(1.05); }

        /* --- View Transitions --- */
        .view { display: none; padding: 20px; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Forms & Inputs --- */
        h1 { text-align: center; font-size: 24px; font-weight: 600; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; position: relative; }
        label { font-weight: 500; color: var(--text-secondary-dark); font-size: 14px; margin-bottom: 8px; display: block; }
        input[type="text"], input[type="tel"], input[type="password"], input[type="number"], input[type="date"], select {
            width: 100%; padding: 14px; background-color: var(--bg-light); border: 1px solid var(--border-color-dark);
            border-radius: 8px; color: var(--text-primary-dark); font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: var(--brand-red); box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.25); }
        button, .btn-primary {
            width: 100%; padding: 15px; background: linear-gradient(90deg, var(--brand-red), #f64d54); color: white;
            border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
            transition: transform 0.2s, box-shadow 0.3s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        button:hover, .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(229, 9, 20, 0.2); }
        button:disabled, .btn-primary:disabled { background: #555; cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        .form-link { text-align: center; margin-top: 25px; color: var(--text-secondary-dark); }
        .form-link a { color: var(--brand-red); text-decoration: none; font-weight: 600; }
        .error-message {
            color: #ff6b6b; font-size: 14px; text-align: center; margin-top: 15px; display: none;
            background-color: rgba(255, 107, 107, 0.1); padding: 10px; border-radius: 6px;
        }

        /* --- Dashboard Header --- */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
        }
        .header h1 {
            text-align: center;
            margin: 0;
            font-size: 26px;
            font-weight: 700;
        }
        .header-actions-bar {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 15px;
        }
        .header-icon {
            font-size: 24px; cursor: pointer; line-height: 1; padding: 8px;
            border-radius: 50%; transition: background-color 0.2s, transform 0.2s; 
            user-select: none; position: relative; display: flex; 
            align-items: center; justify-content: center; text-decoration: none;
        }
        .header-icon:hover { 
            background-color: var(--border-color-dark); 
            transform: scale(1.1);
        }
        .header-icon img {
            width: 24px; height: 24px; transition: filter 0.3s;
        }
        body[data-theme="dark"] .header-icon img { filter: invert(1); }
        body[data-theme="light"] .header-icon img { filter: none; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #refresh-btn.refreshing img { animation: spin 1s linear; }

        #logout-btn {
            display: flex; align-items: center; gap: 8px; background-color: var(--brand-red);
            color: white; padding: 8px 12px; border-radius: 20px; cursor: pointer;
            transition: background-color 0.2s, transform 0.2s; margin-left: auto;
        }
        #logout-btn:hover { background-color: var(--brand-red-hover); transform: scale(1.05); }
        #logout-btn img { width: 18px; height: 18px; filter: invert(1); }
        #logout-btn span { font-weight: 500; font-size: 14px; line-height: 1; }
        
        .notification-dot {
            position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--brand-red);
            border-radius: 50%; border: 2px solid var(--bg-dark); display: none;
        }
        body[data-theme="light"] .notification-dot { border-color: var(--bg-light-theme-card); }
        .notification-dot.active { display: block; }

        .wallet-card {
            background: linear-gradient(135deg, #2980b9, #3498db); color: white; padding: 25px;
            border-radius: 16px; margin-bottom: 30px; position: relative; overflow: hidden;
        }
        .wallet-card::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background-color: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .wallet-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .wallet-header p { font-size: 16px; opacity: 0.9; margin: 0 0 4px 0; }
        #lifetime-earning { font-size: 13px; font-weight: 500; opacity: 0.8; display: block; }
        .highlight-amount { font-weight: 700; color: var(--shiny-green); }
        
        #profile-display {
            width: 50px; height: 50px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.9);
            color: #2980b9; font-size: 24px; font-weight: 600; display: flex; align-items: center; justify-content: center;
            object-fit: cover; border: 2px solid white;
        }

        #wallet-balance { font-size: 40px; font-weight: 700; margin-bottom: 5px; }
        #user-mobile { opacity: 0.8; font-size: 14px; }
        
        .wallet-share {
            position: absolute; bottom: 20px; right: 25px; display: flex; flex-direction: column;
            align-items: center; cursor: pointer; opacity: 0.8; transition: opacity 0.2s, transform 0.2s;
        }
        .wallet-share:hover { opacity: 1; transform: scale(1.1); }
        .wallet-share .share-icon { font-size: 22px; line-height: 1; }
        .wallet-share .share-text { font-size: 12px; font-weight: 500; margin-top: 4px; }

        .dashboard-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .action-card {
            background-color: var(--bg-light); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s, border-color 0.2s; border: 1px solid var(--border-color-dark); position: relative; z-index: 2; aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; color: inherit;
        }
        .action-card:hover { transform: translateY(-5px); background-color: var(--border-color-dark); }
        body[data-theme="light"] .action-card:hover { background-color: #f8f9fa; border-color: #adb5bd; }
        .action-card .icon { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center;}
        .action-card .icon img, .action-card .icon svg { width: 32px; height: 32px; }

        .action-card.scan .icon { color: var(--accent-purple); } /* Scan & Pay */
        .action-card.claim .icon { color: var(--accent-green); } /* Claim */
        .action-card.cashback .icon { color: var(--accent-blue); } /* Cashback */
        .action-card.coupons .icon { color: var(--brand-red); } /* Coupons */
        .action-card.profile .icon { color: #8e44ad; } /* Profile */
        .action-card.whatsapp .icon { color: var(--whatsapp-green); } /* WhatsApp */

        @keyframes gift-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            5%, 15% { transform: scale(1.1) rotate(-3deg); }
            10%, 20% { transform: scale(1.1) rotate(3deg); }
            25% { transform: scale(1.1) rotate(0deg); }
        }
        .action-card.cashback .icon { animation: gift-pulse 4s infinite ease-in-out; animation-delay: 1s; }

        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text-secondary-dark); }
        
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px;
        }
        .filter-btn {
            padding: 8px 16px; border: 1px solid var(--border-color-dark); background-color: transparent;
            color: var(--text-secondary-dark); border-radius: 20px; cursor: pointer;
            font-weight: 500; font-size: 14px; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn:hover { background-color: var(--border-color-dark); color: var(--text-primary-dark); }
        .filter-btn.active { background-color: var(--brand-red); color: white; border-color: var(--brand-red); }
        body[data-theme="light"] .filter-btn { border-color: var(--border-color-light-strong); }
        body[data-theme="light"] .filter-btn:hover { background-color: #e8eef3; color: var(--text-primary-light); }
        body[data-theme="light"] .filter-btn.active { background-color: var(--brand-red); color: white; border-color: var(--brand-red); }

        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item {
            display: flex; align-items: center; justify-content: space-between; background-color: var(--bg-light);
            padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent-blue);
        }
        .history-item.payment { border-left-color: var(--accent-purple); } 
        .history-item.debit { border-left-color: var(--brand-red); } 
        .history-item.credit { border-left-color: var(--accent-green); } 
        .history-details { display: flex; align-items: center; gap: 15px; }
        .history-icon {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .history-icon svg { width: 20px; height: 20px; }
        .history-icon.payment { background-color: rgba(155, 89, 182, 0.1); color: var(--accent-purple); }
        .history-icon.debit { background-color: rgba(229, 9, 20, 0.1); color: var(--brand-red); } 
        .history-icon.credit { background-color: rgba(46, 204, 113, 0.1); color: var(--accent-green); } 
        
        .history-info .title { font-weight: 600; font-size: 15px; }
        .history-info .date { font-size: 13px; color: var(--text-secondary-dark); }
        .history-amount { text-align: right; }
        .history-amount .amount { font-weight: 600; font-size: 16px; }
        .history-amount .amount.payment, .history-amount .amount.debit { color: #ff6b6b; }
        .history-amount .amount.credit { color: #2ecc71; }
        .history-amount .status {
            font-size: 12px; font-weight: 500; padding: 3px 8px; border-radius: 12px; text-transform: capitalize;
        }
        .status-pending { background-color: rgba(241, 196, 15, 0.2); color: var(--accent-yellow); }
        .status-approved, .status-completed { background-color: rgba(46, 204, 113, 0.2); color: var(--accent-green); }
        .status-rejected { background-color: rgba(229, 9, 20, 0.2); color: var(--brand-red); }
        .coupon-code { font-family: 'Courier New', Courier, monospace; font-weight: bold; background-color: #333; padding: 2px 5px; border-radius: 4px; color: #eee; font-size: 12px; display: inline-block; margin-top: 4px; }
        body[data-theme="light"] .coupon-code { background-color: #e9ecef; color: #343a40; }
        .copy-btn {
            background: none; border: none; color: var(--text-secondary-dark); cursor: pointer;
            font-size: 12px; padding: 2px 5px; margin-left: 5px;
        }
        
        .empty-state {
            text-align: center; padding: 40px 20px; background-color: var(--bg-light); border-radius: 12px; color: var(--text-secondary-dark);
            border: 2px dashed var(--border-color-dark);
        }
        body[data-theme="light"] .empty-state {
            background-color: var(--bg-light-theme-card);
            border-color: var(--border-color-light-strong);
        }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.7; }
        .empty-state h4 { font-size: 18px; font-weight: 600; color: var(--text-primary-dark); margin-bottom: 8px; }
        body[data-theme="light"] .empty-state h4 { color: var(--text-primary-light); }
        .empty-state p { margin-bottom: 20px; }
        
        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content {
            background-color: var(--bg-light); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border-color-dark);
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); max-height: 80vh; display: flex; flex-direction: column;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-body { overflow-y: auto; margin-top: 15px; padding-right: 10px; }
        .modal-content h3 { margin-top: 0; text-align: center; font-size: 20px; margin-bottom: 10px; }
        .modal-content .modal-description { text-align: center; color: var(--text-secondary-dark); margin-bottom: 25px; font-size: 14px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: var(--border-color-dark); }
        .btn-secondary:hover { background: #414b69; transform: none; box-shadow: none; }
        
        #scan-pay-modal .modal-content { padding: 20px; }
        #scanner-container {
            position: relative; width: 100%; max-width: 300px;
            aspect-ratio: 1 / 1; margin: 0 auto;
            border-radius: 10px; overflow: hidden; background-color: #000;
        }
        #scanner-video { width: 100%; height: 100%; object-fit: cover; }
        #scanner-status { text-align: center; margin-top: 15px; font-size: 14px; min-height: 20px; }
        .scanned-info { display: none; text-align: center; margin-top: 10px; }
        .scanned-info p { margin-bottom: 5px; }
        .scanned-info span { font-weight: 600; color: var(--brand-red); }

        #profile-modal .modal-content { padding: 0; }
        #profile-modal .profile-info { padding: 30px 30px 0 30px; }
        #profile-modal .modal-body { padding: 0 30px; }
        #profile-modal .modal-actions { padding: 20px 30px 30px 30px; }
        
        #profile-modal-display {
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--brand-red); color: white;
            font-size: 40px; font-weight: 600; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;
            object-fit: cover; border: 3px solid var(--brand-red);
        }
        #profile-payment-id {
            font-size: 14px; color: var(--text-secondary-dark); background-color: var(--bg-light);
            padding: 8px 12px; border-radius: 8px; margin-top: 10px; text-align: center;
            border: 1px solid var(--border-color-dark); word-break: break-all;
        }
        body[data-theme="light"] #profile-payment-id {
            background-color: var(--bg-light-theme);
            border-color: var(--border-color-light-strong);
        }
        #profile-modal-name { font-size: 22px; font-weight: 600; }
        #profile-modal-mobile { font-size: 16px; color: var(--text-secondary-dark); }
        .profile-upload-section { margin-top: 20px; text-align: center; }
        #profile-picture-input { display: none; }
        #upload-status { font-size: 12px; margin-top: 8px; color: var(--accent-yellow); }
        #password-change-form { border-top: 1px solid var(--border-color-dark); padding-top: 20px; margin-top: 20px; }
        body[data-theme="light"] #password-change-form { border-top-color: var(--border-color-light-strong); }
        
        .toast-notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--accent-green); color: white; padding: 12px 25px;
            border-radius: 25px; font-size: 15px; font-weight: 500; z-index: 2000;
            transition: bottom 0.5s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast-notification.show { bottom: 30px; }

        @media (max-width: 600px) {
            body { padding: 0; }
            .container { max-width: 100%; }
            .view { border-radius: 0; min-height: 100vh; }
            .logo-link { margin-top: 50px; }
            .dashboard-actions { grid-template-columns: 1fr 1fr; } 
            .action-card p, .action-card .card-text { font-size: 13px; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- Login View -->
        <div id="login-view" class="view active">
            <a href="https://ramazone.in" target="_blank" rel="noopener noreferrer" class="logo-link">
                <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone Logo" class="main-logo" onerror="this.onerror=null;this.src='https://placehold.co/440x100/121828/FFFFFF?text=Ramazone';">
            </a>
            <h1>Customer Login</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-mobile">Mobile Number</label>
                    <input type="tel" id="login-mobile" inputmode="numeric" pattern="[0-9]{10}" required placeholder="10-digit mobile number">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit">Login</button>
                <p id="login-error-msg" class="error-message"></p>
            </form>
            <p class="form-link">Naye user? <a href="#" id="show-register-link">Yahan register karein</a></p>
        </div>

        <!-- Registration View -->
        <div id="registration-view" class="view">
             <a href="https://ramazone.in" target="_blank" rel="noopener noreferrer" class="logo-link">
                <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone Logo" class="main-logo" onerror="this.onerror=null;this.src='https://placehold.co/440x100/121828/FFFFFF?text=Ramazone';">
            </a>
             <h1>Register New Account</h1>
            <form id="register-form">
                <div class="form-group"><label for="reg-name">Poora Naam (Full Name)</label><input type="text" id="reg-name" required></div>
                <div class="form-group"><label for="reg-mobile">Mobile Number (10 ‡§Ö‡§Ç‡§ï)</label><input type="tel" id="reg-mobile" inputmode="numeric" pattern="[0-9]{10}" required></div>
                <div class="form-group"><label for="reg-password">Password Banayein</label><input type="password" id="reg-password" required placeholder="Kam se kam 6 akshar"></div>
                <button type="submit">Register Karein</button>
                <p id="register-error-msg" class="error-message"></p>
            </form>
            <p class="form-link">Pehle se account hai? <a href="#" id="show-login-link">Yahan login karein</a></p>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <div class="header">
                <h1 id="user-greeting">Good Morning, Kunal!</h1>
                <div class="header-actions-bar">
                    <div id="notification-btn" class="header-icon" title="Notifications">
                        <img src="https://www.svgrepo.com/show/269007/notification-bell.svg" alt="Notifications">
                        <span id="notification-dot" class="notification-dot"></span>
                    </div>
                    <div id="theme-switcher" class="header-icon" title="Toggle Theme">
                         <img src="https://www.svgrepo.com/show/527253/moon.svg" alt="Theme">
                    </div>
                    <a href="https://ramazone.in" target="_blank" rel="noopener noreferrer" id="store-btn" class="header-icon" title="Online Store">
                        <img src="https://www.svgrepo.com/show/290383/online-shop-ecommerce.svg" alt="Store">
                    </a>
                    <div id="refresh-btn" class="header-icon" title="Refresh Data">
                        <img src="https://www.svgrepo.com/show/533700/refresh-cw-alt-1.svg" alt="Refresh">
                    </div>
                    <div id="logout-btn">
                        <img src="https://www.svgrepo.com/show/500927/logout.svg" alt="Logout">
                        <span>Logout</span>
                    </div>
                </div>
            </div>
            
            <div class="wallet-card">
                <div class="wallet-header">
                    <div>
                        <p>Wallet Balance</p>
                        <small id="lifetime-earning">Lifetime Earning: <span class="highlight-amount">‚Çπ0.00</span></small>
                    </div>
                    <img id="profile-display" src="https://placehold.co/50x50/ffffff/2980b9?text=R" alt="Profile Picture">
                </div>
                <p id="wallet-balance">‚Çπ 0.00</p>
                <small id="user-mobile"></small>
                <div id="wallet-share-btn" class="wallet-share" title="Share App">
                    <span class="share-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                    </span>
                    <span class="share-text">Share</span>
                </div>
            </div>

            <div class="dashboard-actions">
                <div id="open-cashback-modal" class="action-card cashback">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>
                    </div>
                    <div class="card-text"><strong>Cashback Request</strong></div>
                </div>
                <!-- UPDATED: Scan & Pay button with new icon -->
                <div id="scan-and-pay-btn" class="action-card scan">
                     <div class="icon">
                        <img src="https://www.svgrepo.com/show/503562/scan-qrcode.svg" alt="Scan & Pay">
                     </div>
                    <p>Scan & Pay</p>
                </div>
                <div id="open-coupons-modal" class="action-card coupons">
                     <div class="icon">üéüÔ∏è</div>
                    <p>My Coupons</p>
                </div>
                <a href="#" id="whatsapp-support-link" target="_blank" class="action-card whatsapp">
                    <div class="icon">üí¨</div>
                    <p>WhatsApp Support</p>
                </a>
                 <div id="open-profile-modal" class="action-card profile">
                     <div class="icon">üë§</div>
                    <p>My Profile</p>
                </div>
                 <div id="open-claim-modal" class="action-card claim">
                     <div class="icon" style="font-size: 36px;">üí∏</div>
                    <p>Claim From Wallet</p>
                </div>
            </div>

            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                     <h2 class="section-title">Haal Hi Ke Transactions</h2>
                </div>
                <div class="filter-bar" id="filter-bar">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="payment">Payments</button>
                    <button class="filter-btn" data-filter="cashback">Cashback</button>
                    <button class="filter-btn" data-filter="claim">Claims</button>
                    <button class="filter-btn" data-filter="approved">Approved</button>
                    <button class="filter-btn" data-filter="pending">Pending</button>
                </div>
                <div id="unified-history-list" class="history-list"></div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <div id="password-modal-for-action" class="modal-overlay">
        <div class="modal-content">
            <h3 id="password-modal-title">Confirm Your Request</h3>
            <p id="password-modal-description" class="modal-description">Kripya aage badhne ke liye apna password daalein.</p>
            <div class="form-group">
                <label for="modal-password">Password</label>
                <input type="password" id="modal-password" required>
            </div>
            <p id="modal-error-msg" class="error-message"></p>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                <button id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>
    <div id="claim-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Wallet Se Claim Karein</h3>
            <p class="modal-description">Aapke wallet se amount redeem kiya jayega.</p>
            <form id="claim-request-form">
                <div class="form-group">
                    <label for="claim-amount">Kitna Amount Claim Karna Hai? (kam se kam ‚Çπ10)</label>
                    <input type="number" id="claim-amount" step="0.01" min="10" required>
                </div>
                <p id="claim-error-msg" class="error-message"></p>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                    <button type="submit" id="claim-submit-btn" disabled>Request Bhejein</button>
                </div>
            </form>
        </div>
    </div>
    <div id="cashback-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Cashback Request</h3>
             <p id="cashback-modal-description" class="modal-description">Product details bharein. Cashback request kiya jayega.</p>
            <form id="cashback-request-form">
                <div class="form-group"><label for="product-name">Product ka Naam</label><input type="text" id="product-name" required></div>
                <div class="form-group">
                    <label for="product-purchase-date">Product Kab Purchase Kiya Tha?</label>
                    <input type="date" id="product-purchase-date" required>
                </div>
                <div class="form-group"><label for="product-price">Product ka Price (‚Çπ)</label><input type="number" id="product-price" min="10" required></div>
                <p id="cashback-error-msg" class="error-message"></p>
                 <div class="modal-actions">
                    <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                    <button type="submit" id="cashback-submit-btn" disabled>Request Submit Karein</button>
                </div>
            </form>
        </div>
    </div>
    <div id="coupons-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Aapke Coupons</h3>
            <div class="modal-body" id="coupons-list"></div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" data-close-modal>Close</button>
            </div>
        </div>
    </div>
    
    <div id="scan-pay-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Scan QR and Pay</h3>
            <div id="scanner-container">
                <video id="scanner-video" playsinline></video>
            </div>
            <p id="scanner-status">Scanning for QR code...</p>
            <div id="payment-form" style="display: none;">
                <div class="scanned-info">
                    <p>Paying to: <span id="receiver-name-display"></span></p>
                    <p>ID: <span id="receiver-id-display"></span></p>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Amount (‚Çπ)</label>
                    <input type="number" id="payment-amount" min="1" step="0.01" required>
                </div>
                <p id="payment-error-msg" class="error-message"></p>
                <div class="modal-actions">
                    <button type="button" id="rescan-btn" class="btn-secondary">Scan Again</button>
                    <button id="pay-submit-btn">Pay Now</button>
                </div>
            </div>
             <div id="scan-pay-initial-actions" class="modal-actions">
                <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
            </div>
        </div>
    </div>


    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="profile-info">
                <img id="profile-modal-display" src="https://placehold.co/80x80/e50914/FFFFFF?text=R" alt="Profile Picture">
                <h3 id="profile-modal-name"></h3>
                <p id="profile-modal-mobile"></p>
                <div id="profile-payment-id-container">
                    <p style="font-size: 12px; text-align: center; margin-bottom: 5px; color: var(--text-secondary-dark);">Your Payment ID</p>
                    <div id="profile-payment-id"></div>
                </div>
            </div>
            <div class="modal-body">
                <div class="profile-upload-section">
                    <input type="file" id="profile-picture-input" accept="image/*">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('profile-picture-input').click();">Change Picture</button>
                    <p id="upload-status"></p>
                </div>
                <form id="password-change-form">
                    <div class="form-group"><label for="current-password">Purana Password</label><input type="password" id="current-password" required></div>
                    <div class="form-group"><label for="new-password">Naya Password</label><input type="password" id="new-password" required></div>
                    <div class="form-group"><label for="confirm-password">Naya Password Confirm Karein</label><input type="password" id="confirm-password" required></div>
                    <button type="submit" id="password-change-btn">Password Badlein</button>
                    <p id="password-change-error-msg" class="error-message"></p>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" data-close-modal>Close</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, push, onValue, runTransaction, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Global Variables & Constants ---
        const IMGBB_API_KEY = "65bbcf742486328061382f03949b47c6";
        let auth, database;

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginErrorMsg = document.getElementById('login-error-msg');
        const registerErrorMsg = document.getElementById('register-error-msg');
        const themeSwitcher = document.getElementById('theme-switcher');
        const refreshBtn = document.getElementById('refresh-btn');
        const profilePictureInput = document.getElementById('profile-picture-input');
        const uploadStatus = document.getElementById('upload-status');
        const walletShareBtn = document.getElementById('wallet-share-btn');
        const whatsappSupportLink = document.getElementById('whatsapp-support-link');
        const filterBar = document.getElementById('filter-bar');
        const passwordModal = document.getElementById('password-modal-for-action');
        const claimModal = document.getElementById('claim-modal');
        const cashbackModal = document.getElementById('cashback-modal');
        const profileModal = document.getElementById('profile-modal');
        const claimRequestForm = document.getElementById('claim-request-form');
        const cashbackRequestForm = document.getElementById('cashback-request-form');
        const passwordChangeForm = document.getElementById('password-change-form');
        const claimErrorMsg = document.getElementById('claim-error-msg');
        const cashbackErrorMsg = document.getElementById('cashback-error-msg');
        const modalErrorMsg = document.getElementById('modal-error-msg');
        const passwordChangeErrorMsg = document.getElementById('password-change-error-msg');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalPasswordInput = document.getElementById('modal-password');
        const claimSubmitBtn = document.getElementById('claim-submit-btn');
        const cashbackSubmitBtn = document.getElementById('cashback-submit-btn');
        const scanPayModal = document.getElementById('scan-pay-modal');
        const scannerVideo = document.getElementById('scanner-video');
        const scannerStatus = document.getElementById('scanner-status');
        const paymentForm = document.getElementById('payment-form');
        const paySubmitBtn = document.getElementById('pay-submit-btn');
        const paymentErrorMsg = document.getElementById('payment-error-msg');
        const rescanBtn = document.getElementById('rescan-btn');
        const scanPayInitialActions = document.getElementById('scan-pay-initial-actions');

        // --- State Variables ---
        let currentUserData = null;
        let activeListeners = [];
        let claimsDataSnapshot = null;
        let cashbackDataSnapshot = null;
        // UPDATED: Split payment snapshots for sent and received
        let sentPaymentsDataSnapshot = null;
        let receivedPaymentsDataSnapshot = null;
        let activeFilter = 'all';
        let scanner = null;
        let tempActionData = {};

        // --- Main Initialization Function ---
        async function initializeFirebaseApp() {
            try {
                const response = await fetch('/api/cashback-config');
                if (!response.ok) throw new Error('Could not fetch Firebase config from server!');
                const firebaseConfig = await response.json();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                database = getDatabase(app);
                setupApplication();
            } catch (error) {
                console.error("FATAL: Firebase initialization failed.", error);
                document.body.innerHTML = `<div style="text-align: center; padding: 50px; color: #ff6b6b;">Application could not start. Please check the connection and try again.</div>`;
            }
        }

        // --- Helper Functions ---
        function showErrorMessage(element, message) { element.textContent = message; element.style.display = 'block'; }
        function hideErrorMessage(element) { element.textContent = ''; element.style.display = 'none'; }
        function toggleView(viewId) { views.forEach(view => view.classList.remove('active')); document.getElementById(viewId)?.classList.add('active'); }
        function openModal(modalElement) { modalElement?.classList.add('active'); }
        function closeModal(modalElement) { 
            modalElement?.classList.remove('active');
            if (scanner) {
                scanner.getTracks().forEach(track => track.stop());
                scanner = null;
            }
        }
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function generatePaymentId(name, mobile) {
            if (!name || !mobile) return '';
            const formattedName = name.split(' ')[0].replace(/[^a-zA-Z0-9]/g, '');
            return `@${formattedName}RMZ${mobile}`;
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            document.body.dataset.theme = theme;
            themeSwitcher.querySelector('img').src = theme === 'light' ? "https://www.svgrepo.com/show/527253/moon.svg" : "https://www.svgrepo.com/show/433086/light-mode.svg";
        }
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        // --- Authentication & Listeners ---
        function setupAuthentication() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    toggleView('dashboard-view');
                    attachRealtimeListeners(user);
                } else {
                    toggleView('login-view');
                    detachAllListeners();
                }
            });
            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                hideErrorMessage(loginErrorMsg);
                const email = `${document.getElementById('login-mobile').value}@ramazone.com`;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password).catch(() => showErrorMessage(loginErrorMsg, "Galat mobile number ya password."));
            });
            registerForm.addEventListener('submit', async e => {
                e.preventDefault();
                hideErrorMessage(registerErrorMsg);
                const name = document.getElementById('reg-name').value.trim();
                const mobile = document.getElementById('reg-mobile').value.trim();
                const password = document.getElementById('reg-password').value.trim();
                if (!name || !/^\d{10}$/.test(mobile) || password.length < 6) {
                    showErrorMessage(registerErrorMsg, "Kripya sabhi details sahi se bharein.");
                    return;
                }
                try {
                    const email = `${mobile}@ramazone.com`;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    const userRef = ref(database, 'users/' + userCredential.user.uid);
                    await set(userRef, { name, mobile, wallet: 0, lifetimeEarning: 0, profilePictureUrl: '', lastSeenNotificationTimestamp: 0 });
                    alert("Registration safal hua! Ab aap login kar sakte hain.");
                    toggleView('login-view');
                    registerForm.reset();
                } catch (error) {
                    showErrorMessage(registerErrorMsg, error.code === 'auth/email-already-in-use' ? "Is mobile number se account pehle se hai." : "Registration fail ho gaya.");
                }
            });
            logoutBtn.addEventListener('click', () => signOut(auth));
        }

        function attachRealtimeListeners(user) {
            detachAllListeners();
            const userDbRef = ref(database, 'users/' + user.uid);
            activeListeners.push(onValue(userDbRef, (snapshot) => {
                if(snapshot.exists()){
                    currentUserData = snapshot.val();
                    updateDashboardUI(currentUserData, user);
                    claimSubmitBtn.disabled = false;
                    cashbackSubmitBtn.disabled = false;
                }
            }));
            
            const claimsQuery = query(ref(database, 'claim_requests'), orderByChild('userId'), equalTo(user.uid));
            activeListeners.push(onValue(claimsQuery, (snapshot) => {
                claimsDataSnapshot = snapshot;
                renderAllViews();
            }));
            
            const cashbackQuery = query(ref(database, 'cashback_requests'), orderByChild('userId'), equalTo(user.uid));
            activeListeners.push(onValue(cashbackQuery, (snapshot) => {
                cashbackDataSnapshot = snapshot;
                renderAllViews();
            }));

            // NEW: Listener for SENT Payments
            const sentPaymentsQuery = query(ref(database, 'payments'), orderByChild('senderId'), equalTo(user.uid));
             activeListeners.push(onValue(sentPaymentsQuery, (snapshot) => {
                sentPaymentsDataSnapshot = snapshot;
                renderAllViews();
            }));

            // NEW: Listener for RECEIVED Payments
            const receivedPaymentsQuery = query(ref(database, 'payments'), orderByChild('receiverId'), equalTo(user.uid));
             activeListeners.push(onValue(receivedPaymentsQuery, (snapshot) => {
                receivedPaymentsDataSnapshot = snapshot;
                renderAllViews();
            }));
        }

        function detachAllListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            currentUserData = null; claimsDataSnapshot = null; cashbackDataSnapshot = null; 
            sentPaymentsDataSnapshot = null; receivedPaymentsDataSnapshot = null;
            claimSubmitBtn.disabled = true; cashbackSubmitBtn.disabled = true;
        }

        function refreshData() {
            if (!auth.currentUser) return;
            refreshBtn.classList.add('refreshing');
            attachRealtimeListeners(auth.currentUser);
            setTimeout(() => refreshBtn.classList.remove('refreshing'), 1000);
        }

        // --- UI Rendering ---
        function renderAllViews() {
            // UPDATED: Wait for all snapshots before rendering
            if (claimsDataSnapshot && cashbackDataSnapshot && sentPaymentsDataSnapshot && receivedPaymentsDataSnapshot) {
                renderUnifiedHistory(claimsDataSnapshot, cashbackDataSnapshot, sentPaymentsDataSnapshot, receivedPaymentsDataSnapshot);
                renderCouponsModal(claimsDataSnapshot);
            }
        }

        function updateDashboardUI(dbData, authUser) {
            if (!dbData || !authUser) return;
            const hour = new Date().getHours();
            let greeting = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
            document.getElementById('user-greeting').textContent = `${greeting}, ${authUser.displayName || 'Kunal'}!`;
            const walletBalance = (dbData.wallet || 0).toFixed(2);
            document.getElementById('wallet-balance').textContent = `‚Çπ ${walletBalance}`;
            document.querySelector('#lifetime-earning .highlight-amount').textContent = `‚Çπ ${(dbData.lifetimeEarning || 0).toFixed(2)}`;
            document.getElementById('user-mobile').textContent = `Mobile: ${dbData.mobile}`;
            const initial = authUser.displayName ? authUser.displayName.charAt(0).toUpperCase() : 'R';
            const placeholderUrl = `https://placehold.co/80x80/ffffff/2980b9?text=${initial}`;
            const profileDisplay = document.getElementById('profile-display');
            const profileModalDisplay = document.getElementById('profile-modal-display');
            profileDisplay.src = dbData.profilePictureUrl || placeholderUrl;
            profileModalDisplay.src = dbData.profilePictureUrl || placeholderUrl;
            profileDisplay.onerror = () => { profileDisplay.src = placeholderUrl; };
            profileModalDisplay.onerror = () => { profileModalDisplay.src = placeholderUrl; };
            document.getElementById('profile-modal-name').textContent = authUser.displayName;
            document.getElementById('profile-modal-mobile').textContent = dbData.mobile;
            const whatsappMessage = `Help Required\n\nName: ${authUser.displayName || 'N/A'}\nWallet Balance: ‚Çπ${walletBalance}`;
            whatsappSupportLink.href = `https://wa.me/917903698180?text=${encodeURIComponent(whatsappMessage)}`;
            document.getElementById('profile-payment-id').textContent = generatePaymentId(authUser.displayName, dbData.mobile);
        }

        function getEmptyStateHTML(type) {
            const messages = {
                history: { icon: 'üìú', title: 'Koi Transactions Nahi', text: 'Aapka pehla transaction yahan dikhega.' },
                coupons: { icon: 'üéüÔ∏è', title: 'Koi Coupons Nahi', text: 'Claim kiye gaye coupons yahan dikhenge.' }
            };
            const msg = messages[type] || { icon: 'üìÇ', title: 'Abhi Kuch Nahi Hai', text: 'Jab aapke paas naye items honge, to woh yahan dikhenge.' };
            return `<div class="empty-state"><div class="empty-state-icon">${msg.icon}</div><h4>${msg.title}</h4><p>${msg.text}</p></div>`;
        }

        // UPDATED: Complete history rendering logic
        function renderUnifiedHistory(claimSnap, cashbackSnap, sentPaymentSnap, receivedPaymentSnap) {
            const historyList = document.getElementById('unified-history-list');
            historyList.innerHTML = '';
            let combinedHistory = [];

            // 1. Claims (Debit)
            if (claimSnap.exists()) claimSnap.forEach(child => {
                const req = child.val();
                combinedHistory.push({ type: 'claim', date: new Date(req.requestDate), title: 'Wallet Claim', amount: req.claimAmount, status: req.status, couponCode: req.couponCode });
            });
            // 2. Cashback (Credit)
            if(cashbackSnap.exists()) cashbackSnap.forEach(child => {
                const req = child.val();
                combinedHistory.push({ type: 'cashback', date: new Date(req.requestDate), title: `Cashback: ${req.productName}`, amount: req.cashbackAmount, status: req.status });
            });
            // 3. Sent Payments (Debit)
            if(sentPaymentSnap.exists()) sentPaymentSnap.forEach(child => {
                const req = child.val();
                combinedHistory.push({ type: 'payment', date: new Date(req.timestamp), title: `Paid to ${req.receiverName}`, amount: req.amount, status: 'completed' });
            });
            // 4. Received Payments (Credit)
            if(receivedPaymentSnap.exists()) receivedPaymentSnap.forEach(child => {
                const req = child.val();
                combinedHistory.push({ type: 'received', date: new Date(req.timestamp), title: `Received from ${req.senderName}`, amount: req.amount, status: 'completed' });
            });

            let filteredHistory = combinedHistory.filter(item => {
                if (activeFilter === 'all') return true;
                if (activeFilter === 'payment') return item.type === 'payment' || item.type === 'received';
                if (activeFilter === 'cashback' || activeFilter === 'claim' || activeFilter === 'pending' || activeFilter === 'approved') {
                    if (item.type === activeFilter) return true;
                    if (item.status === activeFilter) return true;
                }
                return false;
            });

            if (filteredHistory.length === 0) { historyList.innerHTML = getEmptyStateHTML('history'); return; }

            filteredHistory.sort((a, b) => b.date - a.date).forEach(item => {
                const itemDiv = document.createElement('div');
                const isDebit = item.type === 'claim' || item.type === 'payment';
                let typeClass = '';
                let iconContent = '';
                
                switch(item.type) {
                    case 'claim':
                        typeClass = 'debit';
                        iconContent = `üí∏`;
                        break;
                    case 'payment':
                        typeClass = 'payment';
                        iconContent = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`;
                        break;
                    case 'cashback':
                    case 'received':
                        typeClass = 'credit';
                        iconContent = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>`;
                        break;
                }
                
                itemDiv.className = `history-item ${typeClass}`;
                let couponHTML = (item.type === 'claim' && item.status === 'approved' && item.couponCode) ? `<span class="coupon-code">${item.couponCode}</span>` : (item.type === 'claim' && item.status === 'rejected') ? `<span class="coupon-code">Refunded</span>` : '';
                
                itemDiv.innerHTML = `
                    <div class="history-details">
                        <div class="history-icon ${typeClass}">${iconContent}</div>
                        <div class="history-info">
                            <div class="title">${item.title}</div>
                            <div class="date">${item.date.toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="history-amount">
                        <div class="amount ${typeClass}">${isDebit ? '-' : '+'} ‚Çπ${parseFloat(item.amount).toFixed(2)}</div>
                        <span class="status status-${item.status}">${item.status}</span>
                        ${couponHTML}
                    </div>`;
                historyList.appendChild(itemDiv);
            });
        }
        
        function renderCouponsModal(claimSnapshot) {
            const list = document.getElementById('coupons-list');
            list.innerHTML = '';
            const approvedClaims = [];
            if(claimSnapshot.exists()) claimSnapshot.forEach(child => {
                const req = child.val();
                if(req.status === 'approved' && req.couponCode) approvedClaims.push(req);
            });
            if (approvedClaims.length === 0) { list.innerHTML = getEmptyStateHTML('coupons'); return; }
            approvedClaims.sort((a,b) => new Date(b.requestDate) - new Date(a.requestDate)).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item debit';
                const couponText = item.couponCode;
                itemDiv.innerHTML = `<div class="history-details"><div class="history-icon debit">üéüÔ∏è</div><div class="history-info"><div class="title">‚Çπ${parseFloat(item.claimAmount).toFixed(2)} Coupon</div><div class="date">${new Date(item.requestDate).toLocaleDateString()}</div></div></div><div class="history-amount"><span class="coupon-code" style="font-size: 14px;">${couponText}</span><button class="copy-btn" data-coupon="${couponText}">üìã Copy</button></div>`;
                list.appendChild(itemDiv);
            });
        }

        // --- Action Handlers ---
        async function handleClaimRequest(e) {
            e.preventDefault();
            hideErrorMessage(claimErrorMsg);
            if(!auth.currentUser || !currentUserData){ showErrorMessage(claimErrorMsg,"Data load ho raha hai..."); return; }
            const claimAmount=parseFloat(document.getElementById("claim-amount").value);
            if(isNaN(claimAmount)||claimAmount<10){showErrorMessage(claimErrorMsg,"Sahi amount daalein (kam se kam ‚Çπ10).");return}
            if(claimAmount > (currentUserData.wallet||0)){showErrorMessage(claimErrorMsg,"Aap wallet balance se zyada claim nahi kar sakte.");return}
            
            tempActionData = { type: 'claim', amount: claimAmount };
            document.getElementById('password-modal-title').textContent = 'Confirm Claim Request';
            document.getElementById('password-modal-description').textContent = `Aap ‚Çπ${claimAmount.toFixed(2)} claim kar rahe hain. Kripya password daalein.`;
            closeModal(claimModal);
            openModal(passwordModal);
            modalPasswordInput.focus();
        }
        
        async function processClaimConfirmation() {
            const userRef = ref(database, 'users/' + auth.currentUser.uid);
            const transactionResult = await runTransaction(userRef, data => {
                if (data && (data.wallet || 0) >= tempActionData.amount) {
                    data.wallet = (data.wallet || 0) - tempActionData.amount;
                    return data;
                }
                return; 
            });
            if (transactionResult.committed) {
                const newClaimRef = push(ref(database, "claim_requests"));
                await set(newClaimRef, { claimId: newClaimRef.key, userMobile: currentUserData.mobile, userName: auth.currentUser.displayName, claimAmount: tempActionData.amount, status: "pending", requestDate: (new Date).toISOString(), userId: auth.currentUser.uid });
                showToast("Request safaltapoorvak bhej diya gaya hai!");
                closeModal(passwordModal);
                claimRequestForm.reset();
            } else {
                throw new Error("Transaction fail. Balance check karein.");
            }
        }
        
        async function getCashbackPercentage() {
            const defaultPercentage = 2; 
            if (!database) return defaultPercentage;
            try {
                const percentageRef = ref(database, 'app_settings/cashback_percentage');
                const snapshot = await get(percentageRef);
                if (snapshot.exists() && typeof snapshot.val() === 'number') {
                    return snapshot.val();
                }
                return defaultPercentage;
            } catch (error) {
                console.error("Error fetching cashback percentage, using default.", error);
                return defaultPercentage;
            }
        }

        async function handleCashbackRequest(e) {
            e.preventDefault();
            hideErrorMessage(cashbackErrorMsg);
            cashbackSubmitBtn.disabled = true;
            if(!auth.currentUser || !currentUserData){ showErrorMessage(cashbackErrorMsg,"Data load ho raha hai..."); cashbackSubmitBtn.disabled = false; return; }
            const productName = document.getElementById("product-name").value.trim();
            const productPrice = parseFloat(document.getElementById("product-price").value);
            const purchaseDate = document.getElementById("product-purchase-date").value;
            if(!productName || isNaN(productPrice) || productPrice < 10 || !purchaseDate){ 
                showErrorMessage(cashbackErrorMsg,"Sahi product naam, price aur purchase date daalein."); 
                cashbackSubmitBtn.disabled = false; 
                return; 
            }
            const percentage = await getCashbackPercentage();
            const cashbackAmount = productPrice * (percentage / 100);
            const newRequestRef=push(ref(database,"cashback_requests"));
            try{
                await set(newRequestRef,{ 
                    requestId: newRequestRef.key, userMobile: currentUserData.mobile, userName: auth.currentUser.displayName, 
                    productName: productName, productPrice: productPrice, purchaseDate: purchaseDate, 
                    cashbackAmount: cashbackAmount, status: "pending", requestDate: (new Date).toISOString(), 
                    userId: auth.currentUser.uid, scratched: false 
                });
                showToast("Cashback request submit ho gaya!");
                cashbackRequestForm.reset();
                closeModal(cashbackModal);
            } catch(err){
                showErrorMessage(cashbackErrorMsg,"Request submit karne mein error aayi: "+err.message);
            } finally {
                 cashbackSubmitBtn.disabled = false;
            }
        }

        function startScanner() {
            paymentForm.style.display = 'none';
            scannerStatus.textContent = "Scanning for QR code...";
            scannerStatus.style.color = 'inherit';
            scanPayInitialActions.style.display = 'flex';
            hideErrorMessage(paymentErrorMsg);
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                scanner = stream;
                scannerVideo.srcObject = stream;
                scannerVideo.play();
                requestAnimationFrame(tick);
            })
            .catch(function(err) {
                scannerStatus.textContent = "Could not access camera.";
                scannerStatus.style.color = 'var(--brand-red)';
                console.error("Camera Error:", err);
            });
        }

        function tick() {
            if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA && scanner) {
                const canvas = document.createElement('canvas');
                canvas.width = scannerVideo.videoWidth;
                canvas.height = scannerVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(scannerVideo, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code && code.data.startsWith('@')) {
                    handleScannedCode(code.data);
                } else {
                    requestAnimationFrame(tick);
                }
            } else if (scanner) {
                 requestAnimationFrame(tick);
            }
        }

        async function handleScannedCode(paymentId) {
            scanner.getTracks().forEach(track => track.stop());
            scanner = null;
            scannerStatus.textContent = 'Processing ID...';
            
            const match = paymentId.match(/@(.+?)RMZ(\d{10})$/);
            if (!match) {
                scannerStatus.textContent = "Invalid QR Code format.";
                scannerStatus.style.color = 'var(--brand-red)';
                setTimeout(startScanner, 2000);
                return;
            }
            const mobile = match[2];
            
            const usersRef = ref(database, 'users');
            const userQuery = query(usersRef, orderByChild('mobile'), equalTo(mobile));
            const snapshot = await get(userQuery);

            if (!snapshot.exists()) {
                scannerStatus.textContent = "Receiver not found.";
                scannerStatus.style.color = 'var(--brand-red)';
                return;
            }

            const [receiverUid, receiverData] = Object.entries(snapshot.val())[0];

            if(receiverUid === auth.currentUser.uid){
                scannerStatus.textContent = "You cannot pay yourself.";
                scannerStatus.style.color = 'var(--brand-red)';
                return;
            }

            scannerStatus.textContent = 'QR Code Scanned!';
            scanPayInitialActions.style.display = 'none';
            paymentForm.style.display = 'block';
            document.getElementById('receiver-name-display').textContent = receiverData.name;
            document.getElementById('receiver-id-display').textContent = paymentId;
            tempActionData = { type: 'payment', receiverUid, receiverData };
        }

        async function handlePaymentRequest() {
            hideErrorMessage(paymentErrorMsg);
            const amount = parseFloat(document.getElementById('payment-amount').value);

            if(isNaN(amount) || amount <= 0) { showErrorMessage(paymentErrorMsg, "Please enter a valid amount."); return; }
            if(amount > (currentUserData.wallet || 0)) { showErrorMessage(paymentErrorMsg, "Insufficient wallet balance."); return; }
            
            tempActionData.amount = amount;
            document.getElementById('password-modal-title').textContent = 'Confirm Payment';
            document.getElementById('password-modal-description').textContent = `Paying ‚Çπ${amount.toFixed(2)} to ${tempActionData.receiverData.name}. Please enter your password.`;
            closeModal(scanPayModal);
            openModal(passwordModal);
            modalPasswordInput.focus();
        }

        async function processPaymentConfirmation() {
            const { amount, receiverUid, receiverData } = tempActionData;
            
            // This entire logic should ideally be a Cloud Function for security.
            const senderRef = ref(database, 'users/' + auth.currentUser.uid);
            const receiverRef = ref(database, 'users/' + receiverUid);

            // Using a single transaction path to update both users is not directly possible in RTDB
            // without structuring data differently. A Cloud Function is the correct approach.
            // For client-side simulation, we perform two transactions.
            
            const senderTx = await runTransaction(senderRef, (senderData) => {
                if (senderData && (senderData.wallet || 0) >= amount) {
                    senderData.wallet -= amount;
                    return senderData;
                }
                return; // Abort
            });

            if(!senderTx.committed) {
                 throw new Error("Payment failed. Could not debit from your account.");
            }

            await runTransaction(receiverRef, (rcvData) => {
                if (rcvData) {
                    rcvData.wallet = (rcvData.wallet || 0) + amount;
                }
                return rcvData;
            });

            const newPaymentRef = push(ref(database, 'payments'));
            await set(newPaymentRef, {
                paymentId: newPaymentRef.key,
                senderId: auth.currentUser.uid,
                senderName: currentUserData.name,
                receiverId: receiverUid,
                receiverName: receiverData.name,
                amount: amount,
                timestamp: new Date().toISOString()
            });

            showToast(`‚Çπ${amount.toFixed(2)} paid successfully!`);
            closeModal(passwordModal);
        }

        async function handlePasswordConfirmation() {
            hideErrorMessage(modalErrorMsg);
            modalConfirmBtn.disabled = true;
            modalConfirmBtn.textContent = "Verifying...";
            if (!auth.currentUser || !currentUserData) {
                showErrorMessage(modalErrorMsg, "Session expire. Dobara login karein.");
                modalConfirmBtn.disabled = false; modalConfirmBtn.textContent = "Confirm"; return;
            }
            const password = modalPasswordInput.value;
            if (!password) {
                showErrorMessage(modalErrorMsg, "Kripya password daalein.");
                modalConfirmBtn.disabled = false; modalConfirmBtn.textContent = "Confirm"; return;
            }
            const credential = EmailAuthProvider.credential(`${currentUserData.mobile}@ramazone.com`, password);
            try {
                await reauthenticateWithCredential(auth.currentUser, credential);
                modalConfirmBtn.textContent = "Processing...";

                if (tempActionData.type === 'claim') {
                    await processClaimConfirmation();
                } else if (tempActionData.type === 'payment') {
                    await processPaymentConfirmation();
                }

            } catch (error) {
                console.error(error);
                showErrorMessage(modalErrorMsg, "Galat password ya koi anya error.");
            } finally {
                modalConfirmBtn.disabled = false; modalConfirmBtn.textContent = "Confirm"; 
                modalPasswordInput.value = '';
                tempActionData = {};
            }
        }
        
        async function handlePasswordChange(e) {
            e.preventDefault();
            hideErrorMessage(passwordChangeErrorMsg);
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if (newPassword !== confirmPassword) { showErrorMessage(passwordChangeErrorMsg, "Naya password match nahi ho raha."); return; }
            if (newPassword.length < 6) { showErrorMessage(passwordChangeErrorMsg, "Naya password kam se kam 6 akshar ka hona chahiye."); return; }
            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(`${currentUserData.mobile}@ramazone.com`, currentPassword);
            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showToast("Password safaltapoorvak badal gaya hai!");
                passwordChangeForm.reset();
                closeModal(profileModal);
            } catch (error) {
                showErrorMessage(passwordChangeErrorMsg, "Purana password galat hai ya koi aur error aayi.");
            }
        }

        // --- Setup Function ---
        function setupApplication() {
            initTheme();
            setupAuthentication();
            themeSwitcher.addEventListener('click', () => {
                const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            refreshBtn.addEventListener('click', refreshData);
            document.getElementById('show-register-link').addEventListener('click', e => { e.preventDefault(); toggleView('registration-view'); });
            document.getElementById('show-login-link').addEventListener('click', e => { e.preventDefault(); toggleView('login-view'); });
            
            document.getElementById('open-claim-modal').addEventListener('click', () => openModal(claimModal));
            document.getElementById('open-coupons-modal').addEventListener('click', () => openModal(document.getElementById('coupons-modal')));
            document.getElementById('open-profile-modal').addEventListener('click', () => openModal(profileModal));
            
            document.getElementById('open-cashback-modal').addEventListener('click', async () => {
                const percentage = await getCashbackPercentage();
                document.getElementById('cashback-modal-description').textContent = `Product details bharein. ${percentage}% cashback request kiya jayega.`;
                document.getElementById('product-purchase-date').valueAsDate = new Date();
                openModal(cashbackModal);
            });

            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay'))));
            
            claimRequestForm.addEventListener('submit', handleClaimRequest);
            cashbackRequestForm.addEventListener('submit', handleCashbackRequest);
            passwordChangeForm.addEventListener('submit', handlePasswordChange);
            
            modalConfirmBtn.addEventListener('click', handlePasswordConfirmation);

            document.getElementById('coupons-list').addEventListener('click', e => {
                if (e.target?.classList.contains('copy-btn')) {
                    const coupon = e.target.dataset.coupon;
                    navigator.clipboard.writeText(coupon).then(() => {
                        e.target.textContent = '‚úÖ Copied!';
                        setTimeout(() => { e.target.textContent = 'üìã Copy'; }, 2000);
                    });
                }
            });

            walletShareBtn.addEventListener('click', async () => {
                if (!auth.currentUser || !currentUserData) { showToast("Data load ho raha hai, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§"); return; }
                const shareMessage = `üéâ *Wow! Ek Zabardast Offer!* üéâ\n\nMaine, *${auth.currentUser.displayName || 'Prince Rama'}* ne, Ramazone Cashback app se ab tak *‚Çπ${(currentUserData.lifetimeEarning || 0).toFixed(2)}* ki bachat ki hai! ü§ë\n\nAap bhi is app ko use karein aur har khareed par dher saare paise bachayein. Miss mat karna! üëá\n\nhttps://ramazone.in/cashback.html`;
                try {
                    if (navigator.share) await navigator.share({ text: shareMessage });
                    else { navigator.clipboard.writeText(shareMessage); showToast('Share message copied to clipboard!'); }
                } catch (err) { if (err.name !== 'AbortError') showToast('Share karne mein error aayi.'); }
            });

            filterBar.addEventListener('click', e => {
                const target = e.target.closest('.filter-btn');
                if (!target) return;
                filterBar.querySelector('.active').classList.remove('active');
                target.classList.add('active');
                activeFilter = target.dataset.filter;
                renderAllViews();
            });
            
            document.getElementById('scan-and-pay-btn').addEventListener('click', () => {
                openModal(scanPayModal);
                startScanner();
            });
            paySubmitBtn.addEventListener('click', handlePaymentRequest);
            rescanBtn.addEventListener('click', startScanner);
        }

        // --- Start the application ---
        document.addEventListener('DOMContentLoaded', initializeFirebaseApp);
    </script>
</body>
</html>

