<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazone Cashback</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f7f9;
            --bg-card: #ffffff;
            --text-primary: #1c2028;
            --text-secondary: #5a647e;
            --border-color: #e8eef3;
            --border-color-strong: #ced4da;
            --brand-red: #e50914;
            --card-bg: #00ADEF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
        }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Wallet Card */
        .wallet-card {
            background: var(--card-bg); color: white; padding: 20px; border-radius: 20px;
            margin-bottom: 30px; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 173, 239, 0.3);
        }
        .wallet-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .wallet-card-logo { width: 120px; opacity: 0.9; filter: brightness(0) invert(1); }
        #profile-display { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .wallet-card-body { text-align: center; padding: 10px 0; }
        #user-name-display { font-size: 22px; font-weight: 600; }
        .wallet-balance-label { font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 5px; }
        #wallet-balance { font-size: 44px; font-weight: 800; line-height: 1; }
        
        /* **SHARE BUTTON FIX** */
        .referral-container {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 15px; cursor: pointer; padding: 8px; border-radius: 25px;
            transition: background-color 0.2s; background-color: rgba(255,255,255,0.1);
        }
        #user-referral-id { font-weight: 600; font-size: 16px; color: white; letter-spacing: 1px; }
        .referral-container svg { stroke: white; width: 20px; height: 20px; }
        #wallet-share-btn { cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
        #wallet-share-btn:hover svg { transform: scale(1.1); }
        
        .wallet-card-footer { display: flex; justify-content: space-around; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 15px; margin-top: 15px; }
        .wallet-footer-item { text-align: center; }
        .wallet-footer-item p { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.8); margin-bottom: 4px; text-transform: uppercase; }
        .wallet-footer-item .amount { font-size: 16px; font-weight: 700; color: white; }
        /* Other styles remain same */
    </style>
</head>
<body>
    <!-- The rest of your cashback.html body content -->
    <div class="container">
        <!-- ... other views ... -->
        <div id="dashboard-view" class="view">
             <!-- ... header ... -->
             <div class="wallet-card">
                <div class="wallet-card-header">
                    <img src="https://i.ibb.co/Jj0f3QQz/20250708-182433.png" alt="Ramazone Logo" class="wallet-card-logo">
                    <img id="profile-display" src="https://placehold.co/50x50/ffffff/2980b9?text=R" alt="Profile Picture">
                </div>
                <div class="wallet-card-body">
                    <h2 id="user-name-display">User Name</h2>
                    <p class="wallet-balance-label">Available Balance</p>
                    <p id="wallet-balance">₹ 0.00</p>
                    
                    <!-- **SHARE BUTTON FIX** -->
                    <div class="referral-container">
                        <span id="user-referral-id-copy" title="Copy Referral ID"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        <div id="wallet-share-btn" title="Share App">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        </div>
                    </div>
                </div>
                <div class="wallet-card-footer">
                    <!-- ... footer items ... -->
                </div>
            </div>
            <!-- ... rest of dashboard ... -->
        </div>
    </div>

    <!-- Your cashback.js script tag should be here -->
    <script src="cashback.js" type="module"></script>
</body>
</html>

कदम 2: एडमिन पैनल को अपडेट करें (admin.html)
यह एक बड़ा अपडेट है। इस पूरे कोड को अपनी admin.html फ़ाइल में बदल दें।
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Ramazone</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f0f2f5; --bg-card: #ffffff; --text-primary: #1c2028;
            --text-secondary: #5a647e; --border-color: #e8eef3; --brand-red: #e50914;
            --accent-green: #2ecc71; --accent-purple: #8e44ad; --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-page); color: var(--text-primary); }
        .admin-container { max-width: 1400px; margin: 20px auto; padding: 20px; }
        .login-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box { width: 100%; max-width: 400px; padding: 40px; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); text-align: center; }
        #login-view.active, #admin-view.active { display: block; }
        #login-view, #admin-view { display: none; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        input, .input-like { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #ced4da; font-size: 16px; }
        button { width: 100%; padding: 14px; background-color: var(--brand-red); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        #logout-btn { background: var(--text-secondary); width: auto; padding: 10px 20px; font-size: 14px; }
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .card h3 { margin: 0 0 10px 0; color: var(--text-secondary); font-size: 16px; }
        .card .stat-number { font-size: 36px; font-weight: 700; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 12px 25px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--text-secondary); }
        .tab-link.active { color: var(--brand-red); border-bottom-color: var(--brand-red); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-box { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .request-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr auto; gap: 15px; }
        .request-details p { margin: 0 0 10px 0; }
        .request-actions { display: flex; gap: 10px; align-items: center; }
        .btn-approve { background-color: var(--accent-green); }
        .btn-reject { background-color: var(--brand-red); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 14px; border-bottom: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="login-view" class="active">
        <div class="login-wrapper"><div class="login-box">
            <h1>Admin Panel</h1>
            <form id="admin-login-form">
                <div class="form-group"><label for="admin-email">Mobile Number</label><input type="tel" id="admin-email" required></div>
                <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                <button type="submit">Login</button>
                <p id="admin-login-error" style="color: red; margin-top: 15px;"></p>
            </form>
        </div></div>
    </div>

    <div id="admin-view">
        <div class="admin-container">
            <div class="header"><h1>Admin Dashboard</h1><button id="logout-btn">Logout</button></div>
            <div class="stat-cards">
                <div class="card"><h3>Pending Requests</h3><p class="stat-number" id="pending-requests-stat">0</p></div>
                <div class="card"><h3>Total Members</h3><p class="stat-number" id="total-members-stat">0</p></div>
                <div class="card"><h3>Universal Wallet</h3><p class="stat-number" id="universal-wallet-stat">₹0</p></div>
            </div>
            <div class="tabs">
                <div class="tab-link active" data-tab="requests">Pending Requests</div>
                <div class="tab-link" data-tab="members">All Members</div>
                <div class="tab-link" data-tab="univ-history">Universal History</div>
                <div class="tab-link" data-tab="settings">Settings</div>
            </div>
            <div class="content-box">
                <div id="requests-content" class="tab-content active"><h2>Pending Requests</h2><div id="request-list"></div></div>
                <div id="members-content" class="tab-content"><h2>All Members</h2><div id="members-list" class="table-container"></div></div>
                <div id="univ-history-content" class="tab-content"><h2>Universal Wallet History</h2><div id="univ-history-list" class="table-container"></div></div>
                <div id="settings-content" class="tab-content">
                    <h2>App Settings</h2>
                    <div class="form-group">
                        <label for="cashback-percentage">Self Cashback Percentage (%)</label>
                        <input type="number" id="cashback-percentage" step="0.1">
                    </div>
                    <button id="save-settings-btn" style="width: 200px;">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, writeBatch, increment, serverTimestamp, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCmgMr4cj7ec1B09eu3xpRhCwsVCeQR9v0",
            authDomain: "tipsplit-e3wes.firebaseapp.com",
            databaseURL: "https://tipsplit-e3wes-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tipsplit-e3wes",
            storageBucket: "tipsplit-e3wes.appspot.com",
            messagingSenderId: "984733883633",
            appId: "1:984733883633:web:adc1e1d22b629a6b631d50"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_UID = "9trVz1b6zMNPsBjHZRzRhoU6N5F2";
        let activeListeners = [];

        const ui = {
            loginView: document.getElementById('login-view'),
            adminView: document.getElementById('admin-view'),
            adminLoginForm: document.getElementById('admin-login-form'),
            adminLoginError: document.getElementById('admin-login-error'),
            logoutBtn: document.getElementById('logout-btn'),
            tabs: document.querySelector('.tabs'),
            tabContents: document.querySelectorAll('.tab-content'),
            requestList: document.getElementById('request-list'),
            membersList: document.getElementById('members-list'),
            univHistoryList: document.getElementById('univ-history-list'),
            stats: {
                pending: document.getElementById('pending-requests-stat'),
                members: document.getElementById('total-members-stat'),
                universalWallet: document.getElementById('universal-wallet-stat'),
            },
            settings: {
                cashbackPercent: document.getElementById('cashback-percentage'),
                saveBtn: document.getElementById('save-settings-btn'),
            }
        };

        async function init() {
            await setPersistence(auth, browserSessionPersistence);
            onAuthStateChanged(auth, user => {
                if (user && user.uid === ADMIN_UID) {
                    ui.loginView.classList.remove('active');
                    ui.adminView.classList.add('active');
                    loadAllData();
                } else {
                    if (user) signOut(auth);
                    ui.loginView.classList.add('active');
                    ui.adminView.classList.remove('active');
                    activeListeners.forEach(unsub => unsub());
                }
            });
        }

        function loadAllData() {
            activeListeners.forEach(unsub => unsub());
            activeListeners = [
                onSnapshot(query(collection(db, 'cashback_requests'), where('status', '==', 'pending')), renderRequests),
                onSnapshot(query(collection(db, 'users'), orderBy('createdAt', 'desc')), renderMembers),
                onSnapshot(doc(db, 'app_settings', 'config'), renderSettingsAndStats),
                onSnapshot(query(collection(db, 'universal_wallet_transactions'), orderBy('timestamp', 'desc')), renderUnivHistory)
            ];
        }

        function renderRequests(snapshot) {
            ui.stats.pending.textContent = snapshot.size;
            ui.requestList.innerHTML = snapshot.empty ? '<p>No pending requests.</p>' : '';
            snapshot.forEach(doc => {
                const r = { id: doc.id, ...doc.data() };
                ui.requestList.innerHTML += `<div class="request-item"><div><p><strong>User:</strong> ${r.userName} (${r.userMobile})</p><p><strong>Product:</strong> ${r.productName} (₹${r.productPrice})</p><p><strong>Date:</strong> ${r.requestDate.toDate().toLocaleDateString()}</p></div><div class="request-actions"><button class="btn-approve" data-id="${r.id}">Approve</button><button class="btn-reject" data-id="${r.id}">Reject</button></div></div>`;
            });
        }
        function renderMembers(snapshot) {
            ui.stats.members.textContent = snapshot.size;
            let table = `<table><thead><tr><th>Name</th><th>Mobile</th><th>Wallet</th></tr></thead><tbody>`;
            snapshot.forEach(doc => {
                const u = doc.data();
                table += `<tr><td>${u.name}</td><td>${u.mobile}</td><td>₹${(u.wallet || 0).toFixed(2)}</td></tr>`;
            });
            ui.membersList.innerHTML = table + `</tbody></table>`;
        }
        function renderSettingsAndStats(doc) {
            if (doc.exists()) {
                const config = doc.data();
                ui.stats.universalWallet.textContent = `₹${(config.universal_wallet_balance || 0).toFixed(2)}`;
                ui.settings.cashbackPercent.value = config.cashback_percentage || 0;
            }
        }
        function renderUnivHistory(snapshot) {
            let table = `<table><thead><tr><th>Date</th><th>Amount</th><th>Reason</th></tr></thead><tbody>`;
            snapshot.forEach(doc => {
                const t = doc.data();
                table += `<tr><td>${t.timestamp.toDate().toLocaleString()}</td><td>₹${t.amount.toFixed(2)}</td><td>${t.reason}</td></tr>`;
            });
            ui.univHistoryList.innerHTML = table + `</tbody></table>`;
        }
        
        async function approveRequest(requestId) {
            const requestDocRef = doc(db, 'cashback_requests', requestId);
            const configDocRef = doc(db, 'app_settings', 'config');

            const [requestDoc, configDoc] = await Promise.all([getDoc(requestDocRef), getDoc(configDocRef)]);
            if (!requestDoc.exists() || !configDoc.exists()) throw new Error("Request or config not found.");
            
            const requestData = requestDoc.data();
            const config = configDoc.data();
            const cashbackPercent = config.cashback_percentage || 0;

            const userDoc = await getDoc(doc(db, 'users', requestData.userId));
            if (!userDoc.exists()) throw new Error("User not found.");
            const userData = userDoc.data();

            const selfAmount = requestData.productPrice * (cashbackPercent / 100);
            const distributionAmount = selfAmount * 0.50; // 50% of self amount

            const batch = writeBatch(db);
            batch.update(requestDocRef, { status: 'approved', cashbackAmount: selfAmount });

            const upline = userData.upline || [];
            const percentages = [0.30, 0.25, 0.20, 0.15, 0.10];
            let totalLapsedAmount = 0;

            for (let i = 0; i < 5; i++) {
                const commission = distributionAmount * percentages[i];
                if (upline[i]) {
                    const uplineUserRef = doc(db, 'users', upline[i]);
                    batch.update(uplineUserRef, { wallet: increment(commission), lifetimeEarning: increment(commission) });
                    batch.set(doc(collection(db, 'transactions')), { involvedUsers: [upline[i]], type: 'commission', amount: commission, description: `Commission from ${userData.name}`, timestamp: serverTimestamp(), status: 'completed' });
                } else {
                    totalLapsedAmount += commission;
                }
            }

            if (totalLapsedAmount > 0) {
                batch.update(configDocRef, { universal_wallet_balance: increment(totalLapsedAmount) });
                batch.set(doc(collection(db, 'universal_wallet_transactions')), { amount: totalLapsedAmount, reason: `Lapsed commission from ${userData.name}'s request`, timestamp: serverTimestamp() });
            }
            await batch.commit();
        }

        ui.adminLoginForm.addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, `${document.getElementById('admin-email').value}@ramazone.com`, document.getElementById('admin-password').value).catch(() => ui.adminLoginError.textContent = "Login failed."); });
        ui.logoutBtn.addEventListener('click', () => signOut(auth));
        ui.tabs.addEventListener('click', (e) => { if (!e.target.matches('.tab-link')) return; ui.tabs.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); ui.tabContents.forEach(c => c.classList.remove('active')); document.getElementById(`${e.target.dataset.tab}-content`).classList.add('active'); });
        ui.requestList.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            btn.disabled = true;
            try {
                if (btn.matches('.btn-approve')) await approveRequest(btn.dataset.id);
                else if (btn.matches('.btn-reject')) await writeBatch(db).update(doc(db, 'cashback_requests', btn.dataset.id), { status: 'rejected' }).commit();
            } catch (error) { console.error(error); alert(`Error: ${error.message}`); }
            finally { btn.disabled = false; }
        });
        ui.settings.saveBtn.addEventListener('click', async () => {
            const newPercent = parseFloat(ui.settings.cashbackPercent.value);
            if (isNaN(newPercent) || newPercent < 0) return alert("Invalid percentage.");
            await setDoc(doc(db, 'app_settings', 'config'), { cashback_percentage: newPercent }, { merge: true });
            alert("Settings saved!");
        });

        init();
    </script>
</body>
</html>

