<!-- FINAL PERFECTED DESIGN: All visual tweaks and logic corrections are included. -->

<style>
    /* Scoped styles for the Festive Collection section */
    #festive-collection-container .section-header-flex { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; margin-bottom: 1rem; gap: 1rem; }
    #festive-collection-container .festival-headline { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 0; flex-shrink: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #festive-collection-container .header-right-content { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
    #festive-collection-container .countdown-timer { background-color: rgba(0, 0, 0, 0.08); padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem; white-space: nowrap; }
    #festive-collection-container .view-all-arrow { background-color: rgba(0, 0, 0, 0.08); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: background-color 0.2s; }
    #festive-collection-container .view-all-arrow:hover { background-color: rgba(0, 0, 0, 0.15); }
    #festive-collection-container .product-card { flex: 0 0 calc(50% - 10px); max-width: 200px; }
    
    /* UPDATED: Professional Tag Styling */
    #festive-collection-container .offer-tag-top-left {
        position: absolute;
        top: 0;
        left: 0; /* UPDATED: Flush with the left edge */
        background-color: var(--primary-color);
        color: white;
        padding: 3px 10px 5px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0 0 8px 0px; /* UPDATED: Corner radius */
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 5;
    }
    #festive-collection-container .rating-tag-bottom-left {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background-color: #fff;
        backdrop-filter: blur(5px);
        font-size: 12px;
        font-weight: 600;
        padding: 3px 8px;
        z-index: 5;
        color: #000;
        border-radius: 5px;
        border: 1px solid rgba(0, 0,0, 0.5);
    }
    #festive-collection-container .rating-tag-bottom-left .fa-star {
        color: #16a34a; 
    }

    /* UPDATED: Progress Bar Styling */
    #festive-collection-container .progress-bar-container { background-color: #e5e7eb; border-radius: 50px; height: 18px; width: 100%; position: relative; overflow: hidden; margin-top: 8px; }
    #festive-collection-container .progress-bar-inner {
        background-color: #ef4444; /* UPDATED: Pure Red progress bar */
        height: 100%;
        border-radius: 50px;
        transition: width 0.5s ease-in-out;
    }
    #festive-collection-container .progress-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: 600; color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.25); }

    /* NEW: Styles for price and discount alignment */
    #festive-collection-container .price-discount-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.5rem;
    }
    #festive-collection-container .price-wrapper {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }
</style>

<section class="festive-collection reveal" id="festive-collection-container" style="display: none;">
    <div class="section-header-flex">
        <h1 class="festival-headline" id="festive-headline"></h1>
        <div class="header-right-content">
            <div id="festive-countdown-timer" class="countdown-timer"></div>
            <a href="#" id="festive-view-all-link" class="view-all-arrow" aria-label="View All"><i class="fas fa-arrow-right"></i></a>
        </div>
    </div>
    <div class="horizontal-scroller product-slider" id="festive-product-slider"></div>
</section>

<script>
    document.addEventListener('ramazone:dataReady', (event) => {
        const { homepageData, allProducts } = event.detail;
        const collectionData = homepageData.festiveCollection;
        
        const container = document.getElementById('festive-collection-container');
        if (!container || !collectionData || !Array.isArray(collectionData.productIds) || collectionData.productIds.length === 0) {
            return;
        }
        
        container.style.display = 'block';
        container.style.backgroundColor = collectionData.backgroundColor || 'var(--bg-light)';
        
        const headline = document.getElementById('festive-headline');
        const countdownTimer = document.getElementById('festive-countdown-timer');
        const viewAllArrow = document.getElementById('festive-view-all-link');

        if (headline) {
            const headlineColor = collectionData.headlineColor || 'var(--text-dark)';
            headline.innerText = collectionData.title || 'Special Offers';
            headline.style.color = headlineColor;
            
            // UPDATED: Dynamically set timer and arrow color to match headline
            if(countdownTimer) countdownTimer.style.color = headlineColor;
            if(viewAllArrow) viewAllArrow.style.color = headlineColor;
        }

        if (collectionData.endTime) {
            startLocalCountdownTimer(collectionData.endTime, 'festive-countdown-timer');
        }

        const slider = document.getElementById('festive-product-slider');
        const productMetadata = collectionData.productMetadata || {};
        const productsToShow = collectionData.productsToShow || collectionData.productIds.length;

        const productsToRender = collectionData.productIds
            .slice(0, productsToShow)
            .map(id => {
                const product = allProducts.find(p => p && p.id === id);
                if (!product) return null;
                const metadata = productMetadata[id] || {};
                return createLocalProductCardHTML(product, 'carousel-item', {
                    soldPercentage: metadata.soldPercentage
                });
            })
            .filter(Boolean)
            .join('');

        slider.innerHTML = productsToRender;
    });

    let localFestiveCountdownInterval = null;
    function startLocalCountdownTimer(endTimeString, elementId) {
        if (localFestiveCountdownInterval) clearInterval(localFestiveCountdownInterval);
        const countdownElement = document.getElementById(elementId);
        if (!countdownElement) return;
        const endTime = new Date(endTimeString).getTime();
        if (isNaN(endTime)) { countdownElement.innerHTML = "Deal Ended"; return; }
        const updateTimer = () => {
            const now = new Date().getTime();
            const distance = endTime - now;
            if (distance < 0) {
                clearInterval(localFestiveCountdownInterval);
                countdownElement.innerHTML = "Deal Ended";
                return;
            }
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            countdownElement.innerHTML = `<i class="far fa-clock"></i>&nbsp;<span>${String(h).padStart(2, '0')}</span>:<span>${String(m).padStart(2, '0')}</span>:<span>${String(s).padStart(2, '0')}</span>`;
        };
        updateTimer();
        localFestiveCountdownInterval = setInterval(updateTimer, 1000);
    }

    function createLocalProductCardHTML(prod, cardClass = '', options = {}) {
        if (!prod) return '';
        const { soldPercentage } = options;
        const imageUrl = (prod.images && prod.images[0]) || 'https://placehold.co/400x400/e2e8f0/64748b?text=Image';
        const ratingTag = prod.rating ? `<div class="card-rating-tag rating-tag-bottom-left">${prod.rating} <i class="fas fa-star"></i></div>` : '';
        const offerTag = prod.offerText ? `<div class="product-offer-tag offer-tag-top-left" style="color:${prod.offerTextColor||'white'}; background-color:${prod.offerBackgroundColor||'#4F46E5'}">${prod.offerText}</div>` : '';
        
        let priceHTML = `<p class="text-base font-bold" style="color: var(--primary-color)">₹${Number(prod.displayPrice).toLocaleString("en-IN")}</p>`;
        let originalPriceHTML = '', discountHTML = '';
        
        if (prod.originalPrice && Number(prod.originalPrice) > Number(prod.displayPrice)) {
            const discount = Math.round(((prod.originalPrice - prod.displayPrice) / prod.originalPrice) * 100);
            originalPriceHTML = `<p class="text-xs text-gray-400 line-through">₹${Number(prod.originalPrice).toLocaleString("en-IN")}</p>`;
            if (discount > 0) discountHTML = `<p class="text-xs font-semibold text-green-600">${discount}% OFF</p>`;
        }
        
        let progressBarHTML = '';
        if (typeof soldPercentage === 'number' && soldPercentage >= 0) {
            progressBarHTML = `<div class="progress-bar-container"><div class="progress-bar-inner" style="width: ${soldPercentage}%"></div><span class="progress-bar-text">${soldPercentage}% Sold</span></div>`;
        }
        
        const showAddButton = Number(prod.displayPrice) < 500 || prod.category === 'grocery';
        const addButtonHTML = showAddButton ? `<button class="add-btn standard-card-add-btn" data-id="${prod.id}">+</button>` : "";
        
        // UPDATED: HTML structure for price and discount
        return `
        <div class="product-card ${cardClass} h-full block bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
            <div class="relative">
                <a href="./product-details.html?id=${prod.id}" class="block relative">
                    <img src="${imageUrl}" class="w-full object-cover aspect-square" alt="${prod.name || 'Product'}" loading="lazy">
                    ${ratingTag}
                    ${offerTag}
                </a>
                ${addButtonHTML}
            </div>
            <div class="p-2">
                <a href="./product-details.html?id=${prod.id}" class="block">
                    <h4 class="text-sm font-semibold truncate text-gray-800 mb-1">${prod.name || 'Product Name'}</h4>
                    <div class="price-discount-wrapper">
                        <div class="price-wrapper">
                            ${priceHTML}
                            ${originalPriceHTML}
                        </div>
                        ${discountHTML}
                    </div>
                </a>
                ${progressBarHTML}
            </div>
        </div>`;
    }
</script>

