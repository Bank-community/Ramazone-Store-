<!-- sections/dashboard.html -->
<style>
    /* Admin Panel jaise UI ke liye naye styles */
    .action-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 0.75rem;
        border-radius: 0.75rem;
        border-width: 1px;
        transition: all 0.2s ease-in-out;
        text-decoration: none;
        height: 100%;
        min-height: 90px;
        cursor: pointer;
    }
    .action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.07);
    }
    .action-card .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }
    .action-card .stat-label {
        font-size: 0.75rem;
        color: #4b5563;
        margin-top: 2px;
    }
    .admin-card {
        background-color: #fff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f3f4f6;
        font-weight: 600;
    }
    .card-body {
        padding: 1rem;
    }
    .modal-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .modal-list-item:last-child {
        border-bottom: none;
    }
</style>

<div id="dashboard-container" class="space-y-6">

    <!-- 1. Action Grid (Vendor Specific) -->
    <div class="grid grid-cols-4 gap-3">
        <div data-page="sections/orders.html" class="action-card bg-blue-50 border-blue-200 hover:bg-blue-100">
            <div id="stats-total-orders" class="stat-number">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div data-page="sections/products.html" class="action-card bg-green-50 border-green-200 hover:bg-green-100">
            <div id="stats-total-products" class="stat-number">0</div>
            <div class="stat-label">My Products</div>
        </div>
        <div data-action="show-categories" class="action-card bg-yellow-50 border-yellow-200 hover:bg-yellow-100">
            <div id="stats-total-categories" class="stat-number">0</div>
            <div class="stat-label">My Categories</div>
        </div>
        <div data-action="show-low-stock" class="action-card bg-red-50 border-red-200 hover:bg-red-100">
            <div id="stats-low-stock" class="stat-number">0</div>
            <div class="stat-label">Low Stock</div>
        </div>
        
        <div data-action="add-product" class="action-card bg-indigo-50 border-indigo-200 hover:bg-indigo-100">
            <div class="stat-number text-indigo-600"><i class="fas fa-plus"></i></div>
            <div class="stat-label">Add Product</div>
        </div>
        <div data-action="top-selling" class="action-card bg-purple-50 border-purple-200 hover:bg-purple-100">
            <div class="stat-number text-purple-600"><i class="fas fa-chart-bar"></i></div>
            <div class="stat-label">Top Selling</div>
        </div>
        <div data-page="sections/orders.html" class="action-card bg-pink-50 border-pink-200 hover:bg-pink-100">
            <div class="stat-number text-pink-600"><i class="fas fa-receipt"></i></div>
            <div class="stat-label">My Orders</div>
        </div>
        <div class="action-card bg-teal-50 border-teal-200">
            <div id="stats-today-sale" class="stat-number">₹0</div>
            <div class="stat-label">Today's Sale</div>
        </div>
    </div>

    <!-- 2. Today's Activity & Recent Orders (Vendor Specific) -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-2 admin-card">
            <div class="card-header"><h3>Today's Activity</h3></div>
            <div id="today-activity-list" class="card-body space-y-3">
                 <p class="text-center text-sm text-gray-500 py-4">Loading activity...</p>
            </div>
        </div>
        <div class="lg:col-span-3 admin-card">
            <div class="card-header flex justify-between items-center">
                <h3>My Recent Orders</h3>
                <a href="#" data-page="sections/orders.html" class="text-sm font-medium text-primary hover:underline">View All</a>
            </div>
            <div class="p-0">
                <div id="recent-orders-list" class="divide-y divide-gray-100">
                    <p class="p-4 text-center text-sm text-gray-500">Loading recent orders...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const dashboardContainer = document.getElementById('dashboard-container');
    if (!dashboardContainer) return;

    let ordersRef = null;

    // Real-time data listener
    function initializeDashboardListener() {
        if (ordersRef) ordersRef.off();

        ordersRef = db.ref(`${DB_BASE_PATH}/orders`);
        ordersRef.on('value', (snapshot) => {
            const ordersData = snapshot.val() || {};
            processAndRenderDashboard(ordersData);
        }, (error) => {
            console.error("Dashboard listener error:", error);
            window.showToast('Error', 'Could not load dashboard data.', 'error');
        });
        
        setupEventListeners();
    }
    
    // Process and Render data specifically for the logged-in vendor
    function processAndRenderDashboard(ordersData) {
        const vendorProducts = window.currentVendorProductsCache.map(p => p.data).filter(Boolean);
        const vendorProductIds = vendorProducts.map(p => p.id);
        
        const allOrders = [
            ...Object.values(ordersData.pending || {}),
            ...Object.values(ordersData.confirmed || {}),
            ...Object.values(ordersData.rejected || {})
        ];
        
        const vendorOrders = allOrders.filter(order => 
            order.items && order.items.some(item => vendorProductIds.includes(item.id))
        );
        
        const today = new Date().setHours(0, 0, 0, 0);

        renderMainStats(vendorOrders, vendorProducts, today);
        renderActivityAndRecent(vendorOrders, today);
    }

    function renderMainStats(vendorOrders, vendorProducts, today) {
        document.getElementById('stats-total-orders').textContent = vendorOrders.length;
        document.getElementById('stats-total-products').textContent = vendorProducts.length;
        document.getElementById('stats-total-categories').textContent = new Set(vendorProducts.map(p => p.category)).size;
        document.getElementById('stats-low-stock').textContent = vendorProducts.filter(p => p.quantity !== undefined && parseInt(p.quantity, 10) < 5).length;
        
        const todaysConfirmedOrders = vendorOrders.filter(o => {
            const orderDate = new Date(o.createdAt || o.timestamp).setHours(0, 0, 0, 0);
            return orderDate === today && o.status === 'Confirmed';
        });

        let totalSaleAmount = 0;
        const vendorProductIds = vendorProducts.map(p => p.id);
        todaysConfirmedOrders.forEach(order => {
            (order.items || []).forEach(item => {
                if (vendorProductIds.includes(item.id)) {
                    totalSaleAmount += (item.displayPrice || 0) * (item.quantity || 1);
                }
            });
        });
        document.getElementById('stats-today-sale').textContent = `₹${totalSaleAmount.toLocaleString('en-IN')}`;
    }

    function renderActivityAndRecent(vendorOrders, today) {
        const activityContainer = document.getElementById('today-activity-list');
        const recentOrdersContainer = document.getElementById('recent-orders-list');
        activityContainer.innerHTML = '';
        recentOrdersContainer.innerHTML = '';

        const todaysVendorOrders = vendorOrders.filter(o => o.createdAt && new Date(o.createdAt).setHours(0,0,0,0) === today);
        if (todaysVendorOrders.length > 0) {
            todaysVendorOrders.sort((a,b) => b.createdAt - a.createdAt).slice(0, 5).forEach(o => {
                activityContainer.innerHTML += `<div class="flex items-center gap-3 text-sm"><div class="bg-green-100 text-green-600 rounded-full h-8 w-8 flex items-center justify-center"><i class="fas fa-shopping-cart"></i></div><div><p>New order from <span class="font-semibold">${o.customerDetails?.name || 'Guest'}</span></p><p class="text-xs text-gray-500">${new Date(o.createdAt).toLocaleTimeString()}</p></div></div>`;
            });
        } else {
            activityContainer.innerHTML = `<p class="text-center text-sm text-gray-500 py-4">No activity today.</p>`;
        }

        const recentVendorOrders = vendorOrders.sort((a, b) => (b.createdAt || b.timestamp) - (a.createdAt || a.timestamp)).slice(0, 5);
        if (recentVendorOrders.length > 0) {
            const vendorProductIds = (window.currentVendorProductsCache || []).map(p => p.data.id);
            recentVendorOrders.forEach(o => {
                let vendorTotal = 0;
                (o.items || []).forEach(item => {
                    if (vendorProductIds.includes(item.id)) {
                        vendorTotal += (item.displayPrice || 0) * (item.quantity || 1);
                    }
                });
                recentOrdersContainer.innerHTML += `<div class="p-3 flex justify-between items-center hover:bg-gray-50 text-sm"><div><p class="font-semibold">${o.customerDetails?.name||'Unknown'}</p><p class="text-xs text-gray-500">${o.orderId||'N/A'}</p></div><div class="text-right"><p class="font-semibold">₹${vendorTotal.toLocaleString('en-IN')}</p><p class="text-xs text-gray-500">${new Date(o.createdAt || o.timestamp).toLocaleDateString()}</p></div></div>`;
            });
        } else {
            recentOrdersContainer.innerHTML = `<p class="p-4 text-center text-sm text-gray-500">You have no recent orders.</p>`;
        }
    }
    
    function setupEventListeners() {
        dashboardContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.action-card, a');
            if (!target) return;
            e.preventDefault();

            const pageUrl = target.dataset.page;
            const action = target.dataset.action;

            if (pageUrl) {
                const sidebarLink = document.querySelector(`.sidebar-link[data-page="${pageUrl}"]`);
                if (sidebarLink) sidebarLink.click();
            } else if (action) {
                const vendorProducts = window.currentVendorProductsCache.map(p => p.data).filter(Boolean);
                switch(action) {
                    case 'add-product': document.querySelector('.sidebar-link[data-page="sections/products.html"]').click(); setTimeout(() => document.getElementById('add-product-btn')?.click(), 200); break;
                    case 'top-selling': showModalTopSelling(); break;
                    case 'show-categories': showModalCategories(vendorProducts); break;
                    case 'show-low-stock': showModalLowStock(vendorProducts); break;
                }
            }
        });
    }

    // Modal Functions (Vendor Specific)
    function openModal(title, content) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('modalFooter').style.display = 'none'; // Hide save/cancel
        document.getElementById('universalModal').classList.add('active');
    }

    async function showModalTopSelling() {
        const ordersRef = await db.ref(`${DB_BASE_PATH}/orders`).once('value');
        const ordersData = ordersRef.val() || {};
        const vendorProducts = window.currentVendorProductsCache.map(p => p.data).filter(Boolean);
        const vendorProductIds = vendorProducts.map(p => p.id);
        const confirmedOrders = Object.values(ordersData.confirmed || {});
        
        const salesCount = {};
        confirmedOrders.forEach(order => {
            (order.items || []).forEach(item => { 
                if (vendorProductIds.includes(item.id)) {
                    salesCount[item.id] = (salesCount[item.id] || 0) + (item.quantity || 1);
                }
            });
        });
        const topProducts = Object.entries(salesCount).sort(([,a],[,b]) => b-a).slice(0, 5).map(([id, count]) => ({ name: (vendorProducts.find(p => p.id === id) || {}).name || 'Unknown', count }));
        let content = topProducts.map(p => `<div class="modal-list-item"><span>${p.name}</span><span class="font-bold">${p.count} sold</span></div>`).join('');
        openModal('Your Top 5 Selling Products', content || '<p class="text-center text-gray-500">No sales data yet.</p>');
    }

    function showModalCategories(vendorProducts) {
        const categories = [...new Set(vendorProducts.map(p => p.category))];
        let content = categories.map(c => `<div class="modal-list-item"><span>${c}</span></div>`).join('');
        openModal('Your Product Categories', content || '<p class="text-center text-gray-500">You have no categories.</p>');
    }

    function showModalLowStock(vendorProducts) {
        const lowStockProducts = vendorProducts.filter(p => p.quantity !== undefined && parseInt(p.quantity, 10) < 5);
        let content = lowStockProducts.map(p => `<div class="modal-list-item"><span>${p.name}</span><span class="font-bold text-red-600">${p.quantity} left</span></div>`).join('');
        openModal('Your Low Stock Products', content || '<p class="text-center text-gray-500">No products are low on stock.</p>');
    }
    
    initializeDashboardListener();
})();
</script>
