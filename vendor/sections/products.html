<!-- sections/products.html -->
<style>
    /* Styles are good, no changes needed */
    .product-table-img { width: 50px; height: 50px; object-fit: cover; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
    .table-responsive { overflow-x: auto; }
</style>

<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">My Products</h2>
        <p class="text-sm text-gray-500">Apne sabhi products ko yahan manage karein.</p>
    </div>
    <div class="flex items-center gap-4">
        <div class="relative w-full max-w-xs">
            <input type="text" id="product-search-input" class="form-control pl-10" placeholder="Search your products...">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        <button id="add-new-product-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i> Add New Product</button>
    </div>
</div>

<div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-4 table-responsive">
        <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3">Image</th>
                    <th scope="col" class="px-6 py-3">Product Name</th>
                    <th scope="col" class="px-6 py-3">Category</th>
                    <th scope="col" class="px-6 py-3">Price</th>
                    <th scope="col" class="px-6 py-3">Quantity</th>
                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="vendor-products-tbody">
                <!-- Products will be loaded here by the script -->
            </tbody>
        </table>
    </div>
    <div id="no-products-message" class="hidden text-center p-10">
        <div class="text-5xl text-gray-300 mb-4"><i class="fas fa-box-open"></i></div>
        <h3 class="text-lg font-semibold text-gray-700">No products found.</h3>
        <p class="text-gray-500">Click 'Add New Product' to start.</p>
    </div>
</div>

<script>
(function() {
    // --- ELEMENTS ---
    const tableBody = document.getElementById('vendor-products-tbody');
    const noProductsMsg = document.getElementById('no-products-message');
    const searchInput = document.getElementById('product-search-input');
    
    // Use the reliable cache prepared by vendor-main.js
    const vendorProducts = window.currentVendorProductsCache || [];

    // --- RENDER FUNCTION ---
    function renderProducts(productsToRender) {
        tableBody.innerHTML = '';
        if (!productsToRender || productsToRender.length === 0) {
            noProductsMsg.classList.remove('hidden');
            return;
        }
        noProductsMsg.classList.add('hidden');

        productsToRender.forEach(productItem => {
            if (!productItem || !productItem.data) return;

            const product = productItem.data;
            // THE MOST IMPORTANT FIX: Use the originalIndex provided by vendor-main.js
            const originalIndex = productItem.originalIndex; 
            
            const tr = document.createElement('tr');
            tr.className = 'bg-white border-b hover:bg-gray-50';
            // Store the original index directly on the row for easy access
            tr.dataset.originalIndex = originalIndex;

            tr.innerHTML = `
                <td class="px-6 py-4">
                    <img src="${product.images && product.images[0] ? product.images[0] : 'https://placehold.co/100x100/e2e8f0/e2e8f0'}" alt="${product.name}" class="product-table-img">
                </td>
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${product.name}</th>
                <td class="px-6 py-4">${product.category || 'N/A'}</td>
                <td class="px-6 py-4">â‚¹${product.displayPrice}</td>
                <td class="px-6 py-4">${product.quantity || 0}</td>
                <td class="px-6 py-4 text-right">
                    <button class="font-medium text-primary hover:underline edit-product-btn">Edit</button>
                    <button class="font-medium text-red-600 hover:underline ml-4 delete-product-btn">Delete</button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }
    
    // --- EVENT LISTENERS ---
    document.getElementById('add-new-product-btn').addEventListener('click', () => {
        window.editingProductData = null; // Ensure we are in "add" mode
        loadPage('sections/product-form.html');
    });

    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredProducts = vendorProducts.filter(item => 
            item.data && item.data.name.toLowerCase().includes(searchTerm)
        );
        renderProducts(filteredProducts);
    });

    tableBody.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;

        const originalIndex = row.dataset.originalIndex;

        if (target.classList.contains('edit-product-btn')) {
            // Find the correct product from the cache using the original index
            const productToEdit = window.allProductsCache[originalIndex];
            
            if (productToEdit) {
                window.editingProductData = { 
                    data: productToEdit, 
                    originalIndex: originalIndex // Pass the TRUE index to the form
                };
                loadPage('sections/product-form.html');
            } else {
                window.showToast('Error', 'Could not find product to edit.', 'error');
            }
        }

        if (target.classList.contains('delete-product-btn')) {
            if (confirm('Are you sure you want to delete this product? This cannot be undone.')) {
                try {
                    // To "delete" from a Firebase array, we set its value to null.
                    // This preserves the indexes of other items.
                    await db.ref(`${DB_BASE_PATH}/products/${originalIndex}`).set(null);
                    window.showToast('Success', 'Product deleted.', 'success');
                    
                    // Reload the main script to refresh the cache and UI
                    const script = document.createElement('script');
                    script.src = 'vendor-main.js?v=' + new Date().getTime();
                    script.onload = () => { /* The main script will handle reload */ };
                    document.body.appendChild(script).parentNode.removeChild(script);

                } catch (error) {
                    window.showToast('Error', `Could not delete product: ${error.message}`, 'error');
                }
            }
        }
    });

    // --- INITIAL CALL ---
    // Directly render using the pre-loaded and filtered cache
    renderProducts(vendorProducts);
})();
</script>

