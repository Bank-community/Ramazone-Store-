<!-- sections/product-form.html -->
<style>
    /* Styles are correct, no changes needed */
    .combo-item { display: flex; gap: 0.5rem; align-items: center; }
    .dynamic-block { border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
    .dynamic-block-header { display: flex; align-items: center; padding: 0.75rem 1rem; cursor: pointer; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    .dynamic-block-body { padding: 1.25rem; background-color: #ffffff; display: none; }
    .handle { cursor: grab; color: #9ca3af; margin-right: 0.75rem; }
    .remove-btn { background: none; border: none; cursor: pointer; font-size: 1.25rem; color: #ef4444; }
    .fa-chevron-down { transition: transform 0.3s ease; } .rotate-180 { transform: rotate(180deg); }
    .multi-image-preview-item { position: relative; aspect-ratio: 1/1; border-radius: 0.5rem; overflow: hidden; border: 1px solid #e5e7eb; cursor: grab; background-color: #f3f4f6;}
    .multi-image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .remove-img-btn { position: absolute; top: 0.25rem; right: 0.25rem; width: 1.5rem; height: 1.5rem; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }
</style>

<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div>
        <h2 id="product-form-title" class="text-2xl font-bold text-gray-800">Add New Product</h2>
        <p class="text-sm text-gray-500">Apne product ki details yahan bharein.</p>
    </div>
    <button id="back-to-products-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back to Products</button>
</div>

<div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <form id="product-form">
        <div class="p-6">
            <input type="hidden" id="product-edit-original-index">
            <input type="hidden" id="combo-data-storage">
            <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                <!-- All form fields are correct -->
                <div><label class="form-label">Product Name</label><input type="text" class="form-control" data-key="name" required></div>
                <div><label class="form-label">Category</label><select class="form-control" data-key="category" id="product-category-selector" required><option value="">Select Category</option></select></div>
                <div><label class="form-label">Display Price (₹)</label><input type="number" class="form-control" data-key="displayPrice" required></div>
                <div><label class="form-label">Original Price (₹)</label><input type="number" class="form-control" data-key="originalPrice" required></div>
                <div><label class="form-label">Seller Name</label><input type="text" class="form-control" data-key="sellerName"></div>
                <div><label class="form-label">WhatsApp Number</label><input type="text" class="form-control" data-key="whatsappNumber"></div>
                <div><label class="form-label">Product Quantity</label><input type="number" class="form-control" data-key="quantity"></div>
                <div><label class="form-label">SKU (Auto-Generated)</label><input type="text" class="form-control bg-gray-200" data-key="sku" readonly></div>
                <div class="md:col-span-2"><label class="form-label">Return Policy</label><div class="flex items-center gap-4"><select id="return-policy-type" class="form-control w-1/3"><option value="days">Returnable</option><option value="no_return">No Return</option><option value="custom">Custom Policy</option></select><div id="return-policy-value-container" class="flex-grow"><input type="number" id="return-policy-days" class="form-control" placeholder="e.g., 7 (in days)"><input type="text" id="return-policy-custom" class="form-control hidden" placeholder="e.g., 7 Days Replacement"></div></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Offer Badge (Optional)</h4></div>
                <div><label class="form-label">Offer Text</label><input type="text" class="form-control" data-key="offerText"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="form-label">Background Color</label><input type="color" class="form-control h-10 p-1" data-key="offerBackgroundColor" value="#0000ff"></div><div><label class="form-label">Text Color</label><input type="color" class="form-control h-10 p-1" data-key="offerTextColor" value="#ffffff"></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Media</h4></div>
                <div class="md:col-span-2"><label class="form-label">Product YouTube Video (Optional)</label><input type="url" class="form-control" data-key="videoUrl"></div>
                <div class="md:col-span-2"><label class="form-label">Product Images</label><p class="text-xs text-gray-500 mb-2">Pehli image thumbnail banegi. Images ko drag karke order badal sakte hain.</p><input type="file" id="multi-image-upload-input" class="form-control" accept="image/*" multiple><div id="multi-image-preview-container" class="mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Select Similar Products</h4><select id="similar-products-filter" class="form-control text-sm w-auto"><option value="all">All My Products</option><option value="same_category">My Products in Same Category</option></select></div><p class="text-xs text-gray-500 mb-2">Customer ko suggest karne ke liye apne products chunein.</p><select id="similar-products-selector" class="form-control" multiple style="height: 150px;"></select></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Combo Offers</h4><button type="button" id="open-combo-modal-btn" class="btn btn-secondary"><i class="fas fa-cogs mr-2"></i> Manage Combos</button></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Product Variants</h4><button type="button" id="add-variant-type-btn" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i> Add Variant Type</button></div><div id="variants-container"></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-lg text-gray-700 mb-2">Advanced Highlights</h4><div id="spec-highlights-container" class="space-y-4 border rounded-lg p-4 bg-gray-50"><div class="grid md:grid-cols-2 gap-4"><div><label class="form-label">Spec Score</label><input type="text" class="form-control" id="spec-score-input"></div><div><label class="form-label">Spec Tag</label><input type="text" class="form-control" id="spec-tag-input"></div></div><div class="border-t pt-4 mt-4"><div class="flex justify-between items-center"><h5 class="font-semibold text-gray-700">Highlight Blocks</h5><button type="button" id="add-spec-block-btn" class="btn btn-sm btn-secondary"><i class="fas fa-plus mr-1"></i> Add Block</button></div><div id="spec-blocks-list" class="mt-2 space-y-3"></div></div></div></div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg text-gray-700">Simple Product Description</h4><button type="button" id="add-desc-block-btn" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i> Add Block</button></div><div id="description-blocks-container"></div></div>
            </div>
        </div>
        <div class="bg-gray-50 p-4 text-right rounded-b-lg border-t">
            <button id="save-product-btn" type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i> Save Changes</button>
        </div>
    </form>
</div>

<script>
(async function() {
    // --- ELEMENTS ---
    const form = document.getElementById('product-form');
    const saveBtn = document.getElementById('save-product-btn');
    const backBtn = document.getElementById('back-to-products-btn');
    const imagePreviewContainer = document.getElementById('multi-image-preview-container');
    const returnPolicyType = document.getElementById('return-policy-type');
    const returnPolicyDays = document.getElementById('return-policy-days');
    const returnPolicyCustom = document.getElementById('return-policy-custom');
    const openComboModalBtn = document.getElementById('open-combo-modal-btn');
    const comboDataStorage = document.getElementById('combo-data-storage');
    let currentProductId = null;

    // --- HELPER FUNCTIONS ---
    const getVariantOptionHtml = (d={},t='')=>`<div class="variant-option-item flex items-center gap-2 relative pl-6 mt-2"><i class="fas fa-grip-vertical handle-option cursor-move text-gray-300 absolute top-1/2 -translate-y-1/2 left-0"></i><input type="text" class="form-control variant-option-name" placeholder="Option Name" value="${d.name||''}"><input type="color" class="variant-option-value h-10 w-10 p-1" style="display:${t.toLowerCase()==='color'?'block':'none'}" value="${d.value||'#000000'}"><button type="button" class="remove-btn remove-variant-option-btn">×</button></div>`;
    const getVariantTypeHtml = (d={})=>`<div class="dynamic-block variant-type-block"><div class="dynamic-block-header"><i class="fas fa-grip-vertical handle cursor-move"></i><span class="font-semibold flex-grow truncate">${d.type||'New Variant'}</span><i class="fas fa-chevron-down text-gray-500 ml-auto"></i><button type="button" class="remove-btn remove-variant-type-btn ml-3">×</button></div><div class="dynamic-block-body"><div class="grid md:grid-cols-2 gap-4"><div><label class="form-label">Variant Type</label><input type="text" class="form-control variant-type-name" value="${d.type||''}"></div><div><label class="form-label">Options</label><div class="variant-options-container">${(d.options||[]).map(o=>getVariantOptionHtml(o,d.type)).join('')}</div><button type="button" class="btn btn-sm btn-secondary mt-2 add-variant-option-btn"><i class="fas fa-plus mr-1"></i>Add Option</button></div></div></div></div>`;
    const getDescriptionBlockHtml = (d={})=>`<div class="dynamic-block description-block"><div class="dynamic-block-header"><i class="fas fa-grip-vertical handle cursor-move"></i><span class="font-semibold flex-grow truncate">${d.title||'New Block'}</span><i class="fas fa-chevron-down text-gray-500 ml-auto"></i><button type="button" class="remove-btn remove-desc-block-btn ml-3">×</button></div><div class="dynamic-block-body"><label class="form-label">Title</label><input type="text" class="form-control desc-title mb-2" value="${d.title||''}"><label class="form-label">Details</label><textarea class="form-control desc-details" rows="3">${d.details||''}</textarea></div></div>`;
    const getSpecHighlightBlockHtml = (d={})=>`<div class="dynamic-block spec-highlight-block"><div class="dynamic-block-header"><i class="fas fa-grip-vertical handle cursor-move"></i><span class="font-semibold flex-grow truncate">${d.title||'New Highlight'}</span><i class="fas fa-chevron-down text-gray-500 ml-auto"></i><button type="button" class="remove-btn remove-spec-block-btn ml-3">×</button></div><div class="dynamic-block-body"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="form-label">Icon (SVG)</label><textarea class="form-control spec-block-icon" rows="2">${d.icon||''}</textarea></div><div><label class="form-label">Category</label><input type="text" class="form-control spec-block-category" value="${d.category||''}"></div><div class="md:col-span-2"><label class="form-label">Title</label><input type="text" class="form-control spec-block-title" value="${d.title||''}"></div><div class="md:col-span-2"><label class="form-label">Subtitle</label><input type="text" class="form-control spec-block-subtitle" value="${d.subtitle||''}"></div></div></div></div>`;

    // --- INITIALIZE FORM ---
    function initializeForm() {
        const productToEdit = window.editingProductData;
        form.querySelector('[data-key="sellerName"]').value = window.currentVendorData.shopName;
        form.querySelector('[data-key="whatsappNumber"]').value = window.currentVendorData.whatsappNumber;
        const catSelector = form.querySelector('#product-category-selector');
        catSelector.innerHTML = '<option value="">Select Category</option>';
        window.allCategoriesCache.forEach(c => { catSelector.innerHTML += `<option value="${c}">${c}</option>`; });
        if (productToEdit && productToEdit.data) {
            document.getElementById('product-form-title').textContent = 'Edit Product';
            currentProductId = productToEdit.data.id;
            form.querySelector('#product-edit-original-index').value = productToEdit.originalIndex; 
            Object.keys(productToEdit.data).forEach(key => { const input = form.querySelector(`[data-key="${key}"]`); if (input && typeof productToEdit.data[key] !== 'object') { input.value = productToEdit.data[key]; } });
            if (productToEdit.data.returnPolicy) { const { type, value } = productToEdit.data.returnPolicy; returnPolicyType.value = type; if (type === 'days') returnPolicyDays.value = value; if (type === 'custom') returnPolicyCustom.value = value; }
            handleReturnPolicyChange();
            (productToEdit.data.images || []).forEach(url => renderImagePreview(url));
            (productToEdit.data.variants || []).forEach(d => document.getElementById('variants-container').insertAdjacentHTML('beforeend', getVariantTypeHtml(d)));
            (productToEdit.data.description || []).forEach(d => document.getElementById('description-blocks-container').insertAdjacentHTML('beforeend', getDescriptionBlockHtml(d)));
            if (productToEdit.data.specHighlights) { form.querySelector('#spec-score-input').value = productToEdit.data.specHighlights.specScore || ''; form.querySelector('#spec-tag-input').value = productToEdit.data.specHighlights.specTag || ''; (productToEdit.data.specHighlights.blocks || []).forEach(d => document.getElementById('spec-blocks-list').insertAdjacentHTML('beforeend', getSpecHighlightBlockHtml(d))); }
            if (productToEdit.data.combos) comboDataStorage.value = JSON.stringify(productToEdit.data.combos);
            if (productToEdit.data.similarProductIds) form.dataset.tempSimilarIds = JSON.stringify(productToEdit.data.similarProductIds);
        } else {
            document.getElementById('product-form-title').textContent = 'Add New Product';
            const shopAbbr = window.currentVendorData.shopName.substring(0, 3).toUpperCase();
            form.querySelector('[data-key="sku"]').value = `RMZ-${shopAbbr}-${Date.now().toString().slice(-5)}`;
        }
        updateSimilarProductsSelector('all');
        window.editingProductData = null;
    }

    // --- SAVE LOGIC ---
    async function saveProduct() {
        if (!form.reportValidity()) return window.showToast('Validation Error', 'Please fill all required fields.', 'error');
        saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        try {
            const itemData = { vendorId: window.currentVendorData.vendorId };
            form.querySelectorAll('[data-key]').forEach(el => { if (el.multiple) return; const value = el.type === 'number' ? Number(el.value) : el.value; itemData[el.dataset.key] = value === undefined || value === '' ? null : value; });
            itemData.returnPolicy = { type: returnPolicyType.value, value: returnPolicyType.value === 'days' ? returnPolicyDays.value : returnPolicyCustom.value };
            const uploadedImages = await Promise.all( Array.from(imagePreviewContainer.querySelectorAll('img')).map(img => img._file ? window.uploadToImgBB(img._file) : Promise.resolve(img.src)) );
            itemData.images = uploadedImages.filter(Boolean);
            itemData.similarProductIds = Array.from(form.querySelector('#similar-products-selector').selectedOptions).map(o => o.value);
            if (comboDataStorage.value) itemData.combos = JSON.parse(comboDataStorage.value);
            itemData.variants = Array.from(form.querySelectorAll('.variant-type-block')).map(b => ({ type: b.querySelector('.variant-type-name').value, options: Array.from(b.querySelectorAll('.variant-option-item')).map(o => ({ name: o.querySelector('.variant-option-name').value, value: o.querySelector('.variant-option-value').value })) }));
            itemData.description = Array.from(form.querySelectorAll('.description-block')).map(b => ({ title: b.querySelector('.desc-title').value, details: b.querySelector('.desc-details').value }));
            itemData.specHighlights = { specScore: form.querySelector('#spec-score-input').value, specTag: form.querySelector('#spec-tag-input').value, blocks: Array.from(form.querySelectorAll('.spec-highlight-block')).map(b => ({ icon: b.querySelector('.spec-block-icon').value, category: b.querySelector('.spec-block-category').value, title: b.querySelector('.spec-block-title').value, subtitle: b.querySelector('.spec-block-subtitle').value })) };
            const originalIndex = form.querySelector('#product-edit-original-index').value;
            if (originalIndex) {
                itemData.id = currentProductId;
                await db.ref(`${DB_BASE_PATH}/products/${originalIndex}`).set(itemData);
                window.showToast('Success', 'Product updated successfully!', 'success');
            } else {
                itemData.id = `prod-${Date.now()}`;
                const allProductsSnapshot = await db.ref(`${DB_BASE_PATH}/products`).once('value');
                const productsArray = allProductsSnapshot.val() || [];
                const nextIndex = Array.isArray(productsArray) ? productsArray.length : Object.keys(productsArray).length;
                await db.ref(`${DB_BASE_PATH}/products/${nextIndex}`).set(itemData);
                window.showToast('Success', 'New product added!', 'success');
            }
            // --- Force reload main script to get fresh caches ---
            const mainScript = document.querySelector('script[src^="vendor-main.js"]');
            if (mainScript) mainScript.remove();
            const newScript = document.createElement('script');
            newScript.src = 'vendor-main.js?v=' + Date.now();
            newScript.onload = () => document.querySelector('.sidebar-link[data-page="sections/products.html"]').click();
            document.body.appendChild(newScript);
        } catch (err) { console.error("Save Failed:", err); window.showToast('Error', `Save failed: ${err.message}`, 'error'); 
        } finally { saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes'; }
    }

    // --- OTHER FUNCTIONS & LISTENERS ---
    function handleReturnPolicyChange() { const selectedType = returnPolicyType.value; returnPolicyDays.classList.toggle('hidden', selectedType !== 'days'); returnPolicyCustom.classList.toggle('hidden', selectedType !== 'custom'); }
    function renderImagePreview(src, file = null) { const item = document.createElement('div'); item.className = 'multi-image-preview-item'; const img = document.createElement('img'); img.src = src; if (file) img._file = file; item.innerHTML = `<span class="remove-img-btn">×</span>`; item.prepend(img); imagePreviewContainer.appendChild(item); }
    
    // --- ======================================================= ---
    // --- THIS IS THE UPDATED & CORRECTED FUNCTION ---
    // --- ======================================================= ---
    function updateSimilarProductsSelector(filterType) {
        const selector = form.querySelector('#similar-products-selector');
        const currentCategory = form.querySelector('#product-category-selector').value;
        const tempIds = JSON.parse(form.dataset.tempSimilarIds || '[]');
        selector.innerHTML = '';
        
        // --- FIX: Use currentVendorProductsCache instead of allProductsCache ---
        let list = window.currentVendorProductsCache.map(p => p.data).filter(Boolean);
        
        if (filterType === 'same_category' && currentCategory) {
            list = list.filter(p => p.category === currentCategory);
        }
        
        list.forEach(p => {
            if (p && p.id !== currentProductId) {
                const opt = new Option(p.name, p.id);
                if (tempIds.includes(p.id)) opt.selected = true;
                selector.add(opt);
            }
        });
    }

    backBtn.addEventListener('click', () => document.querySelector('.sidebar-link[data-page="sections/products.html"]').click());
    form.addEventListener('submit', (e) => { e.preventDefault(); saveProduct(); });
    document.getElementById('multi-image-upload-input').addEventListener('change', e => { for (const file of e.target.files) { const reader = new FileReader(); reader.onload = ev => renderImagePreview(ev.target.result, file); reader.readAsDataURL(file); } });
    new Sortable(imagePreviewContainer, { animation: 150, ghostClass: 'sortable-ghost', handle: '.multi-image-preview-item' });
    form.addEventListener('click', e => { if (e.target.closest('.remove-img-btn')) e.target.closest('.multi-image-preview-item').remove(); if (e.target.closest('#add-variant-type-btn')) document.getElementById('variants-container').insertAdjacentHTML('beforeend', getVariantTypeHtml()); if (e.target.closest('.add-variant-option-btn')) e.target.closest('.dynamic-block-body').querySelector('.variant-options-container').insertAdjacentHTML('beforeend', getVariantOptionHtml()); if (e.target.closest('.remove-variant-type-btn')) e.target.closest('.variant-type-block').remove(); if (e.target.closest('.remove-variant-option-btn')) e.target.closest('.variant-option-item').remove(); if (e.target.closest('#add-desc-block-btn')) document.getElementById('description-blocks-container').insertAdjacentHTML('beforeend', getDescriptionBlockHtml()); if (e.target.closest('.remove-desc-block-btn')) e.target.closest('.description-block').remove(); if (e.target.closest('#add-spec-block-btn')) document.getElementById('spec-blocks-list').insertAdjacentHTML('beforeend', getSpecHighlightBlockHtml()); if (e.target.closest('.remove-spec-block-btn')) e.target.closest('.spec-highlight-block').remove(); const header = e.target.closest('.dynamic-block-header'); if (header && !e.target.closest('.remove-btn')) { const body = header.nextElementSibling; if (body && body.classList.contains('dynamic-block-body')) { body.style.display = body.style.display === 'none' ? 'block' : 'none'; header.querySelector('.fa-chevron-down').classList.toggle('rotate-180'); } } });
    
    // --- FIX APPLIED TO COMBO MODAL AS WELL ---
    openComboModalBtn.addEventListener('click', () => {
        const modal = document.getElementById('universalModal'); const modalTitle = document.getElementById('modalTitle'); const modalBody = document.getElementById('modalBody'); const modalSaveBtn = document.getElementById('modalSaveBtn'); const existingData = comboDataStorage.value ? JSON.parse(comboDataStorage.value) : {};
        const getComboHtml = (data={}) => { 
            let packsHtml = (data.quantityPacks||[]).map(p=>`<div class="combo-item"><input type="text" class="form-control" value="${p.name}" placeholder="e.g., 2 Piece Pack"><input type="number" class="form-control" value="${p.price}" placeholder="Price"><button type="button" class="remove-btn remove-quantity-pack-btn">×</button></div>`).join('');
            // --- FIX: Using currentVendorProductsCache here too ---
            const vendorProducts = window.currentVendorProductsCache.map(p => p.data).filter(Boolean);
            const opts = vendorProducts.filter(p => p && p.id !== currentProductId).map(p => `<option value="${p.id}" ${data.productBundle&&data.productBundle.linkedProductId===p.id?'selected':''}>${p.name}</option>`).join('');
            return `<div><div><div class="flex justify-between items-center mb-2"><h5 class="font-semibold">Quantity Packs</h5><button type="button" id="add-quantity-pack-btn" class="btn btn-sm btn-secondary"><i class="fas fa-plus mr-1"></i>Add Pack</button></div><p class="text-xs text-gray-500 mb-2">Max 5 packs.</p><div id="quantity-packs-container" class="space-y-2">${packsHtml}</div></div><div class="border-t pt-4 mt-4"><h5 class="font-semibold mb-2">Product Bundle</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="form-label">Select Product</label><select id="bundle-product-selector" class="form-control"><option value="">None</option>${opts}</select></div><div><label class="form-label">Bundle Price</label><input type="number" id="bundle-price-input" class="form-control" value="${data.productBundle?data.productBundle.bundlePrice:''}"></div></div></div></div>`; 
        };
        modalTitle.textContent = 'Manage Combo Offers'; modalBody.innerHTML = getComboHtml(existingData); modalSaveBtn.style.display = 'inline-flex'; modalSaveBtn.textContent = 'Save Combos';
        const modalClickHandler = (e) => { if (e.target.id === 'add-quantity-pack-btn') { const container = modalBody.querySelector('#quantity-packs-container'); if (container.children.length < 5) { container.insertAdjacentHTML('beforeend', `<div class="combo-item"><input type="text" class="form-control" placeholder="e.g., 2 Piece Pack"><input type="number" class="form-control" placeholder="Price"><button type="button" class="remove-btn remove-quantity-pack-btn">×</button></div>`); } else { window.showToast('Limit Reached', 'You can only add up to 5 quantity packs.', 'error'); } } if (e.target.closest('.remove-quantity-pack-btn')) e.target.closest('.combo-item').remove(); };
        modalBody.addEventListener('click', modalClickHandler);
        modalSaveBtn.onclick = () => { const quantityPacks = Array.from(modalBody.querySelectorAll('#quantity-packs-container .combo-item')).map(item => ({name: item.querySelector('input[type="text"]').value, price: Number(item.querySelector('input[type="number"]').value)})).filter(p=>p.name&&p.price); const linkedProductId = modalBody.querySelector('#bundle-product-selector').value; const bundlePrice = modalBody.querySelector('#bundle-price-input').value; let productBundle = (linkedProductId && bundlePrice) ? {linkedProductId, bundlePrice: Number(bundlePrice)} : null; comboDataStorage.value = JSON.stringify({ quantityPacks, productBundle }); window.showToast('Combos Ready', 'Combo data will be saved with the product.', 'info'); document.getElementById('modalCloseBtn').click(); modalBody.removeEventListener('click', modalClickHandler); };
        modal.classList.add('active');
    });

    // --- Add change listener for the similar products filter dropdown ---
    document.getElementById('similar-products-filter').addEventListener('change', (e) => {
        updateSimilarProductsSelector(e.target.value);
    });

    // --- INITIALIZE ---
    initializeForm();
})();
</script>
